var Q=Object.defineProperty;var ee=(e,t,o)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var E=(e,t,o)=>ee(e,typeof t!="symbol"?t+"":t,o);import{i as j,d as W,u as te,b as ne}from"./chunk-4ruemlWu.js";import{u as N}from"./chunk-7OQk-BoX.js";import{t as se,v as oe,u as H,e as F,f as X,w as ie,s as Y,j as J,x as ae,c as re,y as le,U as ce}from"./chunk-ChctAPco.js";import{ad as z,ai as ue,aa as S,ak as k,r as v,au as de}from"./chunk-DJZJtpVs.js";import{a as fe,i as pe}from"./chunk-B4PEA_xj.js";import{l as ge}from"./chunk-yLOK5aTh.js";import{u as me}from"./chunk-C1_4RlJR.js";function he(){const{id:e}=z(),t=ue();return o=>{if(e!==void 0&&e?.toUpperCase()!==o?.toUpperCase()){const s=o?.replace(/^\/+/,"")||"PUBLIC";t(`/${s}`)}}}function I(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function ze(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}const{t:T}=S;class be{constructor(t){E(this,"bags",new Map);E(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];I(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],I(n),this.bags.set(s,n)}return n.pop()||null}}function ve(e,t,o=[]){return e.filter(s=>{const n=s.action;return o.find(r=>r.name===s.group)?.type==="consumption"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const x=new Map;function ye(e,t,o,s){const n=`${e}-${t}-${o}-${s||"normal"}`,i=x.get(n);if(i!==void 0)return i;let r;if([void 0,"normal"].includes(s)){const a=e/t;r=Math.floor(o/a)+1}else t>=3&&Math.random()>=.6?r=t-1:r=t;return x.set(n,r),r}function Z(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=o[r.name];if(!a||a.level<=0)return{title:"",description:""};if(a.variation){const l=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>l)return{title:"",description:""}}const c=Math.max(...r.intensities.map(l=>l.value)),m=ye(n,c,s,i.difficulty),d=Math.min(m,a.level);let u=t.getTile(r.name,d);if(!u){for(let l=d-1;l>=1&&(u=t.getTile(r.name,l),!u);l--);if(!u)for(let l=d+1;l<=c&&(u=t.getTile(r.name,l),!u);l++);if(!u)return{title:"",description:""}}return{title:r.label,description:u.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function $e(e,t,o,s,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=Z(t,o,s,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Ce(e,t,o,s){const n=o.selectedActions||{},i=new be(t),r=e.filter(d=>{const u=n[d.name];return u&&u.level>0&&(!u.variation||u.variation==="standalone")}),a=e.filter(d=>{const u=n[d.name];return u&&u.level>0&&(u.variation==="appendSome"||u.variation==="appendMost")});I(r);let c=0;const m=[];for(let d=1;d<=s;d++){const u=r.length>0?[r[c%r.length]]:[];c++;const l=Z(u,i,n,d,s,o),f=$e(l,a,i,n,d,s,o);m.push({title:l.title,description:f.trim(),role:l.role})}return m}function U(e,t){const o={title:T("start"),description:T("start")},{finishRange:s=[33,66]}=t,n=`${T("noCum")} ${s[0]}%\r
${T("ruined")} ${s[1]-s[0]}%\r
${T("cum")} ${100-s[1]}%`,i={title:T("finish"),description:n};return[o,...e.map(r=>({title:r.title,description:r.description})),i]}async function Te(e,t,o,s=40){try{const[n,i]=await Promise.all([se({locale:t,gameMode:o}),oe({locale:t,gameMode:o})]),r=e.selectedActions||{},a=Object.keys(r).filter(b=>r[b]?.level>0),c=n.filter(b=>a.includes(b.name)),m=n.map(b=>b.name),d=a.filter(b=>!m.includes(b)),u=e.role||"sub",f=ve(i,u,n).filter(b=>a.includes(b.group));if(!c.length||!f.length)return{board:U([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:d,availableTileCount:f.length}};const g=await Ce(c,f,e,s),h=g.filter(b=>b.description.trim().length>0).length,p=U(g,e);return{board:p,metadata:{totalTiles:p.length,tilesWithContent:h+2,selectedGroups:a,missingGroups:d,availableTileCount:f.length}}}catch(n){return console.error("Error building game board:",n),{board:U([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Ae(){const e=N(X),[t,o]=H(),{i18n:s}=k(),n=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:c}=r;const{roomTileCount:m=40,finishRange:d,room:u}=r,l=j(u||"");if(!i||!d)return{gameMode:a};l&&!W(a||"")&&(a="online",c=!0);const f=a||"online",g=s.resolvedLanguage||"en",h=l?40:m||40,p=await Te(r,g,f,h);return p.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",p.metadata.missingGroups),p.metadata.tilesWithContent<h/2&&console.warn("Low tile content ratio:",{tilesWithContent:p.metadata.tilesWithContent,totalTiles:p.metadata.totalTiles,availableTileCount:p.metadata.availableTileCount}),(i?.boardUpdated||c||(e?.tiles?.length??0)!==p.board.length)&&(await o(r),await F({title:e?.title||"",tiles:p.board})),{settingsBoardUpdated:c,gameMode:a,newBoard:p.board,metadata:p.metadata}},[e,s.resolvedLanguage,t,o]);return v.useCallback(i=>n(i),[n])}function we(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Se(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([r])=>s[r]).reduce((r,[a,c])=>(r[a]=Object.keys(c.actions).slice(1,s[a].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Le(e,t,o,s){const{t:n}=S;let i=`### ${S.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(o).forEach(([d,u])=>{if(!r[d])return;const{role:l,variation:f,level:g}=r[d],h=l||e.role||"sub";if(g>0){const p=Object.keys(u?.actions||{});if(i+=`* ${u?.label}: ${p[g]||""}`,f&&(i+=` (${n(f)})`),!W(e.gameMode)&&!f){const b=we(u,h)?u[h]:n(h);i+=` (${b})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const d of e.customGroups)if(d.groupName&&d.intensity)try{const l=(await J(d.groupName,e.locale||"en",e.gameMode||"online"))?.label||d.groupName;i+=`* ${l}: Level ${d.intensity} (Custom)\r
`}catch(u){console.error(`Error loading custom group ${d.groupName}:`,u),i+=`* ${d.groupName}: Level ${d.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a,difficulty:c}=e;if(i+=`--- \r
`,i+=`* ${n("difficulty")}: ${n(c??"normal")} \r
`,a){const d=a[0],u=a[1]-a[0],l=100-a[1],g=[d>0?{percent:d,text:n("noCum")}:null,u>0?{percent:u,text:n("ruined")}:null,l>0?{percent:l,text:n("cum")}:null].filter(h=>h!==null);g.length===1&&g[0].percent===100?i+=`* ${n("finishSlider")} ${g[0].text.replace(":","")} \r
`:g.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,g.forEach(h=>{const p=h.percent===100?h.text.replace(":",""):`${h.text} ${h.percent}%`;i+=`  - ${p} \r
`}))}const m=Se(e,t,o);return m&&(i+=`* ${n("customTilesLabel")}: ${m} \r
`),i}function Ge(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Ee({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ge(t)),c=await ie({title:e,gameBoard:JSON.stringify(n),settings:a}),m=await Le(t,i,s,r);if(!(!c?.id||m===""))return Y({room:t?.room||"PUBLIC",user:o,text:m,type:"settings",gameBoardId:c.id,boardSize:n.length,gameMode:t.gameMode})}function Ue(e){const{t}=S;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${fe(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Ne(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===o)&&(t[o]=s)}),t}async function Ie(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function Me(e,t){const o=Ne(e);return Y({room:e.room,user:t,text:Ue(o),type:"room",settings:JSON.stringify(o)})}const M=50,B=100,R=50,_=1,V=10,O=1,P=10,D=["none","all","default","undefined","null"],Be=["solo","foreplay","sex","consumption"],Re=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>M&&n.push(`Group name must be ${M} characters or less`),D.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},_e=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(de("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>B&&t.push(`Group label must be ${B} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},Ve=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<O&&t.push(`At least ${O} intensity level is required`),e.length>P&&t.push(`Maximum ${P} intensity levels allowed`);const s=new Set,n=new Set;for(let a=0;a<e.length;a++){const c=e[a];if((!c.id||c.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!c.label||c.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const m=c.label.trim();m.length>R&&t.push(`Intensity level ${a+1} label must be ${R} characters or less`),n.has(m.toLowerCase())?t.push(`Intensity label "${m}" is used multiple times`):n.add(m.toLowerCase())}typeof c.value!="number"||!Number.isInteger(c.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((c.value<_||c.value>V)&&t.push(`Intensity level ${a+1} value must be between ${_} and ${V}`),s.has(c.value)?t.push(`Intensity value ${c.value} is used multiple times`):s.add(c.value))}const i=Array.from(s).sort((a,c)=>a-c);let r=i[0];for(const a of i){if(a!==r){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:o}},Ze=async(e,t)=>{const o=[],s=[],n=Re(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=_e(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const r=Ve(e.intensities);if(o.push(...r.errors),s.push(...r.warnings||[]),n.isValid&&e.name)try{await ae(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(a){s.push("Could not verify group name uniqueness"),ge.warn("Failed to check group name uniqueness:",!1,a instanceof Error?a.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},De=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await J(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Oe=()=>({MAX_GROUP_NAME_LENGTH:M,MAX_GROUP_LABEL_LENGTH:B,MAX_INTENSITY_LABEL_LENGTH:R,MIN_INTENSITY_VALUE:_,MAX_INTENSITY_VALUE:V,MIN_INTENSITIES_COUNT:O,MAX_INTENSITIES_COUNT:P,RESERVED_GROUP_NAMES:D,VALID_GROUP_TYPES:Be});function Pe(e){(!e.roomBackgroundURL||!pe(e.roomBackgroundURL))&&(e.roomBackground="app")}function ke(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.level>0&&(o[n]=i)});const s=Oe();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function Ke(){const{user:e,updateUser:t}=te(),{id:o}=z(),{t:s}=k(),n=Ae(),[i,r]=H(),a=N(()=>re(i?.gameMode)),c=N(X),m=he(),{messages:d}=ne(),u=v.useCallback(f=>{const g=o?.toUpperCase()!==f.room.toUpperCase(),h=!!(f.room&&!j(f.room)),p=h&&f.roomTileCount!==i?.roomTileCount;return{roomChanged:g,isPrivateRoom:h,privateBoardSizeChanged:p}},[o,i?.roomTileCount]),l=v.useCallback(async(f,g)=>{const{displayName:h}=f,p=await Ie(e,h,t);Pe(f);const{settingsBoardUpdated:b,gameMode:A,newBoard:C=[]}=await n(f),{roomChanged:L,isPrivateRoom:$,privateBoardSizeChanged:G}=u(f);if(!p)return;$&&(f.roomUpdated||!d.find(w=>w.type==="room"))&&await Me(f,p),c?.tiles!==C&&await F({title:s("settingsGenerated"),tiles:C,isActive:1,gameMode:A}),(b||L||G)&&!d.some(w=>w.type==="settings"&&w.uid===p.uid&&Date.now()-(w.timestamp?.toMillis()||0)<5e3)&&await Ee({formData:f,user:p,customTiles:a,actionsList:g,title:"Settings Generated Board",tiles:C});const K=ke(f);r({...K,boardUpdated:!1,roomUpdated:!1,gameMode:A}),m(f.room)},[e,t,n,u,d,c,s,a,r,m]);return v.useCallback((f,g)=>l(f,g),[l])}const y=new Map,q=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{y.clear()};function Qe(e){const{i18n:t,t:o}=k(),{currentLanguageMigrated:s,isHealthy:n,forceRecovery:i}=me(),[r,a]=v.useState({}),[c,m]=v.useState(!0),[d,u]=v.useState(!1);v.useEffect(()=>{const g=()=>{e&&Array.from(y.keys()).filter(p=>p.endsWith(`-${e}`)).forEach(p=>{y.delete(p)})};return t.on("languageChanged",g),()=>{t.off("languageChanged",g)}},[t,e]);const l=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{s&&l&&y.get(l)&&y.delete(l)},[s,l]),v.useEffect(()=>{if(l){const g=y.get(l);g&&Date.now()-g.timestamp<q&&(a(g.data),m(!1))}},[l]);const f=v.useCallback(async()=>{if(!e||!l){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:l});return}if(!s)return;if(s&&!n&&!d){u(!0);try{await i();return}catch{}}const g=y.get(l);if(g&&Date.now()-g.timestamp<q){a(g.data),m(!1);return}m(!0);try{const h=await le(t.resolvedLanguage,e),p={};for(const b of h){const A={[o("none")]:[]},C={};b.intensities&&Array.isArray(b.intensities)&&b.intensities.sort(($,G)=>$.value-G.value).forEach($=>{A[$.label]=[],C[$.value]=$.label});const L=b.type||"action";p[b.name]={label:b.label||b.name,type:L,actions:A,intensities:C}}y.set(l,{data:p,timestamp:Date.now()}),a(p)}catch(h){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:h,locale:t.resolvedLanguage,gameMode:e,cacheKey:l}),a({})}finally{m(!1)}},[e,t.resolvedLanguage,l,o,s,n,d,i]);return v.useEffect(()=>{l&&s&&f()},[f,l,s,n]),{actionsList:r,isLoading:c}}export{Ke as a,Qe as b,he as c,ze as d,_e as e,De as f,Oe as g,Me as h,Ee as s,Ae as u,Ze as v};
