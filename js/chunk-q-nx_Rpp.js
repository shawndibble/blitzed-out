var te=Object.defineProperty;var ne=(e,t,o)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var G=(e,t,o)=>ne(e,typeof t!="symbol"?t+"":t,o);import{s as W,j as F,t as se,v as oe,w as ie,x as ae,u as H,e as Y,f as X,c as re,y as le,U as ce}from"./chunk-DvmTZbFC.js";import{a as ue,i as de}from"./chunk-CoxDZOLR.js";import{aa as E,au as ge,ak as O,r as v,ad as J,ai as fe}from"./chunk-CJVoFoqV.js";import{l as pe}from"./chunk-D9NIOe8w.js";import{d as z,i as Z,u as me,b as he}from"./chunk-arCWr7CA.js";import{u as I}from"./chunk-CsdNKD0V.js";import{u as be}from"./chunk-B2GYjlo-.js";import{u as ve}from"./chunk-LolS9Tp_.js";(function(){var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};e.SENTRY_RELEASE={id:"8380c411008c81db0d03192c8a87321e8e40e84f"}})();try{(function(){var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="9a92e5b0-b581-4535-a1b2-40a52250cb2c",e._sentryDebugIdIdentifier="sentry-dbid-9a92e5b0-b581-4535-a1b2-40a52250cb2c")})()}catch{}function N(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Qe(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}function ye(e){const{t}=E;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${ue(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Te(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground","roomBackgroundURL"].includes(o)&&(t[o]=s)}),e.roomBackgroundURL&&e.roomBackgroundURL.trim()!==""&&(t.roomBackgroundURL=e.roomBackgroundURL),t}async function Ce(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function $e(e,t){const o=Te(e);return W({room:e.room,user:t,text:ye(o),type:"room",settings:JSON.stringify(o)})}const R=50,M=100,_=50,P=1,k=10,V=1,x=10,D=["none","all","default","undefined","null"],we=["solo","foreplay","sex","consumption"],Le=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>R&&n.push(`Group name must be ${R} characters or less`),D.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Se=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(ge("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>M&&t.push(`Group label must be ${M} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},Ae=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<V&&t.push(`At least ${V} intensity level is required`),e.length>x&&t.push(`Maximum ${x} intensity levels allowed`);const s=new Set,n=new Set;for(let a=0;a<e.length;a++){const u=e[a];if((!u.id||u.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!u.label||u.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const c=u.label.trim();c.length>_&&t.push(`Intensity level ${a+1} label must be ${_} characters or less`),n.has(c.toLowerCase())?t.push(`Intensity label "${c}" is used multiple times`):n.add(c.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((u.value<P||u.value>k)&&t.push(`Intensity level ${a+1} value must be between ${P} and ${k}`),s.has(u.value)?t.push(`Intensity value ${u.value} is used multiple times`):s.add(u.value))}const i=Array.from(s).sort((a,u)=>a-u);let r=i[0];for(const a of i){if(a!==r){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:o}},et=async(e,t)=>{const o=[],s=[],n=Le(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=Se(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const r=Ae(e.intensities);if(o.push(...r.errors),s.push(...r.warnings||[]),n.isValid&&e.name)try{await se(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(a){s.push("Could not verify group name uniqueness"),pe.warn("Failed to check group name uniqueness:",!1,a instanceof Error?a.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},tt=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await F(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Ee=()=>({MAX_GROUP_NAME_LENGTH:R,MAX_GROUP_LABEL_LENGTH:M,MAX_INTENSITY_LABEL_LENGTH:_,MIN_INTENSITY_VALUE:P,MAX_INTENSITY_VALUE:k,MIN_INTENSITIES_COUNT:V,MAX_INTENSITIES_COUNT:x,RESERVED_GROUP_NAMES:D,VALID_GROUP_TYPES:we});function Ue(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ge(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([r])=>s[r]).reduce((r,[a,u])=>{const c=s[a].levels||[],d=Object.keys(u.actions);return r[a]=c.map(g=>d[g]).filter(Boolean),r},{});return(t?.filter(r=>{if(!r.isCustom)return!1;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Be(e,t,o,s){const{t:n}=E;let i=`### ${E.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(o).forEach(([c,d])=>{if(!r[c])return;const{role:g,variation:f,levels:p}=r[c],l=g||e.role||"sub";if(p&&p.length>0){i+=d?.label;let b=null;f?b=n(f):z(e.gameMode)||(b=Ue(d,l)?d[l]:n(l)),b&&(i+=`: ${b}`),i+=`\r
`;const h=d?.intensities||{};p.forEach(m=>{const y=h[m]||`Level ${m}`;i+=`* ${y}\r
`}),i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const g=(await F(c.groupName,e.locale||"en",e.gameMode||"online"))?.label||c.groupName;i+=`* ${g}: Level ${c.intensity} (Custom)\r
`}catch(d){console.error(`Error loading custom group ${c.groupName}:`,d),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a}=e;if(i+=`--- \r
`,a){const c=a[0],d=a[1]-a[0],g=100-a[1],p=[c>0?{percent:c,text:n("noCum")}:null,d>0?{percent:d,text:n("ruined")}:null,g>0?{percent:g,text:n("cum")}:null].filter(l=>l!==null);p.length===1&&p[0].percent===100?i+=`* ${n("finishSlider")} ${p[0].text.replace(":","")} \r
`:p.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,p.forEach(l=>{const b=l.percent===100?l.text.replace(":",""):`${l.text} ${l.percent}%`;i+=`  - ${b} \r
`}))}const u=Ge(e,t,o);return u&&(i+=`* ${n("customTilesLabel")}: ${u} \r
`),i}function Ie(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Ne({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ie(t)),u=await oe({title:e,gameBoard:JSON.stringify(n),settings:a}),c=await Be(t,i,s,r);if(!(!u?.id||c===""))return W({room:t?.room||"PUBLIC",user:o,text:c,type:"settings",gameBoardId:u.id,boardSize:n.length,gameMode:t.gameMode})}const{t:L}=E;class Re{constructor(t){G(this,"bags",new Map);G(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];N(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],N(n),this.bags.set(s,n)}return n.pop()||null}}function Me(e,t,o=[]){return e.filter(s=>{const n=s.action,i=o.find(r=>r.name===s.group);return i?.type==="consumption"||i?.type==="solo"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const q=new Map;function _e(e,t,o){const s=`${e}-${t}-${o}`,n=q.get(s);if(n!==void 0)return n;const i=e/t,r=Math.floor(o/i)+1;return q.set(s,r),r}function K(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=o[r.name];if(!a||!a.levels||a.levels.length===0)return{title:"",description:""};if(a.variation){const p=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>p)return{title:"",description:""}}const u=Math.max(...r.intensities.map(p=>p.value)),c=_e(n,u,s),d=a.levels;let g;d.includes(c)?g=c:g=d.reduce((p,l)=>Math.abs(l-c)<Math.abs(p-c)?l:p);let f=t.getTile(r.name,g);if(!f){const p=d.filter(l=>l!==g);for(const l of p)if(f=t.getTile(r.name,l),f)break;if(!f)return{title:"",description:""}}return{title:r.label,description:f.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function Pe(e,t,o,s,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=K(t,o,s,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function ke(e,t,o,s){const n=o.selectedActions||{},i=new Re(t),r=e.filter(d=>{const g=n[d.name];return g&&g.levels&&g.levels.length>0&&(!g.variation||g.variation==="standalone")}),a=e.filter(d=>{const g=n[d.name];return g&&g.levels&&g.levels.length>0&&(g.variation==="appendSome"||g.variation==="appendMost")});N(r);let u=0;const c=[];for(let d=1;d<=s;d++){const g=r.length>0?[r[u%r.length]]:[];u++;const f=K(g,i,n,d,s,o),p=Pe(f,a,i,n,d,s,o);c.push({title:f.title,description:p.trim(),role:f.role})}return c}function B(e,t){const o={title:L("start"),description:L("start")},{finishRange:s=[33,66]}=t,n=`${L("noCum")} ${s[0]}%\r
${L("ruined")} ${s[1]-s[0]}%\r
${L("cum")} ${100-s[1]}%`,i={title:L("finish"),description:n};return[o,...e.map(r=>({title:r.title,description:r.description})),i]}async function Ve(e,t,o,s=40){try{const[n,i]=await Promise.all([ie({locale:t,gameMode:o}),ae({locale:t,gameMode:o})]),r=e.selectedActions||{},a=Object.keys(r).filter(m=>r[m]?.levels&&r[m].levels.length>0),u=n.filter(m=>a.includes(m.name)),c=n.map(m=>m.name),d=a.filter(m=>!c.includes(m)),g=e.role||"sub",p=Me(i,g,n).filter(m=>a.includes(m.group));if(!u.length||!p.length)return{board:B([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:d,availableTileCount:p.length}};const l=await ke(u,p,e,s),b=l.filter(m=>m.description.trim().length>0).length,h=B(l,e);return{board:h,metadata:{totalTiles:h.length,tilesWithContent:b+2,selectedGroups:a,missingGroups:d,availableTileCount:p.length}}}catch(n){return console.error("Error building game board:",n),{board:B([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function xe(){const e=I(X),[t,o]=H(),{i18n:s}=O(),n=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:u}=r;const{roomTileCount:c=40,finishRange:d,room:g}=r,f=Z(g||"");if(!i||!d)return{gameMode:a};f&&!z(a||"")&&(a="online",u=!0);const p=a||"online",l=s.resolvedLanguage||"en",b=f?40:c||40,h=await Ve(r,l,p,b);return h.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",h.metadata.missingGroups),h.metadata.tilesWithContent<b/2&&console.warn("Low tile content ratio:",{tilesWithContent:h.metadata.tilesWithContent,totalTiles:h.metadata.totalTiles,availableTileCount:h.metadata.availableTileCount}),(i?.boardUpdated||u||(e?.tiles?.length??0)!==h.board.length)&&(await o(r),await Y({title:e?.title||"",tiles:h.board})),{settingsBoardUpdated:u,gameMode:a,newBoard:h.board,metadata:h.metadata}},[e,s.resolvedLanguage,t,o]);return v.useCallback(i=>n(i),[n])}function Oe(){const{id:e}=J(),t=fe();return o=>{const s=e!==void 0&&e?.toUpperCase()!==o?.toUpperCase(),n=o?.replace(/^\/+/,"")||"PUBLIC";s&&t(`/${n}`)}}function qe(e){const t=e.roomBackgroundURL?.trim();t!==e.roomBackgroundURL&&(e.roomBackgroundURL=t||""),e.roomBackgroundURL&&!de(e.roomBackgroundURL)&&(e.roomBackgroundURL="")}function je(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.levels&&i.levels.length>0&&(o[n]=i)});const s=Ee();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function nt(){const{user:e,updateUser:t}=me(),{id:o}=J(),{t:s}=O(),n=xe(),[i,r]=H(),a=I(()=>re(i?.gameMode)),u=I(X),c=Oe(),{messages:d}=he(),{createLocalSession:g}=be(),f=v.useCallback(l=>{const b=(o||"")?.toUpperCase(),h=(l.room||"").toUpperCase(),m=b!==h,y=!!(l.room&&!Z(l.room)),C=y&&l.roomTileCount!==i?.roomTileCount;return{roomChanged:m,isPrivateRoom:y,privateBoardSizeChanged:C}},[o,i?.roomTileCount]),p=v.useCallback(async(l,b)=>{const{displayName:h}=l,m=await Ce(e,h,t);qe(l);const{settingsBoardUpdated:y,gameMode:C,newBoard:S=[]}=await n(l),{roomChanged:$,isPrivateRoom:U,privateBoardSizeChanged:Q}=f(l);if(!m)return;U&&(l.roomUpdated||!d.find(w=>w.type==="room"))&&await $e(l,m),u?.tiles!==S&&await Y({title:s("settingsGenerated"),tiles:S,isActive:1,gameMode:C}),(y||$||Q)&&!d.some(w=>w.type==="settings"&&w.uid===m.uid&&Date.now()-(w.timestamp?.toMillis()||0)<5e3)&&await Ne({formData:l,user:m,customTiles:a,actionsList:b,title:"Settings Generated Board",tiles:S});const A=l;if(A.hasLocalPlayers&&A.localPlayersData&&A.localPlayerSessionSettings)try{await g(l.room,A.localPlayersData,A.localPlayerSessionSettings)}catch(w){console.error("Error creating local session:",w)}const ee=je(l);r({...ee,boardUpdated:!1,roomUpdated:!1,gameMode:C}),c(l.room)},[e,t,n,f,d,u,s,a,r,c,g]);return v.useCallback((l,b)=>p(l,b),[p])}const T=new Map,j=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{T.clear()};function st(e){const{i18n:t,t:o}=O(),{currentLanguageMigrated:s,isHealthy:n,forceRecovery:i}=ve(),[r,a]=v.useState({}),[u,c]=v.useState(!0),[d,g]=v.useState(!1);v.useEffect(()=>{const l=()=>{e&&Array.from(T.keys()).filter(h=>h.endsWith(`-${e}`)).forEach(h=>{T.delete(h)})};return t.on("languageChanged",l),()=>{t.off("languageChanged",l)}},[t,e]);const f=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{s&&f&&T.get(f)&&T.delete(f)},[s,f]),v.useEffect(()=>{if(f){const l=T.get(f);l&&Date.now()-l.timestamp<j&&(a(l.data),c(!1))}},[f]);const p=v.useCallback(async()=>{if(!e||!f){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:f});return}if(!s)return;if(s&&!n&&!d){g(!0);try{await i();return}catch{}}const l=T.get(f);if(l&&Date.now()-l.timestamp<j){a(l.data),c(!1);return}c(!0);try{const b=await le(t.resolvedLanguage,e),h={};for(const m of b){const y={[o("none")]:[]},C={};m.intensities&&Array.isArray(m.intensities)&&m.intensities.sort(($,U)=>$.value-U.value).forEach($=>{y[$.label]=[],C[$.value]=$.label});const S=m.type||"action";h[m.name]={label:m.label||m.name,type:S,actions:y,intensities:C}}T.set(f,{data:h,timestamp:Date.now()}),a(h)}catch(b){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:b,locale:t.resolvedLanguage,gameMode:e,cacheKey:f}),a({})}finally{c(!1)}},[e,t.resolvedLanguage,f,o,s,n,d,i]);return v.useEffect(()=>{f&&s&&p()},[p,f,s,n]),{actionsList:r,isLoading:u}}export{nt as a,st as b,Qe as c,Se as d,tt as e,$e as f,Ee as g,Ne as s,xe as u,et as v};
//# sourceMappingURL=chunk-q-nx_Rpp.js.map
