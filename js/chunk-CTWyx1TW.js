const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/getUniqueImportRecords.ts-bGIHIpig.js","js/chunk-BoIRgPCP.js","js/chunk-BHSFqGHu.js","js/chunk-DXd3GHw1.js","js/chunk-Bne9IgZ_.js","js/chunk-QRE8Uiui.js","js/chunk-DweKt3Ls.js","assets/index-DaclXwpO.js","js/chunk-Bde8qXua.js","js/chunk-D5QWNTV5.js","js/chunk-JK3oC_qz.js","js/chunk-Bp62TkGl.js","js/chunk-ChOHfsSx.js","js/chunk-CegpPsew.js"])))=>i.map(i=>d[i]);
import{j as e,T as b,B as _,al as B,am as H,an as X,o as F,i as se,a8 as Ke,e as Z,C as _e,ak as ye,p as be,q as je,O as at,Q as Me,s as ve,aA as ot,aB as lt,ap as ct,aC as ut,E as ie,aD as We,H as Te,D as qe,aE as dt,w as Fe,aF as pt,g as mt,aG as gt,S as ht,aH as ft,F as xt,aI as yt,af as bt,G as ge}from"./chunk-BoIRgPCP.js";import{r as d,a as jt}from"./chunk-BHSFqGHu.js";import{C as vt,u as Tt}from"./chunk-Bne9IgZ_.js";import{E as de,F as ze,i as ae,D as oe,G as Gt,z as Ge,B as pe,I as Be,J as He,K as $e,_ as Xe,L as Ye,N as Je,O as Ct,P as It,Q as wt,R as St,T as Et,V as Oe,W as Lt,X as At,Y as Dt,l as Nt,Z as _t}from"../assets/index-DaclXwpO.js";import{u as Pe}from"./chunk-D5QWNTV5.js";import{T as $t}from"./chunk-QRE8Uiui.js";import{A as le,a as ce,b as ue}from"./chunk-JK3oC_qz.js";import{d as kt}from"./chunk-Bp62TkGl.js";import{a as ke,u as Mt}from"./chunk-ChOHfsSx.js";import{u as ee,T as N}from"./chunk-DweKt3Ls.js";import{n as he}from"./chunk-DXd3GHw1.js";import{u as Ft}from"./chunk-CegpPsew.js";const Ot=n=>{const o={};for(const r of n){const c={label:r.label||r.name,type:r.type||"action",actions:{None:[]}};if(r.intensities&&Array.isArray(r.intensities))for(const i of r.intensities)c.actions[i.label]=[];o[r.name]=c}return o},fe=async(n="en",o="online")=>{try{const r=await de(n,o);return Ot(r)}catch(r){return console.error("Error importing actions from Dexie:",r),{}}};function Qe(n){return[...Object.entries(n).flatMap(([r,{label:c,actions:i}])=>i?Object.keys(i).filter(a=>a!==ze).map((a,t)=>({group:kt(r),groupLabel:c,value:r,intensity:Number(t+1),translatedIntensity:a,label:`${c} - ${a}`})):[]),{group:ae.t("misc"),groupLabel:ae.t("misc"),value:"misc",intensity:1,translatedIntensity:ae.t("all"),label:`${ae.t("misc")} - ${ae.t("all")}`}]}const Ce=50,Ie=100,we=50,Se=1,Ee=10,Le=1,Ae=10,Ze=["none","all","default","undefined","null"],Pt=["solo","foreplay","sex","consumption"],Vt=(n,o="en",r="online",c)=>{const i=[],h=[];if(!n||n.trim().length===0)return i.push("Group name is required"),{isValid:!1,errors:i,warnings:h};const a=n.trim();return a.length>Ce&&i.push(`Group name must be ${Ce} characters or less`),Ze.includes(a.toLowerCase())&&i.push(`"${a}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(a)||i.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(a)||i.push("Group name must start with a letter"),{isValid:i.length===0,errors:i,warnings:h}},et=n=>{const o=[],r=[];return!n||n.trim().length===0?(o.push("Group label is required"),{isValid:!1,errors:o,warnings:r}):(n.trim().length>Ie&&o.push(`Group label must be ${Ie} characters or less`),{isValid:o.length===0,errors:o,warnings:r})},Rt=n=>{const o=[],r=[];if(!n||n.length===0)return o.push("At least one intensity level is required"),{isValid:!1,errors:o,warnings:r};n.length<Le&&o.push(`At least ${Le} intensity level is required`),n.length>Ae&&o.push(`Maximum ${Ae} intensity levels allowed`);const c=new Set,i=new Set;for(let t=0;t<n.length;t++){const l=n[t];if((!l.id||l.id.trim().length===0)&&o.push(`Intensity level ${t+1} is missing an ID`),!l.label||l.label.trim().length===0)o.push(`Intensity level ${t+1} is missing a label`);else{const m=l.label.trim();m.length>we&&o.push(`Intensity level ${t+1} label must be ${we} characters or less`),i.has(m.toLowerCase())?o.push(`Intensity label "${m}" is used multiple times`):i.add(m.toLowerCase())}typeof l.value!="number"||!Number.isInteger(l.value)?o.push(`Intensity level ${t+1} must have a valid integer value`):((l.value<Se||l.value>Ee)&&o.push(`Intensity level ${t+1} value must be between ${Se} and ${Ee}`),c.has(l.value)?o.push(`Intensity value ${l.value} is used multiple times`):c.add(l.value))}const h=Array.from(c).sort((t,l)=>t-l);let a=h[0];for(const t of h){if(t!==a){r.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}a++}return{isValid:o.length===0,errors:o,warnings:r}},tt=async(n,o)=>{const r=[],c=[],i=Vt(n.name,n.locale||"en",n.gameMode||"online");r.push(...i.errors),c.push(...i.warnings||[]);const h=et(n.label);r.push(...h.errors),c.push(...h.warnings||[]);const a=Rt(n.intensities);if(r.push(...a.errors),c.push(...a.warnings||[]),i.isValid&&n.name)try{await Gt(n.name,n.locale||"en",n.gameMode||"online",o)||r.push(`A group with the name "${n.name}" already exists for this locale and game mode`)}catch{c.push("Could not verify group name uniqueness")}return{isValid:r.length===0,errors:r,warnings:c}},Ve=async(n,o="en",r="online")=>{const c=[],i=[];if(!n.group||n.group.trim().length===0)return c.push("Tile must belong to a group"),{isValid:!1,errors:c,warnings:i};try{const h=await oe(n.group,o,r);if(!h)return c.push(`Group "${n.group}" does not exist for ${o}/${r}`),{isValid:!1,errors:c,warnings:i};const a=h.intensities.map(t=>t.value);a.includes(n.intensity)||c.push(`Intensity ${n.intensity} is not valid for group "${n.group}". Valid intensities: ${a.join(", ")}`),(!n.action||n.action.trim().length===0)&&c.push("Tile action is required")}catch(h){c.push(`Error validating tile: ${h}`)}return{isValid:c.length===0,errors:c,warnings:i}},Ut=()=>({MAX_GROUP_NAME_LENGTH:Ce,MAX_GROUP_LABEL_LENGTH:Ie,MAX_INTENSITY_LABEL_LENGTH:we,MIN_INTENSITY_VALUE:Se,MAX_INTENSITY_VALUE:Ee,MIN_INTENSITIES_COUNT:Le,MAX_INTENSITIES_COUNT:Ae,RESERVED_GROUP_NAMES:Ze,VALID_GROUP_TYPES:Pt}),De="2.0.0",Kt=2,st=0;async function Ne(n="en",o={}){try{let r;if(o.exportScope==="single"&&o.singleGroup){const s=await oe(o.singleGroup,n);r=s&&!s.isDefault?[s]:[]}else o.exportScope==="default"?r=[]:r=(await Ge({locale:n})).filter(p=>!p.isDefault);const c=await Ge({locale:n}),i=new Set(c.filter(s=>s.isDefault).map(s=>s.name)),a=(await pe({isCustom:1})).filter(s=>{const p=!s.locale||s.locale===n;return o.exportScope==="single"&&o.singleGroup?p&&s.group===o.singleGroup:o.exportScope==="default"?p&&i.has(s.group):p}),t={};for(const s of r){const p=s.intensities.sort((I,M)=>I.value-M.value).map(I=>I.label),G=s.intensities.find(I=>I.value===st),E=p.filter(I=>I!==G?.label),k=G?[G.label,...E]:p;t[s.name]={label:s.label,type:s.type||"sex",intensities:k}}const l={};for(const s of a)l[s.group]||(l[s.group]={}),l[s.group][s.intensity]||(l[s.group][s.intensity]=[]),s.tags&&s.tags.length>0?l[s.group][s.intensity].push({action:s.action,tags:s.tags}):l[s.group][s.intensity].push(s.action);const m={};Object.keys(t).sort().forEach(s=>{m[s]=t[s]});const f={};return Object.keys(l).sort().forEach(s=>{f[s]={},Object.keys(l[s]).sort((p,G)=>Number.parseInt(p,10)-Number.parseInt(G,10)).forEach(p=>{f[s][Number.parseInt(p,10)]=l[s][Number.parseInt(p,10)]})}),JSON.stringify({version:De,locale:n,groups:m,customTiles:f},(s,p)=>(Array.isArray(p)&&p.length>0&&typeof p[0]=="string",p),Kt)}catch(r){throw console.error("Error exporting clean data:",r),new Error(`Export failed: ${r}`)}}async function Wt(n,o={}){const r={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{let c;try{c=JSON.parse(n)}catch{return r.errors.push("Invalid JSON format"),r}if(!c.version||!c.groups||!c.customTiles)return r.errors.push("Invalid export format - missing version, groups, or customTiles"),r;c.version!==De&&r.warnings.push(`Format version mismatch: expected ${De}, got ${c.version}`);const i=o.locale||c.locale||"en",h=o.mergeStrategy||"skip";for(const[a,t]of Object.entries(c.groups))try{const l=await oe(a,i);let m=a;if(l)switch(h){case"skip":r.warnings.push(`Skipped existing group: ${a}`);continue;case"overwrite":r.warnings.push(`Will update existing group: ${a}`);break;case"rename":{let p=1;for(m=`${a}_imported`;await oe(m,i);)m=`${a}_imported_${p}`,p++;r.warnings.push(`Renamed group from ${a} to ${m}`);break}}const f=t.intensities.map((p,G)=>({id:`intensity-${G}`,label:p,value:G,isDefault:G===st})),u={name:m,label:t.label,intensities:f,type:t.type,locale:i,isDefault:!1},s=await tt(u);if(!s.isValid){r.errors.push(`Invalid group ${m}: ${s.errors.join(", ")}`);continue}l&&h==="overwrite"?await Be(l.id,u):await He(u),r.importedGroups++}catch(l){r.errors.push(`Error importing group ${a}: ${l}`)}for(const[a,t]of Object.entries(c.customTiles))try{const l=await oe(a,i);if(!l){r.warnings.push(`Group ${a} not found for custom tiles, skipping tiles`);continue}for(const[m,f]of Object.entries(t)){const u=Number.parseInt(m,10);if(!l.intensities.find(p=>p.value===u)){r.warnings.push(`Intensity ${u} not valid for group ${a}, skipping tiles`);continue}for(const p of f)try{let G,E=[];if(typeof p=="string")G=p;else if(p&&typeof p=="object"&&"action"in p)G=p.action,E=p.tags||[];else{r.warnings.push(`Invalid tile data format in group ${a}, skipping`);continue}if((await pe()).find(M=>M.group===a&&M.intensity===u&&M.action===G&&(!M.locale||M.locale===i))&&h==="skip"){r.warnings.push(`Skipped existing tile: ${G.substring(0,50)}...`);continue}await $e({group:a,intensity:u,action:G,tags:E,isCustom:1,locale:i}),r.importedTiles++}catch(G){r.errors.push(`Error importing tile "${typeof p=="string"?p.substring(0,30):"object"}...": ${G}`)}}}catch(l){r.errors.push(`Error importing tiles for group ${a}: ${l}`)}return r.success=r.errors.length===0,r}catch(c){return r.errors.push(`Import failed: ${c}`),r}}async function qt(n,o,r="en",c="online"){const i={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{const{default:h}=await Xe(async()=>{const{default:m}=await import("./getUniqueImportRecords.ts-bGIHIpig.js");return{default:m}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])),a=await pe(),{newUniqueRecords:t,changedTagRecords:l}=h(n,a,o);for(const m of t)try{await $e(m),i.importedTiles++}catch(f){i.errors.push(`Error importing tile: ${f}`)}for(const m of l)try{m.id&&await Ye(m.id,m)}catch(f){i.errors.push(`Error updating tile: ${f}`)}return i.success=i.errors.length===0,i.warnings.push("Imported using legacy format. Consider exporting in clean v2.0 format for better compatibility."),i}catch(h){return i.errors.push(`Legacy import failed: ${h}`),i}}async function zt(n,o="en"){return Ne(o,{singleGroup:n,exportScope:"single"})}async function Bt(n,o,r={}){const c=n.trim();try{const i=JSON.parse(c);if(i.version&&i.groups)return Wt(c,r);if(i.version&&i.customGroups!==void 0)return{success:!1,importedGroups:0,importedTiles:0,errors:["Old enhanced format no longer supported. Please use clean v2.0 format."],warnings:[]}}catch{}return qt(c,o,r.locale||"en",r.gameMode||"online")}async function Ht(n="en"){try{const r=(await Ge({locale:n})).filter(i=>!i.isDefault),c=await pe({isCustom:1});return r.map(i=>{const h=c.filter(a=>a.group===i.name&&(!a.locale||a.locale===n));return{name:i.name,label:i.label,tileCount:h.length}})}catch(o){return console.error("Error getting available groups for export:",o),[]}}function Xt({expanded:n,handleChange:o,customTiles:r,mappedGroups:c,setSubmitMessage:i,bulkImport:h}){const a=d.useRef(null),{t}=ee(),{settings:l}=ke(),[m,f]=d.useState(""),[u,s]=d.useState(null),[p,G]=d.useState("clean"),[E,k]=d.useState("all"),[I,M]=d.useState(""),[L,O]=d.useState([]),[g,D]=d.useState("skip"),A=d.useCallback(async()=>{try{if(p==="clean"){let y;switch(E){case"single":if(!I){i({message:t("errors.selectGroupToExport"),type:"error"});return}y=await zt(I,l.locale||"en");break;case"default":y=await Ne(l.locale||"en",{exportScope:"default"});break;default:y=await Ne(l.locale||"en",{exportScope:"all"});break}f(y)}else{const x=r.filter(j=>j.isCustom).map(({group:j,intensity:w,action:W,tags:R,gameMode:U="online"})=>{const T=Qe(c[U]||{}).find(V=>V?.intensity===Number(w)&&V?.value===j);let S="";return S+=`[${T?.group||j} - ${T?.translatedIntensity||w}]
`,S+=W,S+=R?.length?`
Tags: `+R?.join(", "):"",S+=`
GameMode: ${U}`,S});f(x.join(`
---
`))}}catch(y){console.error("Error exporting data:",y),i({message:t("errors.exportFailed",{error:y}),type:"error"})}},[r,c,f,p,E,I,l.locale,i,t]);async function K(y){if(!y.current)return;const j=y.current.importData.value;if(!j.trim())return i({type:"error",message:t("Please enter data to import")});try{i({type:"info",message:t("messages.importing")});const w=await Bt(j,c,{locale:l.locale||"en",mergeStrategy:g});if(s(w),w.success){w.importedTiles>0&&(await Xe(()=>import("../assets/index-DaclXwpO.js").then(U=>U.a6),__vite__mapDeps([7,1,2,3,8])).then(U=>U.getTiles({isCustom:1}))).slice(-w.importedTiles).forEach(async U=>{Je(`${U.group} - ${U.intensity}`,U.action)});let W=t("messages.importSuccess");w.importedGroups>0&&(W+=` ${t("messages.importedGroups",{count:w.importedGroups})}`),w.importedTiles>0&&(W+=` ${t("messages.importedTiles",{count:w.importedTiles})}`),i({type:"success",message:W}),await A()}else i({type:"error",message:t("errors.importFailed",{errors:w.errors.join(", ")})})}catch(w){console.error("Import error:",w),i({type:"error",message:t("errors.importFailed",{errors:w.message||w})}),s(null)}}const $=d.useCallback(async()=>{try{const y=await Ht(l.locale||"en");O(y)}catch(y){console.error("Error loading available groups:",y)}},[l.locale]);return d.useEffect(()=>{n==="ctImport"&&($(),A())},[n,r,A,$]),e.jsxs(le,{expanded:n==="ctImport",onChange:o("ctImport"),children:[e.jsx(ce,{"aria-controls":"ctImport-content",id:"ctImport-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"importExport"})})}),e.jsxs(ue,{children:[e.jsx(b,{variant:"body1",sx:{mb:2},children:e.jsx(N,{i18nKey:"ctImportDescription"})}),e.jsxs(_,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:2,"& .MuiFormControl-root":{minWidth:150,flex:"1 1 auto"}},children:[e.jsxs(B,{size:"small",children:[e.jsx(H,{children:t("labels.exportFormat")}),e.jsxs(X,{value:p,onChange:y=>G(y.target.value),label:t("labels.exportFormat"),children:[e.jsx(F,{value:"clean",children:t("exportFormat.clean")}),e.jsx(F,{value:"legacy",children:t("exportFormat.legacy")})]})]}),p==="clean"&&e.jsxs(B,{size:"small",children:[e.jsx(H,{children:t("labels.exportScope")}),e.jsxs(X,{value:E,onChange:y=>{k(y.target.value),M("")},label:t("labels.exportScope"),children:[e.jsx(F,{value:"all",children:t("exportScope.all")}),e.jsx(F,{value:"default",children:t("exportScope.default")}),e.jsx(F,{value:"single",children:t("exportScope.single")})]})]}),e.jsxs(B,{size:"small",children:[e.jsx(H,{children:t("labels.importStrategy")}),e.jsxs(X,{value:g,onChange:y=>D(y.target.value),label:t("labels.importStrategy"),children:[e.jsx(F,{value:"skip",children:t("importStrategy.skip")}),e.jsx(F,{value:"overwrite",children:t("importStrategy.overwrite")}),e.jsx(F,{value:"rename",children:t("importStrategy.rename")})]})]})]}),p==="clean"&&E==="single"&&e.jsx(_,{sx:{mb:2},children:e.jsxs(B,{size:"small",fullWidth:!0,children:[e.jsx(H,{children:t("labels.selectGroup")}),e.jsx(X,{value:I,onChange:y=>M(y.target.value),label:t("labels.selectGroup"),children:L.map(y=>e.jsxs(F,{value:y.name,children:[y.label," (",y.tileCount," tiles)"]},y.name))})]})}),e.jsxs(_,{component:"form",method:"post",ref:a,children:[e.jsx(se,{id:"importData",name:"importData",multiline:!0,required:!0,fullWidth:!0,rows:6,sx:{pb:2},value:m,onChange:y=>f(y.target.value),placeholder:t(p==="clean"?"placeholder.cleanFormat":"placeholder.legacyFormat"),InputProps:{endAdornment:e.jsx(vt,{text:m}),sx:{alignItems:"flex-start"}}}),u&&e.jsxs(Ke,{severity:u.success?"success":"error",sx:{mb:2},onClose:()=>s(null),children:[e.jsx(b,{variant:"body2",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.title"})})}),u.importedGroups>0&&e.jsxs(b,{variant:"body2",children:["•"," ",e.jsx(N,{i18nKey:"importResults.groupsImported",values:{count:u.importedGroups}})]}),u.importedTiles>0&&e.jsxs(b,{variant:"body2",children:["•"," ",e.jsx(N,{i18nKey:"importResults.tilesImported",values:{count:u.importedTiles}})]}),u.warnings.length>0&&e.jsxs(_,{sx:{mt:1},children:[e.jsx(b,{variant:"body2",color:"warning.main",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.warnings"})})}),u.warnings.map((y,x)=>e.jsxs(b,{variant:"body2",color:"warning.main",children:["• ",y]},x))]}),u.errors.length>0&&e.jsxs(_,{sx:{mt:1},children:[e.jsx(b,{variant:"body2",color:"error.main",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.errors"})})}),u.errors.map((y,x)=>e.jsxs(b,{variant:"body2",color:"error.main",children:["• ",y]},x))]})]}),e.jsx(Z,{fullWidth:!0,variant:"contained",type:"button",onClick:()=>K(a),children:e.jsx(N,{i18nKey:"import"})})]}),p==="clean"&&e.jsxs(le,{sx:{mt:2},children:[e.jsx(ce,{children:e.jsx(b,{variant:"subtitle2",children:e.jsx(N,{i18nKey:"formatGuide.title"})})}),e.jsxs(ue,{children:[e.jsx(b,{variant:"body2",sx:{mb:2},children:e.jsx(N,{i18nKey:"formatGuide.description"})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.keySections"})}),e.jsx(b,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(N,{i18nKey:"formatGuide.keySectionsContent",components:{strong1:e.jsx("strong",{}),strong2:e.jsx("strong",{}),br:e.jsx("br",{})}})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.manualEditing"})}),e.jsx(b,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(N,{i18nKey:"formatGuide.manualEditingContent",components:{br:e.jsx("br",{})}})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.customTilesFormat"})}),e.jsx(b,{variant:"body2",component:"div",sx:{ml:2},children:e.jsx(N,{i18nKey:"formatGuide.customTilesFormatContent",components:{br:e.jsx("br",{}),code1:e.jsx("code",{}),code2:e.jsx("code",{})}})})]})]})]})]})}function Yt({value:n,onChange:o,locale:r,gameMode:c,includeDefault:i=!0,disabled:h=!1,refreshTrigger:a=0}){const{t}=ee(),[l,m]=d.useState([]),[f,u]=d.useState(!0);return d.useEffect(()=>{(async()=>{u(!0);try{const p=await de(r,c),G=i?p:p.filter(E=>!E.isDefault);m(G)}catch(p){console.error("Error loading custom groups:",p),m([])}finally{u(!1)}})()},[r,c,i,a]),f?e.jsxs(B,{fullWidth:!0,disabled:!0,children:[e.jsx(H,{children:t("customGroups.loadingGroups")}),e.jsx(X,{value:"",children:e.jsx(F,{value:"",children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_e,{size:16}),e.jsx("span",{children:t("customGroups.loadingGroups")})]})})})]}):e.jsx(_,{children:e.jsxs(B,{fullWidth:!0,disabled:h,children:[e.jsx(H,{children:t("Group")}),e.jsx(X,{value:n,onChange:s=>o(s.target.value),label:t("Group"),children:l.length===0?e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:t("customGroups.noGroupsAvailable",{locale:r,gameMode:c})})}):l.map(s=>e.jsx(F,{value:s.name,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{children:s.label}),s.isDefault&&e.jsx(ye,{label:t("default"),size:"small",variant:"outlined"})]})},s.id))})]})})}function Jt({groupName:n,value:o,onChange:r,locale:c,gameMode:i,disabled:h=!1}){const{t:a}=ee(),[t,l]=d.useState([]),[m,f]=d.useState(!1);d.useEffect(()=>{(async()=>{if(!n){l([]);return}f(!0);try{const p=await Ct(n,c,i);l(p)}catch(p){console.error("Error loading group intensities:",p),l([])}finally{f(!1)}})()},[n,c,i]);const u=d.useMemo(()=>t.sort((s,p)=>s.value-p.value),[t]);return d.useEffect(()=>{if(t.length>0&&o&&!t.some(s=>s.value===o)){const s=u[0];s&&r(s.value)}},[t,o,r,u]),n?m?e.jsxs(B,{fullWidth:!0,disabled:!0,children:[e.jsx(H,{children:a("customGroups.loadingIntensities")}),e.jsx(X,{value:"",children:e.jsx(F,{value:"",children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_e,{size:16}),e.jsx("span",{children:a("customGroups.loadingIntensities")})]})})})]}):t.length===0?e.jsxs(B,{fullWidth:!0,disabled:!0,children:[e.jsx(H,{children:a("intensity")}),e.jsx(X,{value:"",children:e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:a("customGroups.noIntensitiesAvailable",{groupName:n})})})})]}):e.jsx(_,{children:e.jsxs(B,{fullWidth:!0,disabled:h,children:[e.jsx(H,{children:a("intensity")}),e.jsx(X,{value:o||"",onChange:s=>r(Number(s.target.value)),label:a("intensity"),children:u.map(s=>e.jsx(F,{value:s.value,children:s.label},s.id))})]})}):e.jsxs(B,{fullWidth:!0,disabled:!0,children:[e.jsx(H,{children:a("intensity")}),e.jsx(X,{value:"",children:e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:a("customGroups.selectGroupFirst")})})})]})}const Re=[{name:"Basic (1-4)",intensities:[{label:"intensityLabels.light",value:1,isDefault:!0},{label:"intensityLabels.medium",value:2,isDefault:!0},{label:"intensityLabels.intense",value:3,isDefault:!0},{label:"intensityLabels.extreme",value:4,isDefault:!0}]},{name:"Simple (1-3)",intensities:[{label:"intensityLabels.beginner",value:1,isDefault:!0},{label:"intensityLabels.intermediate",value:2,isDefault:!0},{label:"intensityLabels.advanced",value:3,isDefault:!0}]},{name:"Extended (1-5)",intensities:[{label:"intensityLabels.veryLight",value:1,isDefault:!0},{label:"intensityLabels.light",value:2,isDefault:!0},{label:"intensityLabels.medium",value:3,isDefault:!0},{label:"intensityLabels.intense",value:4,isDefault:!0},{label:"intensityLabels.veryIntense",value:5,isDefault:!0}]}];function Qt({open:n,onClose:o,onGroupCreated:r,onGroupUpdated:c,editingGroup:i,locale:h,gameMode:a}){const{t}=ee(),[l,m]=d.useState(0),[f,u]=d.useState([]),[s,p]=d.useState(!0),[G,E]=d.useState({}),k=Ut(),[I,M]=d.useState(""),[L,O]=d.useState(""),[g,D]=d.useState([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),[A,K]=d.useState(null),[$,y]=d.useState(!1),[x,j]=d.useState({isValid:!0,errors:[]}),[w,W]=d.useState(!1),[R,U]=d.useState(null),Y=d.useCallback(async()=>{try{const C=(await de(h,a)).filter(z=>!z.isDefault);u(C);const P={};await Promise.all(C.map(async z=>{P[z.id]=await It(z.name,h,a)})),E(P)}catch(v){console.error("Error reloading groups:",v)}},[h,a]);d.useEffect(()=>{(async()=>{if(n){p(!0);try{await Y()}catch(C){console.error("Error loading groups:",C)}finally{p(!1)}}})()},[n,h,a,Y]);const T=v=>v.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,20)||`group_${he(6).toLowerCase()}`;d.useEffect(()=>{i?(K(i),M(i.label),O(i.type||""),D(i.intensities.map(v=>v.label))):A?(M(A.label),O(A.type||""),D(A.intensities.map(v=>v.label))):(K(null),M(""),O(""),D([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")])),j({isValid:!0,errors:[]})},[i,A,n,t]);const S=v=>{const C=Re[v];D(C.intensities.map(P=>t(P.label)))},V=(v,C)=>{const P=[...g];P[v]=C,D(P)},J=()=>{g.length>=k.MAX_INTENSITIES_COUNT||D([...g,t("customGroups.levelLabel",{level:g.length+1})])},ne=v=>{if(g.length<=k.MIN_INTENSITIES_COUNT)return;const C=g.filter((P,z)=>z!==v);D(C)};d.useEffect(()=>{(async()=>{if(!I.trim()&&!L&&g.length===0){j({isValid:!0,errors:[]});return}const C=[];if(L&&!k.VALID_GROUP_TYPES.includes(L)&&C.push(`Type must be one of: ${k.VALID_GROUP_TYPES.join(", ")}`),I.trim()&&!L&&C.push("Type is required when creating a group"),C.length>0){j({isValid:!1,errors:C});return}const P=g.map((rt,it)=>({id:he(),label:rt,value:it+1,isDefault:!1})),z={name:A?A.name:T(I),label:I.trim(),intensities:P,type:L||void 0,locale:h,gameMode:a,isDefault:!1},nt=await tt(z,A?.id);j(nt)})()},[I,L,g,h,a,A,t,k.VALID_GROUP_TYPES]);const Q=v=>{K(v),M(v.label),D(v.intensities.map(C=>C.label)),m(1)},te=async v=>{const C=f.find(z=>z.id===v);if(!C)return;const P=G[v]||0;U({id:v,name:C.label,tileCount:P}),W(!0)},q=async()=>{if(!R)return;const{id:v,tileCount:C}=R,P=f.find(z=>z.id===v);if(P)try{C>0&&await wt(P.name,h,a),await St(v),await Y(),c?.(null)}catch(z){console.error("Error deleting group:",z)}finally{W(!1),U(null)}},re=async()=>{if(!(!x.isValid||$)){y(!0);try{const v=g.map((P,z)=>({id:he(),label:P,value:z+1,isDefault:!1})),C={name:A?A.name:T(I),label:I.trim(),intensities:v,type:L||void 0,locale:h,gameMode:a,isDefault:!1};if(A)await Be(A.id,C),c?.(A);else{const P=await He(C);P&&r?.({...C,id:P,createdAt:new Date,updatedAt:new Date,isDefault:!1,locale:h,gameMode:a})}me(),o()}catch(v){console.error("Error saving custom group:",v),j({isValid:!1,errors:[`Failed to save group: ${v}`]})}finally{y(!1)}}},me=()=>{K(null),M(""),O(""),D([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),j({isValid:!0,errors:[]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{open:n,onClose:o,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"600px"}},children:[e.jsxs(je,{children:[t("Manage Custom Groups"),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mt:1},children:t("Create new groups or manage existing custom groups")}),e.jsxs(at,{value:l,onChange:(v,C)=>{m(C),C===1&&!A&&me()},sx:{mt:2,borderBottom:1,borderColor:"divider"},children:[e.jsx(Me,{label:t("Existing Groups")}),e.jsx(Me,{label:t(A?"Edit Group":"Create New")})]})]}),e.jsxs(ve,{dividers:!0,children:[l===0&&e.jsx(_,{children:s?e.jsx(b,{children:t("Loading groups...")}):f.length===0?e.jsx(b,{color:"text.secondary",sx:{textAlign:"center",py:4},children:t('No custom groups found. Create your first group using the "Create New" tab.')}):e.jsx(ot,{children:f.map((v,C)=>e.jsxs(jt.Fragment,{children:[e.jsxs(lt,{children:[e.jsx(ct,{primary:v.label,secondary:e.jsxs(_,{component:"span",sx:{display:"block"},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block"},children:[t("customGroups.intensityLevelsCount",{count:v.intensities.length}),": ",v.intensities.map(P=>P.label).join(", ")]}),e.jsx(b,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block",mt:.5},children:t("customGroups.customTilesCount",{count:G[v.id]||0})})]})}),e.jsxs(ut,{children:[e.jsx(ie,{edge:"end","aria-label":"edit",onClick:()=>Q(v),sx:{mr:1},children:e.jsx(We,{})}),e.jsx(ie,{edge:"end","aria-label":"delete",onClick:()=>te(v.id),color:"error",children:e.jsx(Te,{})})]})]}),C<f.length-1&&e.jsx(qe,{})]},v.id))})}),l===1&&e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:3},children:[!x.isValid&&e.jsx(Ke,{severity:"error",children:x.errors.map((v,C)=>e.jsx("div",{children:v},C))}),e.jsxs(_,{sx:{p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(b,{variant:"h6",sx:{mb:2},children:t("customGroups.groupInformation")}),e.jsx(se,{label:t("customGroups.groupLabel"),value:I,onChange:v=>M(v.target.value),placeholder:"e.g., My Custom Group",helperText:t("customGroups.groupLabelHelp",{maxLength:k.MAX_GROUP_LABEL_LENGTH}),fullWidth:!0,required:!0,error:I.trim().length>0&&!et(I).isValid,sx:{mb:2}}),e.jsxs(se,{select:!0,label:t("customGroups.groupType"),value:L,onChange:v=>O(v.target.value),helperText:t("customGroups.groupTypeHelp"),fullWidth:!0,required:!0,error:I.trim().length>0&&!L,sx:{mb:2},children:[e.jsx(F,{value:"",children:e.jsx("em",{children:t("groupTypes.selectType")})}),e.jsx(F,{value:"solo",children:t("groupTypes.solo")}),e.jsx(F,{value:"foreplay",children:t("groupTypes.foreplay")}),e.jsx(F,{value:"sex",children:t("groupTypes.sex")}),e.jsx(F,{value:"consumption",children:t("groupTypes.consumption")})]}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.locale")})," ",h," |"," ",e.jsx("strong",{children:t("customGroups.gameMode")})," ",a]}),A?e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",A.name," ","(locked)"]}):e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",I?T(I):t("customGroups.autoGenerated")]})]})]}),e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"action.hover",borderRadius:1},children:[e.jsx(b,{variant:"body2",sx:{fontWeight:"medium",minWidth:"auto"},children:t("customGroups.quickStart")}),e.jsx(se,{select:!0,value:0,onChange:v=>S(Number(v.target.value)),size:"small",sx:{minWidth:200},label:t("customGroups.chooseTemplate"),children:Re.map((v,C)=>e.jsx(F,{value:C,children:v.name},C))}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.75rem"},children:t("customGroups.selectTemplateDescription")})]}),e.jsxs(_,{children:[e.jsxs(b,{variant:"h6",sx:{mb:2},children:[t("customGroups.intensityLabels")," (",g.length,"/",k.MAX_INTENSITIES_COUNT,")"]}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("customGroups.customizeIntensityDescription")}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[g.map((v,C)=>e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(b,{variant:"body2",sx:{minWidth:"30px",fontWeight:"bold",color:"primary.main"},children:C+1}),e.jsx(se,{label:t("customGroups.levelInputLabel",{level:C+1}),value:v,onChange:P=>V(C,P.target.value),size:"small",sx:{flex:1},inputProps:{maxLength:k.MAX_INTENSITY_LABEL_LENGTH}}),e.jsx(ie,{onClick:()=>ne(C),disabled:g.length<=k.MIN_INTENSITIES_COUNT,color:"error",size:"small",children:e.jsx(Te,{})})]},C)),e.jsx(Z,{startIcon:e.jsx(dt,{}),onClick:J,disabled:g.length>=k.MAX_INTENSITIES_COUNT,variant:"outlined",size:"small",sx:{alignSelf:"flex-start",mt:1},children:t("customGroups.addIntensityLevel")})]})]})]})]}),e.jsxs(Fe,{children:[e.jsx(Z,{onClick:o,disabled:$,children:t("Cancel")}),e.jsx(Z,{onClick:re,variant:"contained",disabled:!x.isValid||$,children:t($?"customGroups.saving":A?"customGroups.updateGroup":"customGroups.createGroup")})]})]}),e.jsxs(be,{open:w,onClose:()=>W(!1),children:[e.jsx(je,{children:t("customGroups.confirmDelete")}),e.jsx(ve,{children:e.jsx(b,{children:(R?.tileCount??0)>0?t("customGroups.deleteGroupWithTiles",{name:R?.name,count:R?.tileCount}):t("customGroups.deleteGroupConfirm",{name:R?.name})})}),e.jsxs(Fe,{children:[e.jsx(Z,{onClick:()=>W(!1),children:t("Cancel")}),e.jsx(Z,{onClick:q,color:"error",variant:"contained",children:t("Delete")})]})]})]})}function Zt({setSubmitMessage:n,boardUpdated:o,customTiles:r,mappedGroups:c,expanded:i,handleChange:h,tagList:a,updateTileId:t,setUpdateTileId:l}){const{t:m}=ee(),{settings:f}=ke(),[u,s]=d.useState({gameMode:f.gameMode||"online",group:"",intensity:"",action:"",tags:[m("custom")]}),[p,G]=d.useState(!1),[E,k]=d.useState(""),[I,M]=d.useState(0);d.useEffect(()=>{const j=setTimeout(async()=>{if(!u.group||!u.intensity||!u.action){k("");return}try{const w=await Ve({group:u.group,intensity:Number(u.intensity),action:u.action,tags:u.tags,gameMode:u.gameMode,isCustom:1},f.locale||"en",u.gameMode);w.isValid?k(""):k(w.errors.join(", "))}catch(w){console.error("Error validating tile:",w),k("")}},300);return()=>clearTimeout(j)},[u.group,u.intensity,u.action,u.gameMode,u.tags,f.locale]),d.useEffect(()=>{const j=(Array.isArray(r)?r:[]).find(({id:w})=>w===t);if(j){const w=j.gameMode||f.gameMode;s({gameMode:w,group:j.group||"",intensity:j.intensity||"",action:j.action||"",tags:j.tags||[m("custom")]})}else s(w=>({...w,gameMode:f.gameMode}))},[t,f.gameMode,r,m]);function L(x,j,w){return(Array.isArray(r)?r:[]).find(R=>R.group===x&&R.intensity===j&&R.action===w)}function O(){l(null),s({gameMode:f.gameMode,group:"",intensity:"",action:"",tags:[m("custom")]}),k("")}const g=x=>{s(j=>({...j,group:x.name,intensity:""})),G(!1),M(j=>j+1)},D=()=>{M(x=>x+1)},A=d.useCallback(x=>{s(j=>({...j,intensity:x.toString()}))},[]);async function K(){const x=document.querySelector('input[name="tags"]'),j=[...u.tags];x&&x.value.trim()&&(j.push(x.value.trim()),x.value="");const{gameMode:w,group:W,intensity:R,action:U}=u;if(!w||!W||!R||!U)return n({message:m("allFieldsRequired","All fields are required"),type:"error"});if(E)return n({message:E,type:"error"});if(t==null&&L(W,R,U))return n({message:m("actionExists"),type:"error"});const Y={group:W,intensity:Number(R),action:U,tags:j,gameMode:w,isCustom:1};try{const T=await Ve(Y,f.locale||"en",w);if(!T.isValid)return n({message:T.errors.join(", "),type:"error"});if(t===null){const S=`${W} - Level ${R}`;Je(S,U),await $e(Y)}else await Ye(t,Y);return o(),s(S=>({...S,action:"",tags:[m("custom")]})),n({message:m(t?"customUpdated":"customAdded"),type:"success"})}catch(T){return console.error("Error saving custom tile:",T),n({message:m("Error saving tile"),type:"error"})}}const $=x=>{switch(x.key){case",":case"Enter":{x.preventDefault(),x.stopPropagation(),x.currentTarget.value.length>0&&(s(j=>({...j,tags:[...j.tags,x.currentTarget.value]})),x.currentTarget.value="");break}}},y=x=>{x.target.value.length>0&&(s(j=>({...j,tags:[...j.tags,x.target.value]})),x.target.value=""),setTimeout(()=>{const j=document.querySelector(".MuiAutocomplete-popper");j&&(j.style.display="none")},150)};return e.jsxs(e.Fragment,{children:[e.jsxs(le,{expanded:i==="ctAdd",onChange:h("ctAdd"),children:[e.jsx(ce,{"aria-controls":"ctAdd-content",id:"ctAdd-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:t?"ctUpdate":"ctAdd"})})}),e.jsx(ue,{children:e.jsxs(_,{component:"form",method:"post",className:"settings-box",children:[e.jsxs(se,{select:!0,label:m("Game Mode"),value:u.gameMode,onChange:x=>{s(j=>({...j,gameMode:x.target.value,group:"",intensity:""}))},fullWidth:!0,sx:{mb:2},children:[e.jsx("option",{value:"online",children:"Online"}),e.jsx("option",{value:"local",children:"Local"}),e.jsx("option",{value:"solo",children:"Solo"})]}),e.jsx(Yt,{value:u.group,onChange:x=>{s(j=>({...j,group:x,intensity:""}))},locale:f.locale||"en",gameMode:u.gameMode,refreshTrigger:I}),e.jsx(_,{sx:{mt:2},children:e.jsx(Jt,{groupName:u.group,value:Number(u.intensity)||0,onChange:A,locale:f.locale||"en",gameMode:u.gameMode})}),E&&e.jsx(_,{sx:{mt:1,mb:2},children:e.jsx(b,{color:"error",variant:"body2",children:E})}),e.jsx(se,{id:"action",name:"action",required:!0,fullWidth:!0,label:m("action"),sx:{mt:2,pb:2},value:u.action,onChange:x=>{s({...u,action:x.target.value})}}),e.jsx(pt,{id:"tags",disableCloseOnSelect:!0,multiple:!0,freeSolo:!0,options:a,value:u.tags,onChange:(x,j)=>{s({...u,tags:j})},renderInput:x=>(x.inputProps.onKeyDown=$,x.inputProps.onBlur=y,e.jsx(se,{...x,label:m("tags")})),sx:{pb:2},clearOnBlur:!0,blurOnSelect:!0,openOnFocus:!0,disablePortal:!1,componentsProps:{popper:{modifiers:[{name:"preventOverflow",options:{altAxis:!0,altBoundary:!0,padding:8}}]}}}),e.jsxs(_,{display:"flex",justifyContent:"space-evenly",gap:1,children:[e.jsx(Z,{variant:"outlined",type:"button",onClick:()=>G(!0),children:m("Manage Groups")}),e.jsx(Z,{variant:"contained",type:"button",onClick:()=>O(),children:e.jsx(N,{i18nKey:"clear"})}),e.jsx(Z,{variant:"contained",type:"button",onClick:K,children:e.jsx(N,{i18nKey:t?"ctUpdate":"ctAdd"})})]})]})})]}),e.jsx(Qt,{open:p,onClose:()=>G(!1),onGroupCreated:g,onGroupUpdated:D,locale:f.locale||"en",gameMode:u.gameMode})]})}function es({expanded:n,handleChange:o}){return e.jsxs(e.Fragment,{children:[e.jsxs(le,{expanded:n==="help1",onChange:o("help1"),children:[e.jsx(ce,{"aria-controls":"help1-content",id:"help1-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"ctExplained"})})}),e.jsx(ue,{children:e.jsxs(N,{i18nKey:"ctExplainedDescription",children:[e.jsx(b,{sx:{mb:2},children:"Custom tiles let you add your own variations to the game board. Utilize this dialog to add and remove tiles as you see fit."}),e.jsx(b,{sx:{mb:2},children:"Custom tiles are added based on the kink and intensity you pick from the drop down. As such, you need to have that kink and intensity (or a higher intensity) selected for your custom tiles to show on the board."}),e.jsx(b,{children:"Miscellaneous tiles are the only exception to the above. Regardless of what other options you pick, Miscellaneous tiles will show as their own group. If you use this option, ensure that you add multiple tiles to minimize repeats."})]})})]}),e.jsxs(le,{expanded:n==="help2",onChange:o("help2"),children:[e.jsx(ce,{"aria-controls":"help2-content",id:"help2-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"ctIdeas"})})}),e.jsx(ue,{children:e.jsxs(N,{i18nKey:"ctIdeasDescription",children:[e.jsx(b,{variant:"h6",children:"Add new Activities"}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Come up with new activities that are not part of the existing list"}),e.jsx(b,{variant:"h6",children:"Add harder tiles to easier intensities"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"When you pick higher intensity levels, the game will use the earlier intensity level and gradual move to whatyou picked. If you want harder tiles early on, add several to lower intensities."}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Example: You play Poppers - Advanced. Add advanced tiles to Poppers - Beginner"}),e.jsx(b,{variant:"h6",children:"Combine activities into a single tile"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"Combine multiple activites together in a single tile that normally would not go together."}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Example: Spit roast. Use a toy in your throat and ass at the same time."}),e.jsx(b,{variant:"h6",children:"Miscellaneous custom tiles"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"Miscellaneous tiles allow you to add your own tiles without including other groups. Be aware, you will want to add several options to this group to minimize repeats."})]})})]})]})}function ts({gameMode:n,groupFilter:o,intensityFilter:r,groups:c,mappedGroups:i,dexieGroups:h,onGameModeChange:a,onGroupChange:t,onIntensityChange:l,hideAll:m=!1,sx:f={}}){const{t:u}=ee(),[s,p]=d.useState([]),G=m?1:"all",E=d.useMemo(()=>{if(!i?.[n])return[];const g=Qe(i[n]);return Array.isArray(g)?g:[]},[i,n]),k=d.useCallback(g=>{if(h?.[g])return h[g].label||g;const D=E.find(A=>A.value===g);return D?.groupLabel?D.groupLabel:g},[h,E]),I=d.useCallback((g,D)=>{if(h?.[g]){const K=h[g].intensities.find($=>$.value===Number(D));if(K?.label)return K.label}const A=E.find(K=>K.value===g&&K.intensity===Number(D));return A?.translatedIntensity?A.translatedIntensity:`Level ${Number(D)+1}`},[h,E]);d.useEffect(()=>{if(c){const g=Object.keys(c);p(g)}},[c,n]);function M(g){const D=g.target.value;t(D),l(G)}if(!s?.length)return null;const L=s.length===0||s.includes(o)?o:"",O=r==="all"?"all":r;return e.jsxs(_,{sx:{display:"flex",flexWrap:"wrap",gap:2,...f},children:[e.jsxs(B,{sx:{width:125,flexShrink:0},children:[e.jsx(H,{id:"game-mode-filter-label",children:e.jsx(N,{i18nKey:"customTiles.gameMode"})}),e.jsxs(X,{labelId:"game-mode-filter-label",id:"game-mode-filter",value:n,label:u("customTiles.gameMode","Game Mode"),onChange:g=>{a(g.target.value)},slotProps:{input:{"aria-label":u("customTiles.gameMode","Game Mode")}},children:[e.jsx(F,{value:"online",children:e.jsx(N,{i18nKey:"online"})}),e.jsx(F,{value:"local",children:e.jsx(N,{i18nKey:"local"})})]})]}),e.jsxs(B,{sx:{minWidth:150,flex:1},children:[e.jsx(H,{id:"group-filter-label",children:e.jsx(N,{i18nKey:"group"})}),e.jsx(X,{labelId:"group-filter-label",id:"group-filter",value:L,label:u("group"),onChange:M,slotProps:{input:{"aria-label":u("group")}},children:s.map(g=>e.jsxs(F,{value:g,children:[k(g),!m&&c[g]&&` (${c[g].count})`]},g))})]}),e.jsxs(B,{sx:{minWidth:200,flex:1},disabled:!L,children:[e.jsx(H,{id:"intensity-filter-label",children:e.jsx(N,{i18nKey:"customTiles.intensityLevel",children:"Intensity Level"})}),e.jsxs(X,{labelId:"intensity-filter-label",id:"intensity-filter",value:O,label:u("customTiles.intensityLevel","Intensity Level"),onChange:g=>l(g.target.value),slotProps:{input:{"aria-label":u("customTiles.intensityLevel","Intensity Level")}},children:[!m&&e.jsx(F,{value:"all",children:e.jsx(N,{i18nKey:"all",children:"All"})},"all"),L&&c&&c[L]&&Object.entries(c[L].intensities||{}).sort(([g],[D])=>Number(g)-Number(D)).map(([g,D])=>e.jsxs(F,{value:Number(g),children:[I(L,g),!m&&D!==void 0?` (${D})`:""]},g))]})]})]})}function ss({tagList:n,boardUpdated:o,mappedGroups:r,updateTile:c,refreshTrigger:i}){const{t:h,i18n:a}=ee(),{settings:t}=ke(),[l,m]=d.useState(null),[f,u]=d.useState(t.gameMode||"online"),[s,p]=d.useState(""),[G,E]=d.useState(""),[k,I]=d.useState(1),[M,L]=d.useState(!0),[O,g]=d.useState({items:[],total:0,totalPages:1}),[D,A]=d.useState({}),[K,$]=d.useState({}),y=10;d.useEffect(()=>{async function T(){try{L(!0);const[S,V]=await Promise.all([de(a.resolvedLanguage,f),Et(a.resolvedLanguage,f,l)]),J={};S.forEach(q=>{J[q.name]=q}),$(J);const ne={};S.forEach(q=>{const re=V[q.name]||{count:0,intensities:{}};ne[q.name]={label:q.label||q.name,count:re.count,intensities:re.intensities}}),A(ne);const Q=S.map(q=>q.name),te=Q.includes(s);if((!s||!te)&&Q.length>0)p(Q[0]),E("all");else if(te&&G!=="all"){const q=S.find(re=>re.name===s);q&&(q.intensities.map(me=>me.value).includes(Number(G))||E("all"))}}catch(S){console.error("Error loading groups and counts:",S)}finally{L(!1)}}T()},[f,a.resolvedLanguage,l,s,G]),d.useEffect(()=>{let T=!0;async function S(){try{L(!0);const V={group:s,intensity:G==="all"?null:Number(G),tag:l,gameMode:f,locale:t.locale,page:k,limit:y,paginated:!0},J=await Oe(V);T&&(g(J),setTimeout(()=>{T&&L(!1)},300))}catch(V){console.error("Error loading tiles:",V),T&&L(!1)}}return s?S():L(!1),()=>{T=!1}},[s,G,l,f,k,y,i,t.locale]);function x(T){L(!0),m(l===T?null:T)}function j(T,S){L(!0),I(S)}async function w(T){await Lt(T),o();const S={group:s,intensity:G==="all"?null:G,tag:l,gameMode:f,locale:t.locale,page:k,limit:y,paginated:!0},V=await Oe(S);g(V)}async function W(T){await At(T),o(),g(S=>({...S,items:S.items.map(V=>V.id===T?{...V,isEnabled:!V.isEnabled}:V)}))}function R(T){c(T);const S=document.querySelector(".MuiDialogContent-root");S&&(S.scrollTop=0)}function U(T,S){const V=K[T];if(V){const J=V.label||T,Q=V.intensities.find(te=>te.value===Number(S))?.label||`Level ${Number(S)+1}`;return`${J} - ${Q}`}return`${T} - Level ${Number(S)+1}`}const Y=O.items?.map(({id:T,group:S,intensity:V,action:J,tags:ne,isEnabled:Q=!0,isCustom:te=!0})=>e.jsxs(mt,{sx:{my:2},children:[e.jsx(gt,{title:J,slotProps:{title:{variant:"body1"},subheader:{variant:"body2"},action:{"aria-label":h("customTiles.actions")}},subheader:U(S,V),action:e.jsxs(e.Fragment,{children:[e.jsx(ht,{checked:!!Q,onChange:()=>T!==void 0&&W(T),slotProps:{input:{"aria-label":h("customTiles.toggleTile")}}}),!!te&&e.jsxs(e.Fragment,{children:[e.jsx(ie,{onClick:()=>T!==void 0&&R(T),"aria-label":h("customTiles.update"),children:e.jsx(We,{})}),e.jsx(ie,{onClick:()=>T!==void 0&&w(T),"aria-label":h("customTiles.delete"),children:e.jsx(Te,{})})]})]}),sx:{pb:0}}),e.jsx(ft,{children:ne?.map(q=>e.jsx(ye,{label:q,sx:{m:.5}},q))})]},T));return e.jsxs(_,{children:[e.jsx(_,{children:n?.map(T=>e.jsx(ye,{label:T,sx:{m:.5},color:l===T?"primary":"default",onClick:()=>x(T)},T))}),e.jsx(_,{sx:{display:"flex",flexDirection:"column",gap:2,my:2,transition:"all 0.3s ease-in-out"},children:e.jsx(ts,{gameMode:f,groupFilter:s,intensityFilter:G,groups:D,mappedGroups:r,dexieGroups:K,onGameModeChange:T=>{u(T),p(""),E(""),I(1)},onGroupChange:T=>{p(T),I(1)},onIntensityChange:T=>{E(T),I(1)}})}),e.jsxs(_,{sx:{position:"relative",minHeight:"200px"},children:[e.jsx(xt,{in:M,timeout:300,children:e.jsx(_,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(255, 255, 255, 0)",zIndex:1,borderRadius:1},children:e.jsx(_e,{})})}),e.jsx(_,{sx:{opacity:M?.3:1,transition:"opacity 0.3s ease-in-out",pointerEvents:M?"none":"auto"},children:O.items.length===0?e.jsx(b,{variant:"body1",sx:{textAlign:"center",my:4},children:e.jsx(N,{i18nKey:"customTiles.noTilesFound",children:"No tiles found with the selected filters."})}):e.jsxs(e.Fragment,{children:[Y,O.totalPages>1&&e.jsx(_,{sx:{display:"flex",justifyContent:"center",mt:3,mb:2},children:e.jsx(yt,{count:O.totalPages,page:k,onChange:j,color:"primary"})}),e.jsx(b,{variant:"body2",sx:{textAlign:"center",mt:2,color:"text.secondary"},children:e.jsxs(N,{i18nKey:"customTiles.showingTiles",values:{shown:O.items.length,total:O.total},children:["Showing ",{shown:O.items.length}," of ",{total:O.total}," tiles"]})})]})})]})]})}function hs({boardUpdated:n,setOpen:o,open:r=!1}){const{t:c,i18n:i}=ee(),h=Pe(),a=Pe("md"),[t,l]=d.useState({message:"",type:"info"}),[m,f]=d.useState("ctAdd"),[u,s]=d.useState(null),[p,G]=d.useState(0),[E,k]=d.useState({online:{},local:{},solo:{}}),[I,M]=d.useState(!0),L=d.useCallback(()=>{G($=>$+1)},[]),O=$=>(y,x)=>{f(x?$:"")};d.useEffect(()=>{async function $(){M(!0);try{const[y,x,j]=await Promise.all([fe(i.resolvedLanguage,"online"),fe(i.resolvedLanguage,"local"),fe(i.resolvedLanguage,"solo")]);k({online:y,local:x,solo:j})}catch(y){console.error("Error loading game mode actions:",y)}finally{M(!1)}}$()},[i.resolvedLanguage]);const g=Tt(()=>pe({locale:i.resolvedLanguage})),D=d.useMemo(()=>g?Array.isArray(g)?g.map(({tags:$})=>$).flat().filter(($,y,x)=>$&&x.indexOf($)===y).sort():[]:[],[g]),A=d.useCallback(async $=>{await Dt($),n(),L()},[n,L]);if(!g||I)return null;const K=()=>{const $=e.jsxs(e.Fragment,{children:[e.jsx(es,{expanded:m,handleChange:O}),e.jsx(Zt,{setSubmitMessage:l,boardUpdated:()=>{n(),L()},customTiles:g,mappedGroups:E,expanded:m,handleChange:O,tagList:D,updateTileId:u,setUpdateTileId:s}),e.jsx(Xt,{expanded:m,handleChange:O,customTiles:g,mappedGroups:E,setSubmitMessage:l,bulkImport:A})]}),y=Array.isArray(g)&&g.length>0&&e.jsx(_,{children:e.jsx(ss,{tagList:D,boardUpdated:()=>{n(),L()},mappedGroups:E,updateTile:x=>{s(x),f("ctAdd")},refreshTrigger:p})});return a?e.jsxs(e.Fragment,{children:[$,y&&e.jsxs(e.Fragment,{children:[e.jsx(qe,{sx:{my:2}}),y]})]}):e.jsxs(ge,{container:!0,spacing:2,children:[e.jsx(ge,{size:{xs:12,md:6},children:$}),e.jsx(ge,{size:{xs:12,md:6},children:y})]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{fullScreen:h,open:r,onClose:()=>o(!1),maxWidth:a?"sm":"lg",fullWidth:!0,children:[e.jsxs(je,{children:[e.jsx(N,{i18nKey:"manageTiles"}),e.jsx(ie,{"aria-label":c("close"),onClick:()=>o(!1),sx:{position:"absolute",right:8,top:8,color:$=>$.palette.grey[500]},children:e.jsx(bt,{})})]}),e.jsx(ve,{children:K()})]}),e.jsx($t,{open:!!t.message,close:()=>l({message:"",type:"info"}),type:t.type,children:t.message})]})}function fs(n={},o={}){const[r]=Mt(),c={...n,...r,selectedActions:r?.selectedActions||{},...o},[i,h]=d.useState(c),{messages:a}=Ft(),[t,l]=d.useState(!1);return d.useEffect(()=>{const m=Nt(a,"room");if(m?.settings)try{const f=JSON.parse(m.settings);h(u=>t?u.selectedActions&&Object.keys(u.selectedActions).length>0?{...u,...f,selectedActions:u.selectedActions}:{...u,...f}:(l(!0),{...u,...f}))}catch(f){console.error("Error parsing message settings:",f)}else t||l(!0)},[a,t]),[i,h]}const xe=new Map,Ue=_t;function xs(n){const{i18n:o}=ee(),[r,c]=d.useState({}),[i,h]=d.useState(!0),a=d.useMemo(()=>!n||!o.resolvedLanguage?"":`${o.resolvedLanguage}-${n}`,[o.resolvedLanguage,n]);d.useEffect(()=>{if(a){const l=xe.get(a);l&&Date.now()-l.timestamp<Ue&&(c(l.data),h(!1))}},[a]);const t=d.useCallback(async()=>{if(!n||!a)return;const l=xe.get(a);if(l&&Date.now()-l.timestamp<Ue){c(l.data),h(!1);return}h(!0);try{const m=await de(o.resolvedLanguage,n),f={};for(const u of m){const s={[ze]:[]};u.intensities&&Array.isArray(u.intensities)&&u.intensities.sort((G,E)=>G.value-E.value).forEach(G=>{s[G.label]=[]});const p=u.type||"action";f[u.name]={label:u.label||u.name,type:p,actions:s}}xe.set(a,{data:f,timestamp:Date.now()}),c(f)}catch(m){console.error("Error loading unified actions:",m),c({})}finally{h(!1)}},[n,o.resolvedLanguage,a]);return d.useEffect(()=>{a&&t()},[t,a]),{actionsList:r,isLoading:i}}export{hs as C,xs as a,Qe as b,Ut as g,fe as i,fs as u};
