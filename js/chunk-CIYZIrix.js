var Q=Object.defineProperty;var ee=(e,t,n)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var S=(e,t,n)=>ee(e,typeof t!="symbol"?t+"":t,n);import{u as te}from"./chunk-BrNA7Hwt.js";import{u as G}from"./chunk-gA50YDka.js";import{x as ne,y as se,u as k,f as q,z as j,B as oe,C as ie,s as x,g as ae,D as re,E as le}from"../assets/index-vo-hWdNm.js";import{i as W,b as H}from"./chunk-C7PvMB7v.js";import{u as F}from"./chunk-pqaPnv92.js";import{ac as T,am as R,r as v,az as ce,ad as X,aq as ue}from"./chunk-C6Pi8TK2.js";import{a as de,i as fe}from"./chunk-B4PEA_xj.js";import{u as pe}from"./chunk-DLJ2DhuC.js";function L(e){for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Ye(e,t){return e?.length!==t?.length?!1:e.every((n,s)=>n===t[s])}const{t:$}=T;class me{constructor(t){S(this,"bags",new Map);S(this,"originalTiles",new Map);const n=new Map;t.forEach(s=>{const o=`${s.group}-${s.intensity}`;n.has(o)||n.set(o,[]),n.get(o).push(s)}),n.forEach((s,o)=>{const i=[...s];L(i),this.bags.set(o,i),this.originalTiles.set(o,[...s])})}getTile(t,n){const s=`${t}-${n}`;let o=this.bags.get(s);if(!o||o.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;o=[...i],L(o),this.bags.set(s,o)}return o.pop()||null}}function ge(e,t){return e.filter(n=>{const s=n.action;return t==="vers"?s.includes("{sub}")&&s.includes("{dom}")||s.includes("{player}"):!s.match(/{(dom|sub)}/)||s.includes(`{${t}}`)})}const O=new Map;function he(e,t,n,s){const o=`${e}-${t}-${n}-${s||"normal"}`,i=O.get(o);if(i!==void 0)return i;let r;if([void 0,"normal"].includes(s)){const a=e/t;r=Math.floor(n/a)+1}else t>=3&&Math.random()>=.6?r=t-1:r=t;return O.set(o,r),r}function Y(e,t,n,s,o,i){if(!e.length)return{title:"",description:""};const r=e[0],a=n[r.name];if(!a||a.level<=0)return{title:"",description:""};if(a.variation){const d=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>d)return{title:"",description:""}}const c=Math.max(...r.intensities.map(d=>d.value)),f=he(o,c,s,i.difficulty),u=Math.min(f,a.level);let l=t.getTile(r.name,u);if(!l){for(let d=u-1;d>=1&&(l=t.getTile(r.name,d),!l);d--);if(!l)for(let d=u+1;d<=c&&(l=t.getTile(r.name,d),!l);d++);if(!l)return{title:"",description:""}}return{title:r.label,description:l.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function be(e,t,n,s,o,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=Y(t,n,s,o,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function ve(e,t,n,s){const o=n.selectedActions||{},i=new me(t),r=e.filter(u=>{const l=o[u.name];return l&&l.level>0&&(!l.variation||l.variation==="standalone")}),a=e.filter(u=>{const l=o[u.name];return l&&l.level>0&&(l.variation==="appendSome"||l.variation==="appendMost")});L(r);let c=0;const f=[];for(let u=1;u<=s;u++){const l=r.length>0?[r[c%r.length]]:[];c++;const d=Y(l,i,o,u,s,n),p=be(d,a,i,o,u,s,n);f.push({title:d.title,description:p.trim(),role:d.role})}return f}function w(e,t){const n={title:$("start"),description:$("start")},{finishRange:s=[33,66]}=t,o=`${$("noCum")} ${s[0]}%\r
${$("ruined")} ${s[1]-s[0]}%\r
${$("cum")} ${100-s[1]}%`,i={title:$("finish"),description:o};return[n,...e.map(r=>({title:r.title,description:r.description})),i]}async function $e(e,t,n,s=40){try{const[o,i]=await Promise.all([ne({locale:t,gameMode:n}),se({locale:t,gameMode:n})]),r=e.selectedActions||{},a=Object.keys(r).filter(b=>r[b]?.level>0),c=o.filter(b=>a.includes(b.name)),f=o.map(b=>b.name),u=a.filter(b=>!f.includes(b)),l=e.role||"sub",p=ge(i,l).filter(b=>a.includes(b.group));if(!c.length||!p.length)return{board:w([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:u,availableTileCount:p.length}};const h=await ve(c,p,e,s),g=h.filter(b=>b.description.trim().length>0).length,m=w(h,e);return{board:m,metadata:{totalTiles:m.length,tilesWithContent:g+2,selectedGroups:a,missingGroups:u,availableTileCount:p.length}}}catch(o){return console.error("Error building game board:",o),{board:w([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function ye(){const e=G(q),[t,n]=F(),{i18n:s}=R(),o=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:c}=r;const{roomTileCount:f=40,finishRange:u,room:l}=r,d=W(l||"");if(!i||!u)return{gameMode:a};d&&!H(a||"")&&(a="online",c=!0);const p=a||"online",h=s.resolvedLanguage||"en",g=d?40:f||40,m=await $e(r,h,p,g);return m.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",m.metadata.missingGroups),m.metadata.tilesWithContent<g/2&&console.warn("Low tile content ratio:",{tilesWithContent:m.metadata.tilesWithContent,totalTiles:m.metadata.totalTiles,availableTileCount:m.metadata.availableTileCount}),(i?.boardUpdated||c||(e?.tiles?.length??0)!==m.board.length)&&(await n(r),await k({title:e?.title||"",tiles:m.board})),{settingsBoardUpdated:c,gameMode:a,newBoard:m.board,metadata:m.metadata}},[e,s.resolvedLanguage,t,n]);return v.useCallback(i=>o(i),[o])}const E=50,N=100,U=50,B=1,I=10,M=1,_=10,z=["none","all","default","undefined","null"],Ce=["solo","foreplay","sex","consumption"],Te=(e,t="en",n="online",s)=>{const o=[],i=[];if(!e||e.trim().length===0)return o.push("Group name is required"),{isValid:!1,errors:o,warnings:i};const r=e.trim();return r.length>E&&o.push(`Group name must be ${E} characters or less`),z.includes(r.toLowerCase())&&o.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||o.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||o.push("Group name must start with a letter"),{isValid:o.length===0,errors:o,warnings:i}},Ae=e=>{const t=[],n=[];return!e||e.trim().length===0?(t.push(ce("groupLabelRequired")),{isValid:!1,errors:t,warnings:n}):(e.trim().length>N&&t.push(`Group label must be ${N} characters or less`),{isValid:t.length===0,errors:t,warnings:n})},Se=e=>{const t=[],n=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:n};e.length<M&&t.push(`At least ${M} intensity level is required`),e.length>_&&t.push(`Maximum ${_} intensity levels allowed`);const s=new Set,o=new Set;for(let a=0;a<e.length;a++){const c=e[a];if((!c.id||c.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!c.label||c.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const f=c.label.trim();f.length>U&&t.push(`Intensity level ${a+1} label must be ${U} characters or less`),o.has(f.toLowerCase())?t.push(`Intensity label "${f}" is used multiple times`):o.add(f.toLowerCase())}typeof c.value!="number"||!Number.isInteger(c.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((c.value<B||c.value>I)&&t.push(`Intensity level ${a+1} value must be between ${B} and ${I}`),s.has(c.value)?t.push(`Intensity value ${c.value} is used multiple times`):s.add(c.value))}const i=Array.from(s).sort((a,c)=>a-c);let r=i[0];for(const a of i){if(a!==r){n.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:n}},ze=async(e,t)=>{const n=[],s=[],o=Te(e.name,e.locale||"en",e.gameMode||"online");n.push(...o.errors),s.push(...o.warnings||[]);const i=Ae(e.label);n.push(...i.errors),s.push(...i.warnings||[]);const r=Se(e.intensities);if(n.push(...r.errors),s.push(...r.warnings||[]),o.isValid&&e.name)try{await oe(e.name,e.locale||"en",e.gameMode||"online",t)||n.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch{s.push("Could not verify group name uniqueness")}return{isValid:n.length===0,errors:n,warnings:s}},Je=async(e,t="en",n="online")=>{const s=[],o=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:o};try{const i=await j(e.group,t,n);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${n}`),{isValid:!1,errors:s,warnings:o};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:o}},we=()=>({MAX_GROUP_NAME_LENGTH:E,MAX_GROUP_LABEL_LENGTH:N,MAX_INTENSITY_LABEL_LENGTH:U,MIN_INTENSITY_VALUE:B,MAX_INTENSITY_VALUE:I,MIN_INTENSITIES_COUNT:M,MAX_INTENSITIES_COUNT:_,RESERVED_GROUP_NAMES:z,VALID_GROUP_TYPES:Ce});function Ge(e,t,n){const s=e.selectedActions||{},o=Object.entries(n).filter(([r])=>s[r]).reduce((r,[a,c])=>(r[a]=Object.keys(c.actions).slice(1,s[a].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const a=o[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Le(e,t,n,s){const{t:o}=T;let i=`### ${T.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(n).forEach(([u,l])=>{if(!r[u])return;const{role:d,variation:p,level:h}=r[u],g=d||e.role||"sub";if(h>0){const m=Object.keys(l?.actions||{});if(i+=`* ${l?.label}: ${m[h]||""}`,p&&(i+=` (${o(p)})`),!H(e.gameMode)&&!p){const b=l[g]??o(g);i+=` (${b})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const u of e.customGroups)if(u.groupName&&u.intensity)try{const d=(await j(u.groupName,e.locale||"en",e.gameMode||"online"))?.label||u.groupName;i+=`* ${d}: Level ${u.intensity} (Custom)\r
`}catch(l){console.error(`Error loading custom group ${u.groupName}:`,l),i+=`* ${u.groupName}: Level ${u.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a,difficulty:c}=e;i+=`--- \r
`,i+=`* ${o("difficulty")}: ${o(c??"normal")} \r
`,a&&(i+=`* ${o("finishSlider")} ${a[0]}%  | ${a[1]-a[0]}% | ${100-a[1]}% \r
`);const f=Ge(e,t,n);return f&&(i+=`* ${o("customTilesLabel")}: ${f} \r
`),i}function Ee(e){const t={};return Object.entries(e).forEach(([n,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(n)&&!n.startsWith("room")&&(t[n]=s)}),t}async function Ne({title:e,formData:t,user:n,actionsList:s,tiles:o,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ee(t)),c=await ie({title:e,gameBoard:JSON.stringify(o),settings:a}),f=await Le(t,i,s,r);if(!(!c?.id||f===""))return x({room:t?.room||"PUBLIC",user:n,text:f,type:"settings",gameBoardId:c.id,boardSize:o.length,gameMode:t.gameMode})}function Ue(e){const{t}=T;let n=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,o])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&o!==""){n+=`* ${t(s)}: [${de(o)}:link:](${o})\r
`;return}if(s==="roomRealtime"){n+=`* ${t("playerList")}: ${t(o?"delayed":"realtime")}\r
`;return}o!==""&&(n+=`* ${t(s)}: ${o}\r
`)}}),n}function Be(e){const t={};return Object.entries(e).forEach(([n,s])=>{n.startsWith("room")&&!["roomUpdated","roomBackground"].some(o=>o===n)&&(t[n]=s)}),t}async function Ie(e,t,n){let s=e;return t!==void 0&&t.length>0&&(s=await n(t)),s}function Me(e,t){const n=Be(e);return x({room:e.room,user:t,text:Ue(n),type:"room",settings:JSON.stringify(n)})}function _e(){const{id:e}=X(),t=ue();return n=>{if(e!==void 0&&e?.toUpperCase()!==n?.toUpperCase()){const s=n?.replace(/^\/+/,"")||"PUBLIC";t(`/${s}`)}}}function Re(e){(!e.roomBackgroundURL||!fe(e.roomBackgroundURL))&&(e.roomBackground="app")}function Ve(e){const t={...e},n={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([o,i])=>{i&&i.level>0&&(n[o]=i)});const s=we();return Object.keys(t).forEach(o=>{const i=t[o];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[o]}),t.selectedActions=n,t}function De(){const{user:e,updateUser:t}=te(),{id:n}=X(),{t:s}=R(),o=ye(),[i,r]=F(),a=G(()=>ae(i?.gameMode)),c=G(q),f=_e(),{messages:u}=pe(),l=v.useCallback(p=>{const h=n?.toUpperCase()!==p.room.toUpperCase(),g=!!(p.room&&!W(p.room)),m=g&&p.roomTileCount!==i?.roomTileCount;return{roomChanged:h,isPrivateRoom:g,privateBoardSizeChanged:m}},[n,i?.roomTileCount]),d=v.useCallback(async(p,h)=>{const{displayName:g}=p,m=await Ie(e,g,t);Re(p);const{settingsBoardUpdated:b,gameMode:V,newBoard:A=[]}=await o(p),{roomChanged:J,isPrivateRoom:D,privateBoardSizeChanged:Z}=l(p);if(!m)return;D&&(p.roomUpdated||!u.find(C=>C.type==="room"))&&await Me(p,m),c?.tiles!==A&&await k({title:s("settingsGenerated"),tiles:A,isActive:1,gameMode:V}),(b||J||Z)&&!u.some(C=>C.type==="settings"&&C.uid===m.uid&&Date.now()-(C.timestamp?.toMillis()||0)<5e3)&&await Ne({formData:p,user:m,customTiles:a,actionsList:h,title:"Settings Generated Board",tiles:A});const K=Ve(p);r({...K,boardUpdated:!1,roomUpdated:!1,gameMode:V}),f(p.room)},[e,t,o,l,u,c,s,a,r,f]);return v.useCallback((p,h)=>d(p,h),[d])}const y=new Map,P=le;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{y.clear()};function Ze(e){const{i18n:t,t:n}=R(),[s,o]=v.useState({}),[i,r]=v.useState(!0);v.useEffect(()=>{const f=()=>{e&&Array.from(y.keys()).filter(l=>l.endsWith(`-${e}`)).forEach(l=>{y.delete(l)})};return t.on("languageChanged",f),()=>{t.off("languageChanged",f)}},[t,e]);const a=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{if(a){const f=y.get(a);f&&Date.now()-f.timestamp<P&&(o(f.data),r(!1))}},[a]);const c=v.useCallback(async()=>{if(!e||!a){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:a});return}const f=y.get(a);if(f&&Date.now()-f.timestamp<P){o(f.data),r(!1);return}r(!0);try{const u=await re(t.resolvedLanguage,e),l={};for(const d of u){const p={[n("none")]:[]};d.intensities&&Array.isArray(d.intensities)&&d.intensities.sort((g,m)=>g.value-m.value).forEach(g=>{p[g.label]=[]});const h=d.type||"action";l[d.name]={label:d.label||d.name,type:h,actions:p}}y.set(a,{data:l,timestamp:Date.now()}),o(l)}catch(u){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:u,locale:t.resolvedLanguage,gameMode:e,cacheKey:a}),o({})}finally{r(!1)}},[e,t.resolvedLanguage,a,n]);return v.useEffect(()=>{a&&c()},[c,a]),{actionsList:s,isLoading:i}}export{Me as a,_e as b,Ye as c,De as d,Ze as e,Ae as f,we as g,Je as h,Ne as s,ye as u,ze as v};
