import{r as m,j as g,ak as M,E as T,m as D,am as H}from"./chunk-D6lSgkQl.js";import{c as _}from"./chunk-CygiBK7d.js";import{g as C}from"./chunk-wjnghUwR.js";import{i as Z}from"./chunk-CIkUqbcq.js";import{l as N}from"./chunk-EL58PX5i.js";import{u as J}from"./chunk-CrKijlJ5.js";const A=e=>e&&/\.(jpe?g|png|webp|bmp|svg|gif)(\?.*)?$/i.test(e)?"image":"video";function W({url:e}){const[t,n]=m.useState(A(e)),[o,r]=m.useState(e);if(m.useEffect(()=>{r(e),n(A(e))},[e]),!o)return null;const s=()=>{const l=o??e??"";let u=!1;try{const c=new URL(l);u=c.host==="imgur.com"||c.host==="i.imgur.com"}catch{u=!1}if(u){const c=l.match(/(?:i\.)?imgur\.com\/([a-zA-Z0-9]+)(?:\.[a-z]+)?/)?.[1];if(c){const f=`https://i.imgur.com/${c}.jpg`;r(f),n("image");return}}const a=`${l.replace(/\.(mp4|webm|ogg|mov)(\?.*)?$/i,"")}.jpg`;r(a),n("image")},p=()=>{const l=o??e??"";let u=!1;try{const d=new URL(l);u=d.host==="imgur.com"||d.host==="i.imgur.com"}catch{u=!1}if(u){const d=l.match(/(?:i\.)?imgur\.com\/([a-zA-Z0-9]+)(?:\.[a-z]+)?/)?.[1];if(d){const a=["jpg","png","gif","jpeg","webp"],c=o?.split(".").pop(),i=a.indexOf(c||"")+1;if(i<a.length){const b=a[i],y=`https://i.imgur.com/${d}.${b}`;r(y)}}}else{const d=["jpg","png","gif","jpeg","webp"],a=o?.split(".").pop(),f=d.indexOf(a||"")+1;if(f<d.length&&o){const i=d[f],y=`${o.replace(/\.[^.]+(\?.*)?$/,"")}.${i}`;r(y)}}};return t==="video"?g.jsx("video",{autoPlay:!0,loop:!0,muted:!0,playsInline:!0,src:o||void 0,className:"video-background",onError:s,preload:"auto",crossOrigin:"anonymous",controls:!0}):g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"image-background",style:{backgroundImage:o?`url("${String(o).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"").replace(/\r/g,"")}")`:void 0,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"100%",height:"100%",position:"absolute",top:0,left:0}}),g.jsx("img",{src:o||void 0,onError:p,style:{display:"none"},alt:""})]})}function K({images:e,className:t,zoomDuration:n=3e3,zoomScale:o=1.4}){const{t:r}=M(),[s,p]=m.useState(0),[l,u]=m.useState(0),[d,a]=m.useState(new Set),[c,f]=m.useState(new Set),[i,b]=m.useState(!1),y=m.useRef(null),x=m.useRef(new Map);m.useEffect(()=>{b(!1)},[e]),m.useEffect(()=>{if(e.length===0)return;const v=w=>new Promise(j=>{if(x.current.has(w)||c.has(w)){j();return}const R=new Image;R.onload=()=>{x.current.set(w,R),a(U=>{const F=new Set(U).add(w);return!i&&w===e[0]&&b(!0),F}),j()},R.onerror=()=>{f(U=>new Set(U).add(w)),j()},R.src=w});(async()=>{const w=Math.min(5,e.length),j=[];for(let R=0;R<w;R++){const U=(s+R)%e.length;j.push(v(e[U]))}await Promise.all(j)})()},[e,s,c,i]),m.useEffect(()=>{if(e.length===0||e.length===1)return;const v=()=>{y.current=window.setInterval(()=>{p(w=>(w+1)%e.length),u(w=>w+1)},n)},$=window.setTimeout(v,2e3);return()=>{window.clearTimeout($),y.current&&(window.clearInterval(y.current),y.current=null)}},[e.length,n]),m.useEffect(()=>()=>{y.current&&(window.clearInterval(y.current),y.current=null)},[]);const I=e[s]||"",S=d.has(I)||x.current.has(I),k=c.has(I);return m.useEffect(()=>{if(k&&e.length>1){const v=(s+1)%e.length;p(v),u($=>$+1)}},[k,s,e.length]),e.length===0?null:g.jsxs("div",{className:_("image-slideshow-container",t),"aria-hidden":!0,children:[g.jsx("div",{className:"image-slideshow-fallback"}),!i&&e.length>0&&g.jsx("div",{className:"loading-message",children:r("loadingImages")}),S&&!k&&g.jsx("div",{className:"image-slideshow-slide",style:{backgroundImage:`url(${I})`,animationDuration:`${n}ms`,"--zoom-scale":o}},l)]})}function E(e){return e.replace(/&amp;/g,"&")}const O=["r.jina.ai","api.allorigins.win/get?url=","corsproxy.io/?"],V=(e,t=0)=>{const n=O[t];return n==="api.allorigins.win/get?url="?`https://${n}${encodeURIComponent(e)}`:n==="corsproxy.io/?"?`https://${n}${encodeURIComponent(e)}`:`https://${n}/http://${e.replace(/^https?:\/\//,"")}`};async function q(e,t,n){const o=new Set;let r=null;const s=[u=>`https://www.reddit.com/r/${e}/top.json?limit=100&t=year&raw_json=1${u?`&after=${u}`:""}`,u=>`https://www.reddit.com/r/${e}/hot.json?limit=100&raw_json=1${u?`&after=${u}`:""}`],p=async u=>{try{const d=await fetch(u,{signal:n,credentials:"omit",mode:"cors",headers:{"User-Agent":"BlitzedOut/1.0",Accept:"application/json, text/plain, */*","Accept-Language":"en-US,en;q=0.9"}});if(d.ok){const a=await d.text();try{return JSON.parse(a)}catch{const c=a.indexOf("{"),f=a.lastIndexOf("}");if(c!==-1&&f!==-1&&f>c)try{return JSON.parse(a.slice(c,f+1))}catch{return null}return null}}}catch(d){if(d instanceof DOMException&&d.name==="AbortError")throw d}for(let d=0;d<O.length;d++)try{const a=await fetch(V(u,d),{signal:n,credentials:"omit",mode:"cors",headers:{"User-Agent":"BlitzedOut/1.0",Accept:"application/json, text/plain, */*"}});if(!a.ok)continue;const c=await a.text();let f;try{const i=JSON.parse(c);f=i.contents?JSON.parse(i.contents):i}catch{const i=c.indexOf("{"),b=c.lastIndexOf("}");if(i!==-1&&b!==-1&&b>i)try{f=JSON.parse(c.slice(i,b+1))}catch{continue}else continue}if(f)return f}catch(a){if(a instanceof DOMException&&a.name==="AbortError")throw a;continue}return null};let l=0;for(;o.size<t&&l<s.length;){r=null;for(let u=0;u<5&&o.size<t;u+=1){const d=s[l](r),a=await p(d);if(!a)break;const c=a?.data?.children??[];r=a?.data?.after??null;for(const f of c){const i=f?.data;if(!i)continue;const b=i.url_overridden_by_dest,y=i.post_hint;if(i.is_gallery&&i.media_metadata&&i.gallery_data){const I=i.gallery_data.items||[];for(const S of I){const k=i.media_metadata[S.media_id],v=k?.s?.u||k?.s?.gif||k?.s?.mp4;if(typeof v=="string"){const $=v.startsWith("http")?v:`https:${v}`;/\.(jpe?g|png|gif|webp)(\?.*)?$/i.test($)&&o.add(E($))}}continue}if(y==="image"&&typeof b=="string"&&/\.(jpe?g|png|gif|webp)(\?.*)?$/i.test(b)){o.add(E(b));continue}const x=i.preview?.images?.[0]?.source?.url;if(x){const I=x.startsWith("http")?x:`https:${x}`;o.add(E(I))}}if(!r)break}l+=1}return Array.from(o).slice(0,t)}async function X(e,t){const n=e.maxImages||150;return{images:await q(e.subreddit,n,t),source:`r/${e.subreddit}`}}function P(e){try{const t=new URL(e);return/(^|\.)reddit\.com$/i.test(t.hostname)&&/\/r\//i.test(t.pathname)}catch{return!1}}function Y(e){try{return new URL(e).pathname.match(/\/r\/([^/]+)/i)?.[1]??null}catch{return null}}const G=3e5,z=new Map,L=new Map;async function Q(e,t){const n=JSON.stringify(e),o=Date.now(),r=z.get(n);if(r&&o-r.fetchedAt<G)return r.result;const s=L.get(n);if(s)try{return await s}catch{}const p=X(e,t).then(l=>(z.set(n,{fetchedAt:Date.now(),result:l}),l)).finally(()=>{L.delete(n)});return L.set(n,p),p}function ee(e){const{t}=M(),[n,o]=m.useState([]),[r,s]=m.useState(!1),[p,l]=m.useState(null),[u,d]=m.useState(null),a=m.useRef(null);return m.useEffect(()=>{if(a.current&&a.current.abort(),o([]),l(null),d(null),!e||!P(e)){s(!1);return}const c=Y(e);if(!c){l(t("invalidRedditUrl")),s(!1);return}const f={subreddit:c,maxImages:150};s(!0);const i=new AbortController;a.current=i;const b=async(x=0)=>{try{const I=await Q(f,i.signal);if(i.signal.aborted)return;o(I.images),d(I.source),l(null),s(!1)}catch{if(i.signal.aborted)return;if(x<2){const S=Math.pow(2,x)*1e3;setTimeout(()=>{i.signal.aborted||b(x+1)},S);return}l(t("redditBlocked")),o([]),d(null),s(!1)}},y=window.setTimeout(b,300);return()=>{i.abort(),window.clearTimeout(y)}},[e,t]),m.useEffect(()=>()=>{a.current&&a.current.abort()},[]),{images:n,isLoading:r,error:p,source:u}}function te({url:e}){const{t}=M(),n=T(),{images:o,isLoading:r,error:s}=ee(e);return r?g.jsxs("div",{className:"slideshow-container slideshow-loading","aria-hidden":!0,children:[g.jsx("div",{className:"image-slideshow-fallback"}),g.jsx("div",{className:"loading-message",children:t("loadingRedditImages")})]}):s||o.length===0?s?g.jsxs("div",{className:"slideshow-container slideshow-error","aria-hidden":!0,children:[g.jsx("div",{className:"image-slideshow-fallback"}),g.jsxs("div",{className:"error-message",style:{position:"absolute",bottom:"20px",right:"20px",background:D(n.palette.background.paper,.7),color:n.palette.text.primary,padding:"12px 16px",borderRadius:"8px",fontSize:"14px",maxWidth:"300px",zIndex:1e3},children:[g.jsx("strong",{children:t("redditBackgroundNote")}),g.jsx("br",{}),t("redditBlocked")]})]}):null:g.jsx(K,{images:o})}function je({url:e=null,isVideo:t=null}){const n=e&&/\.(mp4|webm|ogg|mov|gif)(\?.*)?$/i.test(e),o=e?P(e):!1,r=e==="color"||e==="gray"||e?.includes("/color")||e?.includes("/gray"),s=e&&!r&&(t||!t&&e),p=!t&&o&&e;return g.jsxs(H,{className:_("main-container",!s&&"default-background"),role:"presentation",sx:{backgroundImage:!t&&e&&!r&&!o?`url(${e})`:"none"},children:[t&&!o&&(n?g.jsx(W,{url:e}):g.jsx("iframe",{width:"100%",height:"100%",src:e||void 0,title:"video",allow:"autoplay; fullscreen; encrypted-media; picture-in-picture",sandbox:"allow-same-origin allow-scripts allow-presentation",style:{border:0}})),p?g.jsx(te,{url:e}):null]})}function ne(e){const t=/vimeo\.com\/(\d+)/,n=e.match(t);return`https://player.vimeo.com/video/${n?n[1]:""}?autoplay=1&loop=1&autostart=true`}function oe(e){const t=/(?:youtube\.com\/(?:[^/]+\/.+\/|(?:v|e(?:mbed)?)\/|[^#]*[?&]v=|youtu\.be\/)([^"&?/ ]{11})|^(?:[^"&?/ ]{11})$)/,n=e.match(t);return`https://www.youtube.com/embed/${n?n[1]:""}?autoplay=1&loop=1&autostart=true&mute=1&playsinline=1&controls=0&disablekb=1&fs=0&modestbranding=1&rel=0&iv_load_policy=3`}function re(e){const t=/drive\.google\.com\/file\/d\/([^/]+)/,n=e.match(t);return`https://drive.google.com/file/d/${n?n[1]:""}/preview?loop=1`}function se(e){const t=/dropbox\.com\/s\/([^/]+)/,n=e.match(t);return`https://www.dropbox.com/s/${n?n[1]:""}?raw=1`}function ae(e){return`https://pornhub.com/embed/${new URL(e).searchParams.get("viewkey")||""}?autoplay=1&loop=1&autostart=true&playsinline=1`}function ie(e){const t=e.split("-");return`https://xhamster.com/xembed.php?video=${t[t.length-1]}?autoplay=1&loop=1&autostart=true&playsinline=1`}function ce(e){const t=/media\.tenor\.com\/([a-zA-Z0-9_-]+)\/[^/]*\.(mp4|gif|webp)/;if(e.match(t))return e;const o=/tenor\.com\/view\/[^/]*-(\d+)/,r=e.match(o);return`https://tenor.com/embed/${r?r[1]:""}?autoplay=1`}function de(e){const t=/giphy\.com\/gifs\/[^/]*-([a-zA-Z0-9]+)/,n=e.match(t);return`https://media.giphy.com/media/${n?n[1]:""}/giphy.gif`}function le(e){return/\d+\.media\.tumblr\.com\/.*\.(gif|mp4|webm)(\?.*)?$/i.test(e),e}function ue(e){const t=/(?:gfycat\.com|redgifs\.com)\/(?:watch\/)?([a-zA-Z0-9]+)/,n=e.match(t),o=n?n[1]:"";return h(e,["redgifs.com"])?`https://files.redgifs.com/${o}.mp4`:`https://giant.gfycat.com/${o}.mp4`}function me(e){const t=/redtube\.com\/(\d+)/,n=e.match(t);return`https://embed.redtube.com/?id=${n?n[1]:""}&autoplay=true&auto_play=1&playsinline=1&controls=1`}function pe(e){const t=/youporn\.com\/watch\/(\d+)/,n=e.match(t);return`https://www.youporn.com/embed/${n?n[1]:""}?autoplay=1&playsinline=1`}function ge(e){const t=/tube8\.com\/[^/]+\/[^/]+\/(\d+)/,n=e.match(t);return`https://www.tube8.com/embed/${n?n[1]:""}?autoplay=1&playsinline=1`}function fe(e){return`https://twitframe.com/show?url=${encodeURIComponent(e)}`}function he(e){try{const r=new URL(e);if((r.host==="discordapp.net"||r.host.endsWith(".discordapp.net"))&&r.pathname.startsWith("/external/")&&(r.pathname.includes("/https/i.imgur.com/")||r.pathname.includes("/https/imgur.com/")))return e}catch(r){N.debug("URL parsing failed for Discord proxy check:",r)}let t="",n=!1;try{const r=new URL(e);n=r.host==="imgur.com"||r.host==="i.imgur.com"}catch(r){return N.debug("URL parsing failed for Imgur processing:",r),""}if(!n)return"";if(e.includes("/gallery/")){const r=e.match(/imgur\.com\/gallery\/[^#]*#([a-zA-Z0-9]+)/);if(r)t=r[1];else{const s=e.match(/imgur\.com\/gallery\/.*-([a-zA-Z0-9]+)/);if(s)t=s[1];else return N.debug("Could not extract image ID from gallery URL:",e),""}}else{const r=/imgur\.com\/([a-zA-Z0-9]+)(?:\.(mp4|jpg|jpeg|png|gif|webp))?|images-ext-\d+\.discordapp\.net\/external\/[^/]+\/https\/i\.imgur\.com\/([a-zA-Z0-9]+)\.(mp4|jpg|jpeg|png|gif|webp)/,s=e.match(r);t=s?s[1]||s[3]:""}return t?`https://i.imgur.com/${t}.gif`:""}function B(e){return/\.(mp4|webm|ogg|mov)(\?.*)?$/.test(e)}function be(e){return h(e,["media.discordapp.net","cdn.discordapp.com"])&&!B(e)}function h(e,t){try{const n=new URL(e);return t.some(o=>n.host===o||n.host.endsWith("."+o))}catch(n){return N.debug("URL parsing failed in isValidHost, rejecting for security:",n),!1}}function ye(e){let t=null,n=!0;if(!e)return{url:"",isVideo:!1};switch(!0){case h(e,["vimeo.com"]):t=ne(e);break;case h(e,["youtube.com","youtu.be"]):t=oe(e);break;case h(e,["drive.google.com"]):t=re(e);break;case h(e,["pornhub.com"]):t=ae(e);break;case h(e,["xhamster.com"]):t=ie(e);break;case h(e,["dropbox.com"]):t=se(e);break;case h(e,["imgur.com","i.imgur.com"]):t=he(e);break;case h(e,["tenor.com","media.tenor.com"]):t=ce(e),n=!0;break;case h(e,["giphy.com"]):t=de(e),n=!0;break;case(h(e,["tumblr.com","media.tumblr.com"])||/\\d+\\.media\\.tumblr\\.com/.test(e)):t=le(e),n=!1;break;case h(e,["gfycat.com","redgifs.com"]):t=ue(e),n=!0;break;case h(e,["redtube.com"]):t=me(e);break;case h(e,["youporn.com"]):t=pe(e);break;case h(e,["tube8.com"]):t=ge(e);break;case h(e,["twitter.com","x.com"]):t=fe(e),n=!1;break;case h(e,["thisvid.com"]):t=e;break;case h(e,["boyfriendtv.com"]):t=e;break;case be(e):t=e,n=!1;break;case B(e):t=e;break;default:t=C(e),n=!1;break}return{url:t,isVideo:n}}function Se(e,t){const{background:n,backgroundURL:o,roomBackgroundURL:r}=e;let s=null;return n?n==="custom"?s=o||null:n==="useRoomBackground"?!Z(t)&&r?s=r:s="color":s=n:s="color",s||(s="color"),s==="color"||s==="gray"?{url:s,isVideo:!1}:ye(s)}function we(e){return{uid:e.uid,displayName:e.displayName,isSelf:e.isSelf,isFinished:e.isFinished}}function Ue(e){const[t,n]=m.useState(null),o=J(),r=m.useMemo(()=>o.map(p=>`${p.uid}-${p.displayName}-${p.isFinished}-${p.isSelf}`).join("|"),[o]),s=m.useMemo(()=>e?`${e.uid}-${e.displayName||""}`:null,[e]);return m.useEffect(()=>{if(!e){n(null);return}if(o.length<=1){n(null);return}const p=o.filter(c=>!c.isFinished);if(p.length<=1){n(null);return}let l=-1;l=p.findIndex(c=>c.uid===e.uid),l===-1&&(l=p.findIndex(c=>c.displayName===e.displayName)),l===-1&&(l=0);const u=(l+1)%p.length,d=p[u],a=we(d);n(a)},[s,r]),t}export{je as R,Se as g,ye as p,Ue as u};
