var Q=Object.defineProperty;var ee=(e,t,o)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var w=(e,t,o)=>ee(e,typeof t!="symbol"?t+"":t,o);import{u as te}from"./chunk-BJ-_sI1K.js";import{u as G}from"./chunk-Bpm6U_-k.js";import{D as ne,E as se,u as x,e as k,t as j,F as oe,G as ie,s as q,g as ae,I as re,J as le,K as ce}from"../assets/index-CJhYrxms.js";import{i as W,b as F}from"./chunk-C7PvMB7v.js";import{u as H}from"./chunk-DJYgIsA_.js";import{ac as A,ae as V,r as v,az as ue,ad as X,an as de}from"./chunk-Crsl6-54.js";import{a as pe,i as fe}from"./chunk-B4PEA_xj.js";import{u as ge}from"./chunk-3sysC2BZ.js";function E(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Je(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}const{t:C}=A;class me{constructor(t){w(this,"bags",new Map);w(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];E(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],E(n),this.bags.set(s,n)}return n.pop()||null}}function he(e,t,o=[]){return e.filter(s=>{const n=s.action;return o.find(a=>a.name===s.group)?.type==="consumption"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const O=new Map;function be(e,t,o,s){const n=`${e}-${t}-${o}-${s||"normal"}`,i=O.get(n);if(i!==void 0)return i;let a;if([void 0,"normal"].includes(s)){const r=e/t;a=Math.floor(o/r)+1}else t>=3&&Math.random()>=.6?a=t-1:a=t;return O.set(n,a),a}function Y(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const a=e[0],r=o[a.name];if(!r||r.level<=0)return{title:"",description:""};if(r.variation){const p=r.variation==="appendSome"?.4:r.variation==="appendMost"?.9:1;if(r.variation!=="standalone"&&Math.random()>p)return{title:"",description:""}}const l=Math.max(...a.intensities.map(p=>p.value)),g=be(n,l,s,i.difficulty),c=Math.min(g,r.level);let u=t.getTile(a.name,c);if(!u){for(let p=c-1;p>=1&&(u=t.getTile(a.name,p),!u);p--);if(!u)for(let p=c+1;p<=l&&(u=t.getTile(a.name,p),!u);p++);if(!u)return{title:"",description:""}}return{title:a.label,description:u.action,standalone:r.variation==="standalone",role:i.role||"sub"}}function ve(e,t,o,s,n,i,a){if(e.standalone||!t.length||!e.description)return e.description||"";const r=Y(t,o,s,n,i,a);return r.description?`${r.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function $e(e,t,o,s){const n=o.selectedActions||{},i=new me(t),a=e.filter(c=>{const u=n[c.name];return u&&u.level>0&&(!u.variation||u.variation==="standalone")}),r=e.filter(c=>{const u=n[c.name];return u&&u.level>0&&(u.variation==="appendSome"||u.variation==="appendMost")});E(a);let l=0;const g=[];for(let c=1;c<=s;c++){const u=a.length>0?[a[l%a.length]]:[];l++;const p=Y(u,i,n,c,s,o),d=ve(p,r,i,n,c,s,o);g.push({title:p.title,description:d.trim(),role:p.role})}return g}function L(e,t){const o={title:C("start"),description:C("start")},{finishRange:s=[33,66]}=t,n=`${C("noCum")} ${s[0]}%\r
${C("ruined")} ${s[1]-s[0]}%\r
${C("cum")} ${100-s[1]}%`,i={title:C("finish"),description:n};return[o,...e.map(a=>({title:a.title,description:a.description})),i]}async function Ce(e,t,o,s=40){try{const[n,i]=await Promise.all([ne({locale:t,gameMode:o}),se({locale:t,gameMode:o})]),a=e.selectedActions||{},r=Object.keys(a).filter(b=>a[b]?.level>0),l=n.filter(b=>r.includes(b.name)),g=n.map(b=>b.name),c=r.filter(b=>!g.includes(b)),u=e.role||"sub",d=he(i,u,n).filter(b=>r.includes(b.group));if(!l.length||!d.length)return{board:L([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:r,missingGroups:c,availableTileCount:d.length}};const m=await $e(l,d,e,s),h=m.filter(b=>b.description.trim().length>0).length,f=L(m,e);return{board:f,metadata:{totalTiles:f.length,tilesWithContent:h+2,selectedGroups:r,missingGroups:c,availableTileCount:d.length}}}catch(n){return console.error("Error building game board:",n),{board:L([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Te(){const e=G(k),[t,o]=H(),{i18n:s}=V(),n=v.useCallback(async i=>{const a=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:r,boardUpdated:l}=a;const{roomTileCount:g=40,finishRange:c,room:u}=a,p=W(u||"");if(!i||!c)return{gameMode:r};p&&!F(r||"")&&(r="online",l=!0);const d=r||"online",m=s.resolvedLanguage||"en",h=p?40:g||40,f=await Ce(a,m,d,h);return f.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",f.metadata.missingGroups),f.metadata.tilesWithContent<h/2&&console.warn("Low tile content ratio:",{tilesWithContent:f.metadata.tilesWithContent,totalTiles:f.metadata.totalTiles,availableTileCount:f.metadata.availableTileCount}),(i?.boardUpdated||l||(e?.tiles?.length??0)!==f.board.length)&&(await o(a),await x({title:e?.title||"",tiles:f.board})),{settingsBoardUpdated:l,gameMode:r,newBoard:f.board,metadata:f.metadata}},[e,s.resolvedLanguage,t,o]);return v.useCallback(i=>n(i),[n])}const N=50,U=100,I=50,M=1,B=10,_=1,R=10,J=["none","all","default","undefined","null"],ye=["solo","foreplay","sex","consumption"],Ae=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const a=e.trim();return a.length>N&&n.push(`Group name must be ${N} characters or less`),J.includes(a.toLowerCase())&&n.push(`"${a}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(a)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(a)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Se=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(ue("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>U&&t.push(`Group label must be ${U} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},we=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<_&&t.push(`At least ${_} intensity level is required`),e.length>R&&t.push(`Maximum ${R} intensity levels allowed`);const s=new Set,n=new Set;for(let r=0;r<e.length;r++){const l=e[r];if((!l.id||l.id.trim().length===0)&&t.push(`Intensity level ${r+1} is missing an ID`),!l.label||l.label.trim().length===0)t.push(`Intensity level ${r+1} is missing a label`);else{const g=l.label.trim();g.length>I&&t.push(`Intensity level ${r+1} label must be ${I} characters or less`),n.has(g.toLowerCase())?t.push(`Intensity label "${g}" is used multiple times`):n.add(g.toLowerCase())}typeof l.value!="number"||!Number.isInteger(l.value)?t.push(`Intensity level ${r+1} must have a valid integer value`):((l.value<M||l.value>B)&&t.push(`Intensity level ${r+1} value must be between ${M} and ${B}`),s.has(l.value)?t.push(`Intensity value ${l.value} is used multiple times`):s.add(l.value))}const i=Array.from(s).sort((r,l)=>r-l);let a=i[0];for(const r of i){if(r!==a){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}a++}return{isValid:t.length===0,errors:t,warnings:o}},ze=async(e,t)=>{const o=[],s=[],n=Ae(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=Se(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const a=we(e.intensities);if(o.push(...a.errors),s.push(...a.warnings||[]),n.isValid&&e.name)try{await oe(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch{s.push("Could not verify group name uniqueness")}return{isValid:o.length===0,errors:o,warnings:s}},De=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await j(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const a=i.intensities.map(r=>r.value);a.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${a.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Le=()=>({MAX_GROUP_NAME_LENGTH:N,MAX_GROUP_LABEL_LENGTH:U,MAX_INTENSITY_LABEL_LENGTH:I,MIN_INTENSITY_VALUE:M,MAX_INTENSITY_VALUE:B,MIN_INTENSITIES_COUNT:_,MAX_INTENSITIES_COUNT:R,RESERVED_GROUP_NAMES:J,VALID_GROUP_TYPES:ye});function Ge(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([a])=>s[a]).reduce((a,[r,l])=>(a[r]=Object.keys(l.actions).slice(1,s[r].level+1),a),{});return(t?.filter(a=>{if(!a.isCustom)return!1;if(a.group==="misc")return!0;const r=n[a.group];return r&&r.length>=Number(a.intensity)})||[]).length}async function Ee(e,t,o,s){const{t:n}=A;let i=`### ${A.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const a=e.selectedActions||{};if(Object.entries(o).forEach(([c,u])=>{if(!a[c])return;const{role:p,variation:d,level:m}=a[c],h=p||e.role||"sub";if(m>0){const f=Object.keys(u?.actions||{});if(i+=`* ${u?.label}: ${f[m]||""}`,d&&(i+=` (${n(d)})`),!F(e.gameMode)&&!d){const b=u[h]??n(h);i+=` (${b})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const p=(await j(c.groupName,e.locale||"en",e.gameMode||"online"))?.label||c.groupName;i+=`* ${p}: Level ${c.intensity} (Custom)\r
`}catch(u){console.error(`Error loading custom group ${c.groupName}:`,u),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:r,difficulty:l}=e;if(i+=`--- \r
`,i+=`* ${n("difficulty")}: ${n(l??"normal")} \r
`,r){const c=r[0],u=r[1]-r[0],p=100-r[1],m=[c>0?{percent:c,text:n("noCum")}:null,u>0?{percent:u,text:n("ruined")}:null,p>0?{percent:p,text:n("cum")}:null].filter(h=>h!==null);m.length===1&&m[0].percent===100?i+=`* ${n("finishSlider")} ${m[0].text.replace(":","")} \r
`:m.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,m.forEach(h=>{const f=h.percent===100?h.text.replace(":",""):`${h.text} ${h.percent}%`;i+=`  - ${f} \r
`}))}const g=Ge(e,t,o);return g&&(i+=`* ${n("customTilesLabel")}: ${g} \r
`),i}function Ne(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Ue({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:a=""}){const r=JSON.stringify(Ne(t)),l=await ie({title:e,gameBoard:JSON.stringify(n),settings:r}),g=await Ee(t,i,s,a);if(!(!l?.id||g===""))return q({room:t?.room||"PUBLIC",user:o,text:g,type:"settings",gameBoardId:l.id,boardSize:n.length,gameMode:t.gameMode})}function Ie(e){const{t}=A;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${pe(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Me(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===o)&&(t[o]=s)}),t}async function Be(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function _e(e,t){const o=Me(e);return q({room:e.room,user:t,text:Ie(o),type:"room",settings:JSON.stringify(o)})}function Re(){const{id:e}=X(),t=de();return o=>{if(e!==void 0&&e?.toUpperCase()!==o?.toUpperCase()){const s=o?.replace(/^\/+/,"")||"PUBLIC";t(`/${s}`)}}}function Ve(e){(!e.roomBackgroundURL||!fe(e.roomBackgroundURL))&&(e.roomBackground="app")}function Oe(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.level>0&&(o[n]=i)});const s=Le();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function Ke(){const{user:e,updateUser:t}=te(),{id:o}=X(),{t:s}=V(),n=Te(),[i,a]=H(),r=G(()=>ae(i?.gameMode)),l=G(k),g=Re(),{messages:c}=ge(),u=v.useCallback(d=>{const m=o?.toUpperCase()!==d.room.toUpperCase(),h=!!(d.room&&!W(d.room)),f=h&&d.roomTileCount!==i?.roomTileCount;return{roomChanged:m,isPrivateRoom:h,privateBoardSizeChanged:f}},[o,i?.roomTileCount]),p=v.useCallback(async(d,m)=>{const{displayName:h}=d,f=await Be(e,h,t);Ve(d);const{settingsBoardUpdated:b,gameMode:y,newBoard:S=[]}=await n(d),{roomChanged:z,isPrivateRoom:D,privateBoardSizeChanged:K}=u(d);if(!f)return;D&&(d.roomUpdated||!c.find(T=>T.type==="room"))&&await _e(d,f),l?.tiles!==S&&await x({title:s("settingsGenerated"),tiles:S,isActive:1,gameMode:y}),(b||z||K)&&!c.some(T=>T.type==="settings"&&T.uid===f.uid&&Date.now()-(T.timestamp?.toMillis()||0)<5e3)&&await Ue({formData:d,user:f,customTiles:r,actionsList:m,title:"Settings Generated Board",tiles:S});const Z=Oe(d);a({...Z,boardUpdated:!1,roomUpdated:!1,gameMode:y}),g(d.room)},[e,t,n,u,c,l,s,r,a,g]);return v.useCallback((d,m)=>p(d,m),[p])}const $=new Map,P=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{$.clear()};function Ze(e){const{i18n:t,t:o}=V(),{currentLanguageMigrated:s}=re(),[n,i]=v.useState({}),[a,r]=v.useState(!0);v.useEffect(()=>{const c=()=>{e&&Array.from($.keys()).filter(p=>p.endsWith(`-${e}`)).forEach(p=>{$.delete(p)})};return t.on("languageChanged",c),()=>{t.off("languageChanged",c)}},[t,e]);const l=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{s&&l&&$.get(l)&&$.delete(l)},[s,l]),v.useEffect(()=>{if(l){const c=$.get(l);c&&Date.now()-c.timestamp<P&&(i(c.data),r(!1))}},[l]);const g=v.useCallback(async()=>{if(!e||!l){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:l});return}if(!s)return;const c=$.get(l);if(c&&Date.now()-c.timestamp<P){i(c.data),r(!1);return}r(!0);try{const u=await le(t.resolvedLanguage,e),p={};for(const d of u){const m={[o("none")]:[]},h={};d.intensities&&Array.isArray(d.intensities)&&d.intensities.sort((b,y)=>b.value-y.value).forEach(b=>{m[b.label]=[],h[b.value]=b.label});const f=d.type||"action";p[d.name]={label:d.label||d.name,type:f,actions:m,intensities:h}}$.set(l,{data:p,timestamp:Date.now()}),i(p)}catch(u){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:u,locale:t.resolvedLanguage,gameMode:e,cacheKey:l}),i({})}finally{r(!1)}},[e,t.resolvedLanguage,l,o,s]);return v.useEffect(()=>{l&&s&&g()},[g,l,s]),{actionsList:n,isLoading:a}}export{_e as a,Ke as b,Ze as c,Re as d,Je as e,Se as f,Le as g,De as h,Ue as s,Te as u,ze as v};
