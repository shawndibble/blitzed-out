var Q=Object.defineProperty;var ee=(e,t,s)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var S=(e,t,s)=>ee(e,typeof t!="symbol"?t+"":t,s);import{u as te}from"./chunk-L13tEn8b.js";import{u as G}from"./chunk-BVhHzeSz.js";import{x as ne,y as se,u as k,f as q,z as j,B as oe,C as ie,s as x,g as ae,D as re,E as le}from"../assets/index-D_jbYo8z.js";import{i as W,b as H}from"./chunk-C7PvMB7v.js";import{u as F}from"./chunk-DDk6g74G.js";import{ac as T,am as R,r as v,az as ce,ad as X,aq as ue}from"./chunk-CMb_ATvh.js";import{a as de,i as pe}from"./chunk-B4PEA_xj.js";import{u as fe}from"./chunk-DOKcbaC-.js";function L(e){for(let t=e.length-1;t>0;t-=1){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function Ye(e,t){return e?.length!==t?.length?!1:e.every((s,o)=>s===t[o])}const{t:$}=T;class ge{constructor(t){S(this,"bags",new Map);S(this,"originalTiles",new Map);const s=new Map;t.forEach(o=>{const n=`${o.group}-${o.intensity}`;s.has(n)||s.set(n,[]),s.get(n).push(o)}),s.forEach((o,n)=>{const i=[...o];L(i),this.bags.set(n,i),this.originalTiles.set(n,[...o])})}getTile(t,s){const o=`${t}-${s}`;let n=this.bags.get(o);if(!n||n.length===0){const i=this.originalTiles.get(o);if(!i||i.length===0)return null;n=[...i],L(n),this.bags.set(o,n)}return n.pop()||null}}function me(e,t,s=[]){return e.filter(o=>{const n=o.action;return s.find(r=>r.name===o.group)?.type==="consumption"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const O=new Map;function he(e,t,s,o){const n=`${e}-${t}-${s}-${o||"normal"}`,i=O.get(n);if(i!==void 0)return i;let r;if([void 0,"normal"].includes(o)){const a=e/t;r=Math.floor(s/a)+1}else t>=3&&Math.random()>=.6?r=t-1:r=t;return O.set(n,r),r}function Y(e,t,s,o,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=s[r.name];if(!a||a.level<=0)return{title:"",description:""};if(a.variation){const d=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>d)return{title:"",description:""}}const c=Math.max(...r.intensities.map(d=>d.value)),p=he(n,c,o,i.difficulty),u=Math.min(p,a.level);let l=t.getTile(r.name,u);if(!l){for(let d=u-1;d>=1&&(l=t.getTile(r.name,d),!l);d--);if(!l)for(let d=u+1;d<=c&&(l=t.getTile(r.name,d),!l);d++);if(!l)return{title:"",description:""}}return{title:r.label,description:l.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function be(e,t,s,o,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=Y(t,s,o,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function ve(e,t,s,o){const n=s.selectedActions||{},i=new ge(t),r=e.filter(u=>{const l=n[u.name];return l&&l.level>0&&(!l.variation||l.variation==="standalone")}),a=e.filter(u=>{const l=n[u.name];return l&&l.level>0&&(l.variation==="appendSome"||l.variation==="appendMost")});L(r);let c=0;const p=[];for(let u=1;u<=o;u++){const l=r.length>0?[r[c%r.length]]:[];c++;const d=Y(l,i,n,u,o,s),f=be(d,a,i,n,u,o,s);p.push({title:d.title,description:f.trim(),role:d.role})}return p}function w(e,t){const s={title:$("start"),description:$("start")},{finishRange:o=[33,66]}=t,n=`${$("noCum")} ${o[0]}%\r
${$("ruined")} ${o[1]-o[0]}%\r
${$("cum")} ${100-o[1]}%`,i={title:$("finish"),description:n};return[s,...e.map(r=>({title:r.title,description:r.description})),i]}async function $e(e,t,s,o=40){try{const[n,i]=await Promise.all([ne({locale:t,gameMode:s}),se({locale:t,gameMode:s})]),r=e.selectedActions||{},a=Object.keys(r).filter(m=>r[m]?.level>0),c=n.filter(m=>a.includes(m.name)),p=n.map(m=>m.name),u=a.filter(m=>!p.includes(m)),l=e.role||"sub",f=me(i,l,n).filter(m=>a.includes(m.group));if(!c.length||!f.length)return{board:w([],e),metadata:{totalTiles:o+2,tilesWithContent:2,selectedGroups:a,missingGroups:u,availableTileCount:f.length}};const h=await ve(c,f,e,o),b=h.filter(m=>m.description.trim().length>0).length,g=w(h,e);return{board:g,metadata:{totalTiles:g.length,tilesWithContent:b+2,selectedGroups:a,missingGroups:u,availableTileCount:f.length}}}catch(n){return console.error("Error building game board:",n),{board:w([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Ce(){const e=G(q),[t,s]=F(),{i18n:o}=R(),n=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:c}=r;const{roomTileCount:p=40,finishRange:u,room:l}=r,d=W(l||"");if(!i||!u)return{gameMode:a};d&&!H(a||"")&&(a="online",c=!0);const f=a||"online",h=o.resolvedLanguage||"en",b=d?40:p||40,g=await $e(r,h,f,b);return g.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",g.metadata.missingGroups),g.metadata.tilesWithContent<b/2&&console.warn("Low tile content ratio:",{tilesWithContent:g.metadata.tilesWithContent,totalTiles:g.metadata.totalTiles,availableTileCount:g.metadata.availableTileCount}),(i?.boardUpdated||c||(e?.tiles?.length??0)!==g.board.length)&&(await s(r),await k({title:e?.title||"",tiles:g.board})),{settingsBoardUpdated:c,gameMode:a,newBoard:g.board,metadata:g.metadata}},[e,o.resolvedLanguage,t,s]);return v.useCallback(i=>n(i),[n])}const E=50,N=100,U=50,B=1,I=10,M=1,_=10,z=["none","all","default","undefined","null"],ye=["solo","foreplay","sex","consumption"],Te=(e,t="en",s="online",o)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>E&&n.push(`Group name must be ${E} characters or less`),z.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Ae=e=>{const t=[],s=[];return!e||e.trim().length===0?(t.push(ce("groupLabelRequired")),{isValid:!1,errors:t,warnings:s}):(e.trim().length>N&&t.push(`Group label must be ${N} characters or less`),{isValid:t.length===0,errors:t,warnings:s})},Se=e=>{const t=[],s=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:s};e.length<M&&t.push(`At least ${M} intensity level is required`),e.length>_&&t.push(`Maximum ${_} intensity levels allowed`);const o=new Set,n=new Set;for(let a=0;a<e.length;a++){const c=e[a];if((!c.id||c.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!c.label||c.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const p=c.label.trim();p.length>U&&t.push(`Intensity level ${a+1} label must be ${U} characters or less`),n.has(p.toLowerCase())?t.push(`Intensity label "${p}" is used multiple times`):n.add(p.toLowerCase())}typeof c.value!="number"||!Number.isInteger(c.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((c.value<B||c.value>I)&&t.push(`Intensity level ${a+1} value must be between ${B} and ${I}`),o.has(c.value)?t.push(`Intensity value ${c.value} is used multiple times`):o.add(c.value))}const i=Array.from(o).sort((a,c)=>a-c);let r=i[0];for(const a of i){if(a!==r){s.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:s}},ze=async(e,t)=>{const s=[],o=[],n=Te(e.name,e.locale||"en",e.gameMode||"online");s.push(...n.errors),o.push(...n.warnings||[]);const i=Ae(e.label);s.push(...i.errors),o.push(...i.warnings||[]);const r=Se(e.intensities);if(s.push(...r.errors),o.push(...r.warnings||[]),n.isValid&&e.name)try{await oe(e.name,e.locale||"en",e.gameMode||"online",t)||s.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch{o.push("Could not verify group name uniqueness")}return{isValid:s.length===0,errors:s,warnings:o}},Je=async(e,t="en",s="online")=>{const o=[],n=[];if(!e.group||e.group.trim().length===0)return o.push("Tile must belong to a group"),{isValid:!1,errors:o,warnings:n};try{const i=await j(e.group,t,s);if(!i)return o.push(`Group "${e.group}" does not exist for ${t}/${s}`),{isValid:!1,errors:o,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||o.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&o.push("Tile action is required")}catch(i){o.push(`Error validating tile: ${i}`)}return{isValid:o.length===0,errors:o,warnings:n}},we=()=>({MAX_GROUP_NAME_LENGTH:E,MAX_GROUP_LABEL_LENGTH:N,MAX_INTENSITY_LABEL_LENGTH:U,MIN_INTENSITY_VALUE:B,MAX_INTENSITY_VALUE:I,MIN_INTENSITIES_COUNT:M,MAX_INTENSITIES_COUNT:_,RESERVED_GROUP_NAMES:z,VALID_GROUP_TYPES:ye});function Ge(e,t,s){const o=e.selectedActions||{},n=Object.entries(s).filter(([r])=>o[r]).reduce((r,[a,c])=>(r[a]=Object.keys(c.actions).slice(1,o[a].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Le(e,t,s,o){const{t:n}=T;let i=`### ${T.t("gameSettingsHeading")}\r
`;o&&(i+=`##### ${o}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(s).forEach(([u,l])=>{if(!r[u])return;const{role:d,variation:f,level:h}=r[u],b=d||e.role||"sub";if(h>0){const g=Object.keys(l?.actions||{});if(i+=`* ${l?.label}: ${g[h]||""}`,f&&(i+=` (${n(f)})`),!H(e.gameMode)&&!f){const m=l[b]??n(b);i+=` (${m})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const u of e.customGroups)if(u.groupName&&u.intensity)try{const d=(await j(u.groupName,e.locale||"en",e.gameMode||"online"))?.label||u.groupName;i+=`* ${d}: Level ${u.intensity} (Custom)\r
`}catch(l){console.error(`Error loading custom group ${u.groupName}:`,l),i+=`* ${u.groupName}: Level ${u.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a,difficulty:c}=e;i+=`--- \r
`,i+=`* ${n("difficulty")}: ${n(c??"normal")} \r
`,a&&(i+=`* ${n("finishSlider")} ${a[0]}%  | ${a[1]-a[0]}% | ${100-a[1]}% \r
`);const p=Ge(e,t,s);return p&&(i+=`* ${n("customTilesLabel")}: ${p} \r
`),i}function Ee(e){const t={};return Object.entries(e).forEach(([s,o])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(s)&&!s.startsWith("room")&&(t[s]=o)}),t}async function Ne({title:e,formData:t,user:s,actionsList:o,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ee(t)),c=await ie({title:e,gameBoard:JSON.stringify(n),settings:a}),p=await Le(t,i,o,r);if(!(!c?.id||p===""))return x({room:t?.room||"PUBLIC",user:s,text:p,type:"settings",gameBoardId:c.id,boardSize:n.length,gameMode:t.gameMode})}function Ue(e){const{t}=T;let s=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([o,n])=>{if(o!=="room"){if(o==="roomBackgroundURL"&&n!==""){s+=`* ${t(o)}: [${de(n)}:link:](${n})\r
`;return}if(o==="roomRealtime"){s+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(s+=`* ${t(o)}: ${n}\r
`)}}),s}function Be(e){const t={};return Object.entries(e).forEach(([s,o])=>{s.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===s)&&(t[s]=o)}),t}async function Ie(e,t,s){let o=e;return t!==void 0&&t.length>0&&(o=await s(t)),o}function Me(e,t){const s=Be(e);return x({room:e.room,user:t,text:Ue(s),type:"room",settings:JSON.stringify(s)})}function _e(){const{id:e}=X(),t=ue();return s=>{if(e!==void 0&&e?.toUpperCase()!==s?.toUpperCase()){const o=s?.replace(/^\/+/,"")||"PUBLIC";t(`/${o}`)}}}function Re(e){(!e.roomBackgroundURL||!pe(e.roomBackgroundURL))&&(e.roomBackground="app")}function Ve(e){const t={...e},s={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.level>0&&(s[n]=i)});const o=we();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&o.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=s,t}function De(){const{user:e,updateUser:t}=te(),{id:s}=X(),{t:o}=R(),n=Ce(),[i,r]=F(),a=G(()=>ae(i?.gameMode)),c=G(q),p=_e(),{messages:u}=fe(),l=v.useCallback(f=>{const h=s?.toUpperCase()!==f.room.toUpperCase(),b=!!(f.room&&!W(f.room)),g=b&&f.roomTileCount!==i?.roomTileCount;return{roomChanged:h,isPrivateRoom:b,privateBoardSizeChanged:g}},[s,i?.roomTileCount]),d=v.useCallback(async(f,h)=>{const{displayName:b}=f,g=await Ie(e,b,t);Re(f);const{settingsBoardUpdated:m,gameMode:V,newBoard:A=[]}=await n(f),{roomChanged:J,isPrivateRoom:D,privateBoardSizeChanged:Z}=l(f);if(!g)return;D&&(f.roomUpdated||!u.find(y=>y.type==="room"))&&await Me(f,g),c?.tiles!==A&&await k({title:o("settingsGenerated"),tiles:A,isActive:1,gameMode:V}),(m||J||Z)&&!u.some(y=>y.type==="settings"&&y.uid===g.uid&&Date.now()-(y.timestamp?.toMillis()||0)<5e3)&&await Ne({formData:f,user:g,customTiles:a,actionsList:h,title:"Settings Generated Board",tiles:A});const K=Ve(f);r({...K,boardUpdated:!1,roomUpdated:!1,gameMode:V}),p(f.room)},[e,t,n,l,u,c,o,a,r,p]);return v.useCallback((f,h)=>d(f,h),[d])}const C=new Map,P=le;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{C.clear()};function Ze(e){const{i18n:t,t:s}=R(),[o,n]=v.useState({}),[i,r]=v.useState(!0);v.useEffect(()=>{const p=()=>{e&&Array.from(C.keys()).filter(l=>l.endsWith(`-${e}`)).forEach(l=>{C.delete(l)})};return t.on("languageChanged",p),()=>{t.off("languageChanged",p)}},[t,e]);const a=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{if(a){const p=C.get(a);p&&Date.now()-p.timestamp<P&&(n(p.data),r(!1))}},[a]);const c=v.useCallback(async()=>{if(!e||!a){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:a});return}const p=C.get(a);if(p&&Date.now()-p.timestamp<P){n(p.data),r(!1);return}r(!0);try{const u=await re(t.resolvedLanguage,e),l={};for(const d of u){const f={[s("none")]:[]},h={};d.intensities&&Array.isArray(d.intensities)&&d.intensities.sort((g,m)=>g.value-m.value).forEach(g=>{f[g.label]=[],h[g.value]=g.label});const b=d.type||"action";l[d.name]={label:d.label||d.name,type:b,actions:f,intensities:h}}C.set(a,{data:l,timestamp:Date.now()}),n(l)}catch(u){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:u,locale:t.resolvedLanguage,gameMode:e,cacheKey:a}),n({})}finally{r(!1)}},[e,t.resolvedLanguage,a,s]);return v.useEffect(()=>{a&&c()},[c,a]),{actionsList:o,isLoading:i}}export{Me as a,_e as b,Ye as c,De as d,Ze as e,Ae as f,we as g,Je as h,Ne as s,Ce as u,ze as v};
