var te=Object.defineProperty;var ne=(e,t,o)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var E=(e,t,o)=>ne(e,typeof t!="symbol"?t+"":t,o);import{s as W,j as F,t as se,v as oe,w as ie,x as re,u as H,e as X,f as Y,c as ae,y as le,U as ce}from"./chunk-CV1EtLM5.js";import{a as ue,i as de}from"./chunk-CVpt392z.js";import{aa as U,au as ge,ak as O,r as b,ad as J,ai as pe}from"./chunk-D6lSgkQl.js";import{l as fe}from"./chunk-EL58PX5i.js";import{d as z,i as Z,u as me,b as he}from"./chunk-DOmGopoI.js";import{u as N}from"./chunk-CygiBK7d.js";import{u as ve}from"./chunk-DSirq3O1.js";import{u as be}from"./chunk-Yoz82wCl.js";function R(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function De(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}function ye(e){const{t}=U;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${ue(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Ce(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground","roomBackgroundURL"].includes(o)&&(t[o]=s)}),e.roomBackgroundURL&&e.roomBackgroundURL.trim()!==""&&(t.roomBackgroundURL=e.roomBackgroundURL),t}async function $e(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function Te(e,t){const o=Ce(e);return W({room:e.room,user:t,text:ye(o),type:"room",settings:JSON.stringify(o)})}const I=50,M=100,_=50,P=1,V=10,k=1,x=10,K=["none","all","default","undefined","null"],Le=["solo","foreplay","sex","consumption"],Se=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const a=e.trim();return a.length>I&&n.push(`Group name must be ${I} characters or less`),K.includes(a.toLowerCase())&&n.push(`"${a}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(a)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(a)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},we=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(ge("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>M&&t.push(`Group label must be ${M} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},Ae=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<k&&t.push(`At least ${k} intensity level is required`),e.length>x&&t.push(`Maximum ${x} intensity levels allowed`);const s=new Set,n=new Set;for(let r=0;r<e.length;r++){const u=e[r];if((!u.id||u.id.trim().length===0)&&t.push(`Intensity level ${r+1} is missing an ID`),!u.label||u.label.trim().length===0)t.push(`Intensity level ${r+1} is missing a label`);else{const c=u.label.trim();c.length>_&&t.push(`Intensity level ${r+1} label must be ${_} characters or less`),n.has(c.toLowerCase())?t.push(`Intensity label "${c}" is used multiple times`):n.add(c.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?t.push(`Intensity level ${r+1} must have a valid integer value`):((u.value<P||u.value>V)&&t.push(`Intensity level ${r+1} value must be between ${P} and ${V}`),s.has(u.value)?t.push(`Intensity value ${u.value} is used multiple times`):s.add(u.value))}const i=Array.from(s).sort((r,u)=>r-u);let a=i[0];for(const r of i){if(r!==a){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}a++}return{isValid:t.length===0,errors:t,warnings:o}},et=async(e,t)=>{const o=[],s=[],n=Se(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=we(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const a=Ae(e.intensities);if(o.push(...a.errors),s.push(...a.warnings||[]),n.isValid&&e.name)try{await se(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(r){s.push("Could not verify group name uniqueness"),fe.warn("Failed to check group name uniqueness:",!1,r instanceof Error?r.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},tt=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await F(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const a=i.intensities.map(r=>r.value);a.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${a.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Ue=()=>({MAX_GROUP_NAME_LENGTH:I,MAX_GROUP_LABEL_LENGTH:M,MAX_INTENSITY_LABEL_LENGTH:_,MIN_INTENSITY_VALUE:P,MAX_INTENSITY_VALUE:V,MIN_INTENSITIES_COUNT:k,MAX_INTENSITIES_COUNT:x,RESERVED_GROUP_NAMES:K,VALID_GROUP_TYPES:Le});function Ge(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ee(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([a])=>s[a]).reduce((a,[r,u])=>{const c=s[r].levels||[],d=Object.keys(u.actions);return a[r]=c.map(g=>d[g]).filter(Boolean),a},{});return(t?.filter(a=>{if(!a.isCustom)return!1;const r=n[a.group];return r&&r.length>=Number(a.intensity)})||[]).length}async function Be(e,t,o,s){const{t:n}=U;let i=`### ${U.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const a=e.selectedActions||{};if(Object.entries(o).forEach(([c,d])=>{if(!a[c])return;const{role:g,variation:p,levels:f}=a[c],l=g||e.role||"sub";if(f&&f.length>0){i+=d?.label;let v=null;p?v=n(p):z(e.gameMode)||(v=Ge(d,l)?d[l]:n(l)),v&&(i+=`: ${v}`),i+=`\r
`;const h=d?.intensities||{};f.forEach(m=>{const y=h[m]||`Level ${m}`;i+=`* ${y}\r
`}),i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const g=(await F(c.groupName,e.locale||"en",e.gameMode||"online"))?.label||c.groupName;i+=`* ${g}: Level ${c.intensity} (Custom)\r
`}catch(d){console.error(`Error loading custom group ${c.groupName}:`,d),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:r}=e;if(i+=`--- \r
`,r){const c=r[0],d=r[1]-r[0],g=100-r[1],f=[c>0?{percent:c,text:n("noCum")}:null,d>0?{percent:d,text:n("ruined")}:null,g>0?{percent:g,text:n("cum")}:null].filter(l=>l!==null);f.length===1&&f[0].percent===100?i+=`* ${n("finishSlider")} ${f[0].text.replace(":","")} \r
`:f.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,f.forEach(l=>{const v=l.percent===100?l.text.replace(":",""):`${l.text} ${l.percent}%`;i+=`  - ${v} \r
`}))}const u=Ee(e,t,o);return u&&(i+=`* ${n("customTilesLabel")}: ${u} \r
`),i}function Ne(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Re({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:a=""}){const r=JSON.stringify(Ne(t)),u=await oe({title:e,gameBoard:JSON.stringify(n),settings:r}),c=await Be(t,i,s,a);if(!(!u?.id||c===""))return W({room:t?.room||"PUBLIC",user:o,text:c,type:"settings",gameBoardId:u.id,boardSize:n.length,gameMode:t.gameMode})}const{t:S}=U;class Ie{constructor(t){E(this,"bags",new Map);E(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];R(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],R(n),this.bags.set(s,n)}return n.pop()||null}}function Me(e,t,o=[]){return e.filter(s=>{const n=s.action,i=o.find(a=>a.name===s.group);return i?.type==="consumption"||i?.type==="solo"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const q=new Map;function _e(e,t,o){const s=`${e}-${t}-${o}`,n=q.get(s);if(n!==void 0)return n;const i=e/t,a=Math.floor(o/i)+1;return q.set(s,a),a}function Q(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const a=e[0],r=o[a.name];if(!r||!r.levels||r.levels.length===0)return{title:"",description:""};if(r.variation){const f=r.variation==="appendSome"?.4:r.variation==="appendMost"?.9:1;if(r.variation!=="standalone"&&Math.random()>f)return{title:"",description:""}}const u=Math.max(...a.intensities.map(f=>f.value)),c=_e(n,u,s),d=r.levels;let g;d.includes(c)?g=c:g=d.reduce((f,l)=>Math.abs(l-c)<Math.abs(f-c)?l:f);let p=t.getTile(a.name,g);if(!p){const f=d.filter(l=>l!==g);for(const l of f)if(p=t.getTile(a.name,l),p)break;if(!p)return{title:"",description:""}}return{title:a.label,description:p.action,standalone:r.variation==="standalone",role:i.role||"sub"}}function Pe(e,t,o,s,n,i,a){if(e.standalone||!t.length||!e.description)return e.description||"";const r=Q(t,o,s,n,i,a);return r.description?`${r.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Ve(e,t,o,s){const n=o.selectedActions||{},i=new Ie(t),a=e.filter(d=>{const g=n[d.name];return g&&g.levels&&g.levels.length>0&&(!g.variation||g.variation==="standalone")}),r=e.filter(d=>{const g=n[d.name];return g&&g.levels&&g.levels.length>0&&(g.variation==="appendSome"||g.variation==="appendMost")});R(a);let u=0;const c=[];for(let d=1;d<=s;d++){const g=a.length>0?[a[u%a.length]]:[];u++;const p=Q(g,i,n,d,s,o),f=Pe(p,r,i,n,d,s,o);c.push({title:p.title,description:f.trim(),role:p.role})}return c}function B(e,t){const o={title:S("start"),description:S("start")},{finishRange:s=[33,66]}=t,n=`${S("noCum")} ${s[0]}%\r
${S("ruined")} ${s[1]-s[0]}%\r
${S("cum")} ${100-s[1]}%`,i={title:S("finish"),description:n};return[o,...e.map(a=>({title:a.title,description:a.description})),i]}async function ke(e,t,o,s=40){try{const[n,i]=await Promise.all([ie({locale:t,gameMode:o}),re({locale:t,gameMode:o})]),a=e.selectedActions||{},r=Object.keys(a).filter(m=>a[m]?.levels&&a[m].levels.length>0),u=n.filter(m=>r.includes(m.name)),c=n.map(m=>m.name),d=r.filter(m=>!c.includes(m)),g=e.role||"sub",f=Me(i,g,n).filter(m=>r.includes(m.group));if(!u.length||!f.length)return{board:B([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:r,missingGroups:d,availableTileCount:f.length}};const l=await Ve(u,f,e,s),v=l.filter(m=>m.description.trim().length>0).length,h=B(l,e);return{board:h,metadata:{totalTiles:h.length,tilesWithContent:v+2,selectedGroups:r,missingGroups:d,availableTileCount:f.length}}}catch(n){return console.error("Error building game board:",n),{board:B([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function xe(){const e=N(Y),[t,o]=H(),{i18n:s}=O(),n=b.useCallback(async i=>{const a=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:r,boardUpdated:u}=a;const{roomTileCount:c=40,finishRange:d,room:g}=a,p=Z(g||"");if(!i||!d)return{gameMode:r};p&&!z(r||"")&&(r="online",u=!0);const f=r||"online",l=s.resolvedLanguage||"en",v=p?40:c||40,h=await ke(a,l,f,v);return h.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",h.metadata.missingGroups),h.metadata.tilesWithContent<v/2&&console.warn("Low tile content ratio:",{tilesWithContent:h.metadata.tilesWithContent,totalTiles:h.metadata.totalTiles,availableTileCount:h.metadata.availableTileCount}),(i?.boardUpdated||u||(e?.tiles?.length??0)!==h.board.length)&&(await o(a),await X({title:e?.title||"",tiles:h.board})),{settingsBoardUpdated:u,gameMode:r,newBoard:h.board,metadata:h.metadata}},[e,s.resolvedLanguage,t,o]);return b.useCallback(i=>n(i),[n])}function Oe(){const{id:e}=J(),t=pe();return o=>{const s=e!==void 0&&e?.toUpperCase()!==o?.toUpperCase(),n=o?.replace(/^\/+/,"")||"PUBLIC";s&&t(`/${n}`)}}function qe(e){const t=e.roomBackgroundURL?.trim();t!==e.roomBackgroundURL&&(e.roomBackgroundURL=t||""),e.roomBackgroundURL&&!de(e.roomBackgroundURL)&&(e.roomBackgroundURL="")}function je(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.levels&&i.levels.length>0&&(o[n]=i)});const s=Ue();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function nt(){const{user:e,updateUser:t}=me(),{id:o}=J(),{t:s}=O(),n=xe(),[i,a]=H(),r=N(()=>ae(i?.gameMode)),u=N(Y),c=Oe(),{messages:d}=he(),{createLocalSession:g}=ve(),p=b.useCallback(l=>{const v=(o||"")?.toUpperCase(),h=(l.room||"").toUpperCase(),m=v!==h,y=!!(l.room&&!Z(l.room)),$=y&&l.roomTileCount!==i?.roomTileCount;return{roomChanged:m,isPrivateRoom:y,privateBoardSizeChanged:$}},[o,i?.roomTileCount]),f=b.useCallback(async(l,v)=>{const{displayName:h}=l,m=await $e(e,h,t);qe(l);const{settingsBoardUpdated:y,gameMode:$,newBoard:w=[]}=await n(l),{roomChanged:T,isPrivateRoom:G,privateBoardSizeChanged:D}=p(l);if(!m)return;G&&(l.roomUpdated||!d.find(L=>L.type==="room"))&&await Te(l,m),u?.tiles!==w&&await X({title:s("settingsGenerated"),tiles:w,isActive:1,gameMode:$}),(y||T||D)&&!d.some(L=>L.type==="settings"&&L.uid===m.uid&&Date.now()-(L.timestamp?.toMillis()||0)<5e3)&&await Re({formData:l,user:m,customTiles:r,actionsList:v,title:"Settings Generated Board",tiles:w});const A=l;if(A.hasLocalPlayers&&A.localPlayersData&&A.localPlayerSessionSettings)try{await g(l.room,A.localPlayersData,A.localPlayerSessionSettings)}catch(L){console.error("Error creating local session:",L)}const ee=je(l);a({...ee,boardUpdated:!1,roomUpdated:!1,gameMode:$}),c(l.room)},[e,t,n,p,d,u,s,r,a,c,g]);return b.useCallback((l,v)=>f(l,v),[f])}const C=new Map,j=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{C.clear()};function st(e){const{i18n:t,t:o}=O(),{currentLanguageMigrated:s,isHealthy:n,forceRecovery:i}=be(),[a,r]=b.useState({}),[u,c]=b.useState(!0),[d,g]=b.useState(!1);b.useEffect(()=>{const l=()=>{e&&Array.from(C.keys()).filter(h=>h.endsWith(`-${e}`)).forEach(h=>{C.delete(h)})};return t.on("languageChanged",l),()=>{t.off("languageChanged",l)}},[t,e]);const p=b.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);b.useEffect(()=>{s&&p&&C.get(p)&&C.delete(p)},[s,p]),b.useEffect(()=>{if(p){const l=C.get(p);l&&Date.now()-l.timestamp<j&&(r(l.data),c(!1))}},[p]);const f=b.useCallback(async()=>{if(!e||!p){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:p});return}if(!s)return;if(s&&!n&&!d){g(!0);try{await i();return}catch{}}const l=C.get(p);if(l&&Date.now()-l.timestamp<j){r(l.data),c(!1);return}c(!0);try{const v=await le(t.resolvedLanguage,e),h={};for(const m of v){const y={[o("none")]:[]},$={};m.intensities&&Array.isArray(m.intensities)&&m.intensities.sort((T,G)=>T.value-G.value).forEach(T=>{y[T.label]=[],$[T.value]=T.label});const w=m.type||"action";h[m.name]={label:m.label||m.name,type:w,actions:y,intensities:$}}C.set(p,{data:h,timestamp:Date.now()}),r(h)}catch(v){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:v,locale:t.resolvedLanguage,gameMode:e,cacheKey:p}),r({})}finally{c(!1)}},[e,t.resolvedLanguage,p,o,s,n,d,i]);return b.useEffect(()=>{p&&s&&f()},[f,p,s,n]),{actionsList:a,isLoading:u}}export{nt as a,st as b,De as c,we as d,tt as e,Te as f,Ue as g,Re as s,xe as u,et as v};
