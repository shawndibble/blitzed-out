var te=Object.defineProperty;var ne=(e,t,o)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var U=(e,t,o)=>ne(e,typeof t!="symbol"?t+"":t,o);import{s as W,j as F,t as se,v as oe,w as ie,x as ae,u as H,e as X,f as Y,c as re,y as le,U as ce}from"./chunk-DrK7-sOk.js";import{a as ue,i as de}from"./chunk-B4PEA_xj.js";import{aa as G,au as pe,ak as k,r as b,ad as D,ai as ge}from"./chunk-CXdXj9vr.js";import{l as fe}from"./chunk-yLOK5aTh.js";import{d as J,i as z,u as me,b as he}from"./chunk-CIcWkKG8.js";import{u as I}from"./chunk-CwpkSHF3.js";import{u as ve}from"./chunk-CnNtW2n0.js";import{u as be}from"./chunk-BmK5-9ou.js";function B(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Qe(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}function ye(e){const{t}=G;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${ue(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Ce(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===o)&&(t[o]=s)}),t}async function $e(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function Te(e,t){const o=Ce(e);return W({room:e.room,user:t,text:ye(o),type:"room",settings:JSON.stringify(o)})}const M=50,R=100,_=50,P=1,V=10,x=1,O=10,Z=["none","all","default","undefined","null"],Se=["solo","foreplay","sex","consumption"],we=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>M&&n.push(`Group name must be ${M} characters or less`),Z.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Ae=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(pe("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>R&&t.push(`Group label must be ${R} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},Le=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<x&&t.push(`At least ${x} intensity level is required`),e.length>O&&t.push(`Maximum ${O} intensity levels allowed`);const s=new Set,n=new Set;for(let a=0;a<e.length;a++){const u=e[a];if((!u.id||u.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!u.label||u.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const c=u.label.trim();c.length>_&&t.push(`Intensity level ${a+1} label must be ${_} characters or less`),n.has(c.toLowerCase())?t.push(`Intensity label "${c}" is used multiple times`):n.add(c.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((u.value<P||u.value>V)&&t.push(`Intensity level ${a+1} value must be between ${P} and ${V}`),s.has(u.value)?t.push(`Intensity value ${u.value} is used multiple times`):s.add(u.value))}const i=Array.from(s).sort((a,u)=>a-u);let r=i[0];for(const a of i){if(a!==r){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:o}},et=async(e,t)=>{const o=[],s=[],n=we(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=Ae(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const r=Le(e.intensities);if(o.push(...r.errors),s.push(...r.warnings||[]),n.isValid&&e.name)try{await se(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(a){s.push("Could not verify group name uniqueness"),fe.warn("Failed to check group name uniqueness:",!1,a instanceof Error?a.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},tt=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await F(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Ge=()=>({MAX_GROUP_NAME_LENGTH:M,MAX_GROUP_LABEL_LENGTH:R,MAX_INTENSITY_LABEL_LENGTH:_,MIN_INTENSITY_VALUE:P,MAX_INTENSITY_VALUE:V,MIN_INTENSITIES_COUNT:x,MAX_INTENSITIES_COUNT:O,RESERVED_GROUP_NAMES:Z,VALID_GROUP_TYPES:Se});function Ee(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ue(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([r])=>s[r]).reduce((r,[a,u])=>{const c=s[a].levels||[],d=Object.keys(u.actions);return r[a]=c.map(p=>d[p]).filter(Boolean),r},{});return(t?.filter(r=>{if(!r.isCustom)return!1;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Ne(e,t,o,s){const{t:n}=G;let i=`### ${G.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(o).forEach(([c,d])=>{if(!r[c])return;const{role:p,variation:g,levels:f}=r[c],l=p||e.role||"sub";if(f&&f.length>0){i+=d?.label;let v=null;g?v=n(g):J(e.gameMode)||(v=Ee(d,l)?d[l]:n(l)),v&&(i+=`: ${v}`),i+=`\r
`;const h=d?.intensities||{};f.forEach(m=>{const y=h[m]||`Level ${m}`;i+=`* ${y}\r
`}),i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const p=(await F(c.groupName,e.locale||"en",e.gameMode||"online"))?.label||c.groupName;i+=`* ${p}: Level ${c.intensity} (Custom)\r
`}catch(d){console.error(`Error loading custom group ${c.groupName}:`,d),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a}=e;if(i+=`--- \r
`,a){const c=a[0],d=a[1]-a[0],p=100-a[1],f=[c>0?{percent:c,text:n("noCum")}:null,d>0?{percent:d,text:n("ruined")}:null,p>0?{percent:p,text:n("cum")}:null].filter(l=>l!==null);f.length===1&&f[0].percent===100?i+=`* ${n("finishSlider")} ${f[0].text.replace(":","")} \r
`:f.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,f.forEach(l=>{const v=l.percent===100?l.text.replace(":",""):`${l.text} ${l.percent}%`;i+=`  - ${v} \r
`}))}const u=Ue(e,t,o);return u&&(i+=`* ${n("customTilesLabel")}: ${u} \r
`),i}function Ie(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Be({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ie(t)),u=await oe({title:e,gameBoard:JSON.stringify(n),settings:a}),c=await Ne(t,i,s,r);if(!(!u?.id||c===""))return W({room:t?.room||"PUBLIC",user:o,text:c,type:"settings",gameBoardId:u.id,boardSize:n.length,gameMode:t.gameMode})}const{t:w}=G;class Me{constructor(t){U(this,"bags",new Map);U(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];B(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],B(n),this.bags.set(s,n)}return n.pop()||null}}function Re(e,t,o=[]){return e.filter(s=>{const n=s.action,i=o.find(r=>r.name===s.group);return i?.type==="consumption"||i?.type==="solo"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const q=new Map;function _e(e,t,o){const s=`${e}-${t}-${o}`,n=q.get(s);if(n!==void 0)return n;const i=e/t,r=Math.floor(o/i)+1;return q.set(s,r),r}function K(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=o[r.name];if(!a||!a.levels||a.levels.length===0)return{title:"",description:""};if(a.variation){const f=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>f)return{title:"",description:""}}const u=Math.max(...r.intensities.map(f=>f.value)),c=_e(n,u,s),d=a.levels;let p;d.includes(c)?p=c:p=d.reduce((f,l)=>Math.abs(l-c)<Math.abs(f-c)?l:f);let g=t.getTile(r.name,p);if(!g){const f=d.filter(l=>l!==p);for(const l of f)if(g=t.getTile(r.name,l),g)break;if(!g)return{title:"",description:""}}return{title:r.label,description:g.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function Pe(e,t,o,s,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=K(t,o,s,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Ve(e,t,o,s){const n=o.selectedActions||{},i=new Me(t),r=e.filter(d=>{const p=n[d.name];return p&&p.levels&&p.levels.length>0&&(!p.variation||p.variation==="standalone")}),a=e.filter(d=>{const p=n[d.name];return p&&p.levels&&p.levels.length>0&&(p.variation==="appendSome"||p.variation==="appendMost")});B(r);let u=0;const c=[];for(let d=1;d<=s;d++){const p=r.length>0?[r[u%r.length]]:[];u++;const g=K(p,i,n,d,s,o),f=Pe(g,a,i,n,d,s,o);c.push({title:g.title,description:f.trim(),role:g.role})}return c}function N(e,t){const o={title:w("start"),description:w("start")},{finishRange:s=[33,66]}=t,n=`${w("noCum")} ${s[0]}%\r
${w("ruined")} ${s[1]-s[0]}%\r
${w("cum")} ${100-s[1]}%`,i={title:w("finish"),description:n};return[o,...e.map(r=>({title:r.title,description:r.description})),i]}async function xe(e,t,o,s=40){try{const[n,i]=await Promise.all([ie({locale:t,gameMode:o}),ae({locale:t,gameMode:o})]),r=e.selectedActions||{},a=Object.keys(r).filter(m=>r[m]?.levels&&r[m].levels.length>0),u=n.filter(m=>a.includes(m.name)),c=n.map(m=>m.name),d=a.filter(m=>!c.includes(m)),p=e.role||"sub",f=Re(i,p,n).filter(m=>a.includes(m.group));if(!u.length||!f.length)return{board:N([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:d,availableTileCount:f.length}};const l=await Ve(u,f,e,s),v=l.filter(m=>m.description.trim().length>0).length,h=N(l,e);return{board:h,metadata:{totalTiles:h.length,tilesWithContent:v+2,selectedGroups:a,missingGroups:d,availableTileCount:f.length}}}catch(n){return console.error("Error building game board:",n),{board:N([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Oe(){const e=I(Y),[t,o]=H(),{i18n:s}=k(),n=b.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:u}=r;const{roomTileCount:c=40,finishRange:d,room:p}=r,g=z(p||"");if(!i||!d)return{gameMode:a};g&&!J(a||"")&&(a="online",u=!0);const f=a||"online",l=s.resolvedLanguage||"en",v=g?40:c||40,h=await xe(r,l,f,v);return h.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",h.metadata.missingGroups),h.metadata.tilesWithContent<v/2&&console.warn("Low tile content ratio:",{tilesWithContent:h.metadata.tilesWithContent,totalTiles:h.metadata.totalTiles,availableTileCount:h.metadata.availableTileCount}),(i?.boardUpdated||u||(e?.tiles?.length??0)!==h.board.length)&&(await o(r),await X({title:e?.title||"",tiles:h.board})),{settingsBoardUpdated:u,gameMode:a,newBoard:h.board,metadata:h.metadata}},[e,s.resolvedLanguage,t,o]);return b.useCallback(i=>n(i),[n])}function ke(){const{id:e}=D(),t=ge();return o=>{const s=e!==void 0&&e?.toUpperCase()!==o?.toUpperCase(),n=o?.replace(/^\/+/,"")||"PUBLIC";s&&t(`/${n}`)}}function qe(e){(!e.roomBackgroundURL||!de(e.roomBackgroundURL))&&(e.roomBackground="app")}function je(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.levels&&i.levels.length>0&&(o[n]=i)});const s=Ge();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function nt(){const{user:e,updateUser:t}=me(),{id:o}=D(),{t:s}=k(),n=Oe(),[i,r]=H(),a=I(()=>re(i?.gameMode)),u=I(Y),c=ke(),{messages:d}=he(),{createLocalSession:p}=ve(),g=b.useCallback(l=>{const v=(o||"")?.toUpperCase(),h=(l.room||"").toUpperCase(),m=v!==h,y=!!(l.room&&!z(l.room)),$=y&&l.roomTileCount!==i?.roomTileCount;return{roomChanged:m,isPrivateRoom:y,privateBoardSizeChanged:$}},[o,i?.roomTileCount]),f=b.useCallback(async(l,v)=>{const{displayName:h}=l,m=await $e(e,h,t);qe(l);const{settingsBoardUpdated:y,gameMode:$,newBoard:A=[]}=await n(l),{roomChanged:T,isPrivateRoom:E,privateBoardSizeChanged:Q}=g(l);if(!m)return;E&&(l.roomUpdated||!d.find(S=>S.type==="room"))&&await Te(l,m),u?.tiles!==A&&await X({title:s("settingsGenerated"),tiles:A,isActive:1,gameMode:$}),(y||T||Q)&&!d.some(S=>S.type==="settings"&&S.uid===m.uid&&Date.now()-(S.timestamp?.toMillis()||0)<5e3)&&await Be({formData:l,user:m,customTiles:a,actionsList:v,title:"Settings Generated Board",tiles:A});const L=l;if(L.hasLocalPlayers&&L.localPlayersData&&L.localPlayerSessionSettings)try{await p(l.room,L.localPlayersData,L.localPlayerSessionSettings)}catch(S){console.error("Error creating local session:",S)}const ee=je(l);r({...ee,boardUpdated:!1,roomUpdated:!1,gameMode:$}),c(l.room)},[e,t,n,g,d,u,s,a,r,c,p]);return b.useCallback((l,v)=>f(l,v),[f])}const C=new Map,j=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{C.clear()};function st(e){const{i18n:t,t:o}=k(),{currentLanguageMigrated:s,isHealthy:n,forceRecovery:i}=be(),[r,a]=b.useState({}),[u,c]=b.useState(!0),[d,p]=b.useState(!1);b.useEffect(()=>{const l=()=>{e&&Array.from(C.keys()).filter(h=>h.endsWith(`-${e}`)).forEach(h=>{C.delete(h)})};return t.on("languageChanged",l),()=>{t.off("languageChanged",l)}},[t,e]);const g=b.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);b.useEffect(()=>{s&&g&&C.get(g)&&C.delete(g)},[s,g]),b.useEffect(()=>{if(g){const l=C.get(g);l&&Date.now()-l.timestamp<j&&(a(l.data),c(!1))}},[g]);const f=b.useCallback(async()=>{if(!e||!g){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:g});return}if(!s)return;if(s&&!n&&!d){p(!0);try{await i();return}catch{}}const l=C.get(g);if(l&&Date.now()-l.timestamp<j){a(l.data),c(!1);return}c(!0);try{const v=await le(t.resolvedLanguage,e),h={};for(const m of v){const y={[o("none")]:[]},$={};m.intensities&&Array.isArray(m.intensities)&&m.intensities.sort((T,E)=>T.value-E.value).forEach(T=>{y[T.label]=[],$[T.value]=T.label});const A=m.type||"action";h[m.name]={label:m.label||m.name,type:A,actions:y,intensities:$}}C.set(g,{data:h,timestamp:Date.now()}),a(h)}catch(v){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:v,locale:t.resolvedLanguage,gameMode:e,cacheKey:g}),a({})}finally{c(!1)}},[e,t.resolvedLanguage,g,o,s,n,d,i]);return b.useEffect(()=>{g&&s&&f()},[f,g,s,n]),{actionsList:r,isLoading:u}}export{nt as a,st as b,Qe as c,Ae as d,tt as e,Te as f,Ge as g,Be as s,Oe as u,et as v};
