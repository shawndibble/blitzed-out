const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/migrationService.ts-csgod9ZP.js","assets/index-CNaEWhRY.js","js/chunk-DvBFtIbM.js","js/chunk-5s7Iwv9W.js","js/chunk-CAnobccy.js","js/chunk-BWOMt2st.js","js/chunk-DXz8SlaL.js"])))=>i.map(i=>d[i]);
import{_ as N}from"../assets/index-CNaEWhRY.js";import{r as l,ak as P,j as $}from"./chunk-DvBFtIbM.js";import{x as D}from"./chunk-BWOMt2st.js";import{i as M}from"./chunk-CAnobccy.js";const j=a=>{const t={};for(const e of a){const i={label:e.label||e.name,type:e.type||"action",actions:{None:[]}};if(e.intensities&&Array.isArray(e.intensities))for(const g of e.intensities)i.actions[g.label]=[];t[e.name]=i}return t},z=async(a="en",t="online")=>{try{const e=await D(a,t);return j(e)}catch(e){return console.error("Error importing actions from Dexie:",e),{}}},G=async(a="en",t="online")=>{try{const[e,i]=await Promise.all([z(a,t).catch(()=>({})),D(a,t).catch(()=>[])]),g=Object.keys(e).length;if(i.length<g)return!1;const d=Object.keys(e),o=new Set(i.map(p=>p.name));for(const p of d)if(!o.has(p))return!1;return!0}catch(e){return console.error("Error in isDexieDataComplete:",e),!1}},E="blitzed-out-migration-health",k=3,q=300*1e3,H=()=>{try{const a=localStorage.getItem(E);return a?JSON.parse(a):{}}catch(a){return console.warn("Failed to load migration health state:",a),{}}},w=(a,t,e)=>{try{const i=`${a}-${t}`,g=H();g[i]={failureCount:0,lastValidation:new Date().toISOString(),consecutiveFailures:0,...g[i],...e},localStorage.setItem(E,JSON.stringify(g))}catch(i){console.warn("Failed to update migration health state:",i)}},L=async(a,t="online")=>{const e=a||M.resolvedLanguage||M.language||"en",i=`${e}-${t}`,s=H()[i]||{failureCount:0,lastValidation:new Date(0).toISOString(),consecutiveFailures:0},d={...s,lastValidation:new Date(s.lastValidation)},o={isHealthy:!1,requiresRecovery:!1,lastValidation:d.lastValidation,failureCount:d.failureCount,details:{migrationStatus:"incomplete",dataComplete:!1,locale:e,gameMode:t}};try{if(Date.now()-d.lastValidation.getTime()<q&&d.consecutiveFailures===0)return o.isHealthy=!0,o.details.migrationStatus="completed",o.details.dataComplete=!0,o;const c=await G(e,t);if(o.details.dataComplete=c,c)o.isHealthy=!0,o.details.migrationStatus="completed",w(e,t,{consecutiveFailures:0,lastValidation:new Date().toISOString()});else{const S=J();o.details.migrationStatus=S;const h=d.failureCount+1,y=d.consecutiveFailures+1;w(e,t,{failureCount:h,consecutiveFailures:y,lastValidation:new Date().toISOString()}),o.failureCount=h,o.requiresRecovery=y>=k,o.requiresRecovery&&(o.details.errorMessage=`Migration failed ${y} consecutive times. Data incomplete for ${e}/${t}.`)}return o}catch(p){console.error("Migration health check failed:",p);const c=d.failureCount+1,S=d.consecutiveFailures+1;return w(e,t,{failureCount:c,consecutiveFailures:S,lastValidation:new Date().toISOString()}),o.failureCount=c,o.requiresRecovery=S>=k,o.details.migrationStatus="failed",o.details.errorMessage=`Health check failed: ${p instanceof Error?p.message:String(p)}`,o}},J=()=>{try{const a=localStorage.getItem("blitzed-out-action-groups-migration");if(a){const e=JSON.parse(a);if(e.completed&&e.version==="2.1.1")return"completed"}const t=localStorage.getItem("blitzed-out-background-migration");if(t){const e=JSON.parse(t);if(e.completedLanguages&&e.completedLanguages.length>0)return"completed"}return"incomplete"}catch(a){return console.warn("Failed to check migration status from storage:",a),"incomplete"}},x=async(a,t="online")=>{const e=a||M.resolvedLanguage||M.language||"en";try{const i=["blitzed-out-migration-in-progress","blitzed-out-current-language-migration","blitzed-out-background-migration-in-progress"];let g=!1;i.forEach(s=>{try{localStorage.removeItem(s)}catch(d){console.warn(`Failed to remove ${s}:`,d),g=!0}});try{w(e,t,{failureCount:0,consecutiveFailures:0,lastValidation:new Date(0).toISOString()})}catch(s){console.warn("Failed to update health state:",s),g=!0}return!g}catch(i){return console.error("Migration recovery failed:",i),!1}},T=l.createContext(void 0);function K(){const a=l.useContext(T);if(a===void 0)throw new Error("useMigration must be used within a MigrationProvider");return a}function Y({children:a}){const{i18n:t}=P(),[e,i]=l.useState(!1),[g,s]=l.useState(!1),[d,o]=l.useState(!1),[p,c]=l.useState(null),[S,h]=l.useState(!1),[y,I]=l.useState(!1),[v,_]=l.useState(null),m=l.useCallback(async()=>await N(()=>import("./migrationService.ts-csgod9ZP.js"),__vite__mapDeps([0,1,2,3,4,5,6])),[]);l.useEffect(()=>{const n=async()=>{try{const u=await m(),r=t.language||"en",f=u.isCurrentLanguageMigrationCompleted(r),C=u.isMigrationCompleted();if(s(f),o(C),f){const F=await L(r,"online");h(F.isHealthy),!F.isHealthy&&F.requiresRecovery&&!y&&(I(!0),await x(r,"online")?(s(!1),c(null)):c("Migration recovery failed. Some features may not work correctly."))}}catch(u){console.warn("Failed to check migration status:",u),c("Failed to check migration status"),h(!1)}};t.language&&t.language!=="undefined"&&n()},[t.language,m,y]);const O=l.useCallback(async()=>{const n=t.language||"en";try{if(i(!0),c(null),await x(n,"online")){I(!0),s(!1),h(!1);const r=await m();if(await r.runMigrationIfNeeded()){await r.cleanupDuplicatesIfNeeded(),s(!0),o(r.isMigrationCompleted());const C=await L(n,"online");h(C.isHealthy)}}else c("Force recovery failed. Please try refreshing the page.")}catch(u){console.error("Force recovery failed:",u),c("Force recovery failed. Please try refreshing the page.")}finally{i(!1)}},[t.language,m]),A=l.useCallback(async()=>{if(!e){i(!0),c(null);try{const n=await m();if(await n.runMigrationIfNeeded()){await n.cleanupDuplicatesIfNeeded(),s(!0),o(n.isMigrationCompleted());const r=t.language||"en",f=await L(r,"online");h(f.isHealthy),f.isHealthy||c("Migration completed but data validation failed. Some features may not work correctly.")}else c("Migration failed but app will continue with existing data"),h(!1)}catch(n){console.error("Migration failed:",n),c("Migration failed but app will continue with existing data"),h(!1)}finally{i(!1)}}},[e,m,t.language]),b=l.useCallback(n=>{v&&clearTimeout(v);const u=setTimeout(async()=>{try{const r=await m();if(r.isCurrentLanguageMigrationCompleted(n)){s(!0);return}i(!0),c(null),await r.ensureLanguageMigrated(n)?(s(!0),o(r.isMigrationCompleted())):c("Migration failed but app will continue with existing data")}catch(r){console.error(`Failed to migrate language ${n}:`,r),c("Migration failed but app will continue with existing data")}finally{i(!1)}},300);_(u)},[v,m]),R=l.useCallback(async n=>{const u=n||t.language||"en";try{const r=await m();if(r.isCurrentLanguageMigrationCompleted(u))return s(!0),!0;i(!0);const f=await r.ensureLanguageMigrated(u);return f&&s(!0),f}catch(r){return console.error(`Failed to ensure ${u} migration:`,r),!1}finally{i(!1)}},[t.language,m]);l.useEffect(()=>{if(!t.language||t.language==="undefined")return;const n=r=>{b(r)};return t.on("languageChanged",n),(async()=>{try{const r=await m(),f=t.language||"en",C=r.isCurrentLanguageMigrationCompleted(f);s(C),!C&&!e&&b(f)}catch(r){console.warn("Failed to check initial migration status:",r)}})(),()=>{t.off("languageChanged",n),v&&clearTimeout(v)}},[t,b,e,v,m]);const V={isMigrationCompleted:d,isMigrationInProgress:e,currentLanguageMigrated:g,error:p,isHealthy:S,recoveryAttempted:y,triggerMigration:A,ensureLanguageMigrated:R,forceRecovery:O};return $.jsx(T.Provider,{value:V,children:a})}const Z=Object.freeze(Object.defineProperty({__proto__:null,MigrationProvider:Y,useMigration:K},Symbol.toStringTag,{value:"Module"}));export{z as i,Z as m,K as u};
