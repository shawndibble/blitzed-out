const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/syncOrchestrator.ts-CkOeyW02.js","js/chunk-Cyt02cKC.js","js/chunk-CWxWCCzs.js","js/chunk-CR4GjU2t.js","js/chunk-BRtkROVE.js","js/migrationService.ts-BG1W09SZ.js","js/chunk-C7mfLpWK.js","assets/index-o_3bxXCz.js","js/syncRecoveryService.ts-C4J_SsLb.js"])))=>i.map(i=>d[i]);
import{w as st,c as Nt,a as $t,b as Ft,i as Y,d as be,R as Z,r as g,j as U,e as Ht,B as jt,f as qt,u as zt,g as at,h as Fe,k as Vt,T as Wt,C as Yt,l as it,m as Kt}from"./chunk-CWxWCCzs.js";import{s as Qt,D as Jt,n as ct,p as ut,i as Xt,d as Zt}from"./chunk-BRtkROVE.js";import{L as er,A as tr}from"./chunk-CR4GjU2t.js";import{i as rr,g as lt,a as R,E as nr,l as or,s as dt,b as sr,u as Le,c as ar,G as ir,d as cr,e as ur,f as lr,h as _e,j as z,T as dr,k as gr,m as fr,n as Q,o as gt,p as mr,q as se,w as ae,r as me,t as pe,v as ft,x as mt,y as pr,z as hr,A as yr,B as wr,C as ve}from"./chunk-Cyt02cKC.js";(function(){try{var t=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{};t.SENTRY_RELEASE={id:"e813eec1e7bc9496fb578434805a43cbb313f9b2"}}catch(e){}})();try{(function(){var t=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{},e=new t.Error().stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="6b454497-d648-4d02-a7fe-e6c947887d7b",t._sentryDebugIdIdentifier="sentry-dbid-6b454497-d648-4d02-a7fe-e6c947887d7b")})()}catch(t){}const br="modulepreload",_r=function(t){return"/"+t},He={},M=function(e,r,n){let o=Promise.resolve();if(r&&r.length>0){let c=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));o=c(r.map(u=>{if(u=_r(u),u in He)return;He[u]=!0;const d=u.endsWith(".css"),l=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${l}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":br,d||(m.as="script"),m.crossOrigin="",m.href=u,i&&m.setAttribute("nonce",i),document.head.appendChild(m),d)return new Promise((b,v)=>{m.addEventListener("load",b),m.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return o.then(a=>{for(const i of a||[])i.status==="rejected"&&s(i.reason);return e().catch(s)})};class oe extends Error{constructor(e,r,n){super(e),this.code=r,this.cause=n,this.name="AppError"}}class ee extends oe{constructor(e,r,n){super(e,r,n),this.name="AuthError"}}function pt(t){return t instanceof oe}function ke(t){return t instanceof Error}function j(t){return ke(t)?t.message:typeof t=="string"?t:"An unknown error occurred"}function vr(t){if(pt(t)||ke(t)&&"code"in t)return t.code}function te(t,e="An unexpected error occurred"){return pt(t)?t:ke(t)?new oe(t.message||e,void 0,t):typeof t=="string"?new oe(t):new oe(e)}const je={"auth/user-not-found":"No account found with this email address","auth/wrong-password":"Incorrect password","auth/email-already-in-use":"An account with this email already exists","auth/weak-password":"Password is too weak","auth/invalid-email":"Invalid email address","auth/too-many-requests":"Too many login attempts. Please try again later","auth/network-request-failed":"Network error. Please check your connection","permission-denied":"You do not have permission to perform this action",unavailable:"Service is temporarily unavailable. Please try again"};function re(t){const e=vr(t);return e&&je[e]?je[e]:j(t)}function ht(){const t=navigator.userAgent.toLowerCase();return t.includes("firefox")&&(t.includes("mobile")||t.includes("tablet"))}function yt(){var t;return{userAgent:navigator.userAgent,url:window.location.href,timestamp:new Date().toISOString(),connectivity:{online:navigator.onLine,cookiesEnabled:navigator.cookieEnabled,localStorageAvailable:typeof Storage!="undefined",connectionType:((t=navigator.connection)==null?void 0:t.effectiveType)||"unknown"},firebase:{hasApiKey:!0,hasAuthDomain:!0,authDomain:"blitzout-49b39.firebaseapp.com"}}}function he(t,e,r){if(!ht())return;const n={...yt(),authentication:{step:t,...r==null?void 0:r.authentication},error:{message:e.message,stack:e.stack,code:e.code},...r};st(o=>{var s,a;o.setTag("firefox_mobile_auth_error",!0),o.setTag("auth_step",t),o.setLevel("error"),o.setContext("firefox_mobile_debug",n),(s=n.authentication)!=null&&s.displayName&&o.setUser({username:n.authentication.displayName,id:((a=n.authentication.firebaseUser)==null?void 0:a.uid)||"anonymous"}),o.addBreadcrumb({message:`Firefox Mobile Auth Step: ${t}`,level:"info",data:n.authentication}),Nt(e)}),$t({message:`Firefox Mobile Authentication Failure - ${t}: ${e.message}`,level:"error",category:"firefox_mobile_auth"})}function qe(t){if(!ht())return;const e={...yt(),authentication:{step:"connectivity_check"},error:{message:t.error.message,stack:t.error.stack}};st(r=>{r.setTag("firefox_mobile_connectivity_error",!0),r.setLevel("warning"),r.setContext("connectivity_test",{testUrl:t.testUrl,...e}),Ft(`Firefox Mobile Connectivity Issue: Failed to reach ${t.testUrl}. This may indicate uBlock Origin or another adblocker is blocking Firebase.`,"warning")})}const ye={apiKey:"AIzaSyCKS7tWQRYRWHsawNfN42uAmISdUbJHJJw",authDomain:"blitzout-49b39.firebaseapp.com",projectId:"blitzout-49b39",storageBucket:"blitzout-49b39.appspot.com",messagingSenderId:"852428606926",appId:"1:852428606926:web:17444e6f8dbc2f95f0ef9f",measurementId:"G-93YN1YMTQ7"},ze=Object.entries(ye).filter(([t,e])=>!e).map(([t])=>t);ze.length>0&&(console.error("Missing Firebase environment variables:",ze),console.error("Please check your .env file and ensure all VITE_FIREBASE_* variables are set"));const Cr=async()=>{try{const t=`https://identitytoolkit.googleapis.com/v1/projects/${ye.projectId}`,e=await fetch(t,{method:"GET"});if(!e.ok){const r=new Error(`HTTP ${e.status}: ${e.statusText}`);qe({testUrl:t,error:r})}}catch(t){qe({testUrl:`https://identitytoolkit.googleapis.com/v1/projects/${ye.projectId}`,error:t})}};navigator.userAgent.toLowerCase().includes("firefox")&&(navigator.userAgent.toLowerCase().includes("mobile")||navigator.userAgent.toLowerCase().includes("tablet"))&&Cr();const Tr=rr(ye),$=lt(Tr);async function Er(t=""){try{const e=R();if(await lr(e),e.currentUser)return await Le(e.currentUser,{displayName:t}),e.currentUser;{const r=new Error("No current user after anonymous sign in");return he("anonymous_login_no_user",r,{authentication:{step:"anonymous_login_no_user",displayName:t}}),null}}catch(e){throw he("anonymous_login_failed",e,{authentication:{step:"anonymous_login_failed",displayName:t}}),new ee(re(e),"ANONYMOUS_LOGIN_FAILED",te(e))}}async function Ar(t,e,r=""){try{const n=R(),o=await ar(n,t,e);return await Le(o.user,{displayName:r}),o.user}catch(n){throw console.error("Registration error:",n),new ee(re(n),"REGISTRATION_FAILED",te(n))}}async function Sr(t,e){try{const r=R();return(await ur(r,t,e)).user}catch(r){throw console.error("Email login error:",r),new ee(re(r),"EMAIL_LOGIN_FAILED",te(r))}}async function Mr(){try{const t=R(),e=new ir;return(await cr(t,e)).user}catch(t){throw console.error("Google login error:",t),new ee(re(t),"GOOGLE_LOGIN_FAILED",te(t))}}async function Dr(t){try{const e=R();return await sr(e,t),!0}catch(e){throw console.error("Password reset error:",e),new ee(re(e),"PASSWORD_RESET_FAILED",te(e))}}async function Ir(t,e){try{const n=R().currentUser;if(n!=null&&n.isAnonymous){const o=nr.credential(t,e);return(await or(n,o)).user}else throw new Error("User is not anonymous or not logged in")}catch(r){throw console.error("Account conversion error:",r),new ee(re(r),"ACCOUNT_CONVERSION_FAILED",te(r))}}async function xr(){try{const t=R();return await dt(t),!0}catch(t){throw console.error(t),t}}async function Rr(){try{const t=R();await dt(t),["gameSettings","messages-storage","i18nextLng","blitzed-out-action-groups-migration","blitzed-out-background-migration","blitzed-out-migration-in-progress","blitzed-out-current-language-migration","blitzed-out-background-migration-in-progress","blitzed-out-migration-health"].forEach(c=>{try{localStorage.removeItem(c)}catch(u){console.warn(`Failed to remove localStorage key: ${c}`,u)}});const r=["gameSettings","messages-storage","blitzed-out-"];Object.keys(localStorage).forEach(c=>{if(r.some(u=>c.startsWith(u)))try{localStorage.removeItem(c)}catch(u){console.warn(`Failed to remove localStorage key: ${c}`,u)}});try{sessionStorage.clear()}catch(c){console.warn("Failed to clear sessionStorage:",c)}try{const{default:c}=await M(async()=>{const{default:u}=await Promise.resolve().then(function(){return Yr});return{default:u}},void 0);await c.delete()}catch(c){console.warn("Failed to clear IndexedDB:",c)}const o=["i18next"],s=window.location.hostname,a=[s];if(s.includes(".")){const c=s.split(".");for(let u=1;u<c.length-1;u++)a.push(`.${c.slice(u).join(".")}`)}const i=["/","/app","/auth","/login"];o.forEach(c=>{a.forEach(u=>{i.forEach(d=>{try{document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u};`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u}; secure;`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u}; httpOnly;`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u}; SameSite=Strict;`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u}; SameSite=Lax;`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${d}; domain=${u}; SameSite=None; secure;`}catch(l){}})}),i.forEach(u=>{try{document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${u};`,document.cookie=`${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${u}; secure;`}catch(d){}})})}catch(t){throw console.error("Error wiping app data:",t),t}}function Or(t,e,r={},n={}){if(!t)return;const{enableCache:o=!0,enableDebounce:s=!0}=n,a=t.toUpperCase(),i=Pe("userList",a),c=Date.now();if(o){const l=L.get(i);if(l&&Be(l,i)){l.queryCount++,L.set(i,l),P(i,Date.now()-c,!0);const m=Object.keys(l.data).sort().join(","),b=r?Object.keys(r).sort().join(","):"";return m!==b&&e(l.data),()=>{}}}let u;const d=async()=>{let l=!1;try{await Ce();const m=hr(),b=yr(m,"users");u=wr(b,v=>{const x=Date.now(),D=x-c,C=v.val();if(!C){e({});return}const y={};Object.entries(C).forEach(([B,w])=>{w.room===a&&(y[B]={displayName:w.displayName,uid:B,lastSeen:w.lastSeen?new Date(w.lastSeen):new Date,isAnonymous:w.isAnonymous,joinedAt:w.joinedAt?new Date(w.joinedAt):new Date,room:w.room})});const A=y;if(o){Ge();const B=ie(i);L.set(i,{data:A,timestamp:x,queryCount:1,priority:B})}P(i,D,!1,l);const F=Object.keys(A).sort().join(","),G=r?Object.keys(r).sort().join(","):"";F!==G&&e(A)},v=>{l=!0,console.error("getUserList error:",v),P(i,Date.now()-c,!1,!0)})}catch(m){l=!0,console.error("getUserList connection error:",m),P(i,Date.now()-c,!1,!0)}finally{Te()}};return s?(Ne(i,d),()=>{const l=q.get(i);l&&(clearTimeout(l),q.delete(i)),u&&u()}):(d(),u)}async function Ur(t=""){try{const e=R();return e.currentUser?(await Le(e.currentUser,{displayName:t}),e.currentUser):null}catch(e){return console.error(e),null}}async function fo(t,e){try{await _e(z($,"custom-actions"),{grouping:t,customAction:e,ttl:new Date(Date.now()+5760*60*1e3)})}catch(r){console.error(r)}}async function Lr(t){const e=se(z($,"game-boards"),ae("checksum","==",t)),r=await pr(e);return r.size?r.docs[0]:null}async function mo({title:t,gameBoard:e,settings:r}){if(t)try{const n=Qt.sha256(e),o=await Lr(n);return o?(fr(o.ref,{ttl:new Date(Date.now()+720*60*60*1e3)}),o):await kr({title:t,gameBoard:e,settings:r,checksum:n})}catch(n){console.error(n)}}async function kr({title:t,gameBoard:e,settings:r,checksum:n}){try{return await _e(z($,"game-boards"),{title:t,gameBoard:e,settings:r,checksum:n,ttl:new Date(Date.now()+720*60*60*1e3)})}catch(o){console.error(o);return}}async function po(t){try{const e=Q($,"game-boards",t),r=await gt(e);return r.exists()?r.data():void 0}catch(e){console.error(e);return}}let Ve={};const L=new Map,q=new Map,We=15e3,Gr=5e3,Ye=150,Pr=50,wt=50,Br=100,W={activeConnections:0,maxConnections:15,connectionQueue:[]},Ke=new Map;function P(t,e,r,n=!1){const o=Ke.get(t)||{queryCount:0,totalLatency:0,cacheHits:0,lastQueryTime:0,avgLatency:0,p95Latency:0,connectionPoolHits:0,networkErrors:0,latencyHistory:[]};if(o.queryCount++,o.totalLatency+=e,o.lastQueryTime=Date.now(),o.avgLatency=o.totalLatency/o.queryCount,o.latencyHistory.push(e),o.latencyHistory.length>20&&o.latencyHistory.shift(),o.latencyHistory.length>=5){const s=[...o.latencyHistory].sort((i,c)=>i-c),a=Math.floor(s.length*.95);o.p95Latency=s[a]}r&&o.cacheHits++,n&&o.networkErrors++,Ke.set(t,o)}function ie(t){return t.includes("messages")?"high":t.includes("userList")?"medium":"low"}function Nr(t){switch(t){case"high":return Gr;case"medium":return We;case"low":return We*2}}function $r(t){switch(t){case"high":return Pr;case"medium":return Ye;case"low":return Ye*2}}function Ge(){if(L.size<=Br)return;const t=Array.from(L.entries());t.sort(([,r],[,n])=>{const o={low:0,medium:1,high:2},s=o[r.priority]-o[n.priority];if(s!==0)return s;const a=r.queryCount-n.queryCount;return a!==0?a:r.timestamp-n.timestamp});const e=Math.ceil(L.size*.2);for(let r=0;r<e;r++)L.delete(t[r][0])}function Ce(){return new Promise(t=>{W.activeConnections<W.maxConnections?(W.activeConnections++,t()):W.connectionQueue.push(()=>{W.activeConnections++,t()})})}function Te(){if(W.activeConnections--,W.connectionQueue.length>0){const t=W.connectionQueue.shift();t&&t()}}function Pe(t,e,r){return`${t}:${e||"global"}:${r||""}`}function Be(t,e){const r=ie(e),n=Nr(r);return Date.now()-t.timestamp<n}function Ne(t,e,...r){const n=ie(t),o=$r(n),s=q.get(t);s&&clearTimeout(s);const a=setTimeout(async()=>{try{await Ce(),e(...r)}catch(i){console.error("Query execution error:",i)}finally{Te(),q.delete(t)}},o);q.set(t,a)}async function ho({room:t,user:e,text:r="",type:n="chat",...o}){const s=["chat","actions","settings","room","media"];if(!s.includes(n)){let u="Invalid message type. Was expecting ";return u+=s.join(", "),u+=` but got ${n}`,console.error(u)}if(!(e!=null&&e.uid))return;const a={room:t,user:e.uid,text:r,type:n,...o};if(JSON.stringify(a)===JSON.stringify(Ve))return;Ve=a;const i=Date.now(),c=(t==null?void 0:t.toUpperCase())||"PUBLIC";try{return await _e(z($,"chat-rooms",c,"messages"),{text:r.trim(),ttl:new Date(i+864e5),type:n,...o,uid:e.uid,displayName:e.displayName,timestamp:gr()})}catch(u){console.error("Failed to send message:",u);return}}async function yo(t,e){return mr(Q($,`/chat-rooms/${t.toUpperCase()}/messages/${e}`))}function Fr(t,e,r={}){if(!t)return;const n=R();if(!n.currentUser){let o,s;return o=n.onAuthStateChanged(a=>{a&&(s=Qe(t,e,r),o&&(o(),o=void 0))}),()=>{o&&o(),s&&s()}}return Qe(t,e,r)}function Qe(t,e,r={}){const{limitCount:n=wt,startAfterDoc:o,enableCache:s=!0,enableDebounce:a=!0}=r,i=t.toUpperCase(),c=Pe("messages",i,`limit:${n}`),u=Date.now();if(s){const l=L.get(c);if(l&&Be(l,c))return l.queryCount++,L.set(c,l),P(c,Date.now()-u,!0),e(l.data),()=>{}}const d=()=>{let l=!1,m;try{Ce();const b=new Date;b.setHours(b.getHours()-3);let v=se(z($,"chat-rooms",i,"messages"),ae("timestamp",">",b),me("timestamp","desc"),pe(n));return o&&(v=se(z($,"chat-rooms",i,"messages"),ae("timestamp",">",b),me("timestamp","desc"),ft(o),pe(n))),m=mt(v,x=>{const D=Date.now(),C=D-u,y=x.docs.map(A=>({id:A.id,...A.data()}));if(s&&y.length>0){Ge();const A=x.docs[x.docs.length-1],F=ie(c);L.set(c,{data:y,timestamp:D,lastVisible:A,queryCount:1,priority:F})}P(c,C,!1,l),e(y)},x=>{l=!0,console.error("getMessages error:",x),P(c,Date.now()-u,!1,!0)}),m}catch(b){return l=!0,console.error("getMessages connection error:",b),P(c,Date.now()-u,!1,!0),()=>{}}finally{Te()}};if(a){let l;return Ne(c,()=>{l=d()}),()=>{const m=q.get(c);m&&(clearTimeout(m),q.delete(c)),l&&l()}}return d()}function Hr(t,e={}){const{limitCount:r=wt,startAfterDoc:n,enableCache:o=!0,enableDebounce:s=!0}=e,a=Pe("schedule",null,`limit:${r}`),i=Date.now();if(o){const d=L.get(a);if(d&&Be(d,a))return d.queryCount++,L.set(a,d),P(a,Date.now()-i,!0),t(d.data),()=>{}}const c=async()=>{let d=!1,l;try{await Ce();const m=new Date;m.setMinutes(m.getMinutes()-5);let b=se(z($,"schedule"),ae("dateTime",">",m),me("dateTime","asc"),pe(r));return n&&(b=se(z($,"schedule"),ae("dateTime",">",m),me("dateTime","asc"),ft(n),pe(r))),l=mt(b,v=>{const x=Date.now(),D=x-i,C=v.docs.map(y=>({id:y.id,...y.data()}));if(o&&C.length>0){Ge();const y=v.docs[v.docs.length-1],A=ie(a);L.set(a,{data:C,timestamp:x,lastVisible:y,queryCount:1,priority:A})}P(a,D,!1,d),t(C)},v=>{d=!0,console.error("getSchedule error:",v),P(a,Date.now()-i,!1,!0)}),l||(()=>{})}catch(m){return d=!0,console.error("getSchedule connection error:",m),P(a,Date.now()-i,!1,!0),()=>{}}finally{Te()}};if(s){let d;return Ne(a,async()=>{d=await c()}),()=>{const l=q.get(a);l&&(clearTimeout(l),q.delete(a)),d&&d()}}const u=c();return u instanceof Promise?()=>{}:u}async function jr(t,e,r="PUBLIC"){try{return await _e(z($,"schedule"),{dateTime:dr.fromDate(t),url:e,room:r})}catch(n){return console.error(n)}}function qr(t={tables:["customTiles","gameBoard"]}){const{tables:e}=t,r=new Set(e),n={timeouts:{},queue:new Set,scheduleSync(o){this.timeouts[o]&&clearTimeout(this.timeouts[o]),this.queue.add(o),this.timeouts[o]=setTimeout(()=>{this.processSyncQueue()},2e3)},processSyncQueue(){var o;if(this.queue.size===0)return;const s=window;(o=s.authContext)!=null&&o.user&&!s.authContext.user.isAnonymous&&s.authContext.syncData(),this.queue.clear(),Object.keys(this.timeouts).forEach(a=>{clearTimeout(this.timeouts[a]),delete this.timeouts[a]})}};return{stack:"dbcore",name:"syncMiddleware",create(o){return{...o,table(s){const a=o.table(s);return r.has(s)?{...a,mutate:async i=>{const c=await a.mutate(i);return["put","add","delete","deleteRange","update"].includes(i.type)&&n.scheduleSync(s),c}}:a}}}}}var zr=Object.defineProperty,Vr=(t,e,r)=>e in t?zr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,X=(t,e,r)=>Vr(t,typeof e!="symbol"?e+"":e,r);class Wr extends Jt{constructor(){super("blitzedOut"),X(this,"customTiles"),X(this,"gameBoard"),X(this,"customGroups"),X(this,"localPlayerSessions"),X(this,"localPlayerMoves"),X(this,"localPlayerStats"),this.version(1).stores({customTiles:"++id, group_id, [group_id+intensity+action], intensity, action, isEnabled, tags, isCustom",gameBoard:"++id, title, tiles, tags, gameMode, isActive",customGroups:"++id, name, label, locale, gameMode, isDefault, createdAt, [name+locale+gameMode]",localPlayerSessions:"++id, sessionId, roomId, isActive, createdAt, updatedAt",localPlayerMoves:"++id, sessionId, playerId, timestamp, sequence",localPlayerStats:"++id, sessionId, playerId, lastActive"})}}const I=new Wr;I.use(qr({tables:["customTiles","gameBoard","customGroups","localPlayerSessions","localPlayerMoves","localPlayerStats"]}));const Yr=Object.freeze({__proto__:null,default:I});function Kr(){if(typeof window=="undefined"||typeof navigator=="undefined")return!1;const t=navigator.userAgent;return t.includes("Safari")&&!t.includes("Chrome")}class Qr{canHandle(e){return e.message.includes("cursor")}async recover(e,r,n){if(n("Attempting database recovery for cursor error"),typeof e.close=="function"&&typeof e.open=="function")return await e.close(),await e.open(),n("Database reopened successfully, retrying operation"),await r();throw n("Database does not support close/open operations"),new Error("Database recovery not supported")}}class Jr{canHandle(e){if(!Kr())return!1;const r=e.message.toLowerCase();return r.includes("connection to indexed database server lost")||r.includes("error looking up record in object store by key range")||r.includes("indexeddb connection")||r.includes("database connection")}async recover(e,r,n){if(n("Attempting Safari IndexedDB connection recovery"),typeof e.close=="function"&&typeof e.open=="function")return await e.close(),await new Promise(o=>setTimeout(o,100)),await e.open(),await new Promise(o=>setTimeout(o,50)),n("Safari IndexedDB connection recovered, retrying operation"),await r();throw n("Database does not support close/open operations"),new Error("Safari IndexedDB recovery not supported")}}const Xr=[new Jr,new Qr];async function ce(t,e,r){var n;const o=r||((s,a)=>{console.error(s,a)});try{return typeof t.isOpen=="function"&&!t.isOpen()&&await((n=t.open)==null?void 0:n.call(t)),await e()}catch(s){const a=s instanceof Error?s:new Error(String(s));o(`Database operation failed: ${a.message}`,a);for(const i of Xr)if(i.canHandle(a))try{return await i.recover(t,e,o)}catch(c){const u=c instanceof Error?c:new Error(String(c));throw o(`Error retrying operation after ${i.constructor.name}: ${u.message}`,u),u}throw a}}const Zr=["en","es","fr","zh","hi"],en="2.3.0",tn="blitzed-out-action-groups-migration",rn="blitzed-out-background-migration",Re="blitzed-out-migration-in-progress",nn="blitzed-out-current-language-migration",on="blitzed-out-background-migration-in-progress",Oe=30*1e3,sn=300*1e3,an=10,cn=1e3,un=5e3,ln=["local","online"],wo=Object.freeze({__proto__:null,BACKGROUND_MIGRATION_DELAY:an,BACKGROUND_MIGRATION_IN_PROGRESS_KEY:on,BACKGROUND_MIGRATION_KEY:rn,CURRENT_LANGUAGE_MIGRATION_KEY:nn,GAME_MODES:ln,IDLE_CALLBACK_TIMEOUT:un,MIGRATION_IN_PROGRESS_KEY:Re,MIGRATION_KEY:tn,MIGRATION_TIMEOUT:Oe,MIGRATION_VERSION:en,QUEUE_BACKGROUND_MIGRATION_DELAY:cn,STALE_LOCK_TIMEOUT:sn,SUPPORTED_LANGUAGES:Zr}),{customTiles:k}=I;k.hook("creating",function(t,e,r){e.isCustom===void 0&&(e.isCustom=1),(!e.group_id||!e.group_id.trim())&&e.isCustom===1&&console.warn(`Custom tile missing group_id (sync may fail): ${e.action} (group_id: ${e.group_id})`)});const dn=async t=>{const e=t.map(r=>({...r,isEnabled:1}));return await k.bulkAdd(e)},bt=t=>{const e=["locale","gameMode","group","group_id","intensity","tag","isCustom","isEnabled","action"];let r=k.toCollection();return Object.entries(t).filter(([o])=>e.includes(o)).forEach(([o,s])=>{if(!(s==null||s===""))if(o==="tag")r=r.filter(a=>a.tags.includes(s));else if(o==="group"||o==="group_id")r=r.filter(a=>a.group_id===s);else if(o==="intensity"){const a=Number(s);r=r.filter(i=>i.intensity===a)}else r=r.filter(a=>a[o]===s)}),r},K=async(t={})=>{try{if(typeof window!="undefined"){const e=localStorage.getItem(Re);if(e)try{const r=JSON.parse(e);if(Date.now()-new Date(r.startedAt).getTime()<Oe){let o=0;const s=Math.ceil(Oe/50);for(;localStorage.getItem(Re)&&o<s;)await new Promise(a=>setTimeout(a,50)),o++}}catch(r){}}return await ce(I,async()=>await bt(t).toArray(),(e,r)=>{console.error(`Error in getTiles: ${e}`,r)})}catch(e){return console.error("Final error in getTiles:",e),[]}},gn=async t=>{const{page:e=1,limit:r=50}=t;try{const n=bt(t),o=await n.count(),s=(e-1)*r;return{items:await n.offset(s).limit(r).toArray(),total:o,page:e,limit:r,totalPages:Math.ceil(o/r)}}catch(n){return console.error("Error in getPaginatedTiles:",n),{items:[],total:0,page:e,limit:r,totalPages:0}}},fn=async(t="en",e="online",r=null)=>{try{const{getCustomGroups:n}=await M(async()=>{const{getCustomGroups:i}=await Promise.resolve().then(function(){return Ae});return{getCustomGroups:i}},void 0),o=await n({locale:t,gameMode:e}),s=new Set(o.map(i=>i.id));if(s.size===0)return{};let a=[];for(const i of s){const c=await k.where("group_id").equals(i).toArray();a.push(...c)}if(r){const i=Array.isArray(r)?r:[r];a=a.filter(c=>c.tags.some(u=>i.includes(u)))}return a.reduce((i,c)=>{const u=c.group_id;i[u]||(i[u]={count:0,intensities:{}}),i[u].count++;const d=Number(c.intensity);return i[u].intensities[d]||(i[u].intensities[d]=0),i[u].intensities[d]++,i},{})}catch(n){return console.error("Error in getTileCountsByGroup:",n),{}}},mn=async(t=null,e=null)=>{const r=e||Y.resolvedLanguage||Y.language||"en",n=await k.where("isEnabled").equals(1).toArray();if(t||e){const{getCustomGroups:o}=await M(async()=>{const{getCustomGroups:c}=await Promise.resolve().then(function(){return Ae});return{getCustomGroups:c}},void 0),s={};t&&(s.gameMode=t),e&&(s.locale=r);const a=await o(s),i=new Set(a.map(c=>c.id));return n.filter(c=>c.group_id&&i.has(c.group_id))}return n},pn=async t=>await k.add({...t,isEnabled:1}),Ee=async(t,e)=>await k.update(t,e),hn=async t=>{const e=await k.get(t);if(!e)throw new Error(`Custom tile with id ${t} not found`);const r=e.isEnabled?0:1;return await k.update(t,{isEnabled:r})};async function _t(){try{return await I.customTiles.where("isCustom").equals(1).delete(),!0}catch(t){return console.error("Error deleting custom tiles:",t),!1}}const vt=async t=>{await k.delete(t)},yn=async(t,e="en",r="online")=>{try{const{getCustomGroupByName:n}=await M(async()=>{const{getCustomGroupByName:s}=await Promise.resolve().then(function(){return Ae});return{getCustomGroupByName:s}},void 0),o=await n(t,e,r);return o?await Ct(o.id,e,r):0}catch(n){return console.error("Error counting tiles by group:",n),0}},wn=async(t,e="en",r="online")=>{try{const{getCustomGroupByName:n}=await M(async()=>{const{getCustomGroupByName:s}=await Promise.resolve().then(function(){return Ae});return{getCustomGroupByName:s}},void 0),o=await n(t,e,r);return o?await Tt(o.id,e,r):0}catch(n){return console.error("Error deleting tiles by group:",n),0}},bn=async t=>{try{return t.length===0?[]:await ce(I,async()=>await k.where("group_id").anyOf(t).toArray(),(e,r)=>{console.error(`Error in getTilesByGroupIds: ${e}`,r)})}catch(e){return console.error("Final error in getTilesByGroupIds:",e),[]}},Ct=async(t,e="en",r="online")=>{try{return await k.where("group_id").equals(t).count()}catch(n){return console.error("Error counting tiles by group ID:",n),0}},Tt=async(t,e="en",r="online")=>{try{return await k.where("group_id").equals(t).delete()}catch(n){return console.error("Error deleting tiles by group ID:",n),0}},Et=Object.freeze({__proto__:null,addCustomTile:pn,countTilesByGroup:yn,countTilesByGroupId:Ct,deleteAllIsCustomTiles:_t,deleteCustomTile:vt,deleteCustomTilesByGroup:wn,deleteCustomTilesByGroupId:Tt,getActiveTiles:mn,getPaginatedTiles:gn,getTileCountsByGroup:fn,getTiles:K,getTilesByGroupIds:bn,importCustomTiles:dn,toggleCustomTile:hn,updateCustomTile:Ee}),{customGroups:N}=I;N.hook("creating",function(t,e,r){e.id||(e.id=ct()),e.locale===void 0&&(e.locale=Y.resolvedLanguage||Y.language||"en"),e.gameMode===void 0&&(e.gameMode="online"),e.isDefault===void 0&&(e.isDefault=!1);const n=new Date;e.createdAt||(e.createdAt=n),e.updatedAt=n});N.hook("updating",function(t,e,r,n){t.updatedAt=new Date});const _n=t=>{const e=["locale","gameMode","name","isDefault"];let r=N.toCollection();return Object.entries(t).filter(([o])=>e.includes(o)).forEach(([o,s])=>{s==null||s===""||(r=r.filter(a=>a[o]===s))}),r},J=async(t={})=>{try{return await ce(I,async()=>(await _n(t).toArray()).sort((n,o)=>n.name.localeCompare(o.name)),(e,r)=>{console.error(`Error in getCustomGroups: ${e}`,r)})}catch(e){return console.error("Final error in getCustomGroups:",e),[]}},vn=async t=>{try{return await N.get(t)}catch(e){console.error("Error in getCustomGroup:",e);return}},At=async(t,e="en",r="online")=>{try{return await N.where("name").equals(t).and(n=>n.locale===e&&n.gameMode===r).first()}catch(n){console.error("Error in getCustomGroupByName:",n);return}},Cn=async t=>{try{return await ce(I,async()=>{const e=new Date,r={...t,createdAt:e,updatedAt:e};return await N.add(r)},(e,r)=>{console.error(`Error in addCustomGroup: ${e}`,r)})}catch(e){console.error("Final error in addCustomGroup:",e);return}},Tn=async(t,e)=>{try{return typeof I.isOpen=="function"&&!I.isOpen()&&await I.open(),await N.update(t,e)}catch(r){return console.error("Error in updateCustomGroup:",r),0}},$e=async(t,e={})=>{try{const{countTilesByGroupId:r,deleteCustomTilesByGroupId:n}=await M(async()=>{const{countTilesByGroupId:a,deleteCustomTilesByGroupId:i}=await Promise.resolve().then(function(){return Et});return{countTilesByGroupId:a,deleteCustomTilesByGroupId:i}},void 0),o=await N.get(t);if(!o)return{success:!1,error:"Group not found"};const s=await r(t,o.locale,o.gameMode);if(s>0){if(!e.force&&!e.cascadeDelete)return{success:!1,error:`Cannot delete group "${o.name}". It has ${s} associated tiles. Use force or cascadeDelete option.`};if(e.cascadeDelete){const a=await n(t,o.locale,o.gameMode);return await N.delete(t),{success:!0,tilesDeleted:a}}}return await N.delete(t),{success:!0}}catch(r){return console.error("Error in deleteCustomGroup:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}},En=async t=>{try{const e=new Date,r=t.map(n=>({name:n.name||"",label:n.label||"",intensities:n.intensities||[],id:n.id||ct(),locale:n.locale||"en",gameMode:n.gameMode||"online",isDefault:n.isDefault||!1,createdAt:n.createdAt||e,updatedAt:n.updatedAt||e}));return await N.bulkAdd(r)}catch(e){console.error("Error in importCustomGroups:",e);return}},An=async(t,e="en",r="online",n)=>{try{const o=await At(t,e,r);return!!(!o||n&&o.id===n)}catch(o){return console.error("Error in isGroupNameUnique:",o),!1}},St=async t=>{const e=Y.resolvedLanguage||Y.language||"en";return J({locale:e,gameMode:t||"online"})},Mt=async(t="en",e="online")=>{try{const r=await J({locale:t,gameMode:e}),n=new Map;r.forEach(s=>{const a=n.get(s.name)||[];a.push(s),n.set(s.name,a)});let o=0;for(const[,s]of n)if(s.length>1){s.sort((a,i)=>{try{const c=a.createdAt instanceof Date?a.createdAt.getTime():new Date(a.createdAt).getTime(),u=i.createdAt instanceof Date?i.createdAt.getTime():new Date(i.createdAt).getTime();return c-u}catch(c){return console.warn("Date parsing failed in removeDuplicateGroups, using createdAt fallback:",c),a.createdAt.getTime()-i.createdAt.getTime()}});for(let a=1;a<s.length;a++)await $e(s[a].id),o++}return o}catch(r){return console.error("Error in removeDuplicateGroups:",r),0}},Dt=async(t="en",e="online")=>{try{const r=localStorage.getItem("blitzed-out-migration-in-progress");if(r){const s=JSON.parse(r);if(Date.now()-new Date(s.startedAt).getTime()<3e4){let i=0;const c=60;for(;localStorage.getItem("blitzed-out-migration-in-progress")&&i<c;)await new Promise(u=>setTimeout(u,50)),i++}}typeof I.isOpen=="function"&&!I.isOpen()&&await I.open();try{await Mt(t,e)}catch(s){console.warn("Skipping duplicate removal due to database error:",s)}return(await J({locale:t,gameMode:e})).filter((s,a,i)=>i.findIndex(c=>c.name===s.name)===a).sort((s,a)=>s.name.localeCompare(a.name))}catch(r){return console.error("❌ getAllAvailableGroups: Database error",{locale:t,gameMode:e,error:r}),r instanceof Error&&r.message.includes("cursor")&&console.warn("Database cursor error in getAllAvailableGroups, returning empty array to prevent crash"),[]}},Sn=async(t="online")=>{try{return await ce(I,async()=>{const{getTilesByGroupIds:e}=await M(async()=>{const{getTilesByGroupIds:i}=await Promise.resolve().then(function(){return Et});return{getTilesByGroupIds:i}},void 0),r=await St(t),n=r.map(i=>i.id),o=await e(n),s=new Set(o.map(i=>i.group_id).filter(Boolean));return r.filter(i=>s.has(i.id))},(e,r)=>{console.error(`Error in getGroupsWithTiles: ${e}`,r)})}catch(e){return console.error("Final error in getGroupsWithTiles:",e),[]}},Ae=Object.freeze({__proto__:null,addCustomGroup:Cn,deleteCustomGroup:$e,getAllAvailableGroups:Dt,getCurrentGroups:St,getCustomGroup:vn,getCustomGroupByName:At,getCustomGroups:J,getGroupsWithTiles:Sn,importCustomGroups:En,isGroupNameUnique:An,removeDuplicateGroups:Mt,updateCustomGroup:Tn}),{gameBoard:V}=I,Mn=()=>V.orderBy("title").toArray(),bo=async()=>{var t;return(t=V.where("isActive").equals(1))==null?void 0:t.first()},Dn=async t=>V.add(t),In=async(t,e)=>V.update(t.id,{...t,...e}),_o=async t=>{var e,r;const n={title:t.title===void 0?"":t.title,tiles:t.tiles||[],isActive:t.isActive===void 0?1:t.isActive,tags:t.tags||[],gameMode:t.gameMode||"online"};if(!((e=n==null?void 0:n.title)!=null&&e.length)&&((r=n==null?void 0:n.tiles)!=null&&r.length))return;const o=await V.where("title").equals(n.title).first();return I.transaction("rw",I.gameBoard,async()=>(n.isActive&&await xn(),o?(await In(o,t),o.id):await Dn(n)))},vo=async t=>{const r=(await V.toArray()).map(n=>({...n,isActive:n.id===t?1:0}));await V.bulkPut(r)},Co=async t=>{await V.delete(t)},xn=async()=>{await V.where("isActive").equals(1).modify({isActive:0})},Je={locale:"en",gameMode:"online",boardUpdated:!1,room:"PUBLIC",background:"color",roomBackground:"useAppBackground",selectedActions:{},hasSeenRollButton:!1,themeMode:"system",playerDialog:!0},ue=be()(ut(t=>({settings:Je,updateSettings:e=>t(r=>({settings:{...r.settings,...e}})),setLocale:e=>t(r=>({settings:{...r.settings,locale:e}})),resetSettings:()=>t({settings:Je}),updateSelectedAction:(e,r)=>t(n=>{const o={...n.settings.selectedActions};return r===null?delete o[e]:o[e]=r,{settings:{...n.settings,selectedActions:o}}}),removeSelectedAction:e=>t(r=>{const n={...r.settings.selectedActions};return delete n[e],{settings:{...r.settings,selectedActions:n}}}),clearSelectedActions:()=>t(e=>({settings:{...e.settings,selectedActions:{}}})),getSelectedActionsByType:e=>{const{selectedActions:r={}}=ue.getState().settings;return Object.entries(r||{}).filter(([,o])=>o.type===e).reduce((o,[s,a])=>(o[s]=a,o),{})}}),{name:"gameSettings",partialize:t=>({settings:t.settings})})),To=()=>{const{settings:t,updateSettings:e}=ue();return[t,e]},Eo=()=>{const{settings:t,updateSettings:e}=ue();return{settings:t,updateSettings:e}},le=lt(),Ao=_t;async function Rn(){try{const t=await K({}),e=new Map;t.forEach(r=>{const n=`${r.group_id}|${r.intensity}|${r.action}`;e.has(n)||e.set(n,[]),e.get(n).push(r)});for(const[,r]of e)if(r.length>1){r.sort((a,i)=>(a.id||0)-(i.id||0));const n=r[0],o=r.slice(1),s=o.some(a=>a.isEnabled===0);for(const a of o)a.id&&await vt(a.id);s&&n.isEnabled===1&&await Ee(n.id,{isEnabled:0})}return!0}catch(t){return console.error("Error cleaning up duplicate tiles:",t),!1}}async function So(){try{const e=(await J({isDefault:!1})).map(r=>$e(r.id));return await Promise.all(e),!0}catch(t){return console.error("Error deleting user custom groups:",t),!1}}async function Mo(){try{const r=(await K({isCustom:0,isEnabled:0})).filter(n=>n.id).map(n=>Ee(n.id,{isEnabled:1}));return await Promise.all(r),!0}catch(t){return console.error("Error resetting disabled default tiles:",t),!1}}async function Do(t){try{const e=await K({isCustom:0}),r=new Map;e.forEach(o=>{const s=`${o.group_id}|${o.intensity}|${o.action}`;r.set(s,o.id)});const n=[];return t.forEach(o=>{const s=`${o.group_id}|${o.intensity}|${o.action}`,a=r.get(s);a&&n.push(Ee(a,{isEnabled:0}))}),await Promise.all(n),!0}catch(e){return console.error("Error applying disabled defaults:",e),!1}}async function On(){const e=R().currentUser;if(!e)return console.error("No user logged in"),!1;try{const r=await K({isCustom:1}),n=await K({isCustom:0,isEnabled:0}),o=100;return n.length>o&&(console.warn(`⚠️  Attempting to sync ${n.length} disabled defaults, which seems excessive.`),console.warn("This may indicate corrupted local data. Limiting to first 100 disabled defaults."),n.splice(o)),await ve(Q(le,"user-data",e.uid),{customTiles:r,disabledDefaults:n,lastUpdated:new Date},{merge:!0}),!0}catch(r){return console.error("Error syncing custom tiles:",r),!1}}async function Un(){const e=R().currentUser;if(!e)return console.error("No user logged in"),!1;try{const r=await J({isDefault:!1});return await ve(Q(le,"user-data",e.uid),{customGroups:r,lastUpdated:new Date},{merge:!0}),!0}catch(r){return console.error("Error syncing custom groups:",r),!1}}async function Ln(){const e=R().currentUser;if(!e)return console.error("No user logged in"),!1;try{const r=await Mn();return r.length&&await ve(Q(le,"user-data",e.uid),{gameBoards:r,lastUpdated:new Date},{merge:!0}),!0}catch(r){return console.error("Error syncing game boards:",r),!1}}async function kn(){const e=R().currentUser;if(!e)return console.error("No user logged in"),!1;try{const{settings:r}=ue.getState(),{localPlayers:n,...o}=r,s=Object.fromEntries(Object.entries(o).filter(([,a])=>a!==void 0));return await ve(Q(le,"user-data",e.uid),{settings:s,lastUpdated:new Date},{merge:!0}),!0}catch(r){return console.error("Error syncing settings:",r),!1}}async function de(){return await On(),await Un(),await Ln(),await kn(),!0}async function Gn(){const e=R().currentUser;if(!e)return{success:!1,conflicts:["No user logged in"]};try{const r=Q(le,"user-data",e.uid),n=await gt(r),o=await K({isCustom:1}),s=await J({isDefault:!1}),a=[];if(!n.exists())return await de(),{success:!0};const i=n.data(),c=i.customTiles||[],u=i.customGroups||[];return o.length>0&&c.length>0&&a.push(`Custom tiles: Local has ${o.length}, Firebase has ${c.length}`),s.length>0&&u.length>0&&a.push(`Custom groups: Local has ${s.length}, Firebase has ${u.length}`),a.length>0?{success:!1,conflicts:a}:{success:await we()}}catch(r){return console.error("Error in intelligent sync:",r),{success:!1,conflicts:["Sync failed due to error"]}}}async function we(t={}){const{SyncOrchestrator:e}=await M(async()=>{const{SyncOrchestrator:r}=await import("./syncOrchestrator.ts-CkOeyW02.js");return{SyncOrchestrator:r}},__vite__mapDeps([0,1,2,3,4]));return await e.syncFromFirebase(t)}let ge=null;function Xe(t=5){ne();const e=t*60*1e3;return ge=window.setInterval(async()=>{const r=R();r.currentUser&&!r.currentUser.isAnonymous&&await we()},e),!0}function ne(){return ge?(window.clearInterval(ge),ge=null,!0):!1}window.cleanupTiles=Rn;const It=Z.createContext(void 0);function Io(t){const[e,r]=g.useState(null),[n,o]=g.useState(!1),[s,a]=g.useState(!0),[i,c]=g.useState(null),[u,d]=g.useState({syncing:!1,lastSync:null}),l=g.useRef(null),m=g.useRef(!1),b=g.useCallback(async f=>{if(l.current&&(clearTimeout(l.current),l.current=null),!e||e.isAnonymous)return!1;try{return d({syncing:!0,lastSync:u.lastSync}),await f(),d({syncing:!1,lastSync:new Date}),!0}catch(p){return console.error("Sync error:",p),p instanceof Error?c(p.message):c("An unknown error occurred"),d({syncing:!1,lastSync:u.lastSync}),!1}},[e,l,d,u.lastSync,c]);async function v(f=""){try{c(null);const p=await Er(f);if(!p){const h=new Error("Login failed: No user returned from Firebase");return he("auth_context_no_user",h,{authentication:{step:"auth_context_no_user",displayName:f}}),c(h.message),null}return r(p),p}catch(p){const h=j(p),S=p instanceof Error?p:new Error(String(p||"Unknown error"));throw he("auth_context_login_failed",S,{authentication:{step:"auth_context_login_failed",displayName:f}}),c(h),p}}async function x(f,p){try{o(!0);const h=await Sr(f,p);return r(h),h}catch(h){const S=j(h);throw c(S),h}finally{o(!1)}}async function D(){try{o(!0);const f=await Mr();return r(f),f}catch(f){const p=j(f);throw c(p),f}finally{o(!1)}}async function C(f,p,h){try{o(!0);const S=await Ar(f,p,h);return r(S),S}catch(S){const H=j(S);throw c(H),S}finally{o(!1)}}async function y(f){try{return await Dr(f),!0}catch(p){const h=j(p);throw c(h),p}}const A=g.useCallback(async(f,p)=>{try{o(!0);const h=await Ir(f,p);return r(h),await b(de),h}catch(h){throw h instanceof Error&&c(h.message),h}finally{o(!1)}},[o,r,b,c]);async function F(f=""){try{const p=await Ur(f);return r(p),p}catch(p){const h=j(p);throw c(h),p}}const G=g.useCallback(async()=>{try{if(e&&!e.isAnonymous){const f=b(de),p=new Promise(h=>setTimeout(h,5e3,!1));await Promise.race([f,p])}await xr(),r(null)}catch(f){const p=j(f);throw c(p),f}},[e,b,r,c]),B=g.useCallback(async()=>{try{await Rr(),r(null),window.location.reload()}catch(f){const p=j(f);throw c(p),f}},[r,c]),w=g.useCallback(async()=>b(de),[b]),E=g.useCallback(async()=>{if(!e||e.isAnonymous)return{success:!1,conflicts:["User not logged in or is anonymous"]};try{d({syncing:!0,lastSync:u.lastSync});const f=await Gn();return d({syncing:!1,lastSync:new Date}),f}catch(f){return console.error("Intelligent sync error:",f),d({syncing:!1,lastSync:u.lastSync}),f instanceof Error&&c(f.message),{success:!1,conflicts:["Sync failed due to error"]}}},[e,u.lastSync]);g.useEffect(()=>{const p=R().onAuthStateChanged(h=>{if(r(h||null),m.current||(m.current=!0,a(!1)),h&&!h.isAnonymous){const S=()=>{l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{d({syncing:!0,lastSync:null});let H;try{H=we?we():Promise.resolve(!1)}catch(Me){console.warn("syncDataFromFirebase is not available:",Me),H=Promise.resolve(!1)}(!H||typeof H.then!="function")&&(H=Promise.resolve(!1)),H.then(()=>{d({syncing:!1,lastSync:new Date}),Xe&&Xe()}).catch(Me=>{console.error("Error syncing from Firebase:",Me),d({syncing:!1,lastSync:null})}).finally(()=>{l.current=null})},3e3)};typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(S,{timeout:1e4}):setTimeout(S,5e3)}else ne&&ne()});return window.authContext={user:null},()=>{typeof p=="function"&&p(),l.current&&clearTimeout(l.current),ne&&ne(),window.authContext=void 0}},[]),g.useEffect(()=>{const f=window;f.authContext&&(f.authContext.user=e)},[e]);const _=g.useMemo(()=>({user:e,loading:n,initializing:s,error:i,syncStatus:u,login:v,loginEmail:x,loginGoogle:D,register:C,updateUser:F,forgotPassword:y,convertToRegistered:A,logout:G,wipeAllData:B,syncData:w,intelligentSync:E,isAnonymous:(e==null?void 0:e.isAnonymous)||!1}),[e,n,s,i,u,A,G,B,w,E]);return U.jsx(It.Provider,{value:_,...t})}const Pn=async(t="en",e="online")=>{try{const[r,n]=await Promise.all([Xt(t,e).catch(()=>({})),Dt(t,e).catch(()=>[])]),o=Object.keys(r).length;if(n.length<o)return!1;const a=Object.keys(r),i=new Set(n.map(c=>c.name));for(const c of a)if(!i.has(c))return!1;return!0}catch(r){return console.error("Error in isDexieDataComplete:",r),!1}},De=(t,e,r)=>{const n=t[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((o,s)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==r?". Note that variables only represent file names one level deep.":""))))})},Ze=5e3,Bn={fallbackLng:"en",supportedLngs:["en","es","fr","zh","hi"],ns:["translation","errors"],defaultNS:"translation",interpolation:{escapeValue:!1},react:{useSuspense:!1},detection:{order:["querystring","cookie","localStorage","navigator","htmlTag"],caches:["localStorage","cookie"]},load:"currentOnly",preload:!1,cleanCode:!0},Nn=(t,e)=>e==="translation"?De(Object.assign({"./locales/en/translation.json":()=>M(()=>import("./translation.json-lMF-3z7T.js"),[]),"./locales/es/translation.json":()=>M(()=>import("./translation.json-CnRRSAhd.js"),[]),"./locales/fr/translation.json":()=>M(()=>import("./translation.json-uBTVSxlX.js"),[]),"./locales/hi/translation.json":()=>M(()=>import("./translation.json-CWrBFIgu.js"),[]),"./locales/zh/translation.json":()=>M(()=>import("./translation.json-hBs9Hmtr.js"),[])}),`./locales/${t}/translation.json`,4):De(Object.assign({"./locales/en/translation.json":()=>M(()=>import("./translation.json-lMF-3z7T.js"),[]),"./locales/es/translation.json":()=>M(()=>import("./translation.json-CnRRSAhd.js"),[]),"./locales/fr/translation.json":()=>M(()=>import("./translation.json-uBTVSxlX.js"),[]),"./locales/hi/translation.json":()=>M(()=>import("./translation.json-CWrBFIgu.js"),[]),"./locales/zh/translation.json":()=>M(()=>import("./translation.json-hBs9Hmtr.js"),[])}),`./locales/${t}/${e}.json`,4).catch(()=>De(Object.assign({"./locales/en/translation.json":()=>M(()=>import("./translation.json-lMF-3z7T.js"),[])}),`./locales/en/${e}.json`,4)),O=Y.use(Ht).use(jt).use(qt(Nn));O.init(Bn).then(()=>{(()=>{const e=O.language,r=["en","es","fr"].filter(n=>n!==e);typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(()=>{r.forEach(n=>{var o;(o=O==null?void 0:O.options)!=null&&o.supportedLngs&&Array.isArray(O.options.supportedLngs)&&O.options.supportedLngs.includes(n)&&O.loadLanguages(n).catch(console.warn)})},{timeout:Ze}):setTimeout(()=>{r.forEach(n=>{var o;(o=O==null?void 0:O.options)!=null&&o.supportedLngs&&Array.isArray(O.options.supportedLngs)&&O.options.supportedLngs.includes(n)&&O.loadLanguages(n).catch(console.warn)})},Ze)})()}).catch(console.error);const xt="blitzed-out-migration-health",et=3,$n=300*1e3,Rt=()=>{try{const t=localStorage.getItem(xt);return t?JSON.parse(t):{}}catch(t){return console.warn("Failed to load migration health state:",t),{}}},fe=(t,e,r)=>{try{const n=`${t}-${e}`,o=Rt();o[n]={failureCount:0,lastValidation:new Date().toISOString(),consecutiveFailures:0,...o[n],...r},localStorage.setItem(xt,JSON.stringify(o))}catch(n){console.warn("Failed to update migration health state:",n)}},Ie=async(t,e="online")=>{const r=t||O.resolvedLanguage||O.language||"en",n=`${r}-${e}`,s=Rt()[n]||{failureCount:0,lastValidation:new Date(0).toISOString(),consecutiveFailures:0},a={...s,lastValidation:new Date(s.lastValidation)},i={isHealthy:!1,requiresRecovery:!1,lastValidation:a.lastValidation,failureCount:a.failureCount,details:{migrationStatus:"incomplete",dataComplete:!1,locale:r,gameMode:e}};try{if(Date.now()-a.lastValidation.getTime()<$n&&a.consecutiveFailures===0)return i.isHealthy=!0,i.details.migrationStatus="completed",i.details.dataComplete=!0,i;const u=await Pn(r,e);if(i.details.dataComplete=u,u)i.isHealthy=!0,i.details.migrationStatus="completed",fe(r,e,{consecutiveFailures:0,lastValidation:new Date().toISOString()});else{const d=Fn();i.details.migrationStatus=d;const l=a.failureCount+1,m=a.consecutiveFailures+1;fe(r,e,{failureCount:l,consecutiveFailures:m,lastValidation:new Date().toISOString()}),i.failureCount=l,i.requiresRecovery=m>=et,i.requiresRecovery&&(i.details.errorMessage=`Migration failed ${m} consecutive times. Data incomplete for ${r}/${e}.`)}return i}catch(c){console.error("Migration health check failed:",c);const u=a.failureCount+1,d=a.consecutiveFailures+1;return fe(r,e,{failureCount:u,consecutiveFailures:d,lastValidation:new Date().toISOString()}),i.failureCount=u,i.requiresRecovery=d>=et,i.details.migrationStatus="failed",i.details.errorMessage=`Health check failed: ${c instanceof Error?c.message:String(c)}`,i}},Fn=()=>{try{const t=localStorage.getItem("blitzed-out-action-groups-migration");if(t){const r=JSON.parse(t);if(r.completed&&r.version==="2.1.1")return"completed"}const e=localStorage.getItem("blitzed-out-background-migration");if(e){const r=JSON.parse(e);if(r.completedLanguages&&r.completedLanguages.length>0)return"completed"}return"incomplete"}catch(t){return console.warn("Failed to check migration status from storage:",t),"incomplete"}},tt=async(t,e="online")=>{const r=t||O.resolvedLanguage||O.language||"en";try{const n=["blitzed-out-migration-in-progress","blitzed-out-current-language-migration","blitzed-out-background-migration-in-progress"];let o=!1;n.forEach(s=>{try{localStorage.removeItem(s)}catch(a){console.warn(`Failed to remove ${s}:`,a),o=!0}});try{fe(r,e,{failureCount:0,consecutiveFailures:0,lastValidation:new Date(0).toISOString()})}catch(s){console.warn("Failed to update health state:",s),o=!0}return!o}catch(n){return console.error("Migration recovery failed:",n),!1}},Ot=g.createContext(void 0);function xo(){const t=g.useContext(Ot);if(t===void 0)throw new Error("useMigration must be used within a MigrationProvider");return t}function Hn({children:t}){const{i18n:e}=zt(),[r,n]=g.useState(!1),[o,s]=g.useState(!1),[a,i]=g.useState(!1),[c,u]=g.useState(null),[d,l]=g.useState(!1),[m,b]=g.useState(!1),[v,x]=g.useState(null),D=g.useRef(new Set),C=g.useCallback(async()=>await M(()=>import("./migrationService.ts-BG1W09SZ.js"),__vite__mapDeps([5,6,7,2,3,4,1])),[]);g.useEffect(()=>{const w=async()=>{try{const E=await C(),_=e.language||"en";if(!await E.verifyMigrationIntegrity(_,"online")){E.fixMigrationStatusCorruption(),s(!1),i(!1);return}const p=E.isCurrentLanguageMigrationCompleted(_),h=E.isMigrationCompleted();if(s(p),i(h),p){const S=await Ie(_,"online");l(S.isHealthy),!S.isHealthy&&S.requiresRecovery&&!m&&(b(!0),await tt(_,"online")?(s(!1),u(null)):u("Migration recovery failed. Some features may not work correctly."))}}catch(E){console.warn("Failed to check migration status:",!1,E),u("Failed to check migration status"),l(!1)}};e.language&&e.language!=="undefined"&&w()},[e.language,C,m]);const y=g.useCallback(async()=>{const w=e.language||"en";try{if(n(!0),u(null),await tt(w,"online")){b(!0),s(!1),l(!1);const _=await C();if(await _.runMigrationIfNeeded()){await _.cleanupDuplicatesIfNeeded(),s(!0),i(_.isMigrationCompleted());const p=await Ie(w,"online");l(p.isHealthy)}}else u("Force recovery failed. Please try refreshing the page.")}catch(E){console.error("Force recovery failed:",E),u("Force recovery failed. Please try refreshing the page.")}finally{n(!1)}},[e.language,C]),A=g.useCallback(async()=>{if(!r){n(!0),u(null);try{const{runSyncRecovery:w}=await M(async()=>{const{runSyncRecovery:f}=await import("./syncRecoveryService.ts-C4J_SsLb.js");return{runSyncRecovery:f}},__vite__mapDeps([8,6,7,2,3,4,1]));await w();const E=await C();if(await E.runMigrationIfNeeded()){await E.cleanupDuplicatesIfNeeded(),s(!0),i(E.isMigrationCompleted());const f=e.language||"en",p=await Ie(f,"online");l(p.isHealthy),p.isHealthy||u("Migration completed but data validation failed. Some features may not work correctly.")}else u("Migration failed but app will continue with existing data"),l(!1)}catch(w){console.error("Migration failed:",w),u("Migration failed but app will continue with existing data"),l(!1)}finally{n(!1)}}},[r,C,e.language]),F=g.useCallback(w=>{v&&clearTimeout(v);const E=setTimeout(async()=>{try{const _=await C();if(_.isCurrentLanguageMigrationCompleted(w)){s(!0);return}n(!0),u(null),await _.ensureLanguageMigrated(w)?(s(!0),i(_.isMigrationCompleted())):u("Migration failed but app will continue with existing data")}catch(_){console.error("Error during language migration:",_),u("Migration failed but app will continue with existing data")}finally{n(!1)}},300);x(E)},[v,C]),G=g.useCallback(async w=>{const E=w||e.language||"en";try{const _=await C();if(_.isCurrentLanguageMigrationCompleted(E))return s(!0),!0;n(!0);const f=await _.ensureLanguageMigrated(E);return f&&s(!0),f}catch(_){return console.error(`Failed to ensure ${E} migration:`,_),!1}finally{n(!1)}},[e.language,C]);g.useEffect(()=>{if(!e.language||e.language==="undefined")return;const w=_=>{F(_)};return e.on("languageChanged",w),(async()=>{try{const _=await C(),f=e.language||"en",p=_.isCurrentLanguageMigrationCompleted(f);s(p);const h=`${f}-initial`;!p&&!r&&!D.current.has(h)&&(D.current.add(h),n(!0),setTimeout(async()=>{try{const S=await C();await S.ensureLanguageMigrated(f)?(s(!0),i(S.isMigrationCompleted())):(u("Migration failed but app will continue with existing data"),D.current.delete(h))}catch(S){console.error("Error during migration execution:",S),u("Migration failed but app will continue with existing data"),D.current.delete(h)}finally{n(!1)}},0))}catch(_){console.error("Error during initial migration check:",_),n(!1)}})(),()=>{e.off("languageChanged",w),v&&clearTimeout(v)}},[e,F,r,v,C]);const B={isMigrationCompleted:a,isMigrationInProgress:r,currentLanguageMigrated:o,error:c,isHealthy:d,recoveryAttempted:m,triggerMigration:A,ensureLanguageMigrated:G,forceRecovery:y};return U.jsx(Ot.Provider,{value:B,children:t})}const rt=300*1e3,jn=100,qn=be((t,e)=>({schedule:[],loading:!1,error:null,_cache:{upcomingSchedule:{data:[],timestamp:0,limit:0},roomSchedule:{}},_performanceMetrics:{lastUpdateTime:Date.now(),updateCount:0,cacheHitRate:0},_pendingUpdates:[],_batchTimeout:null,loadSchedule:r=>{const n=Date.now();t(o=>{const s=o._performanceMetrics.updateCount+1;return{schedule:r,loading:!1,error:null,_performanceMetrics:{lastUpdateTime:n,updateCount:s,cacheHitRate:o._performanceMetrics.cacheHitRate}}}),e().invalidateCache()},addScheduleItem:r=>{const n=e();t(s=>({_pendingUpdates:[...s._pendingUpdates,r]})),n._batchTimeout&&clearTimeout(n._batchTimeout);const o=setTimeout(()=>{e().flushPendingScheduleUpdates()},jn);t(()=>({_batchTimeout:o}))},batchAddScheduleItems:r=>t(n=>{const o=[...n.schedule,...r],s=Date.now(),a=n._performanceMetrics.updateCount+1;return{schedule:o,_performanceMetrics:{lastUpdateTime:s,updateCount:a,cacheHitRate:n._performanceMetrics.cacheHitRate}}}),flushPendingScheduleUpdates:()=>{const r=e();r._pendingUpdates.length!==0&&(r._batchTimeout&&clearTimeout(r._batchTimeout),r.batchAddScheduleItems(r._pendingUpdates),t(()=>({_pendingUpdates:[],_batchTimeout:null})),r.invalidateCache())},removeScheduleItem:r=>{t(n=>({schedule:n.schedule.filter(o=>o.id!==r)})),e().invalidateCache()},clearSchedule:()=>{const r=e();r._batchTimeout&&clearTimeout(r._batchTimeout),t(()=>({schedule:[],loading:!1,error:null,_pendingUpdates:[],_batchTimeout:null})),e().invalidateCache()},invalidateCache:()=>t(()=>({_cache:{upcomingSchedule:{data:[],timestamp:0,limit:0},roomSchedule:{}}})),setLoading:r=>t(()=>({loading:r})),setError:r=>t(()=>({error:r,loading:!1})),getUpcomingSchedule:(r=10)=>{const n=e(),o=Date.now(),s=n._cache.upcomingSchedule;if(s.timestamp>0&&o-s.timestamp<rt&&s.limit>=r){const u=n._performanceMetrics.updateCount+1,l=(n._performanceMetrics.cacheHitRate*(u-1)+1)/u;return t(m=>({_performanceMetrics:{...m._performanceMetrics,cacheHitRate:l}})),s.data.slice(0,r)}const i=Zt(),c=n.schedule.filter(u=>u.dateTime.isAfter(i)).sort((u,d)=>u.dateTime.valueOf()-d.dateTime.valueOf()).slice(0,Math.max(r,20));return t(u=>({_cache:{...u._cache,upcomingSchedule:{data:c,timestamp:o,limit:Math.max(r,20)}}})),c.slice(0,r)},getScheduleByRoom:r=>{const n=e(),o=Date.now(),s=n._cache.roomSchedule[r];if(s&&s.timestamp>0&&o-s.timestamp<rt){const c=n._performanceMetrics.updateCount+1,d=(n._performanceMetrics.cacheHitRate*(c-1)+1)/c;return t(l=>({_performanceMetrics:{...l._performanceMetrics,cacheHitRate:d}})),s.data}const i=n.schedule.filter(c=>c.room===r);return t(c=>({_cache:{...c._cache,roomSchedule:{...c._cache.roomSchedule,[r]:{data:i,timestamp:o}}}})),i},getPerformanceMetrics:()=>e()._performanceMetrics})),Ut=Z.createContext(void 0);function zn(t){const{schedule:e,loadSchedule:r,flushPendingScheduleUpdates:n}=qn(),o=g.useRef(null),s=g.useCallback(u=>{r(u)},[r]),a=g.useCallback(async(u,d,l)=>{try{const m=await jr(u,d,l);return n(),m||void 0}catch(m){throw console.error("Error adding to schedule:",m),m}},[n]),i=g.useCallback(()=>{o.current&&(o.current(),o.current=null),n()},[n]);g.useEffect(()=>(i(),o.current=Hr(s),i),[s,i]),g.useEffect(()=>i,[i]);const c=g.useMemo(()=>({schedule:e,addToSchedule:a}),[e,a]);return U.jsx(Ut.Provider,{value:c,...t})}const T={LIGHT_CYAN:"8, 145, 178",DARK_CYAN:"72, 219, 251",BRIGHT_CYAN:"34, 211, 238",LIGHT_BORDER:"75, 85, 99",DARK_BORDER:"148, 163, 184"},Lt={typography:{h1:{fontWeight:700,letterSpacing:"-0.025em"},h2:{fontWeight:700,letterSpacing:"-0.025em"},h3:{fontWeight:600,letterSpacing:"-0.025em"},h4:{fontWeight:600},h5:{fontWeight:600},h6:{fontWeight:600},button:{fontWeight:500,textTransform:"none"}},shape:{borderRadius:8}},Vn=t=>({MuiBox:{variants:[{props:{variant:"systemMessage"},style:({theme:e,ownerState:r})=>{const{transparent:n=!1,fullWidth:o=!1}=r;return{background:n?e.palette.systemMessage.transparent:e.palette.systemMessage.main,border:"none",borderRadius:16,margin:"8px auto",alignSelf:"center",padding:"8px 12px",width:"fit-content",backdropFilter:n?"blur(4px)":"none",WebkitBackdropFilter:n?"blur(4px)":"none",transition:e.transitions.create(["background-color","backdrop-filter"],{duration:e.transitions.duration.short}),...o&&{maxWidth:"95%",width:"auto"},[e.breakpoints.down("sm")]:{maxWidth:o?"98%":"95%"}}}}]},MuiButton:{styleOverrides:{root:{borderRadius:8,padding:"8px 16px",transition:"all 0.3s ease",textTransform:"none",fontWeight:500,"&:hover":{transform:"translateY(-1px)"}},contained:({theme:e})=>({background:e.palette.primary.main,boxShadow:"none","&:hover":{background:e.palette.primary.dark,boxShadow:"none",transform:"translateY(-2px)"}}),outlined:({theme:e})=>{const r=e.palette.mode==="light";return{borderColor:`rgba(${r?T.LIGHT_CYAN:T.DARK_CYAN}, 0.5)`,color:e.palette.primary.main,"&:hover":{borderColor:`rgba(${r?T.LIGHT_CYAN:T.DARK_CYAN}, 0.8)`,background:`rgba(${r?T.LIGHT_CYAN:T.DARK_CYAN}, 0.1)`,boxShadow:`0 0 20px rgba(${r?T.LIGHT_CYAN:T.DARK_CYAN}, 0.3)`}}}}},MuiCard:{styleOverrides:{root:()=>({borderRadius:12,background:"var(--container-background)",backdropFilter:"blur(15px)",WebkitBackdropFilter:"blur(15px)",border:"1px solid var(--container-border)",boxShadow:"var(--shadow-lg)",transition:"all 0.3s ease","&:hover":{transform:"translateY(-2px)",boxShadow:"var(--shadow-xl)"}})}},MuiPaper:{styleOverrides:{root:{backgroundImage:"none"},elevation1:({theme:e})=>({boxShadow:e.palette.mode==="light"?"0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.1)":"0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24)"}),elevation2:({theme:e})=>({boxShadow:e.palette.mode==="light"?"0 3px 6px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06)":"0 3px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.12)"}),elevation4:({theme:e})=>({boxShadow:e.palette.mode==="light"?"0 10px 20px rgba(0, 0, 0, 0.08), 0 3px 6px rgba(0, 0, 0, 0.05)":"0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1)"})}},MuiTextField:{styleOverrides:{root:({theme:e})=>{const r=e.palette.mode==="light";return{"& .MuiOutlinedInput-root":{transition:"border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",borderRadius:"8px","& .MuiOutlinedInput-notchedOutline":{borderColor:r?`rgba(${T.LIGHT_BORDER}, 0.4)`:`rgba(${T.DARK_BORDER}, 0.23)`},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:r?`rgba(${T.LIGHT_BORDER}, 0.6)`:e.palette.primary.main},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.primary.main,boxShadow:`0 0 0 2px rgba(${r?T.LIGHT_CYAN:T.BRIGHT_CYAN}, 0.2)`},"& input::placeholder":{color:r?`rgba(${T.LIGHT_BORDER}, 0.7)`:`rgba(${T.DARK_BORDER}, 0.5)`,opacity:1},"& textarea::placeholder":{color:r?`rgba(${T.LIGHT_BORDER}, 0.7)`:`rgba(${T.DARK_BORDER}, 0.5)`,opacity:1}},"& .MuiInputLabel-root":{color:r?`rgba(${T.LIGHT_BORDER}, 0.8)`:`rgba(${T.DARK_BORDER}, 0.7)`,"&.Mui-focused":{color:e.palette.primary.main}}}}}},MuiSelect:{styleOverrides:{root:({theme:e})=>{const r=e.palette.mode==="light";return{borderRadius:"8px",transition:"border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out","& .MuiOutlinedInput-notchedOutline":{borderColor:r?`rgba(${T.LIGHT_BORDER}, 0.4)`:`rgba(${T.DARK_BORDER}, 0.23)`},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:r?`rgba(${T.LIGHT_BORDER}, 0.6)`:e.palette.primary.main},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.primary.main,boxShadow:`0 0 0 2px rgba(${r?T.LIGHT_CYAN:T.BRIGHT_CYAN}, 0.2)`}}}},defaultProps:{MenuProps:{disableScrollLock:!0,BackdropProps:{invisible:!0},PaperProps:{style:{backdropFilter:"none",WebkitBackdropFilter:"none"}}}}},MuiSwitch:{styleOverrides:{switchBase:({theme:e})=>({"&.Mui-checked":{color:e.palette.primary.main,"& + .MuiSwitch-track":{backgroundColor:e.palette.primary.main}}})}},MuiSlider:{styleOverrides:{root:({theme:e})=>({color:e.palette.primary.main})}},MuiCssBaseline:{styleOverrides:{body:({theme:e})=>{const r=e.palette.mode==="light";return{scrollbarWidth:"thin",scrollbarColor:r?"#d1d5db transparent":"#4b5563 transparent","&::-webkit-scrollbar":{width:"8px",height:"8px"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:r?"#d1d5db":"#4b5563",borderRadius:"4px"},"&::-webkit-scrollbar-thumb:hover":{background:r?"#9ca3af":"#6b7280"}}},"*":{"@media (forced-colors: active)":{"&:focus":{outline:"2px solid ButtonText !important"}},"@media (prefers-reduced-motion: reduce)":{"&, &::before, &::after":{animationDuration:"0.01ms !important",animationIterationCount:"1 !important",transitionDuration:"0.01ms !important",scrollBehavior:"auto !important"}}},".keyboard-navigation *:focus":{outline:"2px solid #22d3ee",outlineOffset:"2px"}}},MuiAppBar:{styleOverrides:{root:()=>({backgroundColor:"var(--nav-background)",borderBottom:"1px solid var(--nav-border)",boxShadow:"var(--nav-shadow)"})}},MuiContainer:{styleOverrides:{root:()=>({"&.gradient-background":{minHeight:"100vh",background:"var(--page-gradient)",padding:"2rem 0"}})}},MuiModal:{styleOverrides:{root:{"&:not(.MuiPopover-root)":{backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)"}}}},MuiPopover:{styleOverrides:{root:{"& .MuiModal-backdrop":{backgroundColor:"transparent",backdropFilter:"none",WebkitBackdropFilter:"none"}}}},MuiDialog:{styleOverrides:{paper:()=>({background:"var(--color-surface)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",border:"1px solid var(--nav-border)",borderRadius:"var(--border-radius-lg)",boxShadow:"var(--shadow-lg)"})}}}),Wn={...Lt,palette:{mode:"light",primary:{main:"#0891b2",dark:"#0e7490",light:"#22d3ee",contrastText:"#ffffff"},secondary:{main:"#06b6d4",dark:"#0e7490",light:"#a5f3fc",contrastText:"#ffffff"},background:{default:"#f8fafc",paper:"#ffffff"},text:{primary:"#0f172a",secondary:"#475569"},divider:"rgba(148, 163, 184, 0.2)",error:{main:"#dc2626"},warning:{main:"#d97706"},systemMessage:{main:"rgba(148, 163, 184, 0.15)",transparent:"rgba(148, 163, 184, 0.25)"},info:{main:"#2563eb"},success:{main:"#059669"}}},Yn={...Lt,palette:{mode:"dark",primary:{main:"#22d3ee",dark:"#0891b2",light:"#67e8f9"},secondary:{main:"#48dbfb",dark:"#0e7490",light:"#a5f3fc"},background:{default:"#0f172a",paper:"#1e293b"},text:{primary:"#f8fafc",secondary:"#cbd5e1"},divider:"rgba(148, 163, 184, 0.12)",error:{main:"#b91c1c"},warning:{main:"#b45309"},systemMessage:{main:"rgba(148, 163, 184, 0.1)",transparent:"rgba(148, 163, 184, 0.2)"},info:{main:"#1d4ed8"},success:{main:"#047857"}}},kt=t=>{const e=Fe(t);return Fe({...e,components:Vn(t.palette.mode)})},Kn=at(kt(Wn)),Qn=at(kt(Yn)),Jn=t=>t==="light"?Kn:Qn,Gt=g.createContext(void 0);function Xn({children:t,defaultMode:e="system"}){const{settings:r,updateSettings:n}=ue(),o=Vt("(prefers-color-scheme: dark)",{noSsr:!0}),s=r.themeMode||e,a=g.useMemo(()=>s==="system"?o?"dark":"light":s,[s,o]),i=g.useMemo(()=>Jn(a),[a]),c=l=>{n({themeMode:l})},u=()=>{c(a==="light"?"dark":"light")};g.useEffect(()=>{},[o,s]),g.useEffect(()=>{const l=document.body;return l.style.transition="background-color 0.3s ease, color 0.3s ease",l.classList.remove("theme-light","theme-dark"),l.classList.add(`theme-${a}`),()=>{l.style.transition="",l.classList.remove("theme-light","theme-dark")}},[a]);const d={theme:i,themeMode:s,resolvedThemeMode:a,prefersDarkMode:o,setThemeMode:c,toggleTheme:u};return U.jsx(Gt.Provider,{value:d,children:t})}function Zn(){const t=g.useContext(Gt);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}function eo({children:t}){const{theme:e}=Zn();return U.jsxs(Wt,{theme:e,children:[U.jsx(Yt,{}),U.jsx(er,{dateAdapter:tr,children:t})]})}function Ro({children:t}){return U.jsx(Xn,{children:U.jsx(Hn,{children:U.jsx(zn,{children:U.jsx(eo,{children:t})})})})}function Ue(t){if(!t)return null;try{if(typeof t.toDate=="function")return t.toDate();if(typeof t=="string"){const e=new Date(t);if(isNaN(e.getTime()))throw new Error("Invalid serialized timestamp format");return e}else if(typeof t=="number"){const e=t<3250368e4?t*1e3:t,r=new Date(e);if(isNaN(r.getTime()))throw new Error("Invalid numeric timestamp format");return r}else if(typeof t=="object"&&t.seconds!==void 0){const e=t,r=new Date(e.seconds*1e3+(e.nanoseconds||0)/1e6);if(isNaN(r.getTime()))throw new Error("Invalid Firestore timestamp object format");return r}else{if(t instanceof Date)return t;throw console.warn("Unsupported timestamp format:",typeof t,t),new Error(`Unsupported timestamp format: ${typeof t}`)}}catch(e){return console.warn("Failed to parse timestamp:",e),null}}function xe(t){return t.sort((e,r)=>{const n=Ue(e.timestamp),o=Ue(r.timestamp);return!n||!o?0:n.getTime()-o.getTime()})}function Se(t){return JSON.parse(JSON.stringify(t)).reverse()}function to(t,e){return Se(t).find(r=>r.type===e)}function ro(t,e,r="ASC"){let n=Se(t);return r==="DESC"&&(n=n.reverse()),n.filter(o=>o.type===e)}function Oo(t,e){return Se(t).find(e)}function no(t){return Se(t)[0]}const oo={messages:[],loading:!0,error:null,room:null,paginationCursor:null},so=be()(ut((t,e)=>({...oo,loadMessages:r=>{const o=xe(r);t({messages:o,loading:!1,error:null})},addMessage:r=>{const{messages:n}=e();if(n.find(i=>i.id===r.id))return;const s=[...n,r],a=xe(s);t({messages:a})},updateMessage:(r,n)=>{const{messages:o}=e();let s=!1;const a=o.map(i=>{if(i.id===r){const c={...i,...n};if(Object.keys(n).some(d=>i[d]!==n[d]))return s=!0,c}return i});if(s){const i=xe(a);t({messages:i})}},clearMessages:()=>{t({messages:[],loading:!1,error:null})},setLoading:r=>{const{loading:n}=e();n!==r&&t({loading:r})},setError:r=>{const{error:n}=e();n!==r&&t({error:r})},setRoom:r=>{const{room:n}=e();n!==r&&t({room:r})},setPaginationCursor:r=>{const{paginationCursor:n}=e();n!==r&&t({paginationCursor:r})},getMessagesByType:r=>{const{messages:n}=e(),o=[];for(let s=0;s<n.length;s++)n[s].type===r&&o.push(n[s]);return o},getLatestMessage:()=>{const{messages:r}=e();return no(r)},getLatestMessageByType:r=>{const{messages:n}=e();return to(n,r)},getFilteredMessages:r=>{const{messages:n}=e(),o=[];for(let s=0;s<n.length;s++)r(n[s])&&o.push(n[s]);return o},getOrderedMessagesByType:(r,n="ASC")=>{const{messages:o}=e();return ro(o,r,n)}}),{name:"messages-storage",partialize:t=>({messages:t.messages,room:t.room,paginationCursor:t.paginationCursor}),onRehydrateStorage:()=>t=>{if(t){const e=new Date;e.setHours(e.getHours()-24);const r=t.messages.filter(n=>{try{const o=Ue(n.timestamp);if(!o)throw console.warn(`Failed to parse timestamp for message ${n.id}:`,typeof n.timestamp,n.timestamp),new Error(`Failed to parse timestamp for message ${n.id}`);return o>e}catch(o){return console.warn(`Failed to parse message timestamp for message ID ${n.id}:`,o.message),!0}});r.length!==t.messages.length&&t.loadMessages(r)}}})),Pt=Z.createContext(void 0);function Uo(t){const{id:e}=it(),{messages:r,loading:n,loadMessages:o,setLoading:s,setRoom:a,clearMessages:i}=so();g.useEffect(()=>{if(s(!0),a(e||null),!e){i();return}return Fr(e,u=>{o(u)})},[e,o,s,a,i]);const c={messages:r,isLoading:n};return U.jsx(Pt.Provider,{value:c,...t})}const nt=50,ot=be((t,e)=>({onlineUsers:{},loading:!1,error:null,room:null,_performanceMetrics:{lastUpdateTime:Date.now(),updateCount:0,averageUpdateInterval:0},_pendingUpdates:{},_batchTimeout:null,setUsers:r=>{const n=Date.now();t(o=>{const s=n-o._performanceMetrics.lastUpdateTime,a=o._performanceMetrics.updateCount+1,i=(o._performanceMetrics.averageUpdateInterval*o._performanceMetrics.updateCount+s)/a;return{onlineUsers:r,loading:!1,error:null,_performanceMetrics:{lastUpdateTime:n,updateCount:a,averageUpdateInterval:i}}})},addUser:(r,n)=>{const o=e();o._pendingUpdates[r]=n,o._batchTimeout&&clearTimeout(o._batchTimeout);const s=setTimeout(()=>{o.flushPendingUpdates()},nt);t({_batchTimeout:s})},removeUser:r=>{const n=e();n._pendingUpdates[r]=null,n._batchTimeout&&clearTimeout(n._batchTimeout);const o=setTimeout(()=>{n.flushPendingUpdates()},nt);t({_batchTimeout:o})},batchUpdateUsers:r=>t(n=>{const o={...n.onlineUsers};Object.entries(r).forEach(([u,d])=>{if(d===null){const{[u]:l,...m}=o;Object.assign(o,m)}else o[u]=d});const s=Date.now(),a=s-n._performanceMetrics.lastUpdateTime,i=n._performanceMetrics.updateCount+1,c=(n._performanceMetrics.averageUpdateInterval*n._performanceMetrics.updateCount+a)/i;return{onlineUsers:o,_performanceMetrics:{lastUpdateTime:s,updateCount:i,averageUpdateInterval:c}}}),flushPendingUpdates:()=>{const r=e();Object.keys(r._pendingUpdates).length!==0&&(r.batchUpdateUsers(r._pendingUpdates),t(()=>({_pendingUpdates:{}})))},clearUsers:()=>t(()=>({onlineUsers:{},loading:!1,error:null,_pendingUpdates:{}})),setLoading:r=>t(()=>({loading:r})),setError:r=>t(()=>({error:r,loading:!1})),setRoom:r=>t(()=>({room:r})),getUsersByRoom:r=>{const n=e();return n.onlineUsers},getActiveUserCount:()=>{const r=e();return Object.keys(r.onlineUsers).length},getPerformanceMetrics:()=>e()._performanceMetrics}));function ao(t){if(!t||typeof t!="object")return!1;const e=t;return typeof e.displayName=="string"&&typeof e.uid=="string"&&(e.lastSeen instanceof Date||typeof e.lastSeen=="number"||typeof e.lastSeen=="string")}const io=Z.createContext(void 0);function Lo(t){const{id:e}=it(),r=ot(y=>y.onlineUsers),n=g.useRef(null),o=g.useRef(void 0),s=g.useRef(r);g.useEffect(()=>{s.current=r},[r]);const a=g.useRef(()=>{}),{setUsers:i,clearUsers:c,setRoom:u,flushPendingUpdates:d}=ot(Kt(y=>({setUsers:y.setUsers,clearUsers:y.clearUsers,setRoom:y.setRoom,flushPendingUpdates:y.flushPendingUpdates}))),l=g.useRef(i),m=g.useRef(c),b=g.useRef(u),v=g.useRef(d);g.useEffect(()=>{l.current=i,m.current=c,b.current=u,v.current=d},[i,c,u,d]),g.useEffect(()=>{a.current=y=>{if(y===null){m.current();return}const A={};Object.entries(y).forEach(([F,G])=>{if(ao(G)){const B={...G,lastSeen:G.lastSeen instanceof Date?G.lastSeen:new Date(G.lastSeen)};A[F]=B}}),l.current(A)}},[]);const x=g.useCallback(y=>{var A;(A=a.current)==null||A.call(a,y)},[]),D=g.useCallback(()=>{n.current&&(n.current(),n.current=null),v.current()},[]);g.useEffect(()=>{if(o.current!==e&&(b.current(e||null),o.current=e),!e){D(),m.current();return}D();const y=Or(e,x,s.current);return n.current=y||null,D},[e,x,D]),g.useEffect(()=>D,[D]);const C=g.useMemo(()=>({onlineUsers:r}),[r]);return U.jsx(io.Provider,{value:C,...t})}function ko(){const t=Z.useContext(Ut);if(!t)throw new Error("ScheduleContext's value is undefined.");return t}function Go(){const t=g.useContext(It);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}function Po(){const t=Z.useContext(Pt);if(!t)throw new Error("MessagesContext's value is undefined.");return t}const Bt=g.createContext({initializing:!0,hasUser:!1}),Bo=()=>g.useContext(Bt);function No({children:t}){const[e,r]=g.useState(!0),[n,o]=g.useState(!1);return g.useEffect(()=>{setTimeout(()=>{let a=!1;try{a=!!(localStorage.getItem("firebase:authUser:")||sessionStorage.getItem("firebase:authUser:")||document.cookie.includes("firebase-auth"))}catch(i){console.warn("Authentication check failed due to storage restrictions (e.g., private browsing mode):",i),a=!1}o(a),r(!1)},50)},[]),U.jsx(Bt.Provider,{value:{initializing:e,hasUser:n},children:t})}export{Uo as $,It as A,Cn as B,Eo as C,fo as D,pn as E,Ee as F,gn as G,vt as H,hn as I,dn as J,to as K,xo as L,In as M,vo as N,Co as O,Mn as P,ue as Q,ot as R,ro as S,he as T,Er as U,Ue as V,po as W,Oo as X,yo as Y,Lo as Z,M as _,Mr as a,Io as a0,Ro as a1,Bo as a2,Jn as a3,No as a4,$ as a5,Un as a6,En as a7,So as a8,On as a9,Ao as aa,Mo as ab,Do as ac,de as ad,Rn as ae,en as af,tn as ag,rn as ah,Zr as ai,Re as aj,nn as ak,on as al,sn as am,O as an,ln as ao,Mt as ap,De as aq,an as ar,un as as,cn as at,Oe as au,Yr as av,wo as aw,Ae as ax,ko as b,vn as c,mo as d,At as e,J as f,Dt as g,K as h,An as i,To as j,_o as k,Sr as l,bo as m,I as n,Go as o,Po as p,mn as q,Ar as r,ho as s,Sn as t,Zn as u,fn as v,yn as w,wn as x,$e as y,Tn as z};
//# sourceMappingURL=chunk-Dai8FbIP.js.map
