const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/migrationService.ts-o9hf8nu4.js","assets/index-BHv73vX6.js","js/chunk-DzAIPjqH.js","js/chunk-BfMAFFX0.js","js/chunk-BS7AWNIJ.js","js/chunk-BmjRqaQ3.js","js/chunk-D4nXmTaT.js"])))=>i.map(i=>d[i]);
import{_ as j}from"../assets/index-BHv73vX6.js";import{r as u,ak as z,j as G}from"./chunk-DzAIPjqH.js";import{n as D}from"./chunk-BmjRqaQ3.js";import{i as L}from"./chunk-BS7AWNIJ.js";(function(){var a=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};a.SENTRY_RELEASE={id:"b0aec1b7336667c3da787da9b7139ec106644213"}})();try{(function(){var a=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},e=new a.Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="911c4cd4-eb65-41f2-a60c-21e41215fac7",a._sentryDebugIdIdentifier="sentry-dbid-911c4cd4-eb65-41f2-a60c-21e41215fac7")})()}catch{}const q=a=>{const e={};for(const t of a){const r={label:t.label||t.name,type:t.type||"action",actions:{None:[]}};if(t.intensities&&Array.isArray(t.intensities))for(const g of t.intensities)r.actions[g.label]=[];e[t.name]=r}return e},J=async(a="en",e="online")=>{try{const t=await D(a,e);return q(t)}catch(t){return console.error("Error importing actions from Dexie:",t),{}}},K=async(a="en",e="online")=>{try{const[t,r]=await Promise.all([J(a,e).catch(()=>({})),D(a,e).catch(()=>[])]),g=Object.keys(t).length;if(r.length<g)return!1;const d=Object.keys(t),i=new Set(r.map(p=>p.name));for(const p of d)if(!i.has(p))return!1;return!0}catch(t){return console.error("Error in isDexieDataComplete:",t),!1}},_="blitzed-out-migration-health",F=3,Y=300*1e3,R=()=>{try{const a=localStorage.getItem(_);return a?JSON.parse(a):{}}catch(a){return console.warn("Failed to load migration health state:",a),{}}},I=(a,e,t)=>{try{const r=`${a}-${e}`,g=R();g[r]={failureCount:0,lastValidation:new Date().toISOString(),consecutiveFailures:0,...g[r],...t},localStorage.setItem(_,JSON.stringify(g))}catch(r){console.warn("Failed to update migration health state:",r)}},k=async(a,e="online")=>{const t=a||L.resolvedLanguage||L.language||"en",r=`${t}-${e}`,o=R()[r]||{failureCount:0,lastValidation:new Date(0).toISOString(),consecutiveFailures:0},d={...o,lastValidation:new Date(o.lastValidation)},i={isHealthy:!1,requiresRecovery:!1,lastValidation:d.lastValidation,failureCount:d.failureCount,details:{migrationStatus:"incomplete",dataComplete:!1,locale:t,gameMode:e}};try{if(Date.now()-d.lastValidation.getTime()<Y&&d.consecutiveFailures===0)return i.isHealthy=!0,i.details.migrationStatus="completed",i.details.dataComplete=!0,i;const s=await K(t,e);if(i.details.dataComplete=s,s)i.isHealthy=!0,i.details.migrationStatus="completed",I(t,e,{consecutiveFailures:0,lastValidation:new Date().toISOString()});else{const v=X();i.details.migrationStatus=v;const h=d.failureCount+1,w=d.consecutiveFailures+1;I(t,e,{failureCount:h,consecutiveFailures:w,lastValidation:new Date().toISOString()}),i.failureCount=h,i.requiresRecovery=w>=F,i.requiresRecovery&&(i.details.errorMessage=`Migration failed ${w} consecutive times. Data incomplete for ${t}/${e}.`)}return i}catch(p){console.error("Migration health check failed:",p);const s=d.failureCount+1,v=d.consecutiveFailures+1;return I(t,e,{failureCount:s,consecutiveFailures:v,lastValidation:new Date().toISOString()}),i.failureCount=s,i.requiresRecovery=v>=F,i.details.migrationStatus="failed",i.details.errorMessage=`Health check failed: ${p instanceof Error?p.message:String(p)}`,i}},X=()=>{try{const a=localStorage.getItem("blitzed-out-action-groups-migration");if(a){const t=JSON.parse(a);if(t.completed&&t.version==="2.1.1")return"completed"}const e=localStorage.getItem("blitzed-out-background-migration");if(e){const t=JSON.parse(e);if(t.completedLanguages&&t.completedLanguages.length>0)return"completed"}return"incomplete"}catch(a){return console.warn("Failed to check migration status from storage:",a),"incomplete"}},T=async(a,e="online")=>{const t=a||L.resolvedLanguage||L.language||"en";try{const r=["blitzed-out-migration-in-progress","blitzed-out-current-language-migration","blitzed-out-background-migration-in-progress"];let g=!1;r.forEach(o=>{try{localStorage.removeItem(o)}catch(d){console.warn(`Failed to remove ${o}:`,d),g=!0}});try{I(t,e,{failureCount:0,consecutiveFailures:0,lastValidation:new Date(0).toISOString()})}catch(o){console.warn("Failed to update health state:",o),g=!0}return!g}catch(r){return console.error("Migration recovery failed:",r),!1}},O=u.createContext(void 0);function B(){const a=u.useContext(O);if(a===void 0)throw new Error("useMigration must be used within a MigrationProvider");return a}function Q({children:a}){const{i18n:e}=z(),[t,r]=u.useState(!1),[g,o]=u.useState(!1),[d,i]=u.useState(!1),[p,s]=u.useState(null),[v,h]=u.useState(!1),[w,x]=u.useState(!1),[C,A]=u.useState(null),M=u.useRef(new Set),f=u.useCallback(async()=>await j(()=>import("./migrationService.ts-o9hf8nu4.js"),__vite__mapDeps([0,1,2,3,4,5,6])),[]);u.useEffect(()=>{const c=async()=>{try{const l=await f(),n=e.language||"en";if(!await l.verifyMigrationIntegrity(n,"online")){l.fixMigrationStatusCorruption(),o(!1),i(!1);return}const S=l.isCurrentLanguageMigrationCompleted(n),b=l.isMigrationCompleted();if(o(S),i(b),S){const y=await k(n,"online");h(y.isHealthy),!y.isHealthy&&y.requiresRecovery&&!w&&(x(!0),await T(n,"online")?(o(!1),s(null)):s("Migration recovery failed. Some features may not work correctly."))}}catch(l){console.warn("Failed to check migration status:",l),s("Failed to check migration status"),h(!1)}};e.language&&e.language!=="undefined"&&c()},[e.language,f,w]);const H=u.useCallback(async()=>{const c=e.language||"en";try{if(r(!0),s(null),await T(c,"online")){x(!0),o(!1),h(!1);const n=await f();if(await n.runMigrationIfNeeded()){await n.cleanupDuplicatesIfNeeded(),o(!0),i(n.isMigrationCompleted());const S=await k(c,"online");h(S.isHealthy)}}else s("Force recovery failed. Please try refreshing the page.")}catch(l){console.error("Force recovery failed:",l),s("Force recovery failed. Please try refreshing the page.")}finally{r(!1)}},[e.language,f]),N=u.useCallback(async()=>{if(!t){r(!0),s(null);try{const c=await f();if(await c.runMigrationIfNeeded()){await c.cleanupDuplicatesIfNeeded(),o(!0),i(c.isMigrationCompleted());const n=e.language||"en",m=await k(n,"online");h(m.isHealthy),m.isHealthy||s("Migration completed but data validation failed. Some features may not work correctly.")}else s("Migration failed but app will continue with existing data"),h(!1)}catch(c){console.error("Migration failed:",c),s("Migration failed but app will continue with existing data"),h(!1)}finally{r(!1)}}},[t,f,e.language]),E=u.useCallback(c=>{C&&clearTimeout(C);const l=setTimeout(async()=>{try{const n=await f();if(n.isCurrentLanguageMigrationCompleted(c)){o(!0);return}r(!0),s(null),await n.ensureLanguageMigrated(c)?(o(!0),i(n.isMigrationCompleted())):s("Migration failed but app will continue with existing data")}catch(n){console.error("Error during language migration:",n),s("Migration failed but app will continue with existing data")}finally{r(!1)}},300);A(l)},[C,f]),V=u.useCallback(async c=>{const l=c||e.language||"en";try{const n=await f();if(n.isCurrentLanguageMigrationCompleted(l))return o(!0),!0;r(!0);const m=await n.ensureLanguageMigrated(l);return m&&o(!0),m}catch(n){return console.error(`Failed to ensure ${l} migration:`,n),!1}finally{r(!1)}},[e.language,f]);u.useEffect(()=>{if(!e.language||e.language==="undefined")return;const c=n=>{E(n)};return e.on("languageChanged",c),(async()=>{try{const n=await f(),m=e.language||"en",S=n.isCurrentLanguageMigrationCompleted(m);o(S);const b=`${m}-initial`;!S&&!t&&!M.current.has(b)&&(M.current.add(b),r(!0),setTimeout(async()=>{try{const y=await f();await y.ensureLanguageMigrated(m)?(o(!0),i(y.isMigrationCompleted())):(s("Migration failed but app will continue with existing data"),M.current.delete(b))}catch(y){console.error("Error during migration execution:",y),s("Migration failed but app will continue with existing data"),M.current.delete(b)}finally{r(!1)}},0))}catch(n){console.error("Error during initial migration check:",n),r(!1)}})(),()=>{e.off("languageChanged",c),C&&clearTimeout(C)}},[e,E,t,C,f]);const P={isMigrationCompleted:d,isMigrationInProgress:t,currentLanguageMigrated:g,error:p,isHealthy:v,recoveryAttempted:w,triggerMigration:N,ensureLanguageMigrated:V,forceRecovery:H};return G.jsx(O.Provider,{value:P,children:a})}const te=Object.freeze(Object.defineProperty({__proto__:null,MigrationProvider:Q,useMigration:B},Symbol.toStringTag,{value:"Module"}));export{J as i,te as m,B as u};
//# sourceMappingURL=chunk--sFRCnns.js.map
