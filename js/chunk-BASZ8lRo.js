var Q=Object.defineProperty;var ee=(e,t,o)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var S=(e,t,o)=>ee(e,typeof t!="symbol"?t+"":t,o);import{u as te}from"./chunk-RtjQ02-D.js";import{u as G}from"./chunk-Bfa-QeNm.js";import{D as ne,E as se,u as k,c as x,t as q,F as oe,G as ie,s as j,g as ae,I as re,J as le,U as ce}from"../assets/index-BHjYcaRD.js";import{i as W,b as F}from"./chunk-C7PvMB7v.js";import{u as H}from"./chunk-DyBi9s21.js";import{ac as A,ae as V,r as v,az as ue,ad as X,an as de}from"./chunk-B0_VBOvR.js";import{a as pe,i as fe}from"./chunk-B4PEA_xj.js";import{u as ge}from"./chunk-DC_novU2.js";import{l as me}from"./chunk-yLOK5aTh.js";function E(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Ze(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}const{t:C}=A;class he{constructor(t){S(this,"bags",new Map);S(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];E(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],E(n),this.bags.set(s,n)}return n.pop()||null}}function be(e,t,o=[]){return e.filter(s=>{const n=s.action;return o.find(r=>r.name===s.group)?.type==="consumption"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const O=new Map;function ve(e,t,o,s){const n=`${e}-${t}-${o}-${s||"normal"}`,i=O.get(n);if(i!==void 0)return i;let r;if([void 0,"normal"].includes(s)){const a=e/t;r=Math.floor(o/a)+1}else t>=3&&Math.random()>=.6?r=t-1:r=t;return O.set(n,r),r}function Y(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=o[r.name];if(!a||a.level<=0)return{title:"",description:""};if(a.variation){const p=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>p)return{title:"",description:""}}const l=Math.max(...r.intensities.map(p=>p.value)),g=ve(n,l,s,i.difficulty),c=Math.min(g,a.level);let u=t.getTile(r.name,c);if(!u){for(let p=c-1;p>=1&&(u=t.getTile(r.name,p),!u);p--);if(!u)for(let p=c+1;p<=l&&(u=t.getTile(r.name,p),!u);p++);if(!u)return{title:"",description:""}}return{title:r.label,description:u.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function $e(e,t,o,s,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=Y(t,o,s,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Ce(e,t,o,s){const n=o.selectedActions||{},i=new he(t),r=e.filter(c=>{const u=n[c.name];return u&&u.level>0&&(!u.variation||u.variation==="standalone")}),a=e.filter(c=>{const u=n[c.name];return u&&u.level>0&&(u.variation==="appendSome"||u.variation==="appendMost")});E(r);let l=0;const g=[];for(let c=1;c<=s;c++){const u=r.length>0?[r[l%r.length]]:[];l++;const p=Y(u,i,n,c,s,o),d=$e(p,a,i,n,c,s,o);g.push({title:p.title,description:d.trim(),role:p.role})}return g}function L(e,t){const o={title:C("start"),description:C("start")},{finishRange:s=[33,66]}=t,n=`${C("noCum")} ${s[0]}%\r
${C("ruined")} ${s[1]-s[0]}%\r
${C("cum")} ${100-s[1]}%`,i={title:C("finish"),description:n};return[o,...e.map(r=>({title:r.title,description:r.description})),i]}async function ye(e,t,o,s=40){try{const[n,i]=await Promise.all([ne({locale:t,gameMode:o}),se({locale:t,gameMode:o})]),r=e.selectedActions||{},a=Object.keys(r).filter(b=>r[b]?.level>0),l=n.filter(b=>a.includes(b.name)),g=n.map(b=>b.name),c=a.filter(b=>!g.includes(b)),u=e.role||"sub",d=be(i,u,n).filter(b=>a.includes(b.group));if(!l.length||!d.length)return{board:L([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:c,availableTileCount:d.length}};const h=await Ce(l,d,e,s),m=h.filter(b=>b.description.trim().length>0).length,f=L(h,e);return{board:f,metadata:{totalTiles:f.length,tilesWithContent:m+2,selectedGroups:a,missingGroups:c,availableTileCount:d.length}}}catch(n){return console.error("Error building game board:",n),{board:L([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Te(){const e=G(x),[t,o]=H(),{i18n:s}=V(),n=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:l}=r;const{roomTileCount:g=40,finishRange:c,room:u}=r,p=W(u||"");if(!i||!c)return{gameMode:a};p&&!F(a||"")&&(a="online",l=!0);const d=a||"online",h=s.resolvedLanguage||"en",m=p?40:g||40,f=await ye(r,h,d,m);return f.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",f.metadata.missingGroups),f.metadata.tilesWithContent<m/2&&console.warn("Low tile content ratio:",{tilesWithContent:f.metadata.tilesWithContent,totalTiles:f.metadata.totalTiles,availableTileCount:f.metadata.availableTileCount}),(i?.boardUpdated||l||(e?.tiles?.length??0)!==f.board.length)&&(await o(r),await k({title:e?.title||"",tiles:f.board})),{settingsBoardUpdated:l,gameMode:a,newBoard:f.board,metadata:f.metadata}},[e,s.resolvedLanguage,t,o]);return v.useCallback(i=>n(i),[n])}const U=50,N=100,I=50,M=1,B=10,_=1,R=10,J=["none","all","default","undefined","null"],Ae=["solo","foreplay","sex","consumption"],we=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>U&&n.push(`Group name must be ${U} characters or less`),J.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Se=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(ue("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>N&&t.push(`Group label must be ${N} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},Le=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<_&&t.push(`At least ${_} intensity level is required`),e.length>R&&t.push(`Maximum ${R} intensity levels allowed`);const s=new Set,n=new Set;for(let a=0;a<e.length;a++){const l=e[a];if((!l.id||l.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!l.label||l.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const g=l.label.trim();g.length>I&&t.push(`Intensity level ${a+1} label must be ${I} characters or less`),n.has(g.toLowerCase())?t.push(`Intensity label "${g}" is used multiple times`):n.add(g.toLowerCase())}typeof l.value!="number"||!Number.isInteger(l.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((l.value<M||l.value>B)&&t.push(`Intensity level ${a+1} value must be between ${M} and ${B}`),s.has(l.value)?t.push(`Intensity value ${l.value} is used multiple times`):s.add(l.value))}const i=Array.from(s).sort((a,l)=>a-l);let r=i[0];for(const a of i){if(a!==r){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:o}},Ke=async(e,t)=>{const o=[],s=[],n=we(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=Se(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const r=Le(e.intensities);if(o.push(...r.errors),s.push(...r.warnings||[]),n.isValid&&e.name)try{await oe(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(a){s.push("Could not verify group name uniqueness"),me.warn("Failed to check group name uniqueness:",!1,a instanceof Error?a.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},Qe=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await q(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},Ge=()=>({MAX_GROUP_NAME_LENGTH:U,MAX_GROUP_LABEL_LENGTH:N,MAX_INTENSITY_LABEL_LENGTH:I,MIN_INTENSITY_VALUE:M,MAX_INTENSITY_VALUE:B,MIN_INTENSITIES_COUNT:_,MAX_INTENSITIES_COUNT:R,RESERVED_GROUP_NAMES:J,VALID_GROUP_TYPES:Ae});function Ee(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ue(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([r])=>s[r]).reduce((r,[a,l])=>(r[a]=Object.keys(l.actions).slice(1,s[a].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Ne(e,t,o,s){const{t:n}=A;let i=`### ${A.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(o).forEach(([c,u])=>{if(!r[c])return;const{role:p,variation:d,level:h}=r[c],m=p||e.role||"sub";if(h>0){const f=Object.keys(u?.actions||{});if(i+=`* ${u?.label}: ${f[h]||""}`,d&&(i+=` (${n(d)})`),!F(e.gameMode)&&!d){const b=Ee(u,m)?u[m]:n(m);i+=` (${b})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const p=(await q(c.groupName,e.locale||"en",e.gameMode||"online"))?.label||c.groupName;i+=`* ${p}: Level ${c.intensity} (Custom)\r
`}catch(u){console.error(`Error loading custom group ${c.groupName}:`,u),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a,difficulty:l}=e;if(i+=`--- \r
`,i+=`* ${n("difficulty")}: ${n(l??"normal")} \r
`,a){const c=a[0],u=a[1]-a[0],p=100-a[1],h=[c>0?{percent:c,text:n("noCum")}:null,u>0?{percent:u,text:n("ruined")}:null,p>0?{percent:p,text:n("cum")}:null].filter(m=>m!==null);h.length===1&&h[0].percent===100?i+=`* ${n("finishSlider")} ${h[0].text.replace(":","")} \r
`:h.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,h.forEach(m=>{const f=m.percent===100?m.text.replace(":",""):`${m.text} ${m.percent}%`;i+=`  - ${f} \r
`}))}const g=Ue(e,t,o);return g&&(i+=`* ${n("customTilesLabel")}: ${g} \r
`),i}function Ie(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Me({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ie(t)),l=await ie({title:e,gameBoard:JSON.stringify(n),settings:a}),g=await Ne(t,i,s,r);if(!(!l?.id||g===""))return j({room:t?.room||"PUBLIC",user:o,text:g,type:"settings",gameBoardId:l.id,boardSize:n.length,gameMode:t.gameMode})}function Be(e){const{t}=A;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${pe(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function _e(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===o)&&(t[o]=s)}),t}async function Re(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function Ve(e,t){const o=_e(e);return j({room:e.room,user:t,text:Be(o),type:"room",settings:JSON.stringify(o)})}function Oe(){const{id:e}=X(),t=de();return o=>{if(e!==void 0&&e?.toUpperCase()!==o?.toUpperCase()){const s=o?.replace(/^\/+/,"")||"PUBLIC";t(`/${s}`)}}}function Pe(e){(!e.roomBackgroundURL||!fe(e.roomBackgroundURL))&&(e.roomBackground="app")}function ke(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.level>0&&(o[n]=i)});const s=Ge();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function et(){const{user:e,updateUser:t}=te(),{id:o}=X(),{t:s}=V(),n=Te(),[i,r]=H(),a=G(()=>ae(i?.gameMode)),l=G(x),g=Oe(),{messages:c}=ge(),u=v.useCallback(d=>{const h=o?.toUpperCase()!==d.room.toUpperCase(),m=!!(d.room&&!W(d.room)),f=m&&d.roomTileCount!==i?.roomTileCount;return{roomChanged:h,isPrivateRoom:m,privateBoardSizeChanged:f}},[o,i?.roomTileCount]),p=v.useCallback(async(d,h)=>{const{displayName:m}=d,f=await Re(e,m,t);Pe(d);const{settingsBoardUpdated:b,gameMode:T,newBoard:w=[]}=await n(d),{roomChanged:z,isPrivateRoom:D,privateBoardSizeChanged:Z}=u(d);if(!f)return;D&&(d.roomUpdated||!c.find(y=>y.type==="room"))&&await Ve(d,f),l?.tiles!==w&&await k({title:s("settingsGenerated"),tiles:w,isActive:1,gameMode:T}),(b||z||Z)&&!c.some(y=>y.type==="settings"&&y.uid===f.uid&&Date.now()-(y.timestamp?.toMillis()||0)<5e3)&&await Me({formData:d,user:f,customTiles:a,actionsList:h,title:"Settings Generated Board",tiles:w});const K=ke(d);r({...K,boardUpdated:!1,roomUpdated:!1,gameMode:T}),g(d.room)},[e,t,n,u,c,l,s,a,r,g]);return v.useCallback((d,h)=>p(d,h),[p])}const $=new Map,P=ce;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{$.clear()};function tt(e){const{i18n:t,t:o}=V(),{currentLanguageMigrated:s}=re(),[n,i]=v.useState({}),[r,a]=v.useState(!0);v.useEffect(()=>{const c=()=>{e&&Array.from($.keys()).filter(p=>p.endsWith(`-${e}`)).forEach(p=>{$.delete(p)})};return t.on("languageChanged",c),()=>{t.off("languageChanged",c)}},[t,e]);const l=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{s&&l&&$.get(l)&&$.delete(l)},[s,l]),v.useEffect(()=>{if(l){const c=$.get(l);c&&Date.now()-c.timestamp<P&&(i(c.data),a(!1))}},[l]);const g=v.useCallback(async()=>{if(!e||!l){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:l});return}if(!s)return;const c=$.get(l);if(c&&Date.now()-c.timestamp<P){i(c.data),a(!1);return}a(!0);try{const u=await le(t.resolvedLanguage,e),p={};for(const d of u){const h={[o("none")]:[]},m={};d.intensities&&Array.isArray(d.intensities)&&d.intensities.sort((b,T)=>b.value-T.value).forEach(b=>{h[b.label]=[],m[b.value]=b.label});const f=d.type||"action";p[d.name]={label:d.label||d.name,type:f,actions:h,intensities:m}}$.set(l,{data:p,timestamp:Date.now()}),i(p)}catch(u){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:u,locale:t.resolvedLanguage,gameMode:e,cacheKey:l}),i({})}finally{a(!1)}},[e,t.resolvedLanguage,l,o,s]);return v.useEffect(()=>{l&&s&&g()},[g,l,s]),{actionsList:n,isLoading:r}}export{Ve as a,et as b,tt as c,Oe as d,Ze as e,Se as f,Ge as g,Qe as h,Me as s,Te as u,Ke as v};
