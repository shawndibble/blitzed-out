const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/getUniqueImportRecords.ts-Bi9esRPP.js","js/chunk-Vuzv59E5.js","js/chunk-CfN-ANIX.js","js/chunk-CuMUTfgR.js","js/chunk-DOYo4UL0.js","js/chunk-CwKBHVCv.js","assets/index-NXMOp5SB.js","js/chunk-Bde8qXua.js","js/chunk-6JIRnTv3.js","js/chunk-D0hPV1-j.js","js/chunk-Bp62TkGl.js","js/chunk-DwDV8mEA.js","js/chunk-C3rktb3S.js","js/chunk-DXy1pfJx.js"])))=>i.map(i=>d[i]);
import{j as e,T as b,B as _,l as H,I as X,S as Y,M as F,h as se,ab as qe,i as Q,C as $e,an as ye,q as be,s as je,U as lt,V as Ve,t as ve,aB as ct,aC as ut,ap as dt,aD as pt,K as ae,aE as ze,N as Te,D as Be,aF as mt,z as Oe,aG as ht,f as gt,aH as ft,w as xt,aI as yt,F as bt,aJ as jt,ai as vt,G as ge}from"./chunk-Vuzv59E5.js";import{r as p,a as Tt}from"./chunk-CfN-ANIX.js";import{C as Gt,u as Ct}from"./chunk-DOYo4UL0.js";import{O as pe,P as It,k as oe,t as wt,N as le,Q as St,J as Ge,K as me,R as He,T as Xe,V as ke,_ as Ye,W as Je,u as ee,X as Ze,Y as Et,Z as Lt,$ as At,a0 as Dt,a1 as Nt,a2 as Pe,a3 as _t,a4 as $t,a5 as kt,l as Mt,a6 as Ft}from"../assets/index-NXMOp5SB.js";import{u as Re}from"./chunk-6JIRnTv3.js";import{T as Vt}from"./chunk-CwKBHVCv.js";import{A as ce,a as ue,b as de}from"./chunk-D0hPV1-j.js";import{d as Ot}from"./chunk-Bp62TkGl.js";import{a as Me,u as Pt}from"./chunk-DwDV8mEA.js";import{T as N}from"./chunk-C3rktb3S.js";import{n as fe}from"./chunk-CuMUTfgR.js";import{u as Rt}from"./chunk-DXy1pfJx.js";const Ut=n=>{const a={};for(const r of n){const c={label:r.label||r.name,type:r.type||"action",actions:{None:[]}};if(r.intensities&&Array.isArray(r.intensities))for(const i of r.intensities)c.actions[i.label]=[];a[r.name]=c}return a},xe=async(n="en",a="online")=>{try{const r=await pe(n,a);return Ut(r)}catch(r){return console.error("Error importing actions from Dexie:",r),{}}};function Qe(n){return[...Object.entries(n).flatMap(([r,{label:c,actions:i}])=>i?Object.keys(i).filter(o=>o!==It).map((o,t)=>({group:Ot(r),groupLabel:c,value:r,intensity:Number(t+1),translatedIntensity:o,label:`${c} - ${o}`})):[]),{group:oe.t("misc"),groupLabel:oe.t("misc"),value:"misc",intensity:1,translatedIntensity:oe.t("all"),label:`${oe.t("misc")} - ${oe.t("all")}`}]}const Ce=50,Ie=100,we=50,Se=1,Ee=10,Le=1,Ae=10,et=["none","all","default","undefined","null"],Kt=["solo","foreplay","sex","consumption"],Wt=(n,a="en",r="online",c)=>{const i=[],h=[];if(!n||n.trim().length===0)return i.push("Group name is required"),{isValid:!1,errors:i,warnings:h};const o=n.trim();return o.length>Ce&&i.push(`Group name must be ${Ce} characters or less`),et.includes(o.toLowerCase())&&i.push(`"${o}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(o)||i.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(o)||i.push("Group name must start with a letter"),{isValid:i.length===0,errors:i,warnings:h}},tt=n=>{const a=[],r=[];return!n||n.trim().length===0?(a.push(wt("groupLabelRequired")),{isValid:!1,errors:a,warnings:r}):(n.trim().length>Ie&&a.push(`Group label must be ${Ie} characters or less`),{isValid:a.length===0,errors:a,warnings:r})},qt=n=>{const a=[],r=[];if(!n||n.length===0)return a.push("At least one intensity level is required"),{isValid:!1,errors:a,warnings:r};n.length<Le&&a.push(`At least ${Le} intensity level is required`),n.length>Ae&&a.push(`Maximum ${Ae} intensity levels allowed`);const c=new Set,i=new Set;for(let t=0;t<n.length;t++){const u=n[t];if((!u.id||u.id.trim().length===0)&&a.push(`Intensity level ${t+1} is missing an ID`),!u.label||u.label.trim().length===0)a.push(`Intensity level ${t+1} is missing a label`);else{const d=u.label.trim();d.length>we&&a.push(`Intensity level ${t+1} label must be ${we} characters or less`),i.has(d.toLowerCase())?a.push(`Intensity label "${d}" is used multiple times`):i.add(d.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?a.push(`Intensity level ${t+1} must have a valid integer value`):((u.value<Se||u.value>Ee)&&a.push(`Intensity level ${t+1} value must be between ${Se} and ${Ee}`),c.has(u.value)?a.push(`Intensity value ${u.value} is used multiple times`):c.add(u.value))}const h=Array.from(c).sort((t,u)=>t-u);let o=h[0];for(const t of h){if(t!==o){r.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}o++}return{isValid:a.length===0,errors:a,warnings:r}},st=async(n,a)=>{const r=[],c=[],i=Wt(n.name,n.locale||"en",n.gameMode||"online");r.push(...i.errors),c.push(...i.warnings||[]);const h=tt(n.label);r.push(...h.errors),c.push(...h.warnings||[]);const o=qt(n.intensities);if(r.push(...o.errors),c.push(...o.warnings||[]),i.isValid&&n.name)try{await St(n.name,n.locale||"en",n.gameMode||"online",a)||r.push(`A group with the name "${n.name}" already exists for this locale and game mode`)}catch{c.push("Could not verify group name uniqueness")}return{isValid:r.length===0,errors:r,warnings:c}},Ue=async(n,a="en",r="online")=>{const c=[],i=[];if(!n.group||n.group.trim().length===0)return c.push("Tile must belong to a group"),{isValid:!1,errors:c,warnings:i};try{const h=await le(n.group,a,r);if(!h)return c.push(`Group "${n.group}" does not exist for ${a}/${r}`),{isValid:!1,errors:c,warnings:i};const o=h.intensities.map(t=>t.value);o.includes(n.intensity)||c.push(`Intensity ${n.intensity} is not valid for group "${n.group}". Valid intensities: ${o.join(", ")}`),(!n.action||n.action.trim().length===0)&&c.push("Tile action is required")}catch(h){c.push(`Error validating tile: ${h}`)}return{isValid:c.length===0,errors:c,warnings:i}},zt=()=>({MAX_GROUP_NAME_LENGTH:Ce,MAX_GROUP_LABEL_LENGTH:Ie,MAX_INTENSITY_LABEL_LENGTH:we,MIN_INTENSITY_VALUE:Se,MAX_INTENSITY_VALUE:Ee,MIN_INTENSITIES_COUNT:Le,MAX_INTENSITIES_COUNT:Ae,RESERVED_GROUP_NAMES:et,VALID_GROUP_TYPES:Kt}),De="2.0.0",Bt=2,nt=0;async function Ne(n="en",a={}){try{let r;if(a.exportScope==="single"&&a.singleGroup){const s=await le(a.singleGroup,n);r=s&&!s.isDefault?[s]:[]}else a.exportScope==="default"?r=[]:r=(await Ge({locale:n})).filter(m=>!m.isDefault);const c=await Ge({locale:n}),i=new Set(c.filter(s=>s.isDefault).map(s=>s.name)),o=(await me({isCustom:1})).filter(s=>{const m=!s.locale||s.locale===n;return a.exportScope==="single"&&a.singleGroup?m&&s.group===a.singleGroup:a.exportScope==="default"?m&&i.has(s.group):m}),t={};for(const s of r){const m=s.intensities.sort((S,$)=>S.value-$.value).map(S=>S.label),C=s.intensities.find(S=>S.value===nt),L=m.filter(S=>S!==C?.label),D=C?[C.label,...L]:m;t[s.name]={label:s.label,type:s.type||"sex",intensities:D}}const u={};for(const s of o)u[s.group]||(u[s.group]={}),u[s.group][s.intensity]||(u[s.group][s.intensity]=[]),s.tags&&s.tags.length>0?u[s.group][s.intensity].push({action:s.action,tags:s.tags}):u[s.group][s.intensity].push(s.action);const d={};Object.keys(t).sort().forEach(s=>{d[s]=t[s]});const g={};return Object.keys(u).sort().forEach(s=>{g[s]={},Object.keys(u[s]).sort((m,C)=>Number.parseInt(m,10)-Number.parseInt(C,10)).forEach(m=>{g[s][Number.parseInt(m,10)]=u[s][Number.parseInt(m,10)]})}),JSON.stringify({version:De,locale:n,groups:d,customTiles:g},(s,m)=>(Array.isArray(m)&&m.length>0&&typeof m[0]=="string",m),Bt)}catch(r){throw console.error("Error exporting clean data:",r),new Error(`Export failed: ${r}`)}}async function Ht(n,a={}){const r={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{let c;try{c=JSON.parse(n)}catch{return r.errors.push("Invalid JSON format"),r}if(!c.version||!c.groups||!c.customTiles)return r.errors.push("Invalid export format - missing version, groups, or customTiles"),r;c.version!==De&&r.warnings.push(`Format version mismatch: expected ${De}, got ${c.version}`);const i=a.locale||c.locale||"en",h=a.mergeStrategy||"skip";for(const[o,t]of Object.entries(c.groups))try{const u=await le(o,i);let d=o;if(u)switch(h){case"skip":r.warnings.push(`Skipped existing group: ${o}`);continue;case"overwrite":r.warnings.push(`Will update existing group: ${o}`);break;case"rename":{let m=1;for(d=`${o}_imported`;await le(d,i);)d=`${o}_imported_${m}`,m++;r.warnings.push(`Renamed group from ${o} to ${d}`);break}}const g=t.intensities.map((m,C)=>({id:`intensity-${C}`,label:m,value:C,isDefault:C===nt})),l={name:d,label:t.label,intensities:g,type:t.type,locale:i,isDefault:!1},s=await st(l);if(!s.isValid){r.errors.push(`Invalid group ${d}: ${s.errors.join(", ")}`);continue}u&&h==="overwrite"?await He(u.id,l):await Xe(l),r.importedGroups++}catch(u){r.errors.push(`Error importing group ${o}: ${u}`)}for(const[o,t]of Object.entries(c.customTiles))try{const u=await le(o,i);if(!u){r.warnings.push(`Group ${o} not found for custom tiles, skipping tiles`);continue}for(const[d,g]of Object.entries(t)){const l=Number.parseInt(d,10);if(!u.intensities.find(m=>m.value===l)){r.warnings.push(`Intensity ${l} not valid for group ${o}, skipping tiles`);continue}for(const m of g)try{let C,L=[];if(typeof m=="string")C=m;else if(m&&typeof m=="object"&&"action"in m)C=m.action,L=m.tags||[];else{r.warnings.push(`Invalid tile data format in group ${o}, skipping`);continue}if((await me()).find($=>$.group===o&&$.intensity===l&&$.action===C&&(!$.locale||$.locale===i))&&h==="skip"){r.warnings.push(`Skipped existing tile: ${C.substring(0,50)}...`);continue}await ke({group:o,intensity:l,action:C,tags:L,isCustom:1,locale:i}),r.importedTiles++}catch(C){r.errors.push(`Error importing tile "${typeof m=="string"?m.substring(0,30):"object"}...": ${C}`)}}}catch(u){r.errors.push(`Error importing tiles for group ${o}: ${u}`)}return r.success=r.errors.length===0,r}catch(c){return r.errors.push(`Import failed: ${c}`),r}}async function Xt(n,a,r="en",c="online"){const i={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{const{default:h}=await Ye(async()=>{const{default:d}=await import("./getUniqueImportRecords.ts-Bi9esRPP.js");return{default:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])),o=await me(),{newUniqueRecords:t,changedTagRecords:u}=h(n,o,a);for(const d of t)try{await ke(d),i.importedTiles++}catch(g){i.errors.push(`Error importing tile: ${g}`)}for(const d of u)try{d.id&&await Je(d.id,d)}catch(g){i.errors.push(`Error updating tile: ${g}`)}return i.success=i.errors.length===0,i.warnings.push("Imported using legacy format. Consider exporting in clean v2.0 format for better compatibility."),i}catch(h){return i.errors.push(`Legacy import failed: ${h}`),i}}async function Yt(n,a="en"){return Ne(a,{singleGroup:n,exportScope:"single"})}async function Jt(n,a,r={}){const c=n.trim();try{const i=JSON.parse(c);if(i.version&&i.groups)return Ht(c,r);if(i.version&&i.customGroups!==void 0)return{success:!1,importedGroups:0,importedTiles:0,errors:["Old enhanced format no longer supported. Please use clean v2.0 format."],warnings:[]}}catch{}return Xt(c,a,r.locale||"en",r.gameMode||"online")}async function Zt(n="en"){try{const r=(await Ge({locale:n})).filter(i=>!i.isDefault),c=await me({isCustom:1});return r.map(i=>{const h=c.filter(o=>o.group===i.name&&(!o.locale||o.locale===n));return{name:i.name,label:i.label,tileCount:h.length}})}catch(a){return console.error("Error getting available groups for export:",a),[]}}function Qt({expanded:n,handleChange:a,customTiles:r,mappedGroups:c,setSubmitMessage:i,bulkImport:h}){const o=p.useRef(null),{t}=ee(),{settings:u}=Me(),[d,g]=p.useState(""),[l,s]=p.useState(null),[m,C]=p.useState("clean"),[L,D]=p.useState("all"),[S,$]=p.useState(""),[A,O]=p.useState([]),[j,M]=p.useState("skip"),k=p.useCallback(async()=>{try{if(m==="clean"){let y;switch(L){case"single":if(!S){i({message:t("errors.selectGroupToExport"),type:"error"});return}y=await Yt(S,u.locale||"en");break;case"default":y=await Ne(u.locale||"en",{exportScope:"default"});break;default:y=await Ne(u.locale||"en",{exportScope:"all"});break}g(y)}else{const f=r.filter(T=>T.isCustom).map(({group:T,intensity:w,action:K,tags:q,gameMode:U="online"})=>{const v=Qe(c[U]||{}).find(V=>V?.intensity===Number(w)&&V?.value===T);let E="";return E+=`[${v?.group||T} - ${v?.translatedIntensity||w}]
`,E+=K,E+=q?.length?`
Tags: `+q?.join(", "):"",E+=`
GameMode: ${U}`,E});g(f.join(`
---
`))}}catch(y){console.error("Error exporting data:",y),i({message:t("errors.exportFailed",{error:y}),type:"error"})}},[r,c,g,m,L,S,u.locale,i,t]);async function P(y){if(!y.current)return;const T=y.current.importData.value;if(!T.trim())return i({type:"error",message:t("enterDataToImport")});try{i({type:"info",message:t("importMessages.importing")});const w=await Jt(T,c,{locale:u.locale||"en",mergeStrategy:j});if(s(w),w.success){w.importedTiles>0&&(await Ye(()=>import("../assets/index-NXMOp5SB.js").then(U=>U.ad),__vite__mapDeps([6,1,2,3,7])).then(U=>U.getTiles({isCustom:1}))).slice(-w.importedTiles).forEach(async U=>{Ze(`${U.group} - ${U.intensity}`,U.action)});let K=t("importMessages.importSuccess");w.importedGroups>0&&(K+=` ${t("importMessages.importedGroups",{count:w.importedGroups})}`),w.importedTiles>0&&(K+=` ${t("importMessages.importedTiles",{count:w.importedTiles})}`),i({type:"success",message:K}),await k()}else i({type:"error",message:t("errors.importFailed",{errors:w.errors.join(", ")})})}catch(w){console.error("Import error:",w),i({type:"error",message:t("errors.importFailed",{errors:w.message||w})}),s(null)}}const G=p.useCallback(async()=>{try{const y=await Zt(u.locale||"en");O(y)}catch(y){console.error("Error loading available groups:",y)}},[u.locale]);return p.useEffect(()=>{n==="ctImport"&&(G(),k())},[n,r,k,G]),e.jsxs(ce,{expanded:n==="ctImport",onChange:a("ctImport"),children:[e.jsx(ue,{"aria-controls":"ctImport-content",id:"ctImport-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"importExport"})})}),e.jsxs(de,{children:[e.jsx(b,{variant:"body1",sx:{mb:2},children:e.jsx(N,{i18nKey:"ctImportDescription"})}),e.jsxs(_,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:2,"& .MuiFormControl-root":{minWidth:150,flex:"1 1 auto"}},children:[e.jsxs(H,{size:"small",children:[e.jsx(X,{children:t("labels.exportFormat")}),e.jsxs(Y,{value:m,onChange:y=>C(y.target.value),label:t("labels.exportFormat"),children:[e.jsx(F,{value:"clean",children:t("exportFormat.clean")}),e.jsx(F,{value:"legacy",children:t("exportFormat.legacy")})]})]}),m==="clean"&&e.jsxs(H,{size:"small",children:[e.jsx(X,{children:t("labels.exportScope")}),e.jsxs(Y,{value:L,onChange:y=>{D(y.target.value),$("")},label:t("labels.exportScope"),children:[e.jsx(F,{value:"all",children:t("exportScope.all")}),e.jsx(F,{value:"default",children:t("exportScope.default")}),e.jsx(F,{value:"single",children:t("exportScope.single")})]})]}),e.jsxs(H,{size:"small",children:[e.jsx(X,{children:t("labels.importStrategy")}),e.jsxs(Y,{value:j,onChange:y=>M(y.target.value),label:t("labels.importStrategy"),children:[e.jsx(F,{value:"skip",children:t("importStrategy.skip")}),e.jsx(F,{value:"overwrite",children:t("importStrategy.overwrite")}),e.jsx(F,{value:"rename",children:t("importStrategy.rename")})]})]})]}),m==="clean"&&L==="single"&&e.jsx(_,{sx:{mb:2},children:e.jsxs(H,{size:"small",fullWidth:!0,children:[e.jsx(X,{children:t("labels.selectGroup")}),e.jsx(Y,{value:S,onChange:y=>$(y.target.value),label:t("labels.selectGroup"),children:A.map(y=>e.jsxs(F,{value:y.name,children:[y.label," (",y.tileCount," tiles)"]},y.name))})]})}),e.jsxs(_,{component:"form",method:"post",ref:o,children:[e.jsx(se,{id:"importData",name:"importData",multiline:!0,required:!0,fullWidth:!0,rows:6,sx:{pb:2},value:d,onChange:y=>g(y.target.value),placeholder:t(m==="clean"?"placeholder.cleanFormat":"placeholder.legacyFormat"),InputProps:{endAdornment:e.jsx(Gt,{text:d}),sx:{alignItems:"flex-start"}}}),l&&e.jsxs(qe,{severity:l.success?"success":"error",sx:{mb:2},onClose:()=>s(null),children:[e.jsx(b,{variant:"body2",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.title"})})}),l.importedGroups>0&&e.jsxs(b,{variant:"body2",children:["•"," ",e.jsx(N,{i18nKey:"importResults.groupsImported",values:{count:l.importedGroups}})]}),l.importedTiles>0&&e.jsxs(b,{variant:"body2",children:["•"," ",e.jsx(N,{i18nKey:"importResults.tilesImported",values:{count:l.importedTiles}})]}),l.warnings.length>0&&e.jsxs(_,{sx:{mt:1},children:[e.jsx(b,{variant:"body2",color:"warning.main",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.warnings"})})}),l.warnings.map((y,f)=>e.jsxs(b,{variant:"body2",color:"warning.main",children:["• ",y]},f))]}),l.errors.length>0&&e.jsxs(_,{sx:{mt:1},children:[e.jsx(b,{variant:"body2",color:"error.main",children:e.jsx("strong",{children:e.jsx(N,{i18nKey:"importResults.errors"})})}),l.errors.map((y,f)=>e.jsxs(b,{variant:"body2",color:"error.main",children:["• ",y]},f))]})]}),e.jsx(Q,{fullWidth:!0,variant:"contained",type:"button",onClick:()=>P(o),children:e.jsx(N,{i18nKey:"import"})})]}),m==="clean"&&e.jsxs(ce,{sx:{mt:2},children:[e.jsx(ue,{children:e.jsx(b,{variant:"subtitle2",children:e.jsx(N,{i18nKey:"formatGuide.title"})})}),e.jsxs(de,{children:[e.jsx(b,{variant:"body2",sx:{mb:2},children:e.jsx(N,{i18nKey:"formatGuide.description"})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.keySections"})}),e.jsx(b,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(N,{i18nKey:"formatGuide.keySectionsContent",components:{strong1:e.jsx("strong",{}),strong2:e.jsx("strong",{}),br:e.jsx("br",{})}})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.manualEditing"})}),e.jsx(b,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(N,{i18nKey:"formatGuide.manualEditingContent",components:{br:e.jsx("br",{})}})}),e.jsx(b,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(N,{i18nKey:"formatGuide.customTilesFormat"})}),e.jsx(b,{variant:"body2",component:"div",sx:{ml:2},children:e.jsx(N,{i18nKey:"formatGuide.customTilesFormatContent",components:{br:e.jsx("br",{}),code1:e.jsx("code",{}),code2:e.jsx("code",{})}})})]})]})]})]})}function es({value:n,onChange:a,locale:r,gameMode:c,includeDefault:i=!0,disabled:h=!1,refreshTrigger:o=0}){const{t}=ee(),[u,d]=p.useState([]),[g,l]=p.useState(!0);return p.useEffect(()=>{(async()=>{l(!0);try{const m=await pe(r,c),C=i?m:m.filter(L=>!L.isDefault);d(C)}catch(m){console.error("Error loading custom groups:",m),d([])}finally{l(!1)}})()},[r,c,i,o]),g?e.jsxs(H,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:t("customGroups.loadingGroups")}),e.jsx(Y,{value:"",children:e.jsx(F,{value:"",children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($e,{size:16}),e.jsx("span",{children:t("customGroups.loadingGroups")})]})})})]}):e.jsx(_,{children:e.jsxs(H,{fullWidth:!0,disabled:h,children:[e.jsx(X,{id:"group-label",children:t("group")}),e.jsx(Y,{labelId:"group-label",value:n,onChange:s=>a(s.target.value),label:t("group"),children:u.length===0?e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:t("customGroups.noGroupsAvailable",{locale:r,gameMode:c})})}):u.map(s=>e.jsx(F,{value:s.name,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{children:s.label}),s.isDefault&&e.jsx(ye,{label:t("default"),size:"small",variant:"outlined"})]})},s.id))})]})})}function ts({groupName:n,value:a,onChange:r,locale:c,gameMode:i,disabled:h=!1}){const{t:o}=ee(),[t,u]=p.useState([]),[d,g]=p.useState(!1);p.useEffect(()=>{(async()=>{if(!n){u([]);return}g(!0);try{const m=await Et(n,c,i);u(m)}catch(m){console.error("Error loading group intensities:",m),u([])}finally{g(!1)}})()},[n,c,i]);const l=p.useMemo(()=>t.sort((s,m)=>s.value-m.value),[t]);return p.useEffect(()=>{if(t.length>0&&a&&!t.some(s=>s.value===a)){const s=l[0];s&&r(s.value)}},[t,a,r,l]),n?d?e.jsxs(H,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:o("customGroups.loadingIntensities")}),e.jsx(Y,{value:"",children:e.jsx(F,{value:"",children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($e,{size:16}),e.jsx("span",{children:o("customGroups.loadingIntensities")})]})})})]}):t.length===0?e.jsxs(H,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:o("intensity")}),e.jsx(Y,{value:"",children:e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:o("customGroups.noIntensitiesAvailable",{groupName:n})})})})]}):e.jsx(_,{children:e.jsxs(H,{fullWidth:!0,disabled:h,children:[e.jsx(X,{children:o("intensity")}),e.jsx(Y,{value:a||"",onChange:s=>r(Number(s.target.value)),label:o("intensity"),children:l.map(s=>e.jsx(F,{value:s.value,children:s.label},s.id))})]})}):e.jsxs(H,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:o("intensity")}),e.jsx(Y,{value:"",children:e.jsx(F,{value:"",disabled:!0,children:e.jsx(b,{color:"text.secondary",children:o("customGroups.selectGroupFirst")})})})]})}const _e=[{name:"Basic (1-4)",intensities:[{label:"intensityLabels.light",value:1,isDefault:!0},{label:"intensityLabels.medium",value:2,isDefault:!0},{label:"intensityLabels.intense",value:3,isDefault:!0},{label:"intensityLabels.extreme",value:4,isDefault:!0}]},{name:"Simple (1-3)",intensities:[{label:"intensityLabels.beginner",value:1,isDefault:!0},{label:"intensityLabels.intermediate",value:2,isDefault:!0},{label:"intensityLabels.advanced",value:3,isDefault:!0}]},{name:"Extended (1-5)",intensities:[{label:"intensityLabels.veryLight",value:1,isDefault:!0},{label:"intensityLabels.light",value:2,isDefault:!0},{label:"intensityLabels.medium",value:3,isDefault:!0},{label:"intensityLabels.intense",value:4,isDefault:!0},{label:"intensityLabels.veryIntense",value:5,isDefault:!0}]}],Ke=n=>{const a=_e.findIndex(r=>r.intensities.length===n.length);return a>=0?a:1};function ss({open:n,onClose:a,onGroupCreated:r,onGroupUpdated:c,editingGroup:i,locale:h,gameMode:o}){const{t}=ee(),[u,d]=p.useState(0),[g,l]=p.useState([]),[s,m]=p.useState(!0),[C,L]=p.useState({}),D=zt(),[S,$]=p.useState(""),[A,O]=p.useState(""),[j,M]=p.useState(1),[k,P]=p.useState([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),[G,y]=p.useState(null),[f,T]=p.useState(!1),[w,K]=p.useState({isValid:!0,errors:[]}),[q,U]=p.useState(!1),[B,v]=p.useState(null),E=p.useCallback(async()=>{try{const I=(await pe(h,o)).filter(z=>!z.isDefault);l(I);const R={};await Promise.all(I.map(async z=>{R[z.id]=await Lt(z.name,h,o)})),L(R)}catch(x){console.error("Error reloading groups:",x)}},[h,o]);p.useEffect(()=>{(async()=>{if(n){m(!0);try{await E()}catch(I){console.error("Error loading groups:",I)}finally{m(!1)}}})()},[n,h,o,E]);const V=x=>x.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,20)||`group_${fe(6).toLowerCase()}`;p.useEffect(()=>{i?(y(i),$(i.label),O(i.type||""),P(i.intensities.map(x=>x.label)),M(Ke(i.intensities))):G?($(G.label),O(G.type||""),P(G.intensities.map(x=>x.label)),M(Ke(G.intensities))):(y(null),$(""),O(""),M(1),P([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")])),K({isValid:!0,errors:[]})},[i,G,n,t]);const J=x=>{const I=_e[x];M(x),P(I.intensities.map(R=>t(R.label)))},ne=(x,I)=>{const R=[...k];R[x]=I,P(R)},Z=()=>{k.length>=D.MAX_INTENSITIES_COUNT||P([...k,t("customGroups.levelLabel",{level:k.length+1})])},te=x=>{if(k.length<=D.MIN_INTENSITIES_COUNT)return;const I=k.filter((R,z)=>z!==x);P(I)};p.useEffect(()=>{(async()=>{if(!S.trim()&&!A&&k.length===0){K({isValid:!0,errors:[]});return}const I=[];if(A&&!D.VALID_GROUP_TYPES.includes(A)&&I.push(t("typeValidationError",{types:D.VALID_GROUP_TYPES.join(", ")})),S.trim()&&!A&&I.push(t("typeRequiredError")),I.length>0){K({isValid:!1,errors:I});return}const R=k.map((at,ot)=>({id:fe(),label:at,value:ot+1,isDefault:!1})),z={name:G?G.name:V(S),label:S.trim(),intensities:R,type:A||void 0,locale:h,gameMode:o,isDefault:!1},it=await st(z,G?.id);K(it)})()},[S,A,k,h,o,G,t,D.VALID_GROUP_TYPES]);const W=x=>{y(x),$(x.label),P(x.intensities.map(I=>I.label)),d(1)},re=async x=>{const I=g.find(z=>z.id===x);if(!I)return;const R=C[x]||0;v({id:x,name:I.label,tileCount:R}),U(!0)},he=async()=>{if(!B)return;const{id:x,tileCount:I}=B,R=g.find(z=>z.id===x);if(R)try{I>0&&await At(R.name,h,o),await Dt(x),await E(),c?.(null)}catch(z){console.error("Error deleting group:",z)}finally{U(!1),v(null)}},rt=async()=>{if(!(!w.isValid||f)){T(!0);try{const x=k.map((R,z)=>({id:fe(),label:R,value:z+1,isDefault:!1})),I={name:G?G.name:V(S),label:S.trim(),intensities:x,type:A||void 0,locale:h,gameMode:o,isDefault:!1};if(G)await He(G.id,I),c?.(G);else{const R=await Xe(I);R&&r?.({...I,id:R,createdAt:new Date,updatedAt:new Date,isDefault:!1,locale:h,gameMode:o})}Fe(),a()}catch(x){console.error("Error saving custom group:",x),K({isValid:!1,errors:[t("failedToSaveGroup",{error:x})]})}finally{T(!1)}}},Fe=()=>{y(null),$(""),O(""),M(1),P([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),K({isValid:!0,errors:[]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{open:n,onClose:a,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"600px"}},children:[e.jsxs(je,{children:[t("customGroups.manageCustomGroups"),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mt:1},children:t("customGroups.createNewGroupsDescription")}),e.jsxs(lt,{value:u,onChange:(x,I)=>{d(I),I===1&&!G&&Fe()},sx:{mt:2,borderBottom:1,borderColor:"divider"},children:[e.jsx(Ve,{label:t("customGroups.existingGroups")}),e.jsx(Ve,{label:t(G?"customGroups.editGroup":"customGroups.createNew")})]})]}),e.jsxs(ve,{dividers:!0,children:[u===0&&e.jsx(_,{children:s?e.jsx(b,{children:t("Loading groups...")}):g.length===0?e.jsx(b,{color:"text.secondary",sx:{textAlign:"center",py:4},children:t("customGroups.noCustomGroupsFound")}):e.jsx(ct,{children:g.map((x,I)=>e.jsxs(Tt.Fragment,{children:[e.jsxs(ut,{children:[e.jsx(dt,{primary:x.label,secondary:e.jsxs(_,{component:"span",sx:{display:"block"},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block"},children:[t("customGroups.intensityLevelsCount",{count:x.intensities.length}),": ",x.intensities.map(R=>R.label).join(", ")]}),e.jsx(b,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block",mt:.5},children:t("customGroups.customTilesCount",{count:C[x.id]||0})})]})}),e.jsxs(pt,{children:[e.jsx(ae,{edge:"end","aria-label":"edit",onClick:()=>W(x),sx:{mr:1},children:e.jsx(ze,{})}),e.jsx(ae,{edge:"end","aria-label":"delete",onClick:()=>re(x.id),color:"error",children:e.jsx(Te,{})})]})]}),I<g.length-1&&e.jsx(Be,{})]},x.id))})}),u===1&&e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:3},children:[!w.isValid&&e.jsx(qe,{severity:"error",children:w.errors.map((x,I)=>e.jsx("div",{children:x},I))}),e.jsxs(_,{sx:{p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(b,{variant:"h6",sx:{mb:2},children:t("customGroups.groupInformation")}),e.jsx(se,{label:t("customGroups.groupLabel"),value:S,onChange:x=>$(x.target.value),placeholder:"e.g., My Custom Group",helperText:t("customGroups.groupLabelHelp",{maxLength:D.MAX_GROUP_LABEL_LENGTH}),fullWidth:!0,required:!0,error:S.trim().length>0&&!tt(S).isValid,sx:{mb:2}}),e.jsxs(se,{select:!0,label:t("customGroups.groupType"),value:A,onChange:x=>O(x.target.value),helperText:t("customGroups.groupTypeHelp"),fullWidth:!0,required:!0,error:S.trim().length>0&&!A,sx:{mb:2},children:[e.jsx(F,{value:"",children:e.jsx("em",{children:t("groupTypes.selectType")})}),e.jsx(F,{value:"solo",children:t("groupTypes.solo")}),e.jsx(F,{value:"foreplay",children:t("groupTypes.foreplay")}),e.jsx(F,{value:"sex",children:t("groupTypes.sex")}),e.jsx(F,{value:"consumption",children:t("groupTypes.consumption")})]}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.locale")})," ",h," |"," ",e.jsx("strong",{children:t("customGroups.gameMode")})," ",o]}),G?e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",G.name," ","(locked)"]}):e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",S?V(S):t("customGroups.autoGenerated")]})]})]}),e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"action.hover",borderRadius:1},children:[e.jsx(b,{variant:"body2",sx:{fontWeight:"medium",minWidth:"auto"},children:t("customGroups.quickStart")}),e.jsx(se,{select:!0,value:j,onChange:x=>J(Number(x.target.value)),size:"small",sx:{minWidth:200},label:t("customGroups.chooseTemplate"),children:_e.map((x,I)=>e.jsx(F,{value:I,children:x.name==="Basic (1-4)"?t("templateBasic"):x.name==="Simple (1-3)"?t("templateSimple"):x.name==="Extended (1-5)"?t("templateExtended"):x.name},I))}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.75rem"},children:t("customGroups.selectTemplateDescription")})]}),e.jsxs(_,{children:[e.jsxs(b,{variant:"h6",sx:{mb:2},children:[t("customGroups.intensityLabels")," (",k.length,"/",D.MAX_INTENSITIES_COUNT,")"]}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("customGroups.customizeIntensityDescription")}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[k.map((x,I)=>e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(b,{variant:"body2",sx:{minWidth:"30px",fontWeight:"bold",color:"primary.main"},children:I+1}),e.jsx(se,{label:t("customGroups.levelInputLabel",{level:I+1}),value:x,onChange:R=>ne(I,R.target.value),size:"small",sx:{flex:1},inputProps:{maxLength:D.MAX_INTENSITY_LABEL_LENGTH}}),e.jsx(ae,{onClick:()=>te(I),disabled:k.length<=D.MIN_INTENSITIES_COUNT,color:"error",size:"small",children:e.jsx(Te,{})})]},I)),e.jsx(Q,{startIcon:e.jsx(mt,{}),onClick:Z,disabled:k.length>=D.MAX_INTENSITIES_COUNT,variant:"outlined",size:"small",sx:{alignSelf:"flex-start",mt:1},children:t("customGroups.addIntensityLevel")})]})]})]})]}),e.jsxs(Oe,{children:[e.jsx(Q,{onClick:a,disabled:f,children:t("cancel")}),e.jsx(Q,{onClick:rt,variant:"contained",disabled:!w.isValid||f,children:t(f?"customGroups.saving":G?"customGroups.updateGroup":"customGroups.createGroup")})]})]}),e.jsxs(be,{open:q,onClose:()=>U(!1),children:[e.jsx(je,{children:t("customGroups.confirmDelete")}),e.jsx(ve,{children:e.jsx(b,{children:(B?.tileCount??0)>0?t("customGroups.deleteGroupWithTiles",{name:B?.name,count:B?.tileCount}):t("customGroups.deleteGroupConfirm",{name:B?.name})})}),e.jsxs(Oe,{children:[e.jsx(Q,{onClick:()=>U(!1),children:t("cancel")}),e.jsx(Q,{onClick:he,color:"error",variant:"contained",children:t("Delete")})]})]})]})}function ns({setSubmitMessage:n,boardUpdated:a,customTiles:r,mappedGroups:c,expanded:i,handleChange:h,tagList:o,updateTileId:t,setUpdateTileId:u}){const{t:d}=ee(),{settings:g}=Me(),[l,s]=p.useState({gameMode:g.gameMode||"online",group:"",intensity:"",action:"",tags:[d("custom")]}),[m,C]=p.useState(!1),[L,D]=p.useState(""),[S,$]=p.useState(0);p.useEffect(()=>{const T=setTimeout(async()=>{if(!l.group||!l.intensity||!l.action){D("");return}try{const w=await Ue({group:l.group,intensity:Number(l.intensity),action:l.action,tags:l.tags,gameMode:l.gameMode,isCustom:1},g.locale||"en",l.gameMode);w.isValid?D(""):D(w.errors.join(", "))}catch(w){console.error("Error validating tile:",w),D("")}},300);return()=>clearTimeout(T)},[l.group,l.intensity,l.action,l.gameMode,l.tags,g.locale]),p.useEffect(()=>{const T=(Array.isArray(r)?r:[]).find(({id:w})=>w===t);if(T){const w=T.gameMode||g.gameMode;s({gameMode:w,group:T.group||"",intensity:T.intensity||"",action:T.action||"",tags:T.tags||[d("custom")]})}else s(w=>({...w,gameMode:g.gameMode}))},[t,g.gameMode,r,d]);function A(f,T,w){return(Array.isArray(r)?r:[]).find(q=>q.group===f&&q.intensity===T&&q.action===w)}function O(){u(null),s({gameMode:g.gameMode,group:"",intensity:"",action:"",tags:[d("custom")]}),D("")}const j=f=>{s(T=>({...T,group:f.name,intensity:""})),C(!1),$(T=>T+1)},M=()=>{$(f=>f+1)},k=p.useCallback(f=>{s(T=>({...T,intensity:f.toString()}))},[]);async function P(){const f=document.querySelector('input[name="tags"]'),T=[...l.tags];f&&f.value.trim()&&(T.push(f.value.trim()),f.value="");const{gameMode:w,group:K,intensity:q,action:U}=l;if(!w||!K||!q||!U)return n({message:d("allFieldsRequired","All fields are required"),type:"error"});if(L)return n({message:L,type:"error"});if(t==null&&A(K,q,U))return n({message:d("actionExists"),type:"error"});const B={group:K,intensity:Number(q),action:U,tags:T,gameMode:w,isCustom:1};try{const v=await Ue(B,g.locale||"en",w);if(!v.isValid)return n({message:v.errors.join(", "),type:"error"});if(t===null){const E=`${K} - Level ${q}`;Ze(E,U),await ke(B)}else await Je(t,B);return a(),s(E=>({...E,action:"",tags:[d("custom")]})),n({message:d(t?"customUpdated":"customAdded"),type:"success"})}catch(v){return console.error("Error saving custom tile:",v),n({message:d("errorSavingTile"),type:"error"})}}const G=f=>{switch(f.key){case",":case"Enter":{f.preventDefault(),f.stopPropagation(),f.currentTarget.value.length>0&&(s(T=>({...T,tags:[...T.tags,f.currentTarget.value]})),f.currentTarget.value="");break}}},y=f=>{f.target.value.length>0&&(s(T=>({...T,tags:[...T.tags,f.target.value]})),f.target.value=""),setTimeout(()=>{const T=document.querySelector(".MuiAutocomplete-popper");T&&(T.style.display="none")},150)};return e.jsxs(e.Fragment,{children:[e.jsxs(ce,{expanded:i==="ctAdd",onChange:h("ctAdd"),children:[e.jsx(ue,{"aria-controls":"ctAdd-content",id:"ctAdd-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:t?"ctUpdate":"ctAdd"})})}),e.jsx(de,{children:e.jsxs(_,{component:"form",method:"post",className:"settings-box",children:[e.jsxs(se,{select:!0,label:d("customTiles.gameMode"),value:l.gameMode,onChange:f=>{s(T=>({...T,gameMode:f.target.value,group:"",intensity:""}))},fullWidth:!0,sx:{mb:2},children:[e.jsx("option",{value:"online",children:d("online")}),e.jsx("option",{value:"local",children:d("local")}),e.jsx("option",{value:"solo",children:d("solo")})]}),e.jsx(es,{value:l.group,onChange:f=>{s(T=>({...T,group:f,intensity:""}))},locale:g.locale||"en",gameMode:l.gameMode,refreshTrigger:S}),e.jsx(_,{sx:{mt:2},children:e.jsx(ts,{groupName:l.group,value:Number(l.intensity)||0,onChange:k,locale:g.locale||"en",gameMode:l.gameMode})}),L&&e.jsx(_,{sx:{mt:1,mb:2},children:e.jsx(b,{color:"error",variant:"body2",children:L})}),e.jsx(se,{id:"action",name:"action",required:!0,fullWidth:!0,label:d("action"),sx:{mt:2,pb:2},value:l.action,onChange:f=>{s({...l,action:f.target.value})}}),e.jsx(ht,{id:"tags",disableCloseOnSelect:!0,multiple:!0,freeSolo:!0,options:o,value:l.tags,onChange:(f,T)=>{s({...l,tags:T})},renderInput:f=>(f.inputProps.onKeyDown=G,f.inputProps.onBlur=y,e.jsx(se,{...f,label:d("tags")})),sx:{pb:2},clearOnBlur:!0,blurOnSelect:!0,openOnFocus:!0,disablePortal:!1,componentsProps:{popper:{modifiers:[{name:"preventOverflow",options:{altAxis:!0,altBoundary:!0,padding:8}}]}}}),e.jsxs(_,{display:"flex",justifyContent:"space-evenly",gap:1,children:[e.jsx(Q,{variant:"outlined",type:"button",onClick:()=>C(!0),children:d("manageGroups")}),e.jsx(Q,{variant:"contained",type:"button",onClick:()=>O(),children:e.jsx(N,{i18nKey:"clear"})}),e.jsx(Q,{variant:"contained",type:"button",onClick:P,children:e.jsx(N,{i18nKey:t?"ctUpdate":"ctAdd"})})]})]})})]}),e.jsx(ss,{open:m,onClose:()=>C(!1),onGroupCreated:j,onGroupUpdated:M,locale:g.locale||"en",gameMode:l.gameMode})]})}function rs({expanded:n,handleChange:a}){return e.jsxs(e.Fragment,{children:[e.jsxs(ce,{expanded:n==="help1",onChange:a("help1"),children:[e.jsx(ue,{"aria-controls":"help1-content",id:"help1-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"ctExplained"})})}),e.jsx(de,{children:e.jsxs(N,{i18nKey:"ctExplainedDescription",children:[e.jsx(b,{sx:{mb:2},children:"Custom tiles let you add your own variations to the game board. Utilize this dialog to add and remove tiles as you see fit."}),e.jsx(b,{sx:{mb:2},children:"Custom tiles are added based on the kink and intensity you pick from the drop down. As such, you need to have that kink and intensity (or a higher intensity) selected for your custom tiles to show on the board."}),e.jsx(b,{children:"Miscellaneous tiles are the only exception to the above. Regardless of what other options you pick, Miscellaneous tiles will show as their own group. If you use this option, ensure that you add multiple tiles to minimize repeats."})]})})]}),e.jsxs(ce,{expanded:n==="help2",onChange:a("help2"),children:[e.jsx(ue,{"aria-controls":"help2-content",id:"help2-header",children:e.jsx(b,{children:e.jsx(N,{i18nKey:"ctIdeas"})})}),e.jsx(de,{children:e.jsxs(N,{i18nKey:"ctIdeasDescription",children:[e.jsx(b,{variant:"h6",children:"Add new Activities"}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Come up with new activities that are not part of the existing list"}),e.jsx(b,{variant:"h6",children:"Add harder tiles to easier intensities"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"When you pick higher intensity levels, the game will use the earlier intensity level and gradual move to whatyou picked. If you want harder tiles early on, add several to lower intensities."}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Example: You play Poppers - Advanced. Add advanced tiles to Poppers - Beginner"}),e.jsx(b,{variant:"h6",children:"Combine activities into a single tile"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"Combine multiple activites together in a single tile that normally would not go together."}),e.jsx(b,{variant:"subtitle2",sx:{mb:2},children:"Example: Spit roast. Use a toy in your throat and ass at the same time."}),e.jsx(b,{variant:"h6",children:"Miscellaneous custom tiles"}),e.jsx(b,{variant:"subtitle2",sx:{mb:1},children:"Miscellaneous tiles allow you to add your own tiles without including other groups. Be aware, you will want to add several options to this group to minimize repeats."})]})})]})]})}function is({gameMode:n,groupFilter:a,intensityFilter:r,groups:c,mappedGroups:i,dexieGroups:h,onGameModeChange:o,onGroupChange:t,onIntensityChange:u,hideAll:d=!1,sx:g={}}){const{t:l}=ee(),[s,m]=p.useState([]),C=d?1:"all",L=p.useMemo(()=>{if(!i?.[n])return[];const j=Qe(i[n]);return Array.isArray(j)?j:[]},[i,n]),D=p.useCallback(j=>{if(h?.[j])return h[j].label||j;const M=L.find(k=>k.value===j);return M?.groupLabel?M.groupLabel:j},[h,L]),S=p.useCallback((j,M)=>{if(h?.[j]){const P=h[j].intensities.find(G=>G.value===Number(M));if(P?.label)return P.label}const k=L.find(P=>P.value===j&&P.intensity===Number(M));return k?.translatedIntensity?k.translatedIntensity:`Level ${Number(M)+1}`},[h,L]);p.useEffect(()=>{if(c){const j=Object.keys(c);m(j)}},[c,n]);function $(j){const M=j.target.value;t(M),u(C)}if(!s?.length)return null;const A=s.length===0||s.includes(a)?a:"",O=r==="all"?"all":r;return e.jsxs(_,{sx:{display:"flex",flexWrap:"wrap",gap:2,...g},children:[e.jsxs(H,{sx:{width:125,flexShrink:0},children:[e.jsx(X,{id:"game-mode-filter-label",children:e.jsx(N,{i18nKey:"customTiles.gameMode"})}),e.jsxs(Y,{labelId:"game-mode-filter-label",id:"game-mode-filter",value:n,label:l("customTiles.gameMode","Game Mode"),onChange:j=>{o(j.target.value)},slotProps:{input:{"aria-label":l("customTiles.gameMode","Game Mode")}},children:[e.jsx(F,{value:"online",children:e.jsx(N,{i18nKey:"online"})}),e.jsx(F,{value:"local",children:e.jsx(N,{i18nKey:"local"})})]})]}),e.jsxs(H,{sx:{minWidth:150,flex:1},children:[e.jsx(X,{id:"group-filter-label",children:e.jsx(N,{i18nKey:"group"})}),e.jsx(Y,{labelId:"group-filter-label",id:"group-filter",value:A,label:l("group"),onChange:$,slotProps:{input:{"aria-label":l("group")}},children:s.map(j=>e.jsxs(F,{value:j,children:[D(j),!d&&c[j]&&` (${c[j].count})`]},j))})]}),e.jsxs(H,{sx:{minWidth:200,flex:1},disabled:!A,children:[e.jsx(X,{id:"intensity-filter-label",children:e.jsx(N,{i18nKey:"customTiles.intensityLevel",children:"Intensity Level"})}),e.jsxs(Y,{labelId:"intensity-filter-label",id:"intensity-filter",value:O,label:l("customTiles.intensityLevel","Intensity Level"),onChange:j=>u(j.target.value),slotProps:{input:{"aria-label":l("customTiles.intensityLevel","Intensity Level")}},children:[!d&&e.jsx(F,{value:"all",children:e.jsx(N,{i18nKey:"all",children:"All"})},"all"),A&&c&&c[A]&&Object.entries(c[A].intensities||{}).sort(([j],[M])=>Number(j)-Number(M)).map(([j,M])=>e.jsxs(F,{value:Number(j),children:[S(A,j),!d&&M!==void 0?` (${M})`:""]},j))]})]})]})}function as({tagList:n,boardUpdated:a,mappedGroups:r,updateTile:c,refreshTrigger:i}){const{t:h,i18n:o}=ee(),{settings:t}=Me(),[u,d]=p.useState(null),[g,l]=p.useState(t.gameMode||"online"),[s,m]=p.useState(""),[C,L]=p.useState(""),[D,S]=p.useState(1),[$,A]=p.useState(!0),[O,j]=p.useState({items:[],total:0,totalPages:1}),[M,k]=p.useState({}),[P,G]=p.useState({}),y=10;p.useEffect(()=>{async function v(){try{A(!0);const[E,V]=await Promise.all([pe(o.resolvedLanguage,g),Nt(o.resolvedLanguage,g,u)]),J={};E.forEach(W=>{J[W.name]=W}),G(J);const ne={};E.forEach(W=>{const re=V[W.name]||{count:0,intensities:{}};ne[W.name]={label:W.label||W.name,count:re.count,intensities:re.intensities}}),k(ne);const Z=E.map(W=>W.name),te=Z.includes(s);if((!s||!te)&&Z.length>0)m(Z[0]),L("all");else if(te&&C!=="all"){const W=E.find(re=>re.name===s);W&&(W.intensities.map(he=>he.value).includes(Number(C))||L("all"))}}catch(E){console.error("Error loading groups and counts:",E)}finally{A(!1)}}v()},[g,o.resolvedLanguage,u,s,C]),p.useEffect(()=>{let v=!0;async function E(){try{A(!0);const V={group:s,intensity:C==="all"?null:Number(C),tag:u,gameMode:g,locale:t.locale,page:D,limit:y,paginated:!0},J=await Pe(V);v&&(j(J),setTimeout(()=>{v&&A(!1)},300))}catch(V){console.error("Error loading tiles:",V),v&&A(!1)}}return s?E():A(!1),()=>{v=!1}},[s,C,u,g,D,y,i,t.locale]);function f(v){A(!0),d(u===v?null:v)}function T(v,E){A(!0),S(E)}async function w(v){await _t(v),a();const E={group:s,intensity:C==="all"?null:C,tag:u,gameMode:g,locale:t.locale,page:D,limit:y,paginated:!0},V=await Pe(E);j(V)}async function K(v){await $t(v),a(),j(E=>({...E,items:E.items.map(V=>V.id===v?{...V,isEnabled:!V.isEnabled}:V)}))}function q(v){c(v);const E=document.querySelector(".MuiDialogContent-root");E&&(E.scrollTop=0)}function U(v,E){const V=P[v];if(V){const J=V.label||v,Z=V.intensities.find(te=>te.value===Number(E))?.label||`Level ${Number(E)+1}`;return`${J} - ${Z}`}return`${v} - Level ${Number(E)+1}`}const B=O.items?.map(({id:v,group:E,intensity:V,action:J,tags:ne,isEnabled:Z=!0,isCustom:te=!0})=>e.jsxs(gt,{sx:{my:2},children:[e.jsx(ft,{title:J,slotProps:{title:{variant:"body1"},subheader:{variant:"body2"},action:{"aria-label":h("customTiles.actions")}},subheader:U(E,V),action:e.jsxs(e.Fragment,{children:[e.jsx(xt,{checked:!!Z,onChange:()=>v!==void 0&&K(v),slotProps:{input:{"aria-label":h("customTiles.toggleTile")}}}),!!te&&e.jsxs(e.Fragment,{children:[e.jsx(ae,{onClick:()=>v!==void 0&&q(v),"aria-label":h("customTiles.update"),children:e.jsx(ze,{})}),e.jsx(ae,{onClick:()=>v!==void 0&&w(v),"aria-label":h("customTiles.delete"),children:e.jsx(Te,{})})]})]}),sx:{pb:0}}),e.jsx(yt,{children:ne?.map(W=>e.jsx(ye,{label:W==="default"?h("default"):W,sx:{m:.5}},W))})]},v));return e.jsxs(_,{children:[e.jsx(_,{children:n?.map(v=>e.jsx(ye,{label:v,sx:{m:.5},color:u===v?"primary":"default",onClick:()=>f(v)},v))}),e.jsx(_,{sx:{display:"flex",flexDirection:"column",gap:2,my:2,transition:"all 0.3s ease-in-out"},children:e.jsx(is,{gameMode:g,groupFilter:s,intensityFilter:C,groups:M,mappedGroups:r,dexieGroups:P,onGameModeChange:v=>{l(v),m(""),L(""),S(1)},onGroupChange:v=>{m(v),S(1)},onIntensityChange:v=>{L(v),S(1)}})}),e.jsxs(_,{sx:{position:"relative",minHeight:"200px"},children:[e.jsx(bt,{in:$,timeout:300,children:e.jsx(_,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(255, 255, 255, 0)",zIndex:1,borderRadius:1},children:e.jsx($e,{})})}),e.jsx(_,{sx:{opacity:$?.3:1,transition:"opacity 0.3s ease-in-out",pointerEvents:$?"none":"auto"},children:O.items.length===0?e.jsx(b,{variant:"body1",sx:{textAlign:"center",my:4},children:e.jsx(N,{i18nKey:"customTiles.noTilesFound",children:"No tiles found with the selected filters."})}):e.jsxs(e.Fragment,{children:[B,O.totalPages>1&&e.jsx(_,{sx:{display:"flex",justifyContent:"center",mt:3,mb:2},children:e.jsx(jt,{count:O.totalPages,page:D,onChange:T,color:"primary"})}),e.jsx(b,{variant:"body2",sx:{textAlign:"center",mt:2,color:"text.secondary"},children:e.jsxs(N,{i18nKey:"customTiles.showingTiles",values:{shown:O.items.length,total:O.total},children:["Showing ",{shown:O.items.length}," of ",{total:O.total}," tiles"]})})]})})]})]})}function bs({boardUpdated:n,setOpen:a,open:r=!1}){const{t:c,i18n:i}=ee(),h=Re(),o=Re("md"),[t,u]=p.useState({message:"",type:"info"}),[d,g]=p.useState("ctAdd"),[l,s]=p.useState(null),[m,C]=p.useState(0),[L,D]=p.useState({online:{},local:{},solo:{}}),[S,$]=p.useState(!0),A=p.useCallback(()=>{C(G=>G+1)},[]),O=G=>(y,f)=>{g(f?G:"")};p.useEffect(()=>{async function G(){$(!0);try{const[y,f,T]=await Promise.all([xe(i.resolvedLanguage,"online"),xe(i.resolvedLanguage,"local"),xe(i.resolvedLanguage,"solo")]);D({online:y,local:f,solo:T})}catch(y){console.error("Error loading game mode actions:",y)}finally{$(!1)}}G()},[i.resolvedLanguage]);const j=Ct(()=>me({locale:i.resolvedLanguage})),M=p.useMemo(()=>j?Array.isArray(j)?j.map(({tags:G})=>G).flat().filter((G,y,f)=>G&&f.indexOf(G)===y).sort():[]:[],[j]),k=p.useCallback(async G=>{await kt(G),n(),A()},[n,A]);if(!j||S)return null;const P=()=>{const G=e.jsxs(e.Fragment,{children:[e.jsx(rs,{expanded:d,handleChange:O}),e.jsx(ns,{setSubmitMessage:u,boardUpdated:()=>{n(),A()},customTiles:j,mappedGroups:L,expanded:d,handleChange:O,tagList:M,updateTileId:l,setUpdateTileId:s}),e.jsx(Qt,{expanded:d,handleChange:O,customTiles:j,mappedGroups:L,setSubmitMessage:u,bulkImport:k})]}),y=Array.isArray(j)&&j.length>0&&e.jsx(_,{children:e.jsx(as,{tagList:M,boardUpdated:()=>{n(),A()},mappedGroups:L,updateTile:f=>{s(f),g("ctAdd")},refreshTrigger:m})});return o?e.jsxs(e.Fragment,{children:[G,y&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{sx:{my:2}}),y]})]}):e.jsxs(ge,{container:!0,spacing:2,children:[e.jsx(ge,{size:{xs:12,md:6},children:G}),e.jsx(ge,{size:{xs:12,md:6},children:y})]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{fullScreen:h,open:r,onClose:()=>a(!1),maxWidth:o?"sm":"lg",fullWidth:!0,children:[e.jsxs(je,{children:[e.jsx(N,{i18nKey:"manageTiles"}),e.jsx(ae,{"aria-label":c("close"),onClick:()=>a(!1),sx:{position:"absolute",right:8,top:8,color:G=>G.palette.grey[500]},children:e.jsx(vt,{})})]}),e.jsx(ve,{children:P()})]}),e.jsx(Vt,{open:!!t.message,close:()=>u({message:"",type:"info"}),type:t.type,children:t.message})]})}function js(n={},a={}){const[r]=Pt(),c={...n,...r,selectedActions:r?.selectedActions||{},...a},[i,h]=p.useState(c),{messages:o}=Rt(),[t,u]=p.useState(!1);return p.useEffect(()=>{const d=Mt(o,"room");if(d?.settings)try{const g=JSON.parse(d.settings);h(l=>t?l.selectedActions&&Object.keys(l.selectedActions).length>0?{...l,...g,selectedActions:l.selectedActions}:{...l,...g}:(u(!0),{...l,...g}))}catch(g){console.error("Error parsing message settings:",g)}else t||u(!0)},[o,t]),[i,h]}const ie=new Map,We=Ft;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{ie.clear()};function vs(n){const{i18n:a,t:r}=ee(),[c,i]=p.useState({}),[h,o]=p.useState(!0);p.useEffect(()=>{const d=()=>{n&&Array.from(ie.keys()).filter(l=>l.endsWith(`-${n}`)).forEach(l=>{ie.delete(l)})};return a.on("languageChanged",d),()=>{a.off("languageChanged",d)}},[a,n]);const t=p.useMemo(()=>!n||!a.resolvedLanguage?"":`${a.resolvedLanguage}-${n}`,[a.resolvedLanguage,n]);p.useEffect(()=>{if(t){const d=ie.get(t);d&&Date.now()-d.timestamp<We&&(i(d.data),o(!1))}},[t]);const u=p.useCallback(async()=>{if(!n||!t){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:n,cacheKey:t});return}const d=ie.get(t);if(d&&Date.now()-d.timestamp<We){i(d.data),o(!1);return}o(!0);try{const g=await pe(a.resolvedLanguage,n),l={};for(const s of g){const m={[r("none")]:[]};s.intensities&&Array.isArray(s.intensities)&&s.intensities.sort((L,D)=>L.value-D.value).forEach(L=>{m[L.label]=[]});const C=s.type||"action";l[s.name]={label:s.label||s.name,type:C,actions:m}}ie.set(t,{data:l,timestamp:Date.now()}),i(l)}catch(g){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:g,locale:a.resolvedLanguage,gameMode:n,cacheKey:t}),i({})}finally{o(!1)}},[n,a.resolvedLanguage,t,r]);return p.useEffect(()=>{t&&u()},[u,t]),{actionsList:c,isLoading:h}}export{bs as C,vs as a,Qe as b,zt as g,xe as i,js as u};
