const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/getUniqueImportRecords.ts-BXpYdn-7.js","js/chunk-B0_VBOvR.js","js/chunk-Bfa-QeNm.js","assets/index-BHjYcaRD.js","js/chunk-C8C4XuLE.js","js/chunk-DjfcUfB3.js","js/chunk-DOyVz6k9.js","js/chunk-Cviq917M.js","js/chunk-G27VazTP.js","js/chunk-CH6uyvQ0.js","js/chunk-C7PvMB7v.js","js/chunk-BASZ8lRo.js","js/chunk-RtjQ02-D.js","js/chunk-DyBi9s21.js","js/chunk-B4PEA_xj.js","js/chunk-DC_novU2.js","js/chunk-yLOK5aTh.js"])))=>i.map(i=>d[i]);
import{ac as oe,r as o,ae as re,j as e,T as G,ax as k,aa as w,z as Y,y as X,ay as H,M as $,A as te,aW as Be,Q as Z,ab as Ae,U as ye,W as be,aD as je,$ as it,Z as Me,Y as ve,V as Ce,a7 as ot,S as Te,aO as Ge,bc as at,I as se,a1 as pe,R as Fe,bd as lt,aN as $e,b6 as Oe,av as ct,aU as ut,aF as dt,be as pt,G as mt,bf as gt,au as xe}from"./chunk-B0_VBOvR.js";import{n as he,u as xt}from"./chunk-Bfa-QeNm.js";import{J as me,L as ht,t as de,D as Se,E as ue,N as Ue,v as qe,O as Ne,_ as Ye,P as Xe,Q as He,R as ft,T as yt,V as bt,W as jt,X as vt,Y as Pe,Z as Ct,$ as Tt,w as Gt,l as St}from"../assets/index-BHjYcaRD.js";import{u as Ie}from"./chunk-DOyVz6k9.js";import{T as It}from"./chunk-Cviq917M.js";import{A as ae,a as le,b as ce}from"./chunk-G27VazTP.js";import{C as wt}from"./chunk-CH6uyvQ0.js";import{d as Et}from"./chunk-C7PvMB7v.js";import{v as Je,g as Lt,f as Dt,h as Re}from"./chunk-BASZ8lRo.js";import{b as ke,u as At}from"./chunk-DyBi9s21.js";import{O as Qe,D as we,p as Nt,Q as We,R as Ve,N as Ke,U as kt,S as _t,W as Mt,X as Ft,Y as $t,Z as Ot,_ as Pt,d as Rt,x as Wt}from"./chunk-DjfcUfB3.js";import{u as Vt}from"./chunk-DC_novU2.js";const Kt=c=>{const g={};for(const n of c){const m={label:n.label||n.name,type:n.type||"action",actions:{None:[]}};if(n.intensities&&Array.isArray(n.intensities))for(const i of n.intensities)m.actions[i.label]=[];g[n.name]=m}return g},fe=async(c="en",g="online")=>{try{const n=await me(c,g);return Kt(n)}catch(n){return console.error("Error importing actions from Dexie:",n),{}}};function Ze(c){return[...Object.entries(c).flatMap(([n,{label:m,actions:i}])=>i?Object.keys(i).filter(a=>a!==ht).map((a,t)=>({group:Et(n),groupLabel:m,value:n,intensity:Number(t+1),translatedIntensity:a,label:`${m} - ${a}`})):[]),{group:oe.t("misc"),groupLabel:oe.t("misc"),value:"misc",intensity:1,translatedIntensity:oe.t("all"),label:`${oe.t("misc")} - ${oe.t("all")}`}]}const Ee="2.0.0",zt=2,et=0;async function Le(c="en",g={}){try{let n;if(g.exportScope==="single"&&g.singleGroup){const s=await de(g.singleGroup,c);n=s&&!s.isDefault?[s]:[]}else g.exportScope==="default"?n=[]:n=(await Se({locale:c})).filter(l=>!l.isDefault);const m=await Se({locale:c}),i=new Set(m.filter(s=>s.isDefault).map(s=>s.name)),a=(await ue({isCustom:1})).filter(s=>{const l=!s.locale||s.locale===c;return g.exportScope==="single"&&g.singleGroup?l&&s.group===g.singleGroup:g.exportScope==="default"?l&&i.has(s.group):l}),t={};for(const s of n){const l=s.intensities.sort((E,_)=>E.value-_.value).map(E=>E.label),C=s.intensities.find(E=>E.value===et),A=l.filter(E=>E!==C?.label),N=C?[C.label,...A]:l;t[s.name]={label:s.label,type:s.type||"sex",intensities:N}}const d={};for(const s of a)d[s.group]||(d[s.group]={}),d[s.group][s.intensity]||(d[s.group][s.intensity]=[]),s.tags&&s.tags.length>0?d[s.group][s.intensity].push({action:s.action,tags:s.tags}):d[s.group][s.intensity].push(s.action);const u={};Object.keys(t).sort().forEach(s=>{u[s]=t[s]});const p={};return Object.keys(d).sort().forEach(s=>{p[s]={},Object.keys(d[s]).sort((l,C)=>Number.parseInt(l,10)-Number.parseInt(C,10)).forEach(l=>{p[s][Number.parseInt(l,10)]=d[s][Number.parseInt(l,10)]})}),JSON.stringify({version:Ee,locale:c,groups:u,customTiles:p},(s,l)=>(Array.isArray(l)&&l.length>0&&typeof l[0]=="string",l),zt)}catch(n){throw console.error("Error exporting clean data:",n),new Error(`Export failed: ${n}`)}}async function Bt(c,g={}){const n={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{let m;try{m=JSON.parse(c)}catch(a){return n.errors.push("Invalid JSON format"),console.warn("Failed to parse import data JSON:",a),n}if(!m.version||!m.groups||!m.customTiles)return n.errors.push("Invalid export format - missing version, groups, or customTiles"),n;m.version!==Ee&&n.warnings.push(`Format version mismatch: expected ${Ee}, got ${m.version}`);const i=g.locale||m.locale||"en",j=g.mergeStrategy||"skip";for(const[a,t]of Object.entries(m.groups))try{const d=await de(a,i);let u=a;if(d)switch(j){case"skip":n.warnings.push(`Skipped existing group: ${a}`);continue;case"overwrite":n.warnings.push(`Will update existing group: ${a}`);break;case"rename":{let l=1;for(u=`${a}_imported`;await de(u,i);)u=`${a}_imported_${l}`,l++;n.warnings.push(`Renamed group from ${a} to ${u}`);break}}const p=t.intensities.map((l,C)=>({id:`intensity-${C}`,label:l,value:C,isDefault:C===et})),r={name:u,label:t.label,intensities:p,type:t.type,locale:i,isDefault:!1},s=await Je(r);if(!s.isValid){n.errors.push(`Invalid group ${u}: ${s.errors.join(", ")}`);continue}d&&j==="overwrite"?await Ue(d.id,r):await qe(r),n.importedGroups++}catch(d){n.errors.push(`Error importing group ${a}: ${d}`)}for(const[a,t]of Object.entries(m.customTiles))try{const d=await de(a,i);if(!d){n.warnings.push(`Group ${a} not found for custom tiles, skipping tiles`);continue}for(const[u,p]of Object.entries(t)){const r=Number.parseInt(u,10);if(!d.intensities.find(l=>l.value===r)){n.warnings.push(`Intensity ${r} not valid for group ${a}, skipping tiles`);continue}for(const l of p)try{let C,A=[];if(typeof l=="string")C=l;else if(l&&typeof l=="object"&&"action"in l)C=l.action,A=l.tags||[];else{n.warnings.push(`Invalid tile data format in group ${a}, skipping`);continue}if((await ue()).find(_=>_.group===a&&_.intensity===r&&_.action===C&&(!_.locale||_.locale===i))&&j==="skip"){n.warnings.push(`Skipped existing tile: ${C.substring(0,50)}...`);continue}await Ne({group:a,intensity:r,action:C,tags:A,isCustom:1,locale:i}),n.importedTiles++}catch(C){n.errors.push(`Error importing tile "${typeof l=="string"?l.substring(0,30):"object"}...": ${C}`)}}}catch(d){n.errors.push(`Error importing tiles for group ${a}: ${d}`)}return n.success=n.errors.length===0,n}catch(m){return n.errors.push(`Import failed: ${m}`),n}}async function Ut(c,g,n="en",m="online"){const i={success:!1,importedGroups:0,importedTiles:0,errors:[],warnings:[]};try{const{default:j}=await Ye(async()=>{const{default:u}=await import("./getUniqueImportRecords.ts-BXpYdn-7.js");return{default:u}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16])),a=await ue(),{newUniqueRecords:t,changedTagRecords:d}=j(c,a,g);for(const u of t)try{await Ne(u),i.importedTiles++}catch(p){i.errors.push(`Error importing tile: ${p}`)}for(const u of d)try{u.id&&await Xe(u.id,u)}catch(p){i.errors.push(`Error updating tile: ${p}`)}return i.success=i.errors.length===0,i.warnings.push("Imported using legacy format. Consider exporting in clean v2.0 format for better compatibility."),i}catch(j){return i.errors.push(`Legacy import failed: ${j}`),i}}async function qt(c,g="en"){return Le(g,{singleGroup:c,exportScope:"single"})}async function Yt(c,g,n={}){const m=c.trim();try{const i=JSON.parse(m);if(i.version&&i.groups)return Bt(m,n);if(i.version&&i.customGroups!==void 0)return{success:!1,importedGroups:0,importedTiles:0,errors:["Old enhanced format no longer supported. Please use clean v2.0 format."],warnings:[]}}catch{}return Ut(m,g,n.locale||"en",n.gameMode||"online")}async function Xt(c="en"){try{const n=(await Se({locale:c})).filter(i=>!i.isDefault),m=await ue({isCustom:1});return n.map(i=>{const j=m.filter(a=>a.group===i.name&&(!a.locale||a.locale===c));return{name:i.name,label:i.label,tileCount:j.length}})}catch(g){return console.error("Error getting available groups for export:",g),[]}}function Ht({expanded:c,handleChange:g,customTiles:n,mappedGroups:m,setSubmitMessage:i,bulkImport:j}){const a=o.useRef(null),{t}=re(),{settings:d}=ke(),[u,p]=o.useState(""),[r,s]=o.useState(null),[l,C]=o.useState("clean"),[A,N]=o.useState("all"),[E,_]=o.useState(""),[D,P]=o.useState([]),[y,F]=o.useState("skip"),M=o.useCallback(async()=>{try{if(l==="clean"){let f;switch(A){case"single":if(!E){i({message:t("errors.selectGroupToExport"),type:"error"});return}f=await qt(E,d.locale||"en");break;case"default":f=await Le(d.locale||"en",{exportScope:"default"});break;default:f=await Le(d.locale||"en",{exportScope:"all"});break}p(f)}else{const x=n.filter(v=>v.isCustom).map(({group:v,intensity:I,action:K,tags:B,gameMode:V="online"})=>{const b=Ze(m[V]||{}).find(O=>O?.intensity===Number(I)&&O?.value===v);let L="";return L+=`[${b?.group||v} - ${b?.translatedIntensity||I}]
`,L+=K,L+=B?.length?`
Tags: `+B?.join(", "):"",L+=`
GameMode: ${V}`,L});p(x.join(`
---
`))}}catch(f){console.error("Error exporting data:",f),i({message:t("errors.exportFailed",{error:f}),type:"error"})}},[n,m,p,l,A,E,d.locale,i,t]);async function R(f){if(!f.current)return;const v=f.current.importData.value;if(!v.trim())return i({type:"error",message:t("enterDataToImport")});try{i({type:"info",message:t("importMessages.importing")});const I=await Yt(v,m,{locale:d.locale||"en",mergeStrategy:y});if(s(I),I.success){I.importedTiles>0&&(await Ye(()=>import("../assets/index-BHjYcaRD.js").then(V=>V.a4),__vite__mapDeps([3,1,2,4,5])).then(V=>V.getTiles({isCustom:1}))).slice(-I.importedTiles).forEach(async V=>{He(`${V.group} - ${V.intensity}`,V.action)});let K=t("importMessages.importSuccess");I.importedGroups>0&&(K+=` ${t("importMessages.importedGroups",{count:I.importedGroups})}`),I.importedTiles>0&&(K+=` ${t("importMessages.importedTiles",{count:I.importedTiles})}`),i({type:"success",message:K}),await M()}else i({type:"error",message:t("errors.importFailed",{errors:I.errors.join(", ")})})}catch(I){console.error("Import error:",I),i({type:"error",message:t("errors.importFailed",{errors:I.message||I})}),s(null)}}const T=o.useCallback(async()=>{try{const f=await Xt(d.locale||"en");P(f)}catch(f){console.error("Error loading available groups:",f)}},[d.locale]);return o.useEffect(()=>{c==="ctImport"&&(T(),M())},[c,n,M,T]),e.jsxs(ae,{expanded:c==="ctImport",onChange:g("ctImport"),className:"about-accordion",children:[e.jsx(le,{"aria-controls":"ctImport-content",id:"ctImport-header",children:e.jsx(G,{className:"accordion-title",children:e.jsx(k,{i18nKey:"importExport"})})}),e.jsxs(ce,{children:[e.jsx(G,{variant:"body1",sx:{mb:2},children:e.jsx(k,{i18nKey:"ctImportDescription"})}),e.jsxs(w,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:2,"& .MuiFormControl-root":{minWidth:150,flex:"1 1 auto"}},children:[e.jsxs(Y,{size:"small",children:[e.jsx(X,{children:t("labels.exportFormat")}),e.jsxs(H,{value:l,onChange:f=>C(f.target.value),label:t("labels.exportFormat"),children:[e.jsx($,{value:"clean",children:t("exportFormat.clean")}),e.jsx($,{value:"legacy",children:t("exportFormat.legacy")})]})]}),l==="clean"&&e.jsxs(Y,{size:"small",children:[e.jsx(X,{children:t("labels.exportScope")}),e.jsxs(H,{value:A,onChange:f=>{N(f.target.value),_("")},label:t("labels.exportScope"),children:[e.jsx($,{value:"all",children:t("exportScope.all")}),e.jsx($,{value:"default",children:t("exportScope.default")}),e.jsx($,{value:"single",children:t("exportScope.single")})]})]}),e.jsxs(Y,{size:"small",children:[e.jsx(X,{children:t("labels.importStrategy")}),e.jsxs(H,{value:y,onChange:f=>F(f.target.value),label:t("labels.importStrategy"),children:[e.jsx($,{value:"skip",children:t("importStrategy.skip")}),e.jsx($,{value:"overwrite",children:t("importStrategy.overwrite")}),e.jsx($,{value:"rename",children:t("importStrategy.rename")})]})]})]}),l==="clean"&&A==="single"&&e.jsx(w,{sx:{mb:2},children:e.jsxs(Y,{size:"small",fullWidth:!0,children:[e.jsx(X,{children:t("labels.selectGroup")}),e.jsx(H,{value:E,onChange:f=>_(f.target.value),label:t("labels.selectGroup"),children:D.map(f=>e.jsxs($,{value:f.name,children:[f.label," (",f.tileCount," tiles)"]},f.name))})]})}),e.jsxs(w,{component:"form",method:"post",ref:a,children:[e.jsx(te,{id:"importData",name:"importData",multiline:!0,required:!0,fullWidth:!0,rows:6,sx:{pb:2},value:u,onChange:f=>p(f.target.value),placeholder:t(l==="clean"?"placeholder.cleanFormat":"placeholder.legacyFormat"),InputProps:{endAdornment:e.jsx(wt,{text:u}),sx:{alignItems:"flex-start"}}}),r&&e.jsxs(Be,{severity:r.success?"success":"error",sx:{mb:2},onClose:()=>s(null),children:[e.jsx(G,{variant:"body2",children:e.jsx("strong",{children:e.jsx(k,{i18nKey:"importResults.title"})})}),r.importedGroups>0&&e.jsxs(G,{variant:"body2",children:["•"," ",e.jsx(k,{i18nKey:"importResults.groupsImported",values:{count:r.importedGroups}})]}),r.importedTiles>0&&e.jsxs(G,{variant:"body2",children:["•"," ",e.jsx(k,{i18nKey:"importResults.tilesImported",values:{count:r.importedTiles}})]}),r.warnings.length>0&&e.jsxs(w,{sx:{mt:1},children:[e.jsx(G,{variant:"body2",color:"warning.main",children:e.jsx("strong",{children:e.jsx(k,{i18nKey:"importResults.warnings"})})}),r.warnings.map((f,x)=>e.jsxs(G,{variant:"body2",color:"warning.main",children:["• ",f]},x))]}),r.errors.length>0&&e.jsxs(w,{sx:{mt:1},children:[e.jsx(G,{variant:"body2",color:"error.main",children:e.jsx("strong",{children:e.jsx(k,{i18nKey:"importResults.errors"})})}),r.errors.map((f,x)=>e.jsxs(G,{variant:"body2",color:"error.main",children:["• ",f]},x))]})]}),e.jsx(Z,{fullWidth:!0,variant:"contained",type:"button",onClick:()=>R(a),children:e.jsx(k,{i18nKey:"import"})})]}),l==="clean"&&e.jsxs(ae,{sx:{mt:2},className:"about-accordion",children:[e.jsx(le,{children:e.jsx(G,{variant:"subtitle2",className:"accordion-title",children:e.jsx(k,{i18nKey:"formatGuide.title"})})}),e.jsxs(ce,{children:[e.jsx(G,{variant:"body2",sx:{mb:2},children:e.jsx(k,{i18nKey:"formatGuide.description"})}),e.jsx(G,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(k,{i18nKey:"formatGuide.keySections"})}),e.jsx(G,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(k,{i18nKey:"formatGuide.keySectionsContent",components:{strong1:e.jsx("strong",{}),strong2:e.jsx("strong",{}),br:e.jsx("br",{})}})}),e.jsx(G,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(k,{i18nKey:"formatGuide.manualEditing"})}),e.jsx(G,{variant:"body2",component:"div",sx:{mb:2,ml:2},children:e.jsx(k,{i18nKey:"formatGuide.manualEditingContent",components:{br:e.jsx("br",{})}})}),e.jsx(G,{variant:"body2",sx:{mb:1,fontWeight:"bold"},children:e.jsx(k,{i18nKey:"formatGuide.customTilesFormat"})}),e.jsx(G,{variant:"body2",component:"div",sx:{ml:2},children:e.jsx(k,{i18nKey:"formatGuide.customTilesFormatContent",components:{br:e.jsx("br",{}),code1:e.jsx("code",{}),code2:e.jsx("code",{})}})})]})]})]})]})}function Jt({value:c,onChange:g,locale:n,gameMode:m,includeDefault:i=!0,disabled:j=!1,refreshTrigger:a=0}){const{t}=re(),[d,u]=o.useState([]),[p,r]=o.useState(!0);return o.useEffect(()=>{(async()=>{r(!0);try{const l=await me(n,m),C=i?l:l.filter(A=>!A.isDefault);u(C)}catch(l){console.error("Error loading custom groups:",l),u([])}finally{r(!1)}})()},[n,m,i,a]),p?e.jsxs(Y,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:t("customGroups.loadingGroups")}),e.jsx(H,{value:"",children:e.jsx($,{value:"",children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ae,{size:16}),e.jsx("span",{children:t("customGroups.loadingGroups")})]})})})]}):e.jsx(w,{children:e.jsxs(Y,{fullWidth:!0,disabled:j,children:[e.jsx(X,{id:"group-label",children:t("group")}),e.jsx(H,{labelId:"group-label",value:c,onChange:s=>g(s.target.value),label:t("group"),children:d.length===0?e.jsx($,{value:"",disabled:!0,children:e.jsx(G,{color:"text.secondary",children:t("customGroups.noGroupsAvailable",{locale:n,gameMode:m})})}):d.map(s=>e.jsx($,{value:s.name,children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx("span",{children:s.label}),s.isDefault&&e.jsx(ye,{label:t("default"),size:"small",variant:"outlined"})]})},s.id))})]})})}function Qt({groupName:c,value:g,onChange:n,locale:m,gameMode:i,disabled:j=!1}){const{t:a}=re(),[t,d]=o.useState([]),[u,p]=o.useState(!1);o.useEffect(()=>{(async()=>{if(!c){d([]);return}p(!0);try{const l=await ft(c,m,i);d(l)}catch(l){console.error("Error loading group intensities:",l),d([])}finally{p(!1)}})()},[c,m,i]);const r=o.useMemo(()=>t.sort((s,l)=>s.value-l.value),[t]);return o.useEffect(()=>{if(t.length>0&&g&&!t.some(s=>s.value===g)){const s=r[0];s&&n(s.value)}},[t,g,n,r]),c?u?e.jsxs(Y,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:a("customGroups.loadingIntensities")}),e.jsx(H,{value:"",children:e.jsx($,{value:"",children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ae,{size:16}),e.jsx("span",{children:a("customGroups.loadingIntensities")})]})})})]}):t.length===0?e.jsxs(Y,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:a("intensity")}),e.jsx(H,{value:"",children:e.jsx($,{value:"",disabled:!0,children:e.jsx(G,{color:"text.secondary",children:a("customGroups.noIntensitiesAvailable",{groupName:c})})})})]}):e.jsx(w,{children:e.jsxs(Y,{fullWidth:!0,disabled:j,children:[e.jsx(X,{children:a("intensity")}),e.jsx(H,{value:g||"",onChange:s=>n(Number(s.target.value)),label:a("intensity"),children:r.map(s=>e.jsx($,{value:s.value,children:s.label},s.id))})]})}):e.jsxs(Y,{fullWidth:!0,disabled:!0,children:[e.jsx(X,{children:a("intensity")}),e.jsx(H,{value:"",children:e.jsx($,{value:"",disabled:!0,children:e.jsx(G,{color:"text.secondary",children:a("customGroups.selectGroupFirst")})})})]})}const De=[{name:"Basic (1-4)",intensities:[{label:"intensityLabels.light",value:1,isDefault:!0},{label:"intensityLabels.medium",value:2,isDefault:!0},{label:"intensityLabels.intense",value:3,isDefault:!0},{label:"intensityLabels.extreme",value:4,isDefault:!0}]},{name:"Simple (1-3)",intensities:[{label:"intensityLabels.beginner",value:1,isDefault:!0},{label:"intensityLabels.intermediate",value:2,isDefault:!0},{label:"intensityLabels.advanced",value:3,isDefault:!0}]},{name:"Extended (1-5)",intensities:[{label:"intensityLabels.veryLight",value:1,isDefault:!0},{label:"intensityLabels.light",value:2,isDefault:!0},{label:"intensityLabels.medium",value:3,isDefault:!0},{label:"intensityLabels.intense",value:4,isDefault:!0},{label:"intensityLabels.veryIntense",value:5,isDefault:!0}]}],ze=c=>{const g=De.findIndex(n=>n.intensities.length===c.length);return g>=0?g:1};function Zt({open:c,onClose:g,onGroupCreated:n,onGroupUpdated:m,editingGroup:i,locale:j,gameMode:a}){const{t}=re(),[d,u]=o.useState(0),[p,r]=o.useState([]),[s,l]=o.useState(!0),[C,A]=o.useState({}),N=Lt(),[E,_]=o.useState(""),[D,P]=o.useState(""),[y,F]=o.useState(1),[M,R]=o.useState([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),[T,f]=o.useState(null),[x,v]=o.useState(!1),[I,K]=o.useState({isValid:!0,errors:[]}),[B,V]=o.useState(!1),[q,b]=o.useState(null),L=o.useCallback(async()=>{try{const S=(await me(j,a)).filter(U=>!U.isDefault);r(S);const W={};await Promise.all(S.map(async U=>{W[U.id]=await yt(U.name,j,a)})),A(W)}catch(h){console.error("Error reloading groups:",h)}},[j,a]);o.useEffect(()=>{(async()=>{if(c){l(!0);try{await L()}catch(S){console.error("Error loading groups:",S)}finally{l(!1)}}})()},[c,j,a,L]);const O=h=>h.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,20)||`group_${he(6).toLowerCase()}`;o.useEffect(()=>{i?(f(i),_(i.label),P(i.type||""),R(i.intensities.map(h=>h.label)),F(ze(i.intensities))):T?(_(T.label),P(T.type||""),R(T.intensities.map(h=>h.label)),F(ze(T.intensities))):(f(null),_(""),P(""),F(1),R([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")])),K({isValid:!0,errors:[]})},[i,T,c,t]);const J=h=>{const S=De[h];F(h),R(S.intensities.map(W=>t(W.label)))},ne=(h,S)=>{const W=[...M];W[h]=S,R(W)},Q=()=>{M.length>=N.MAX_INTENSITIES_COUNT||R([...M,t("customGroups.levelLabel",{level:M.length+1})])},ee=h=>{if(M.length<=N.MIN_INTENSITIES_COUNT)return;const S=M.filter((W,U)=>U!==h);R(S)};o.useEffect(()=>{(async()=>{if(!E.trim()&&!D&&M.length===0){K({isValid:!0,errors:[]});return}const S=[];if(D&&!N.VALID_GROUP_TYPES.includes(D)&&S.push(t("typeValidationError",{types:N.VALID_GROUP_TYPES.join(", ")})),E.trim()&&!D&&S.push(t("typeRequiredError")),S.length>0){K({isValid:!1,errors:S});return}const W=M.map((rt,nt)=>({id:he(),label:rt,value:nt+1,isDefault:!1})),U={name:T?T.name:O(E),label:E.trim(),intensities:W,type:D||void 0,locale:j,gameMode:a,isDefault:!1},st=await Je(U,T?.id);K(st)})()},[E,D,M,j,a,T,t,N.VALID_GROUP_TYPES]);const z=h=>{f(h),_(h.label),R(h.intensities.map(S=>S.label)),u(1)},ie=async h=>{const S=p.find(U=>U.id===h);if(!S)return;const W=C[h]||0;b({id:h,name:S.label,tileCount:W}),V(!0)},ge=async()=>{if(!q)return;const{id:h,tileCount:S}=q,W=p.find(U=>U.id===h);if(W)try{S>0&&await bt(W.name,j,a),await jt(h),await L(),m?.(null)}catch(U){console.error("Error deleting group:",U)}finally{V(!1),b(null)}},tt=async()=>{if(!(!I.isValid||x)){v(!0);try{const h=M.map((W,U)=>({id:he(),label:W,value:U+1,isDefault:!1})),S={name:T?T.name:O(E),label:E.trim(),intensities:h,type:D||void 0,locale:j,gameMode:a,isDefault:!1};if(T)await Ue(T.id,S),m?.(T);else{const W=await qe(S);W&&n?.({...S,id:W,createdAt:new Date,updatedAt:new Date,isDefault:!1,locale:j,gameMode:a})}_e(),g()}catch(h){console.error("Error saving custom group:",h),K({isValid:!1,errors:[t("failedToSaveGroup",{error:h})]})}finally{v(!1)}}},_e=()=>{f(null),_(""),P(""),F(1),R([t("intensityLabels.beginner"),t("intensityLabels.intermediate"),t("intensityLabels.advanced")]),K({isValid:!0,errors:[]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{open:c,onClose:g,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"600px"}},children:[e.jsxs(je,{children:[t("customGroups.manageCustomGroups"),e.jsx(G,{variant:"body2",color:"text.secondary",sx:{mt:1},children:t("customGroups.createNewGroupsDescription")}),e.jsxs(it,{value:d,onChange:(h,S)=>{u(S),S===1&&!T&&_e()},sx:{mt:2,borderBottom:1,borderColor:"divider"},children:[e.jsx(Me,{label:t("customGroups.existingGroups")}),e.jsx(Me,{label:t(T?"customGroups.editGroup":"customGroups.createNew")})]})]}),e.jsxs(ve,{dividers:!0,children:[d===0&&e.jsx(w,{children:s?e.jsx(G,{children:t("Loading groups...")}):p.length===0?e.jsx(G,{color:"text.secondary",sx:{textAlign:"center",py:4},children:t("customGroups.noCustomGroupsFound")}):e.jsx(Ce,{children:p.map((h,S)=>e.jsxs(ot.Fragment,{children:[e.jsxs(Te,{children:[e.jsx(Ge,{primary:h.label,secondary:e.jsxs(w,{component:"span",sx:{display:"block"},children:[e.jsxs(G,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block"},children:[t("customGroups.intensityLevelsCount",{count:h.intensities.length}),": ",h.intensities.map(W=>W.label).join(", ")]}),e.jsx(G,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block",mt:.5},children:t("customGroups.customTilesCount",{count:C[h.id]||0})})]})}),e.jsxs(at,{children:[e.jsx(se,{edge:"end","aria-label":"edit",onClick:()=>z(h),sx:{mr:1},children:e.jsx(Qe,{})}),e.jsx(se,{edge:"end","aria-label":"delete",onClick:()=>ie(h.id),color:"error",children:e.jsx(we,{})})]})]}),S<p.length-1&&e.jsx(pe,{})]},h.id))})}),d===1&&e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:3},children:[!I.isValid&&e.jsx(Be,{severity:"error",children:I.errors.map((h,S)=>e.jsx("div",{children:h},S))}),e.jsxs(w,{sx:{p:2,bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(G,{variant:"h6",sx:{mb:2},children:t("customGroups.groupInformation")}),e.jsx(te,{label:t("customGroups.groupLabel"),value:E,onChange:h=>_(h.target.value),placeholder:"e.g., My Custom Group",helperText:t("customGroups.groupLabelHelp",{maxLength:N.MAX_GROUP_LABEL_LENGTH}),fullWidth:!0,required:!0,error:E.trim().length>0&&!Dt(E).isValid,sx:{mb:2}}),e.jsxs(te,{select:!0,label:t("customGroups.groupType"),value:D,onChange:h=>P(h.target.value),helperText:t("customGroups.groupTypeHelp"),fullWidth:!0,required:!0,error:E.trim().length>0&&!D,sx:{mb:2},children:[e.jsx($,{value:"",children:e.jsx("em",{children:t("groupTypes.selectType")})}),e.jsx($,{value:"solo",children:t("groupTypes.solo")}),e.jsx($,{value:"foreplay",children:t("groupTypes.foreplay")}),e.jsx($,{value:"sex",children:t("groupTypes.sex")}),e.jsx($,{value:"consumption",children:t("groupTypes.consumption")})]}),e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(G,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.locale")})," ",j," |"," ",e.jsx("strong",{children:t("customGroups.gameMode")})," ",a]}),T?e.jsxs(G,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",T.name," ","(locked)"]}):e.jsxs(G,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:t("customGroups.internalId")})," ",E?O(E):t("customGroups.autoGenerated")]})]})]}),e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"action.hover",borderRadius:1},children:[e.jsx(G,{variant:"body2",sx:{fontWeight:"medium",minWidth:"auto"},children:t("customGroups.quickStart")}),e.jsx(te,{select:!0,value:y,onChange:h=>J(Number(h.target.value)),size:"small",sx:{minWidth:200},label:t("customGroups.chooseTemplate"),children:De.map((h,S)=>e.jsx($,{value:S,children:h.name==="Basic (1-4)"?t("templateBasic"):h.name==="Simple (1-3)"?t("templateSimple"):h.name==="Extended (1-5)"?t("templateExtended"):h.name},S))}),e.jsx(G,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.75rem"},children:t("customGroups.selectTemplateDescription")})]}),e.jsxs(w,{children:[e.jsxs(G,{variant:"h6",sx:{mb:2},children:[t("customGroups.intensityLabels")," (",M.length,"/",N.MAX_INTENSITIES_COUNT,")"]}),e.jsx(G,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("customGroups.customizeIntensityDescription")}),e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[M.map((h,S)=>e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(G,{variant:"body2",sx:{minWidth:"30px",fontWeight:"bold",color:"primary.main"},children:S+1}),e.jsx(te,{label:t("customGroups.levelInputLabel",{level:S+1}),value:h,onChange:W=>ne(S,W.target.value),size:"small",sx:{flex:1},inputProps:{maxLength:N.MAX_INTENSITY_LABEL_LENGTH}}),e.jsx(se,{onClick:()=>ee(S),disabled:M.length<=N.MIN_INTENSITIES_COUNT,color:"error",size:"small",children:e.jsx(we,{})})]},S)),e.jsx(Z,{startIcon:e.jsx(Nt,{}),onClick:Q,disabled:M.length>=N.MAX_INTENSITIES_COUNT,variant:"outlined",size:"small",sx:{alignSelf:"flex-start",mt:1},children:t("customGroups.addIntensityLevel")})]})]})]})]}),e.jsxs(Fe,{children:[e.jsx(Z,{onClick:g,disabled:x,children:t("cancel")}),e.jsx(Z,{onClick:tt,variant:"contained",disabled:!I.isValid||x,children:t(x?"customGroups.saving":T?"customGroups.updateGroup":"customGroups.createGroup")})]})]}),e.jsxs(be,{open:B,onClose:()=>V(!1),children:[e.jsx(je,{children:t("customGroups.confirmDelete")}),e.jsx(ve,{children:e.jsx(G,{children:(q?.tileCount??0)>0?t("customGroups.deleteGroupWithTiles",{name:q?.name,count:q?.tileCount}):t("customGroups.deleteGroupConfirm",{name:q?.name})})}),e.jsxs(Fe,{children:[e.jsx(Z,{onClick:()=>V(!1),children:t("cancel")}),e.jsx(Z,{onClick:ge,color:"error",variant:"contained",children:t("delete")})]})]})]})}function es({setSubmitMessage:c,boardUpdated:g,customTiles:n,mappedGroups:m,expanded:i,handleChange:j,tagList:a,updateTileId:t,setUpdateTileId:d}){const{t:u}=re(),{settings:p}=ke(),[r,s]=o.useState({gameMode:p.gameMode||"online",group:"",intensity:"",action:"",tags:[u("custom")]}),[l,C]=o.useState(!1),[A,N]=o.useState(""),[E,_]=o.useState(0);o.useEffect(()=>{const v=setTimeout(async()=>{if(!r.group||!r.intensity||!r.action){N("");return}try{const I=await Re({group:r.group,intensity:Number(r.intensity),action:r.action,tags:r.tags,gameMode:r.gameMode,isCustom:1},p.locale||"en",r.gameMode);I.isValid?N(""):N(I.errors.join(", "))}catch(I){console.error("Error validating tile:",I),N("")}},300);return()=>clearTimeout(v)},[r.group,r.intensity,r.action,r.gameMode,r.tags,p.locale]),o.useEffect(()=>{const v=(Array.isArray(n)?n:[]).find(({id:I})=>I===t);if(v){const I=v.gameMode||p.gameMode;s({gameMode:I,group:v.group||"",intensity:v.intensity||"",action:v.action||"",tags:v.tags||[u("custom")]})}else s(I=>({...I,gameMode:p.gameMode}))},[t,p.gameMode,n,u]);function D(x,v,I){return(Array.isArray(n)?n:[]).find(B=>B.group===x&&B.intensity===v&&B.action===I)}function P(){d(null),s({gameMode:p.gameMode,group:"",intensity:"",action:"",tags:[u("custom")]}),N("")}const y=x=>{s(v=>({...v,group:x.name,intensity:""})),C(!1),_(v=>v+1)},F=()=>{_(x=>x+1)},M=o.useCallback(x=>{s(v=>({...v,intensity:x.toString()}))},[]);async function R(){const x=document.querySelector('input[name="tags"]'),v=[...r.tags];x&&x.value.trim()&&(v.push(x.value.trim()),x.value="");const{gameMode:I,group:K,intensity:B,action:V}=r;if(!I||!K||!B||!V)return c({message:u("allFieldsRequired","All fields are required"),type:"error"});if(A)return c({message:A,type:"error"});if(t==null&&D(K,B,V))return c({message:u("actionExists"),type:"error"});const q={group:K,intensity:Number(B),action:V,tags:v,gameMode:I,isCustom:1};try{const b=await Re(q,p.locale||"en",I);if(!b.isValid)return c({message:b.errors.join(", "),type:"error"});if(t===null){const L=`${K} - Level ${B}`;He(L,V),await Ne(q)}else await Xe(t,q);return g(),s(L=>({...L,action:"",tags:[u("custom")]})),c({message:u(t?"customUpdated":"customAdded"),type:"success"})}catch(b){return console.error("Error saving custom tile:",b),c({message:u("errorSavingTile"),type:"error"})}}const T=x=>{switch(x.key){case",":case"Enter":{x.preventDefault(),x.stopPropagation(),x.currentTarget.value.length>0&&(s(v=>({...v,tags:[...v.tags,x.currentTarget.value]})),x.currentTarget.value="");break}}},f=x=>{x.target.value.length>0&&(s(v=>({...v,tags:[...v.tags,x.target.value]})),x.target.value=""),setTimeout(()=>{const v=document.querySelector(".MuiAutocomplete-popper");v&&(v.style.display="none")},150)};return e.jsxs(e.Fragment,{children:[e.jsxs(ae,{expanded:i==="ctAdd",onChange:j("ctAdd"),className:"about-accordion",children:[e.jsx(le,{"aria-controls":"ctAdd-content",id:"ctAdd-header",children:e.jsx(G,{className:"accordion-title",children:e.jsx(k,{i18nKey:t?"ctUpdate":"ctAdd"})})}),e.jsx(ce,{children:e.jsxs(w,{component:"form",method:"post",className:"settings-box",children:[e.jsxs(te,{select:!0,label:u("customTiles.gameMode"),value:r.gameMode,onChange:x=>{s(v=>({...v,gameMode:x.target.value,group:"",intensity:""}))},fullWidth:!0,sx:{mb:2},children:[e.jsx("option",{value:"online",children:u("online")}),e.jsx("option",{value:"local",children:u("local")}),e.jsx("option",{value:"solo",children:u("solo")})]}),e.jsx(Jt,{value:r.group,onChange:x=>{s(v=>({...v,group:x,intensity:""}))},locale:p.locale||"en",gameMode:r.gameMode,refreshTrigger:E}),e.jsx(w,{sx:{mt:2},children:e.jsx(Qt,{groupName:r.group,value:Number(r.intensity)||0,onChange:M,locale:p.locale||"en",gameMode:r.gameMode})}),A&&e.jsx(w,{sx:{mt:1,mb:2},children:e.jsx(G,{color:"error",variant:"body2",children:A})}),e.jsx(te,{id:"action",name:"action",required:!0,fullWidth:!0,label:u("action"),sx:{mt:2,pb:2},value:r.action,onChange:x=>{s({...r,action:x.target.value})}}),e.jsx(lt,{id:"tags",disableCloseOnSelect:!0,multiple:!0,freeSolo:!0,options:a,value:r.tags,onChange:(x,v)=>{s({...r,tags:v})},renderInput:x=>(x.inputProps.onKeyDown=T,x.inputProps.onBlur=f,e.jsx(te,{...x,label:u("tags")})),sx:{pb:2},clearOnBlur:!0,blurOnSelect:!0,openOnFocus:!0,disablePortal:!1,componentsProps:{popper:{modifiers:[{name:"preventOverflow",options:{altAxis:!0,altBoundary:!0,padding:8}}]}}}),e.jsxs(w,{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:{xs:"stretch",sm:"space-evenly"},gap:1,children:[e.jsx(Z,{variant:"outlined",type:"button",onClick:()=>C(!0),children:u("manageGroups")}),e.jsx(Z,{variant:"contained",type:"button",onClick:()=>P(),children:e.jsx(k,{i18nKey:"clear"})}),e.jsx(Z,{variant:"contained",type:"button",onClick:R,children:e.jsx(k,{i18nKey:t?"ctUpdate":"ctAdd"})})]})]})})]}),e.jsx(Zt,{open:l,onClose:()=>C(!1),onGroupCreated:y,onGroupUpdated:F,locale:p.locale||"en",gameMode:r.gameMode})]})}function ts({expanded:c,handleChange:g}){const n=Ie(),[m,i]=o.useState({}),[j,a]=o.useState({}),t=r=>{i(s=>({...s,[r]:!s[r]}))},d=r=>{a(s=>({...s,[r]:!s[r]}))},u=[{id:"custom-actions",icon:e.jsx(We,{}),title:"Custom Actions",description:"Add your own personalized activities to the game",tip:"Think of custom tiles as your personal touch - add activities that match your style and preferences perfectly.",color:"primary"},{id:"category-intensity",icon:e.jsx(_t,{}),title:"Category & Intensity Rules",description:"Tiles appear based on your game settings",tip:"Your tiles only show up when you select their category and intensity level (or higher) in game settings.",color:"secondary"},{id:"miscellaneous-tiles",icon:e.jsx(Mt,{}),title:"Always-Visible Tiles",description:"Miscellaneous tiles bypass category rules",tip:"Misc tiles are perfect for unique activities that don't fit standard categories - they always appear regardless of settings.",color:"success"}],p=[{id:"new-activities",icon:e.jsx(Ft,{}),title:"New Activities",description:"Create unique actions not in the default list",tips:["Think outside the box - what creative activities would make your game more exciting?",'Add themed tiles like "Movie Night Actions" or "Kitchen Adventures"',"Create seasonal tiles for holidays or special occasions","Design role-play scenarios with specific character actions"],color:"primary"},{id:"intensity-boost",icon:e.jsx($t,{}),title:"Early Intensity Boost",description:"Add advanced tiles to beginner levels",tips:["Pro tip: Add exciting advanced tiles to lower intensities to start games with more energy.","Copy your favorite advanced tiles and add them to beginner categories",'Create "gateway" tiles that introduce advanced concepts gradually',"Mix easy and challenging elements in the same tile for variety"],color:"secondary"},{id:"mix-match",icon:e.jsx(Ot,{}),title:"Mix & Match",description:"Combine different activities into one tile",tips:["Mix activities that don't usually go together for unexpected combinations.","Combine physical actions with mental challenges or games","Create multi-step tiles that build on each other","Blend different intensity levels within a single creative tile"],color:"success"},{id:"custom-groups",icon:e.jsx(Pt,{}),title:"Custom Groups",description:"Create your own tile categories with unique intensities",tips:['Design completely custom groups like "Couples Yoga" or "Adventure Challenges"',"Set your own intensity progression from gentle to wild","Create themed collections that tell a story or follow a theme","Build niche categories that perfectly match your interests"],color:"warning"},{id:"share-creations",icon:e.jsx(Rt,{}),title:"Share & Discover",description:"Import/export tiles to share with others",tips:["Export your best tile collections to share with friends or partners","Import creative tiles from others to expand your game options","Create themed tile packs and share them in communities","Backup your custom tiles by exporting them regularly"],color:"info"}];return e.jsxs(e.Fragment,{children:[e.jsxs(ae,{expanded:c==="help1",onChange:g("help1"),className:"about-accordion",children:[e.jsx(le,{"aria-controls":"help1-content",id:"help1-header",children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(We,{color:"primary"}),e.jsx(G,{className:"accordion-title",children:e.jsx(k,{i18nKey:"ctExplained"})})]})}),e.jsx(ce,{sx:{p:0},children:e.jsx(Ce,{dense:!0,children:u.map((r,s)=>e.jsxs(w,{children:[e.jsxs(Te,{sx:{cursor:"pointer",borderRadius:1,"&:hover":{bgcolor:"action.hover",transform:"translateX(4px)",transition:"all 0.2s ease-in-out"},transition:"all 0.2s ease-in-out"},onClick:()=>d(r.id),children:[e.jsx($e,{sx:{minWidth:n?36:40},children:e.jsx(w,{sx:{color:`${r.color}.main`,display:"flex",alignItems:"center"},children:r.icon})}),e.jsx(Ge,{primary:e.jsx(G,{variant:"subtitle2",sx:{fontWeight:500,fontSize:n?"0.9rem":"1rem"},children:r.title}),secondary:e.jsx(G,{variant:"body2",sx:{fontSize:n?"0.8rem":"0.85rem",color:"text.secondary"},children:r.description})}),e.jsx(se,{size:"small",sx:{ml:1},children:j[r.id]?e.jsx(Ve,{}):e.jsx(Ke,{})})]}),e.jsx(Oe,{in:j[r.id],timeout:"auto",unmountOnExit:!0,children:e.jsx(w,{sx:{ml:n?4:6,mr:2,mb:1,p:1.5,bgcolor:"action.selected",borderRadius:1,borderLeft:3,borderLeftColor:`${r.color}.main`},children:e.jsxs(G,{variant:"body2",sx:{fontSize:n?"0.8rem":"0.85rem",fontStyle:"italic",color:"text.secondary"},children:["💡 ",r.tip]})})}),s<u.length-1&&e.jsx(pe,{variant:"inset",sx:{ml:n?4:6}})]},r.id))})})]}),e.jsxs(ae,{expanded:c==="help2",onChange:g("help2"),className:"about-accordion",children:[e.jsx(le,{"aria-controls":"help2-content",id:"help2-header",children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(kt,{color:"primary"}),e.jsx(G,{className:"accordion-title",children:e.jsx(k,{i18nKey:"ctIdeas"})})]})}),e.jsx(ce,{sx:{p:0},children:e.jsx(Ce,{dense:!0,children:p.map((r,s)=>e.jsxs(w,{children:[e.jsxs(Te,{sx:{cursor:"pointer",borderRadius:1,"&:hover":{bgcolor:"action.hover",transform:"translateX(4px)",transition:"all 0.2s ease-in-out"},transition:"all 0.2s ease-in-out"},onClick:()=>t(r.id),children:[e.jsx($e,{sx:{minWidth:n?36:40},children:e.jsx(w,{sx:{color:`${r.color}.main`,display:"flex",alignItems:"center"},children:r.icon})}),e.jsx(Ge,{primary:e.jsx(G,{variant:"subtitle2",sx:{fontWeight:500,fontSize:n?"0.9rem":"1rem"},children:r.title}),secondary:e.jsx(G,{variant:"body2",sx:{fontSize:n?"0.8rem":"0.85rem",color:"text.secondary"},children:r.description})}),e.jsx(se,{size:"small",sx:{ml:1},children:m[r.id]?e.jsx(Ve,{}):e.jsx(Ke,{})})]}),e.jsx(Oe,{in:m[r.id],timeout:"auto",unmountOnExit:!0,children:e.jsx(w,{sx:{ml:n?4:6,mr:2,mb:1,p:1.5,bgcolor:"action.selected",borderRadius:1,borderLeft:3,borderLeftColor:`${r.color}.main`},children:r.tips.map((l,C)=>e.jsx(G,{variant:"body2",sx:{fontSize:n?"0.8rem":"0.85rem",fontStyle:C===0?"italic":"normal",color:"text.secondary",mb:C<r.tips.length-1?1:0,"&:before":C===0?{content:'"💡 "'}:{content:'"• "'}},children:l},C))})}),s<p.length-1&&e.jsx(pe,{variant:"inset",sx:{ml:n?4:6}})]},r.id))})})]})]})}function ss({gameMode:c,groupFilter:g,intensityFilter:n,groups:m,mappedGroups:i,dexieGroups:j,onGameModeChange:a,onGroupChange:t,onIntensityChange:d,hideAll:u=!1,sx:p={}}){const{t:r}=re(),[s,l]=o.useState([]),C=u?1:"all",A=o.useMemo(()=>{if(!i?.[c])return[];const y=Ze(i[c]);return Array.isArray(y)?y:[]},[i,c]),N=o.useCallback(y=>{if(j?.[y])return j[y].label||y;const F=A.find(M=>M.value===y);return F?.groupLabel?F.groupLabel:y},[j,A]),E=o.useCallback((y,F)=>{if(j?.[y]){const R=j[y].intensities.find(T=>T.value===Number(F));if(R?.label)return R.label}const M=A.find(R=>R.value===y&&R.intensity===Number(F));return M?.translatedIntensity?M.translatedIntensity:`Level ${Number(F)+1}`},[j,A]);o.useEffect(()=>{if(m){const y=Object.keys(m);l(y)}},[m,c]);function _(y){const F=y.target.value;t(F),d(C)}if(!s?.length)return null;const D=s.length===0||s.includes(g)?g:"",P=n==="all"?"all":n;return e.jsxs(w,{sx:{display:"flex",flexWrap:"wrap",gap:2,...p},children:[e.jsxs(Y,{sx:{width:125,flexShrink:0},children:[e.jsx(X,{id:"game-mode-filter-label",children:e.jsx(k,{i18nKey:"customTiles.gameMode"})}),e.jsxs(H,{labelId:"game-mode-filter-label",id:"game-mode-filter",value:c,label:r("customTiles.gameMode","Game Mode"),onChange:y=>{a(y.target.value)},slotProps:{input:{"aria-label":r("customTiles.gameMode","Game Mode")}},children:[e.jsx($,{value:"online",children:e.jsx(k,{i18nKey:"online"})}),e.jsx($,{value:"local",children:e.jsx(k,{i18nKey:"local"})})]})]}),e.jsxs(Y,{sx:{minWidth:150,flex:1},children:[e.jsx(X,{id:"group-filter-label",children:e.jsx(k,{i18nKey:"group"})}),e.jsx(H,{labelId:"group-filter-label",id:"group-filter",value:D,label:r("group"),onChange:_,slotProps:{input:{"aria-label":r("group")}},children:s.map(y=>e.jsxs($,{value:y,children:[N(y),!u&&m[y]&&` (${m[y].count})`]},y))})]}),e.jsxs(Y,{sx:{minWidth:200,flex:1},disabled:!D,children:[e.jsx(X,{id:"intensity-filter-label",children:e.jsx(k,{i18nKey:"customTiles.intensityLevel",children:"Intensity Level"})}),e.jsxs(H,{labelId:"intensity-filter-label",id:"intensity-filter",value:P,label:r("customTiles.intensityLevel","Intensity Level"),onChange:y=>d(y.target.value),slotProps:{input:{"aria-label":r("customTiles.intensityLevel","Intensity Level")}},children:[!u&&e.jsx($,{value:"all",children:e.jsx(k,{i18nKey:"all",children:"All"})},"all"),D&&m&&m[D]&&Object.entries(m[D].intensities||{}).sort(([y],[F])=>Number(y)-Number(F)).map(([y,F])=>e.jsxs($,{value:Number(y),children:[E(D,y),!u&&F!==void 0?` (${F})`:""]},y))]})]})]})}function rs({tagList:c,boardUpdated:g,mappedGroups:n,updateTile:m,refreshTrigger:i}){const{t:j,i18n:a}=re(),{settings:t}=ke(),[d,u]=o.useState(null),[p,r]=o.useState(t.gameMode||"online"),[s,l]=o.useState(""),[C,A]=o.useState(""),[N,E]=o.useState(1),[_,D]=o.useState(!0),[P,y]=o.useState({items:[],total:0,totalPages:1}),[F,M]=o.useState({}),[R,T]=o.useState({}),f=10;o.useEffect(()=>{async function b(){try{D(!0);const[L,O]=await Promise.all([me(a.resolvedLanguage,p),vt(a.resolvedLanguage,p,d)]),J={};L.forEach(z=>{J[z.name]=z}),T(J);const ne={};L.forEach(z=>{const ie=O[z.name]||{count:0,intensities:{}};ne[z.name]={label:z.label||z.name,count:ie.count,intensities:ie.intensities}}),M(ne);const Q=L.map(z=>z.name),ee=Q.includes(s);if((!s||!ee)&&Q.length>0)l(Q[0]),A("all");else if(ee&&C!=="all"){const z=L.find(ie=>ie.name===s);z&&(z.intensities.map(ge=>ge.value).includes(Number(C))||A("all"))}}catch(L){console.error("Error loading groups and counts:",L)}finally{D(!1)}}b()},[p,a.resolvedLanguage,d,s,C]),o.useEffect(()=>{let b=!0;async function L(){try{D(!0);const O={group:s,intensity:C==="all"?null:Number(C),tag:d,gameMode:p,locale:t.locale,page:N,limit:f,paginated:!0},J=await Pe(O);b&&(y(J),setTimeout(()=>{b&&D(!1)},300))}catch(O){console.error("Error loading tiles:",O),b&&D(!1)}}return s?L():D(!1),()=>{b=!1}},[s,C,d,p,N,f,i,t.locale]);function x(b){D(!0),u(d===b?null:b)}function v(b,L){D(!0),E(L)}async function I(b){await Ct(b),g();const L={group:s,intensity:C==="all"?null:C,tag:d,gameMode:p,locale:t.locale,page:N,limit:f,paginated:!0},O=await Pe(L);y(O)}async function K(b){await Tt(b),g(),y(L=>({...L,items:L.items.map(O=>O.id===b?{...O,isEnabled:!O.isEnabled}:O)}))}function B(b){m(b);const L=document.querySelector(".MuiDialogContent-root");L&&(L.scrollTop=0)}function V(b,L){const O=R[b];if(O){const J=O.label||b,Q=O.intensities.find(ee=>ee.value===Number(L))?.label||`Level ${Number(L)+1}`;return`${J} - ${Q}`}return`${b} - Level ${Number(L)+1}`}const q=P.items?.map(({id:b,group:L,intensity:O,action:J,tags:ne,isEnabled:Q=!0,isCustom:ee=!0})=>e.jsxs(ct,{sx:{my:2},children:[e.jsx(ut,{title:J,slotProps:{title:{variant:"body1"},subheader:{variant:"body2"},action:{"aria-label":j("customTiles.actions")}},subheader:V(L,O),action:e.jsxs(e.Fragment,{children:[e.jsx(dt,{checked:!!Q,onChange:()=>b!==void 0&&K(b),slotProps:{input:{"aria-label":j("customTiles.toggleTile")}}}),!!ee&&e.jsxs(e.Fragment,{children:[e.jsx(se,{onClick:()=>b!==void 0&&B(b),"aria-label":j("customTiles.update"),children:e.jsx(Qe,{})}),e.jsx(se,{onClick:()=>b!==void 0&&I(b),"aria-label":j("customTiles.delete"),children:e.jsx(we,{})})]})]}),sx:{pb:0}}),e.jsx(pt,{children:ne?.map(z=>e.jsx(ye,{label:z==="default"?j("default"):z,sx:{m:.5}},z))})]},b));return e.jsxs(w,{children:[e.jsx(w,{children:c?.map(b=>e.jsx(ye,{label:b,sx:{m:.5},color:d===b?"primary":"default",onClick:()=>x(b)},b))}),e.jsx(w,{sx:{display:"flex",flexDirection:"column",gap:2,my:2,transition:"all 0.3s ease-in-out"},children:e.jsx(ss,{gameMode:p,groupFilter:s,intensityFilter:C,groups:F,mappedGroups:n,dexieGroups:R,onGameModeChange:b=>{r(b),l(""),A(""),E(1)},onGroupChange:b=>{l(b),E(1)},onIntensityChange:b=>{A(b),E(1)}})}),e.jsxs(w,{sx:{position:"relative",minHeight:"200px"},children:[e.jsx(mt,{in:_,timeout:300,children:e.jsx(w,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(255, 255, 255, 0)",zIndex:1,borderRadius:1},children:e.jsx(Ae,{})})}),e.jsx(w,{sx:{opacity:_?.3:1,transition:"opacity 0.3s ease-in-out",pointerEvents:_?"none":"auto"},children:P.items.length===0?e.jsx(G,{variant:"body1",sx:{textAlign:"center",my:4},children:e.jsx(k,{i18nKey:"customTiles.noTilesFound",children:"No tiles found with the selected filters."})}):e.jsxs(e.Fragment,{children:[q,P.totalPages>1&&e.jsx(w,{sx:{display:"flex",justifyContent:"center",mt:3,mb:2},children:e.jsx(gt,{count:P.totalPages,page:N,onChange:v,color:"primary"})}),e.jsx(G,{variant:"body2",sx:{textAlign:"center",mt:2,color:"text.secondary"},children:e.jsxs(k,{i18nKey:"customTiles.showingTiles",values:{shown:P.items.length,total:P.total},children:["Showing ",{shown:P.items.length}," of ",{total:P.total}," tiles"]})})]})})]})]})}function hs({boardUpdated:c,setOpen:g,open:n=!1}){const{t:m,i18n:i}=re(),j=Ie(),a=Ie("md"),[t,d]=o.useState({message:"",type:"info"}),[u,p]=o.useState("ctAdd"),[r,s]=o.useState(null),[l,C]=o.useState(0),[A,N]=o.useState({online:{},local:{},solo:{}}),[E,_]=o.useState(!0),D=o.useCallback(()=>{C(T=>T+1)},[]),P=T=>(f,x)=>{p(x?T:"")};o.useEffect(()=>{async function T(){_(!0);try{const[f,x,v]=await Promise.all([fe(i.resolvedLanguage,"online"),fe(i.resolvedLanguage,"local"),fe(i.resolvedLanguage,"solo")]);N({online:f,local:x,solo:v})}catch(f){console.error("Error loading game mode actions:",f)}finally{_(!1)}}T()},[i.resolvedLanguage]);const y=xt(()=>ue({locale:i.resolvedLanguage})),F=o.useMemo(()=>y?Array.isArray(y)?y.map(({tags:T})=>T).flat().filter((T,f,x)=>T&&x.indexOf(T)===f).sort():[]:[],[y]),M=o.useCallback(async T=>{await Gt(T),c(),D()},[c,D]);if(!y||E)return null;const R=()=>{const T=e.jsxs(e.Fragment,{children:[e.jsx(ts,{expanded:u,handleChange:P}),e.jsx(es,{setSubmitMessage:d,boardUpdated:()=>{c(),D()},customTiles:y,mappedGroups:A,expanded:u,handleChange:P,tagList:F,updateTileId:r,setUpdateTileId:s}),e.jsx(Ht,{expanded:u,handleChange:P,customTiles:y,mappedGroups:A,setSubmitMessage:d,bulkImport:M})]}),f=Array.isArray(y)&&y.length>0&&e.jsx(w,{children:e.jsx(rs,{tagList:F,boardUpdated:()=>{c(),D()},mappedGroups:A,updateTile:x=>{s(x),p("ctAdd")},refreshTrigger:l})});return a?e.jsxs(e.Fragment,{children:[T,f&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{sx:{my:2}}),f]})]}):e.jsxs(xe,{container:!0,spacing:2,children:[e.jsx(xe,{size:{xs:12,md:6},children:T}),e.jsx(xe,{size:{xs:12,md:6},children:f})]})};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{fullScreen:j,open:n,onClose:()=>g(!1),maxWidth:a?"sm":"lg",fullWidth:!0,children:[e.jsxs(je,{children:[e.jsx(k,{i18nKey:"manageTiles"}),e.jsx(se,{"aria-label":m("close"),onClick:()=>g(!1),sx:{position:"absolute",right:8,top:8,color:T=>T.palette.grey[500]},children:e.jsx(Wt,{})})]}),e.jsx(ve,{children:R()})]}),e.jsx(It,{open:!!t.message,close:()=>d({message:"",type:"info"}),type:t.type,children:t.message})]})}function fs(c={},g={}){const[n]=At(),m={...c,...n,selectedActions:n?.selectedActions||{},finishRange:n?.finishRange||[30,70],...g},[i,j]=o.useState(m),{messages:a}=Vt(),[t,d]=o.useState(!1);return o.useEffect(()=>{const u=St(a,"room");if(u?.settings)try{const p=JSON.parse(u.settings);j(r=>t?r.selectedActions&&Object.keys(r.selectedActions).length>0?{...r,...p,selectedActions:r.selectedActions}:{...r,...p}:(d(!0),{...r,...p}))}catch(p){console.error("Error parsing message settings:",p)}else t||d(!0)},[a,t]),[i,j]}export{hs as C,Ze as g,fe as i,fs as u};
