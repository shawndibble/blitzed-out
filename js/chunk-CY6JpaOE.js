import{b as ne,u as F,a as H,g as se,U as oe}from"./chunk-YpQmZHCE.js";import{a as ie,i as re}from"./chunk-Chz5q09A.js";import{i as E,az as ae,u as x,b as y,aj as Y,ao as le}from"./chunk-DCqCmTw7.js";import{y as X,q as z,E as ce,F as ue,g as de,x as J,G as fe,H as ge}from"./chunk-5SGEHjMG.js";import{l as pe}from"./chunk-Bmx5YEUT.js";import{d as Z,i as K,u as me,b as he}from"./chunk-BqV4rolb.js";import{u as _}from"./chunk-rJHcTq4h.js";import{u as ve}from"./chunk-B47UJojq.js";(function(){var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{};e.SENTRY_RELEASE={id:"b82d01bea29447e452b49ba3e85b9fac2f7942a4"}})();try{(function(){var e=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="56c60fcf-3f6e-44c1-9339-ba760f2e2d02",e._sentryDebugIdIdentifier="sentry-dbid-56c60fcf-3f6e-44c1-9339-ba760f2e2d02")})()}catch(e){}function B(e){for(let t=e.length-1;t>0;t-=1){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function De(e,t){return(e==null?void 0:e.length)!==(t==null?void 0:t.length)?!1:e.every((s,o)=>s===t[o])}function be(e){const{t}=E;let s=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([o,n])=>{if(o!=="room"){if(o==="roomBackgroundURL"&&n!==""){s+=`* ${t(o)}: [${ie(n)}:link:](${n})\r
`;return}if(o==="roomRealtime"){s+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(s+=`* ${t(o)}: ${n}\r
`)}}),s}function ye(e){const t={};return Object.entries(e).forEach(([s,o])=>{s.startsWith("room")&&!["roomUpdated","roomBackground","roomBackgroundURL"].includes(s)&&(t[s]=o)}),e.roomBackgroundURL&&e.roomBackgroundURL.trim()!==""&&(t.roomBackgroundURL=e.roomBackgroundURL),t}async function Te(e,t,s){let o=e;return t!==void 0&&t.length>0&&(o=await s(t)),o}function Ce(e,t){const s=ye(e);return X({room:e.room,user:t,text:be(s),type:"room",settings:JSON.stringify(s)})}const I=50,N=100,R=50,M=1,P=10,V=1,O=10,Q=["none","all","default","undefined","null"],$e=["solo","foreplay","sex","consumption"],we=(e,t="en",s="online",o)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const a=e.trim();return a.length>I&&n.push(`Group name must be ${I} characters or less`),Q.includes(a.toLowerCase())&&n.push(`"${a}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(a)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(a)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Le=e=>{const t=[],s=[];return!e||e.trim().length===0?(t.push(ae("groupLabelRequired")),{isValid:!1,errors:t,warnings:s}):(e.trim().length>N&&t.push(`Group label must be ${N} characters or less`),{isValid:t.length===0,errors:t,warnings:s})},Se=e=>{const t=[],s=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:s};e.length<V&&t.push(`At least ${V} intensity level is required`),e.length>O&&t.push(`Maximum ${O} intensity levels allowed`);const o=new Set,n=new Set;for(let r=0;r<e.length;r++){const u=e[r];if((!u.id||u.id.trim().length===0)&&t.push(`Intensity level ${r+1} is missing an ID`),!u.label||u.label.trim().length===0)t.push(`Intensity level ${r+1} is missing a label`);else{const c=u.label.trim();c.length>R&&t.push(`Intensity level ${r+1} label must be ${R} characters or less`),n.has(c.toLowerCase())?t.push(`Intensity label "${c}" is used multiple times`):n.add(c.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?t.push(`Intensity level ${r+1} must have a valid integer value`):((u.value<M||u.value>P)&&t.push(`Intensity level ${r+1} value must be between ${M} and ${P}`),o.has(u.value)?t.push(`Intensity value ${u.value} is used multiple times`):o.add(u.value))}const i=Array.from(o).sort((r,u)=>r-u);let a=i[0];for(const r of i){if(r!==a){s.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}a++}return{isValid:t.length===0,errors:t,warnings:s}},et=async(e,t)=>{const s=[],o=[],n=we(e.name,e.locale||"en",e.gameMode||"online");s.push(...n.errors),o.push(...n.warnings||[]);const i=Le(e.label);s.push(...i.errors),o.push(...i.warnings||[]);const a=Se(e.intensities);if(s.push(...a.errors),o.push(...a.warnings||[]),n.isValid&&e.name)try{await ce(e.name,e.locale||"en",e.gameMode||"online",t)||s.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(r){o.push("Could not verify group name uniqueness"),pe.warn("Failed to check group name uniqueness:",!1,r instanceof Error?r.message:"Unknown error")}return{isValid:s.length===0,errors:s,warnings:o}},tt=async(e,t="en",s="online")=>{const o=[],n=[];if(!e.group||e.group.trim().length===0)return o.push("Tile must belong to a group"),{isValid:!1,errors:o,warnings:n};try{const i=await z(e.group,t,s);if(!i)return o.push(`Group "${e.group}" does not exist for ${t}/${s}`),{isValid:!1,errors:o,warnings:n};const a=i.intensities.map(r=>r.value);a.includes(e.intensity)||o.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${a.join(", ")}`),(!e.action||e.action.trim().length===0)&&o.push("Tile action is required")}catch(i){o.push(`Error validating tile: ${i}`)}return{isValid:o.length===0,errors:o,warnings:n}},Ae=()=>({MAX_GROUP_NAME_LENGTH:I,MAX_GROUP_LABEL_LENGTH:N,MAX_INTENSITY_LABEL_LENGTH:R,MIN_INTENSITY_VALUE:M,MAX_INTENSITY_VALUE:P,MIN_INTENSITIES_COUNT:V,MAX_INTENSITIES_COUNT:O,RESERVED_GROUP_NAMES:Q,VALID_GROUP_TYPES:$e});function Ee(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ue(e,t,s){const o=e.selectedActions||{},n=Object.entries(s).filter(([a])=>o[a]).reduce((a,[r,u])=>{const c=o[r].levels||[],d=Object.keys(u.actions);return a[r]=c.map(f=>d[f]).filter(Boolean),a},{});return((t==null?void 0:t.filter(a=>{if(!a.isCustom)return!1;const r=n[a.group];return r&&r.length>=Number(a.intensity)}))||[]).length}async function Ge(e,t,s,o){const{t:n}=E;let i=`### ${E.t("gameSettingsHeading")}\r
`;o&&(i+=`##### ${o}\r
`),i+=`--- \r
`;const a=e.selectedActions||{};if(Object.entries(s).forEach(([c,d])=>{if(!a[c])return;const{role:f,variation:g,levels:p}=a[c],l=f||e.role||"sub";if(p&&p.length>0){i+=d==null?void 0:d.label;let h=null;g?h=n(g):Z(e.gameMode)||(h=Ee(d,l)?d[l]:n(l)),h&&(i+=`: ${h}`),i+=`\r
`;const b=(d==null?void 0:d.intensities)||{};p.forEach(m=>{const v=b[m]||`Level ${m}`;i+=`* ${v}\r
`}),i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const c of e.customGroups)if(c.groupName&&c.intensity)try{const d=await z(c.groupName,e.locale||"en",e.gameMode||"online"),f=(d==null?void 0:d.label)||c.groupName;i+=`* ${f}: Level ${c.intensity} (Custom)\r
`}catch(d){console.error(`Error loading custom group ${c.groupName}:`,d),i+=`* ${c.groupName}: Level ${c.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:r}=e;if(i+=`--- \r
`,r){const c=r[0],d=r[1]-r[0],f=100-r[1],p=[c>0?{percent:c,text:n("noCum")}:null,d>0?{percent:d,text:n("ruined")}:null,f>0?{percent:f,text:n("cum")}:null].filter(l=>l!==null);p.length===1&&p[0].percent===100?i+=`* ${n("finishSlider")} ${p[0].text.replace(":","")} \r
`:p.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,p.forEach(l=>{const h=l.percent===100?l.text.replace(":",""):`${l.text} ${l.percent}%`;i+=`  - ${h} \r
`}))}const u=Ue(e,t,s);return u&&(i+=`* ${n("customTilesLabel")}: ${u} \r
`),i}function _e(e){const t={};return Object.entries(e).forEach(([s,o])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(s)&&!s.startsWith("room")&&(t[s]=o)}),t}async function Be({title:e,formData:t,user:s,actionsList:o,tiles:n,customTiles:i=[],reason:a=""}){const r=JSON.stringify(_e(t)),u=await ue({title:e,gameBoard:JSON.stringify(n),settings:r}),c=await Ge(t,i,o,a);if(!(!(u!=null&&u.id)||c===""))return X({room:(t==null?void 0:t.room)||"PUBLIC",user:s,text:c,type:"settings",gameBoardId:u.id,boardSize:n.length,gameMode:t.gameMode})}var Ie=Object.defineProperty,Ne=(e,t,s)=>t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,q=(e,t,s)=>Ne(e,typeof t!="symbol"?t+"":t,s);const{t:S}=E;class Re{constructor(t){q(this,"bags",new Map),q(this,"originalTiles",new Map);const s=new Map;t.forEach(o=>{const n=`${o.group}-${o.intensity}`;s.has(n)||s.set(n,[]),s.get(n).push(o)}),s.forEach((o,n)=>{const i=[...o];B(i),this.bags.set(n,i),this.originalTiles.set(n,[...o])})}getTile(t,s){const o=`${t}-${s}`;let n=this.bags.get(o);if(!n||n.length===0){const i=this.originalTiles.get(o);if(!i||i.length===0)return null;n=[...i],B(n),this.bags.set(o,n)}return n.pop()||null}}function Me(e,t,s=[]){return e.filter(o=>{const n=o.action,i=s.find(a=>a.name===o.group);return(i==null?void 0:i.type)==="consumption"||(i==null?void 0:i.type)==="solo"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const W=new Map;function Pe(e,t,s){const o=`${e}-${t}-${s}`,n=W.get(o);if(n!==void 0)return n;const i=e/t,a=Math.floor(s/i)+1;return W.set(o,a),a}function D(e,t,s,o,n,i){if(!e.length)return{title:"",description:""};const a=e[0],r=s[a.name];if(!r||!r.levels||r.levels.length===0)return{title:"",description:""};if(r.variation){const p=r.variation==="appendSome"?.4:r.variation==="appendMost"?.9:1;if(r.variation!=="standalone"&&Math.random()>p)return{title:"",description:""}}const u=Math.max(...a.intensities.map(p=>p.value)),c=Pe(n,u,o),d=r.levels;let f;d.includes(c)?f=c:f=d.reduce((p,l)=>Math.abs(l-c)<Math.abs(p-c)?l:p);let g=t.getTile(a.name,f);if(!g){const p=d.filter(l=>l!==f);for(const l of p)if(g=t.getTile(a.name,l),g)break;if(!g)return{title:"",description:""}}return{title:a.label,description:g.action,standalone:r.variation==="standalone",role:i.role||"sub"}}function Ve(e,t,s,o,n,i,a){if(e.standalone||!t.length||!e.description)return e.description||"";const r=D(t,s,o,n,i,a);return r.description?`${r.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Oe(e,t,s,o){const n=s.selectedActions||{},i=new Re(t),a=e.filter(d=>{const f=n[d.name];return f&&f.levels&&f.levels.length>0&&(!f.variation||f.variation==="standalone")}),r=e.filter(d=>{const f=n[d.name];return f&&f.levels&&f.levels.length>0&&(f.variation==="appendSome"||f.variation==="appendMost")});B(a);let u=0;const c=[];for(let d=1;d<=o;d++){const f=a.length>0?[a[u%a.length]]:[];u++;const g=D(f,i,n,d,o,s),p=Ve(g,r,i,n,d,o,s);c.push({title:g.title,description:p.trim(),role:g.role})}return c}function G(e,t){const s={title:S("start"),description:S("start")},{finishRange:o=[33,66]}=t,n=`${S("noCum")} ${o[0]}%\r
${S("ruined")} ${o[1]-o[0]}%\r
${S("cum")} ${100-o[1]}%`,i={title:S("finish"),description:n};return[s,...e.map(a=>({title:a.title,description:a.description})),i]}async function xe(e,t,s,o=40){try{const[n,i]=await Promise.all([de({locale:t,gameMode:s}),ne({locale:t,gameMode:s})]),a=e.selectedActions||{},r=Object.keys(a).filter(m=>{var v;return((v=a[m])==null?void 0:v.levels)&&a[m].levels.length>0}),u=n.filter(m=>r.includes(m.name)),c=n.map(m=>m.name),d=r.filter(m=>!c.includes(m)),f=e.role||"sub",p=Me(i,f,n).filter(m=>r.includes(m.group));if(!u.length||!p.length)return{board:G([],e),metadata:{totalTiles:o+2,tilesWithContent:2,selectedGroups:r,missingGroups:d,availableTileCount:p.length}};const l=await Oe(u,p,e,o),h=l.filter(m=>m.description.trim().length>0).length,b=G(l,e);return{board:b,metadata:{totalTiles:b.length,tilesWithContent:h+2,selectedGroups:r,missingGroups:d,availableTileCount:p.length}}}catch(n){return console.error("Error building game board:",n),{board:G([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function ke(){const e=_(H),[t,s]=J(),{i18n:o}=x(),n=y.useCallback(async i=>{var a,r;const u=i!=null&&i.roomUpdate||i!=null&&i.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:c,boardUpdated:d}=u;const{roomTileCount:f=40,finishRange:g,room:p}=u,l=K(p||"");if(!i||!g)return{gameMode:c};l&&!Z(c||"")&&(c="online",d=!0);const h=c||"online",b=o.resolvedLanguage||"en",m=l?40:f||40,v=await xe(u,b,h,m);return v.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",v.metadata.missingGroups),v.metadata.tilesWithContent<m/2&&console.warn("Low tile content ratio:",{tilesWithContent:v.metadata.tilesWithContent,totalTiles:v.metadata.totalTiles,availableTileCount:v.metadata.availableTileCount}),(i!=null&&i.boardUpdated||d||((r=(a=e==null?void 0:e.tiles)==null?void 0:a.length)!=null?r:0)!==v.board.length)&&(await s(u),await F({title:(e==null?void 0:e.title)||"",tiles:v.board})),{settingsBoardUpdated:d,gameMode:c,newBoard:v.board,metadata:v.metadata}},[e,o.resolvedLanguage,t,s]);return y.useCallback(i=>n(i),[n])}function qe(){const{id:e}=Y(),t=le();return s=>{const o=e!==void 0&&(e==null?void 0:e.toUpperCase())!==(s==null?void 0:s.toUpperCase()),n=(s==null?void 0:s.replace(/^\/+/,""))||"PUBLIC";o&&t(`/${n}`)}}function We(e){var t;const s=(t=e.roomBackgroundURL)==null?void 0:t.trim();s!==e.roomBackgroundURL&&(e.roomBackgroundURL=s||""),e.roomBackgroundURL&&!re(e.roomBackgroundURL)&&(e.roomBackgroundURL="")}function je(e){const t={...e},s={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.levels&&i.levels.length>0&&(s[n]=i)});const o=Ae();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&o.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=s,t}function nt(){const{user:e,updateUser:t}=me(),{id:s}=Y(),{t:o}=x(),n=ke(),[i,a]=J(),r=_(()=>se(i==null?void 0:i.gameMode)),u=_(H),c=qe(),{messages:d}=he(),{createLocalSession:f}=ve(),g=y.useCallback(l=>{var h;const b=(h=s||"")==null?void 0:h.toUpperCase(),m=(l.room||"").toUpperCase(),v=b!==m,T=!!(l.room&&!K(l.room)),$=T&&l.roomTileCount!==(i==null?void 0:i.roomTileCount);return{roomChanged:v,isPrivateRoom:T,privateBoardSizeChanged:$}},[s,i==null?void 0:i.roomTileCount]),p=y.useCallback(async(l,h)=>{const{displayName:b}=l,m=await Te(e,b,t);We(l);const{settingsBoardUpdated:v,gameMode:T,newBoard:$=[]}=await n(l),{roomChanged:w,isPrivateRoom:U,privateBoardSizeChanged:ee}=g(l);if(!m)return;U&&(l.roomUpdated||!d.find(L=>L.type==="room"))&&await Ce(l,m),(u==null?void 0:u.tiles)!==$&&await F({title:o("settingsGenerated"),tiles:$,isActive:1,gameMode:T}),(v||w||ee)&&!d.some(L=>{var k;return L.type==="settings"&&L.uid===m.uid&&Date.now()-(((k=L.timestamp)==null?void 0:k.toMillis())||0)<5e3})&&await Be({formData:l,user:m,customTiles:r,actionsList:h,title:"Settings Generated Board",tiles:$});const A=l;if(A.hasLocalPlayers&&A.localPlayersData&&A.localPlayerSessionSettings)try{await f(l.room,A.localPlayersData,A.localPlayerSessionSettings)}catch(L){console.error("Error creating local session:",L)}const te=je(l);a({...te,boardUpdated:!1,roomUpdated:!1,gameMode:T}),c(l.room)},[e,t,n,g,d,u,o,r,a,c,f]);return y.useCallback((l,h)=>p(l,h),[p])}const C=new Map,j=oe;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{C.clear()};function st(e){const{i18n:t,t:s}=x(),{currentLanguageMigrated:o,isHealthy:n,forceRecovery:i}=fe(),[a,r]=y.useState({}),[u,c]=y.useState(!0),[d,f]=y.useState(!1);y.useEffect(()=>{const l=()=>{e&&Array.from(C.keys()).filter(b=>b.endsWith(`-${e}`)).forEach(b=>{C.delete(b)})};return t.on("languageChanged",l),()=>{t.off("languageChanged",l)}},[t,e]);const g=y.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);y.useEffect(()=>{o&&g&&C.get(g)&&C.delete(g)},[o,g]),y.useEffect(()=>{if(g){const l=C.get(g);l&&Date.now()-l.timestamp<j&&(r(l.data),c(!1))}},[g]);const p=y.useCallback(async()=>{if(!e||!g){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:g});return}if(!o)return;if(o&&!n&&!d){f(!0);try{await i();return}catch(h){}}const l=C.get(g);if(l&&Date.now()-l.timestamp<j){r(l.data),c(!1);return}c(!0);try{const h=await ge(t.resolvedLanguage,e),b={};for(const m of h){const v={[s("none")]:[]},T={};m.intensities&&Array.isArray(m.intensities)&&m.intensities.sort((w,U)=>w.value-U.value).forEach(w=>{v[w.label]=[],T[w.value]=w.label});const $=m.type||"action";b[m.name]={label:m.label||m.name,type:$,actions:v,intensities:T}}C.set(g,{data:b,timestamp:Date.now()}),r(b)}catch(h){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:h,locale:t.resolvedLanguage,gameMode:e,cacheKey:g}),r({})}finally{c(!1)}},[e,t.resolvedLanguage,g,s,o,n,d,i]);return y.useEffect(()=>{g&&o&&p()},[p,g,o,n]),{actionsList:a,isLoading:u}}export{nt as a,st as b,De as c,Le as d,tt as e,Ce as f,Ae as g,Be as s,ke as u,et as v};
//# sourceMappingURL=chunk-CY6JpaOE.js.map
