import{u as Q}from"./chunk-Dfz0O4C-.js";import{u as L}from"./chunk-gA50YDka.js";import{x as K,y as ee,u as P,f as k,z as q,B as te,C as ne,s as x,g as se,D as ie,E as oe}from"../assets/index-CrMGNACz.js";import{i as j,b as W}from"./chunk-C7PvMB7v.js";import{u as H}from"./chunk-BOGMcbnZ.js";import{ac as A,am as M,r as v,az as ae,ad as z,aq as re}from"./chunk-C6Pi8TK2.js";import{a as le,i as ce}from"./chunk-B4PEA_xj.js";import{u as ue}from"./chunk-qOLLNyCc.js";function V(e){e.length>1&&e.push(e.shift())}function je(e,t){return e?.length!==t?.length?!1:e.every((s,n)=>s===t[n])}const{t:y}=A;function de(e,t){return e.filter(s=>{const n=s.action;return t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}function me(e,t,s,n){if([void 0,"normal"].includes(n)){const i=e/t;return Math.floor(s/i)+1}return t>=3&&Math.random()>=.6?t-1:t}function S(e,t,s){return e.filter(n=>n.group===t&&n.intensity===s&&n.isEnabled)}function F(e,t,s,n,i,a){if(!e.length)return{title:"",description:""};V(e);const r=e[0],o=s[r.name];if(!o||o.level<=0)return{title:"",description:""};if(o.variation){const d=o.variation==="appendSome"?.4:o.variation==="appendMost"?.9:1;if(o.variation!=="standalone"&&Math.random()>d)return{title:"",description:""}}const l=Math.max(...r.intensities.map(d=>d.value)),c=me(i,l,n,a.difficulty),m=Math.min(c,o.level),g=[...new Set(t.filter(d=>d.group===r.name&&d.isEnabled).map(d=>d.intensity))].sort((d,h)=>d-h)[0]||1;let u=S(t,r.name,m);if(!u.length){for(let d=m-1;d>=1;d--){const h=S(t,r.name,d);if(h.length>0){u=h;break}}if(!u.length&&g>m){const d=S(t,r.name,g);d.length>0&&(u=d)}if(!u.length)return{title:"",description:""}}return V(u),{title:r.label,description:u[0].action,standalone:o.variation==="standalone",role:a.role||"sub"}}function fe(e,t,s,n,i,a,r){if(e.standalone||!t.length||!e.description)return e.description||"";const o=F(t,s,n,i,a,r);return o.description?`${o.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function pe(e,t,s,n){const i=s.selectedActions||{},a=e.filter(l=>{const c=i[l.name];return c&&c.level>0&&(!c.variation||c.variation==="standalone")}),r=e.filter(l=>{const c=i[l.name];return c&&c.level>0&&(c.variation==="appendSome"||c.variation==="appendMost")}),o=[];for(let l=1;l<=n;l++){const c=F(a,t,i,l,n,s),m=fe(c,r,t,i,l,n,s);o.push({title:c.title,description:m.trim(),role:c.role})}return o}function w(e,t){const s={title:y("start"),description:y("start")},{finishRange:n=[33,66]}=t,i=`${y("noCum")} ${n[0]}%\r
${y("ruined")} ${n[1]-n[0]}%\r
${y("cum")} ${100-n[1]}%`,a={title:y("finish"),description:i};return[s,...e.map(r=>({title:r.title,description:r.description})),a]}async function ge(e,t,s,n=40){try{const[i,a]=await Promise.all([K({locale:t,gameMode:s}),ee({locale:t,gameMode:s})]),r=e.selectedActions||{},o=Object.keys(r).filter(b=>r[b]?.level>0),l=i.filter(b=>o.includes(b.name)),c=i.map(b=>b.name),m=o.filter(b=>!c.includes(b)),p=e.role||"sub",u=de(a,p).filter(b=>o.includes(b.group));if(!l.length||!u.length)return{board:w([],e),metadata:{totalTiles:n+2,tilesWithContent:2,selectedGroups:o,missingGroups:m,availableTileCount:u.length}};const d=await pe(l,u,e,n),h=d.filter(b=>b.description.trim().length>0).length,f=w(d,e);return{board:f,metadata:{totalTiles:f.length,tilesWithContent:h+2,selectedGroups:o,missingGroups:m,availableTileCount:u.length}}}catch(i){return console.error("Error building game board:",i),{board:w([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function he(){const e=L(k),[t,s]=H(),{i18n:n}=M(),i=v.useCallback(async a=>{const r=a?.roomUpdate||a?.boardUpdated?a:{...t,...a,selectedActions:{...t.selectedActions,...a.selectedActions}};let{gameMode:o,boardUpdated:l}=r;const{roomTileCount:c=40,finishRange:m,room:p}=r,g=j(p||"");if(!a||!m)return{gameMode:o};g&&!W(o||"")&&(o="online",l=!0);const u=o||"online",d=n.resolvedLanguage||"en",h=g?40:c||40,f=await ge(r,d,u,h);return f.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",f.metadata.missingGroups),f.metadata.tilesWithContent<h/2&&console.warn("Low tile content ratio:",{tilesWithContent:f.metadata.tilesWithContent,totalTiles:f.metadata.totalTiles,availableTileCount:f.metadata.availableTileCount}),(a?.boardUpdated||l||(e?.tiles?.length??0)!==f.board.length)&&(await s(r),await P({title:e?.title||"",tiles:f.board})),{settingsBoardUpdated:l,gameMode:o,newBoard:f.board,metadata:f.metadata}},[e,n.resolvedLanguage,t,s]);return v.useCallback(a=>i(a),[i])}const G=50,E=100,N=50,U=1,I=10,B=1,_=10,X=["none","all","default","undefined","null"],be=["solo","foreplay","sex","consumption"],ve=(e,t="en",s="online",n)=>{const i=[],a=[];if(!e||e.trim().length===0)return i.push("Group name is required"),{isValid:!1,errors:i,warnings:a};const r=e.trim();return r.length>G&&i.push(`Group name must be ${G} characters or less`),X.includes(r.toLowerCase())&&i.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||i.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||i.push("Group name must start with a letter"),{isValid:i.length===0,errors:i,warnings:a}},ye=e=>{const t=[],s=[];return!e||e.trim().length===0?(t.push(ae("groupLabelRequired")),{isValid:!1,errors:t,warnings:s}):(e.trim().length>E&&t.push(`Group label must be ${E} characters or less`),{isValid:t.length===0,errors:t,warnings:s})},Ce=e=>{const t=[],s=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:s};e.length<B&&t.push(`At least ${B} intensity level is required`),e.length>_&&t.push(`Maximum ${_} intensity levels allowed`);const n=new Set,i=new Set;for(let o=0;o<e.length;o++){const l=e[o];if((!l.id||l.id.trim().length===0)&&t.push(`Intensity level ${o+1} is missing an ID`),!l.label||l.label.trim().length===0)t.push(`Intensity level ${o+1} is missing a label`);else{const c=l.label.trim();c.length>N&&t.push(`Intensity level ${o+1} label must be ${N} characters or less`),i.has(c.toLowerCase())?t.push(`Intensity label "${c}" is used multiple times`):i.add(c.toLowerCase())}typeof l.value!="number"||!Number.isInteger(l.value)?t.push(`Intensity level ${o+1} must have a valid integer value`):((l.value<U||l.value>I)&&t.push(`Intensity level ${o+1} value must be between ${U} and ${I}`),n.has(l.value)?t.push(`Intensity value ${l.value} is used multiple times`):n.add(l.value))}const a=Array.from(n).sort((o,l)=>o-l);let r=a[0];for(const o of a){if(o!==r){s.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:s}},We=async(e,t)=>{const s=[],n=[],i=ve(e.name,e.locale||"en",e.gameMode||"online");s.push(...i.errors),n.push(...i.warnings||[]);const a=ye(e.label);s.push(...a.errors),n.push(...a.warnings||[]);const r=Ce(e.intensities);if(s.push(...r.errors),n.push(...r.warnings||[]),i.isValid&&e.name)try{await te(e.name,e.locale||"en",e.gameMode||"online",t)||s.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch{n.push("Could not verify group name uniqueness")}return{isValid:s.length===0,errors:s,warnings:n}},He=async(e,t="en",s="online")=>{const n=[],i=[];if(!e.group||e.group.trim().length===0)return n.push("Tile must belong to a group"),{isValid:!1,errors:n,warnings:i};try{const a=await q(e.group,t,s);if(!a)return n.push(`Group "${e.group}" does not exist for ${t}/${s}`),{isValid:!1,errors:n,warnings:i};const r=a.intensities.map(o=>o.value);r.includes(e.intensity)||n.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&n.push("Tile action is required")}catch(a){n.push(`Error validating tile: ${a}`)}return{isValid:n.length===0,errors:n,warnings:i}},$e=()=>({MAX_GROUP_NAME_LENGTH:G,MAX_GROUP_LABEL_LENGTH:E,MAX_INTENSITY_LABEL_LENGTH:N,MIN_INTENSITY_VALUE:U,MAX_INTENSITY_VALUE:I,MIN_INTENSITIES_COUNT:B,MAX_INTENSITIES_COUNT:_,RESERVED_GROUP_NAMES:X,VALID_GROUP_TYPES:be});function Ae(e,t,s){const n=e.selectedActions||{},i=Object.entries(s).filter(([r])=>n[r]).reduce((r,[o,l])=>(r[o]=Object.keys(l.actions).slice(1,n[o].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const o=i[r.group];return o&&o.length>=Number(r.intensity)})||[]).length}async function Te(e,t,s,n){const{t:i}=A;let a=`### ${A.t("gameSettingsHeading")}\r
`;n&&(a+=`##### ${n}\r
`),a+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(s).forEach(([m,p])=>{if(!r[m])return;const{role:g,variation:u,level:d}=r[m],h=g||e.role||"sub";if(d>0){const f=Object.keys(p?.actions||{});if(a+=`* ${p?.label}: ${f[d]||""}`,u&&(a+=` (${i(u)})`),!W(e.gameMode)&&!u){const b=p[h]??i(h);a+=` (${b})`}a+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const m of e.customGroups)if(m.groupName&&m.intensity)try{const g=(await q(m.groupName,e.locale||"en",e.gameMode||"online"))?.label||m.groupName;a+=`* ${g}: Level ${m.intensity} (Custom)\r
`}catch(p){console.error(`Error loading custom group ${m.groupName}:`,p),a+=`* ${m.groupName}: Level ${m.intensity} (Custom)\r
`}}if(a.endsWith(`--- \r
`))return"";const{finishRange:o,difficulty:l}=e;a+=`--- \r
`,a+=`* ${i("difficulty")}: ${i(l??"normal")} \r
`,o&&(a+=`* ${i("finishSlider")} ${o[0]}%  | ${o[1]-o[0]}% | ${100-o[1]}% \r
`);const c=Ae(e,t,s);return c&&(a+=`* ${i("customTilesLabel")}: ${c} \r
`),a}function Se(e){const t={};return Object.entries(e).forEach(([s,n])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(s)&&!s.startsWith("room")&&(t[s]=n)}),t}async function we({title:e,formData:t,user:s,actionsList:n,tiles:i,customTiles:a=[],reason:r=""}){const o=JSON.stringify(Se(t)),l=await ne({title:e,gameBoard:JSON.stringify(i),settings:o}),c=await Te(t,a,n,r);if(!(!l?.id||c===""))return x({room:t?.room||"PUBLIC",user:s,text:c,type:"settings",gameBoardId:l.id,boardSize:i.length,gameMode:t.gameMode})}function Le(e){const{t}=A;let s=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([n,i])=>{if(n!=="room"){if(n==="roomBackgroundURL"&&i!==""){s+=`* ${t(n)}: [${le(i)}:link:](${i})\r
`;return}if(n==="roomRealtime"){s+=`* ${t("playerList")}: ${t(i?"delayed":"realtime")}\r
`;return}i!==""&&(s+=`* ${t(n)}: ${i}\r
`)}}),s}function Ge(e){const t={};return Object.entries(e).forEach(([s,n])=>{s.startsWith("room")&&!["roomUpdated","roomBackground"].some(i=>i===s)&&(t[s]=n)}),t}async function Ee(e,t,s){let n=e;return t!==void 0&&t.length>0&&(n=await s(t)),n}function Ne(e,t){const s=Ge(e);return x({room:e.room,user:t,text:Le(s),type:"room",settings:JSON.stringify(s)})}function Ue(){const{id:e}=z(),t=re();return s=>{if(e!==void 0&&e?.toUpperCase()!==s?.toUpperCase()){const n=s?.replace(/^\/+/,"")||"PUBLIC";t(`/${n}`)}}}function Ie(e){(!e.roomBackgroundURL||!ce(e.roomBackgroundURL))&&(e.roomBackground="app")}function Be(e){const t={...e},s={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([i,a])=>{a&&a.level>0&&(s[i]=a)});const n=$e();return Object.keys(t).forEach(i=>{const a=t[i];a&&typeof a=="object"&&a.type&&n.VALID_GROUP_TYPES.includes(a.type)&&delete t[i]}),t.selectedActions=s,t}function ze(){const{user:e,updateUser:t}=Q(),{id:s}=z(),{t:n}=M(),i=he(),[a,r]=H(),o=L(()=>se(a?.gameMode)),l=L(k),c=Ue(),{messages:m}=ue(),p=v.useCallback(u=>{const d=s?.toUpperCase()!==u.room.toUpperCase(),h=!!(u.room&&!j(u.room)),f=h&&u.roomTileCount!==a?.roomTileCount;return{roomChanged:d,isPrivateRoom:h,privateBoardSizeChanged:f}},[s,a?.roomTileCount]),g=v.useCallback(async(u,d)=>{const{displayName:h}=u,f=await Ee(e,h,t);Ie(u);const{settingsBoardUpdated:b,gameMode:R,newBoard:T=[]}=await i(u),{roomChanged:Y,isPrivateRoom:J,privateBoardSizeChanged:D}=p(u);if(!f)return;J&&(u.roomUpdated||!m.find($=>$.type==="room"))&&await Ne(u,f),l?.tiles!==T&&await P({title:n("settingsGenerated"),tiles:T,isActive:1,gameMode:R}),(b||Y||D)&&!m.some($=>$.type==="settings"&&$.uid===f.uid&&Date.now()-($.timestamp?.toMillis()||0)<5e3)&&await we({formData:u,user:f,customTiles:o,actionsList:d,title:"Settings Generated Board",tiles:T});const Z=Be(u);r({...Z,boardUpdated:!1,roomUpdated:!1,gameMode:R}),c(u.room)},[e,t,i,p,m,l,n,o,r,c]);return v.useCallback((u,d)=>g(u,d),[g])}const C=new Map,O=oe;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{C.clear()};function Fe(e){const{i18n:t,t:s}=M(),[n,i]=v.useState({}),[a,r]=v.useState(!0);v.useEffect(()=>{const c=()=>{e&&Array.from(C.keys()).filter(p=>p.endsWith(`-${e}`)).forEach(p=>{C.delete(p)})};return t.on("languageChanged",c),()=>{t.off("languageChanged",c)}},[t,e]);const o=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{if(o){const c=C.get(o);c&&Date.now()-c.timestamp<O&&(i(c.data),r(!1))}},[o]);const l=v.useCallback(async()=>{if(!e||!o){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:o});return}const c=C.get(o);if(c&&Date.now()-c.timestamp<O){i(c.data),r(!1);return}r(!0);try{const m=await ie(t.resolvedLanguage,e),p={};for(const g of m){const u={[s("none")]:[]};g.intensities&&Array.isArray(g.intensities)&&g.intensities.sort((h,f)=>h.value-f.value).forEach(h=>{u[h.label]=[]});const d=g.type||"action";p[g.name]={label:g.label||g.name,type:d,actions:u}}C.set(o,{data:p,timestamp:Date.now()}),i(p)}catch(m){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:m,locale:t.resolvedLanguage,gameMode:e,cacheKey:o}),i({})}finally{r(!1)}},[e,t.resolvedLanguage,o,s]);return v.useEffect(()=>{o&&l()},[l,o]),{actionsList:n,isLoading:a}}export{Ne as a,Ue as b,je as c,ze as d,Fe as e,ye as f,$e as g,He as h,we as s,he as u,We as v};
