const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/migrationService.ts-COPz7YmP.js","assets/index-7-CLrmJ-.js","js/chunk-DX6P0x0s.js","js/chunk-kXcKns83.js","js/chunk-D0kTc4er.js","js/chunk-D1-3ETWm.js","js/chunk-B37hsyTU.js"])))=>i.map(i=>d[i]);
import{_ as j}from"../assets/index-7-CLrmJ-.js";import{r as u,ak as z,j as G}from"./chunk-DX6P0x0s.js";import{y as O}from"./chunk-D1-3ETWm.js";import{i as x}from"./chunk-D0kTc4er.js";const q=r=>{const t={};for(const e of r){const a={label:e.label||e.name,type:e.type||"action",actions:{None:[]}};if(e.intensities&&Array.isArray(e.intensities))for(const g of e.intensities)a.actions[g.label]=[];t[e.name]=a}return t},J=async(r="en",t="online")=>{try{const e=await O(r,t);return q(e)}catch(e){return console.error("Error importing actions from Dexie:",e),{}}},K=async(r="en",t="online")=>{try{const[e,a]=await Promise.all([J(r,t).catch(()=>({})),O(r,t).catch(()=>[])]),g=Object.keys(e).length;if(a.length<g)return!1;const d=Object.keys(e),i=new Set(a.map(p=>p.name));for(const p of d)if(!i.has(p))return!1;return!0}catch(e){return console.error("Error in isDexieDataComplete:",e),!1}},T="blitzed-out-migration-health",E=3,Y=300*1e3,H=()=>{try{const r=localStorage.getItem(T);return r?JSON.parse(r):{}}catch(r){return console.warn("Failed to load migration health state:",r),{}}},L=(r,t,e)=>{try{const a=`${r}-${t}`,g=H();g[a]={failureCount:0,lastValidation:new Date().toISOString(),consecutiveFailures:0,...g[a],...e},localStorage.setItem(T,JSON.stringify(g))}catch(a){console.warn("Failed to update migration health state:",a)}},I=async(r,t="online")=>{const e=r||x.resolvedLanguage||x.language||"en",a=`${e}-${t}`,o=H()[a]||{failureCount:0,lastValidation:new Date(0).toISOString(),consecutiveFailures:0},d={...o,lastValidation:new Date(o.lastValidation)},i={isHealthy:!1,requiresRecovery:!1,lastValidation:d.lastValidation,failureCount:d.failureCount,details:{migrationStatus:"incomplete",dataComplete:!1,locale:e,gameMode:t}};try{if(Date.now()-d.lastValidation.getTime()<Y&&d.consecutiveFailures===0)return i.isHealthy=!0,i.details.migrationStatus="completed",i.details.dataComplete=!0,i;const s=await K(e,t);if(i.details.dataComplete=s,s)i.isHealthy=!0,i.details.migrationStatus="completed",L(e,t,{consecutiveFailures:0,lastValidation:new Date().toISOString()});else{const v=X();i.details.migrationStatus=v;const h=d.failureCount+1,S=d.consecutiveFailures+1;L(e,t,{failureCount:h,consecutiveFailures:S,lastValidation:new Date().toISOString()}),i.failureCount=h,i.requiresRecovery=S>=E,i.requiresRecovery&&(i.details.errorMessage=`Migration failed ${S} consecutive times. Data incomplete for ${e}/${t}.`)}return i}catch(p){console.error("Migration health check failed:",p);const s=d.failureCount+1,v=d.consecutiveFailures+1;return L(e,t,{failureCount:s,consecutiveFailures:v,lastValidation:new Date().toISOString()}),i.failureCount=s,i.requiresRecovery=v>=E,i.details.migrationStatus="failed",i.details.errorMessage=`Health check failed: ${p instanceof Error?p.message:String(p)}`,i}},X=()=>{try{const r=localStorage.getItem("blitzed-out-action-groups-migration");if(r){const e=JSON.parse(r);if(e.completed&&e.version==="2.1.1")return"completed"}const t=localStorage.getItem("blitzed-out-background-migration");if(t){const e=JSON.parse(t);if(e.completedLanguages&&e.completedLanguages.length>0)return"completed"}return"incomplete"}catch(r){return console.warn("Failed to check migration status from storage:",r),"incomplete"}},D=async(r,t="online")=>{const e=r||x.resolvedLanguage||x.language||"en";try{const a=["blitzed-out-migration-in-progress","blitzed-out-current-language-migration","blitzed-out-background-migration-in-progress"];let g=!1;a.forEach(o=>{try{localStorage.removeItem(o)}catch(d){console.warn(`Failed to remove ${o}:`,d),g=!0}});try{L(e,t,{failureCount:0,consecutiveFailures:0,lastValidation:new Date(0).toISOString()})}catch(o){console.warn("Failed to update health state:",o),g=!0}return!g}catch(a){return console.error("Migration recovery failed:",a),!1}},R=u.createContext(void 0);function B(){const r=u.useContext(R);if(r===void 0)throw new Error("useMigration must be used within a MigrationProvider");return r}function Q({children:r}){const{i18n:t}=z(),[e,a]=u.useState(!1),[g,o]=u.useState(!1),[d,i]=u.useState(!1),[p,s]=u.useState(null),[v,h]=u.useState(!1),[S,k]=u.useState(!1),[C,_]=u.useState(null),b=u.useRef(new Set),f=u.useCallback(async()=>await j(()=>import("./migrationService.ts-COPz7YmP.js"),__vite__mapDeps([0,1,2,3,4,5,6])),[]);u.useEffect(()=>{const c=async()=>{try{const l=await f(),n=t.language||"en";if(!await l.verifyMigrationIntegrity(n,"online")){l.fixMigrationStatusCorruption(),o(!1),i(!1);return}const w=l.isCurrentLanguageMigrationCompleted(n),M=l.isMigrationCompleted();if(o(w),i(M),w){const y=await I(n,"online");h(y.isHealthy),!y.isHealthy&&y.requiresRecovery&&!S&&(k(!0),await D(n,"online")?(o(!1),s(null)):s("Migration recovery failed. Some features may not work correctly."))}}catch(l){console.warn("Failed to check migration status:",l),s("Failed to check migration status"),h(!1)}};t.language&&t.language!=="undefined"&&c()},[t.language,f,S]);const A=u.useCallback(async()=>{const c=t.language||"en";try{if(a(!0),s(null),await D(c,"online")){k(!0),o(!1),h(!1);const n=await f();if(await n.runMigrationIfNeeded()){await n.cleanupDuplicatesIfNeeded(),o(!0),i(n.isMigrationCompleted());const w=await I(c,"online");h(w.isHealthy)}}else s("Force recovery failed. Please try refreshing the page.")}catch(l){console.error("Force recovery failed:",l),s("Force recovery failed. Please try refreshing the page.")}finally{a(!1)}},[t.language,f]),V=u.useCallback(async()=>{if(!e){a(!0),s(null);try{const c=await f();if(await c.runMigrationIfNeeded()){await c.cleanupDuplicatesIfNeeded(),o(!0),i(c.isMigrationCompleted());const n=t.language||"en",m=await I(n,"online");h(m.isHealthy),m.isHealthy||s("Migration completed but data validation failed. Some features may not work correctly.")}else s("Migration failed but app will continue with existing data"),h(!1)}catch(c){console.error("Migration failed:",c),s("Migration failed but app will continue with existing data"),h(!1)}finally{a(!1)}}},[e,f,t.language]),F=u.useCallback(c=>{C&&clearTimeout(C);const l=setTimeout(async()=>{try{const n=await f();if(n.isCurrentLanguageMigrationCompleted(c)){o(!0);return}a(!0),s(null),await n.ensureLanguageMigrated(c)?(o(!0),i(n.isMigrationCompleted())):s("Migration failed but app will continue with existing data")}catch(n){console.error("Error during language migration:",n),s("Migration failed but app will continue with existing data")}finally{a(!1)}},300);_(l)},[C,f]),N=u.useCallback(async c=>{const l=c||t.language||"en";try{const n=await f();if(n.isCurrentLanguageMigrationCompleted(l))return o(!0),!0;a(!0);const m=await n.ensureLanguageMigrated(l);return m&&o(!0),m}catch(n){return console.error(`Failed to ensure ${l} migration:`,n),!1}finally{a(!1)}},[t.language,f]);u.useEffect(()=>{if(!t.language||t.language==="undefined")return;const c=n=>{F(n)};return t.on("languageChanged",c),(async()=>{try{const n=await f(),m=t.language||"en",w=n.isCurrentLanguageMigrationCompleted(m);o(w);const M=`${m}-initial`;!w&&!e&&!b.current.has(M)&&(b.current.add(M),a(!0),setTimeout(async()=>{try{const y=await f();await y.ensureLanguageMigrated(m)?(o(!0),i(y.isMigrationCompleted())):(s("Migration failed but app will continue with existing data"),b.current.delete(M))}catch(y){console.error("Error during migration execution:",y),s("Migration failed but app will continue with existing data"),b.current.delete(M)}finally{a(!1)}},0))}catch(n){console.error("Error during initial migration check:",n),a(!1)}})(),()=>{t.off("languageChanged",c),C&&clearTimeout(C)}},[t,F,e,C,f]);const P={isMigrationCompleted:d,isMigrationInProgress:e,currentLanguageMigrated:g,error:p,isHealthy:v,recoveryAttempted:S,triggerMigration:V,ensureLanguageMigrated:N,forceRecovery:A};return G.jsx(R.Provider,{value:P,children:r})}const te=Object.freeze(Object.defineProperty({__proto__:null,MigrationProvider:Q,useMigration:B},Symbol.toStringTag,{value:"Module"}));export{J as i,te as m,B as u};
