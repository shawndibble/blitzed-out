var te=Object.defineProperty;var ne=(e,t,o)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var U=(e,t,o)=>ne(e,typeof t!="symbol"?t+"":t,o);import{i as W,d as F,u as se,b as oe}from"./chunk-DEA6y773.js";import{u as I}from"./chunk-B5PHAmSG.js";import{t as ie,v as ae,u as H,e as X,f as Y,w as re,s as D,j as J,x as le,c as ce,y as ue,U as de}from"./chunk-Bg66iSD7.js";import{aa as G,ak as x,r as v,ad as z,ai as pe,au as fe}from"./chunk-B8izEdPk.js";import{a as ge,i as me}from"./chunk-B4PEA_xj.js";import{l as he}from"./chunk-yLOK5aTh.js";import{u as be}from"./chunk-HelPtATz.js";import{u as ve}from"./chunk-DV4CcANF.js";function M(e){for(let t=e.length-1;t>0;t-=1){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Qe(e,t){return e?.length!==t?.length?!1:e.every((o,s)=>o===t[s])}const{t:w}=G;class ye{constructor(t){U(this,"bags",new Map);U(this,"originalTiles",new Map);const o=new Map;t.forEach(s=>{const n=`${s.group}-${s.intensity}`;o.has(n)||o.set(n,[]),o.get(n).push(s)}),o.forEach((s,n)=>{const i=[...s];M(i),this.bags.set(n,i),this.originalTiles.set(n,[...s])})}getTile(t,o){const s=`${t}-${o}`;let n=this.bags.get(s);if(!n||n.length===0){const i=this.originalTiles.get(s);if(!i||i.length===0)return null;n=[...i],M(n),this.bags.set(s,n)}return n.pop()||null}}function $e(e,t,o=[]){return e.filter(s=>{const n=s.action,i=o.find(r=>r.name===s.group);return i?.type==="consumption"||i?.type==="solo"?!0:t==="vers"?n.includes("{sub}")&&n.includes("{dom}")||n.includes("{player}"):!n.match(/{(dom|sub)}/)||n.includes(`{${t}}`)})}const q=new Map;function Ce(e,t,o,s){const n=`${e}-${t}-${o}-${s||"normal"}`,i=q.get(n);if(i!==void 0)return i;let r;if([void 0,"normal"].includes(s)){const a=e/t;r=Math.floor(o/a)+1}else t>=3&&Math.random()>=.6?r=t-1:r=t;return q.set(n,r),r}function Z(e,t,o,s,n,i){if(!e.length)return{title:"",description:""};const r=e[0],a=o[r.name];if(!a||a.level<=0)return{title:"",description:""};if(a.variation){const l=a.variation==="appendSome"?.4:a.variation==="appendMost"?.9:1;if(a.variation!=="standalone"&&Math.random()>l)return{title:"",description:""}}const u=Math.max(...r.intensities.map(l=>l.value)),m=Ce(n,u,s,i.difficulty),p=Math.min(m,a.level);let d=t.getTile(r.name,p);if(!d){for(let l=p-1;l>=1&&(d=t.getTile(r.name,l),!d);l--);if(!d)for(let l=p+1;l<=u&&(d=t.getTile(r.name,l),!d);l++);if(!d)return{title:"",description:""}}return{title:r.label,description:d.action,standalone:a.variation==="standalone",role:i.role||"sub"}}function Te(e,t,o,s,n,i,r){if(e.standalone||!t.length||!e.description)return e.description||"";const a=Z(t,o,s,n,i,r);return a.description?`${a.description.trim().replace(/([^.,!?])$/,"$1.")} ${e.description}`:e.description}async function Se(e,t,o,s){const n=o.selectedActions||{},i=new ye(t),r=e.filter(p=>{const d=n[p.name];return d&&d.level>0&&(!d.variation||d.variation==="standalone")}),a=e.filter(p=>{const d=n[p.name];return d&&d.level>0&&(d.variation==="appendSome"||d.variation==="appendMost")});M(r);let u=0;const m=[];for(let p=1;p<=s;p++){const d=r.length>0?[r[u%r.length]]:[];u++;const l=Z(d,i,n,p,s,o),b=Te(l,a,i,n,p,s,o);m.push({title:l.title,description:b.trim(),role:l.role})}return m}function N(e,t){const o={title:w("start"),description:w("start")},{finishRange:s=[33,66]}=t,n=`${w("noCum")} ${s[0]}%\r
${w("ruined")} ${s[1]-s[0]}%\r
${w("cum")} ${100-s[1]}%`,i={title:w("finish"),description:n};return[o,...e.map(r=>({title:r.title,description:r.description})),i]}async function we(e,t,o,s=40){try{const[n,i]=await Promise.all([ie({locale:t,gameMode:o}),ae({locale:t,gameMode:o})]),r=e.selectedActions||{},a=Object.keys(r).filter(g=>r[g]?.level>0),u=n.filter(g=>a.includes(g.name)),m=n.map(g=>g.name),p=a.filter(g=>!m.includes(g)),d=e.role||"sub",b=$e(i,d,n).filter(g=>a.includes(g.group));if(!u.length||!b.length)return{board:N([],e),metadata:{totalTiles:s+2,tilesWithContent:2,selectedGroups:a,missingGroups:p,availableTileCount:b.length}};const c=await Se(u,b,e,s),h=c.filter(g=>g.description.trim().length>0).length,f=N(c,e);return{board:f,metadata:{totalTiles:f.length,tilesWithContent:h+2,selectedGroups:a,missingGroups:p,availableTileCount:b.length}}}catch(n){return console.error("Error building game board:",n),{board:N([],e),metadata:{totalTiles:2,tilesWithContent:2,selectedGroups:[],missingGroups:[],availableTileCount:0}}}}function Ae(){const e=I(Y),[t,o]=H(),{i18n:s}=x(),n=v.useCallback(async i=>{const r=i?.roomUpdate||i?.boardUpdated?i:{...t,...i,selectedActions:{...t.selectedActions,...i.selectedActions}};let{gameMode:a,boardUpdated:u}=r;const{roomTileCount:m=40,finishRange:p,room:d}=r,l=W(d||"");if(!i||!p)return{gameMode:a};l&&!F(a||"")&&(a="online",u=!0);const b=a||"online",c=s.resolvedLanguage||"en",h=l?40:m||40,f=await we(r,c,b,h);return f.metadata.missingGroups.length>0&&console.warn("Missing groups for board building:",f.metadata.missingGroups),f.metadata.tilesWithContent<h/2&&console.warn("Low tile content ratio:",{tilesWithContent:f.metadata.tilesWithContent,totalTiles:f.metadata.totalTiles,availableTileCount:f.metadata.availableTileCount}),(i?.boardUpdated||u||(e?.tiles?.length??0)!==f.board.length)&&(await o(r),await X({title:e?.title||"",tiles:f.board})),{settingsBoardUpdated:u,gameMode:a,newBoard:f.board,metadata:f.metadata}},[e,s.resolvedLanguage,t,o]);return v.useCallback(i=>n(i),[n])}function Le(e,t){return e!==null&&typeof e=="object"&&typeof t=="string"&&t in e}function Ge(e,t,o){const s=e.selectedActions||{},n=Object.entries(o).filter(([r])=>s[r]).reduce((r,[a,u])=>(r[a]=Object.keys(u.actions).slice(1,s[a].level+1),r),{});return(t?.filter(r=>{if(!r.isCustom)return!1;if(r.group==="misc")return!0;const a=n[r.group];return a&&a.length>=Number(r.intensity)})||[]).length}async function Ee(e,t,o,s){const{t:n}=G;let i=`### ${G.t("gameSettingsHeading")}\r
`;s&&(i+=`##### ${s}\r
`),i+=`--- \r
`;const r=e.selectedActions||{};if(Object.entries(o).forEach(([p,d])=>{if(!r[p])return;const{role:l,variation:b,level:c}=r[p],h=l||e.role||"sub";if(c>0){const f=Object.keys(d?.actions||{});if(i+=`* ${d?.label}: ${f[c]||""}`,b&&(i+=` (${n(b)})`),!F(e.gameMode)&&!b){const g=Le(d,h)?d[h]:n(h);i+=` (${g})`}i+=`\r
`}}),e.customGroups&&Array.isArray(e.customGroups)){for(const p of e.customGroups)if(p.groupName&&p.intensity)try{const l=(await J(p.groupName,e.locale||"en",e.gameMode||"online"))?.label||p.groupName;i+=`* ${l}: Level ${p.intensity} (Custom)\r
`}catch(d){console.error(`Error loading custom group ${p.groupName}:`,d),i+=`* ${p.groupName}: Level ${p.intensity} (Custom)\r
`}}if(i.endsWith(`--- \r
`))return"";const{finishRange:a,difficulty:u}=e;if(i+=`--- \r
`,i+=`* ${n("difficulty")}: ${n(u??"normal")} \r
`,a){const p=a[0],d=a[1]-a[0],l=100-a[1],c=[p>0?{percent:p,text:n("noCum")}:null,d>0?{percent:d,text:n("ruined")}:null,l>0?{percent:l,text:n("cum")}:null].filter(h=>h!==null);c.length===1&&c[0].percent===100?i+=`* ${n("finishSlider")} ${c[0].text.replace(":","")} \r
`:c.length>0&&(i+=`* ${n("finishSlider")} \r
\r
`,c.forEach(h=>{const f=h.percent===100?h.text.replace(":",""):`${h.text} ${h.percent}%`;i+=`  - ${f} \r
`}))}const m=Ge(e,t,o);return m&&(i+=`* ${n("customTilesLabel")}: ${m} \r
`),i}function Ue(e){const t={};return Object.entries(e).forEach(([o,s])=>{!["displayName","background","boardUpdated","chatSound","mySound","otherSound","othersDialog","playerDialog","readRoll","hideBoardActions","advancedSettings"].includes(o)&&!o.startsWith("room")&&(t[o]=s)}),t}async function Ne({title:e,formData:t,user:o,actionsList:s,tiles:n,customTiles:i=[],reason:r=""}){const a=JSON.stringify(Ue(t)),u=await re({title:e,gameBoard:JSON.stringify(n),settings:a}),m=await Ee(t,i,s,r);if(!(!u?.id||m===""))return D({room:t?.room||"PUBLIC",user:o,text:m,type:"settings",gameBoardId:u.id,boardSize:n.length,gameMode:t.gameMode})}function Ie(e){const{t}=G;let o=`### ${t("roomSettings")}\r
`;return Object.entries(e).forEach(([s,n])=>{if(s!=="room"){if(s==="roomBackgroundURL"&&n!==""){o+=`* ${t(s)}: [${ge(n)}:link:](${n})\r
`;return}if(s==="roomRealtime"){o+=`* ${t("playerList")}: ${t(n?"delayed":"realtime")}\r
`;return}n!==""&&(o+=`* ${t(s)}: ${n}\r
`)}}),o}function Me(e){const t={};return Object.entries(e).forEach(([o,s])=>{o.startsWith("room")&&!["roomUpdated","roomBackground"].some(n=>n===o)&&(t[o]=s)}),t}async function Be(e,t,o){let s=e;return t!==void 0&&t.length>0&&(s=await o(t)),s}function Re(e,t){const o=Me(e);return D({room:e.room,user:t,text:Ie(o),type:"room",settings:JSON.stringify(o)})}function _e(){const{id:e}=z(),t=pe();return o=>{const s=e!==void 0&&e?.toUpperCase()!==o?.toUpperCase(),n=o?.replace(/^\/+/,"")||"PUBLIC";s&&t(`/${n}`)}}const B=50,R=100,_=50,P=1,V=10,O=1,k=10,K=["none","all","default","undefined","null"],Pe=["solo","foreplay","sex","consumption"],Ve=(e,t="en",o="online",s)=>{const n=[],i=[];if(!e||e.trim().length===0)return n.push("Group name is required"),{isValid:!1,errors:n,warnings:i};const r=e.trim();return r.length>B&&n.push(`Group name must be ${B} characters or less`),K.includes(r.toLowerCase())&&n.push(`"${r}" is a reserved name and cannot be used`),/^[a-zA-Z0-9_-]+$/.test(r)||n.push("Group name can only contain letters, numbers, hyphens, and underscores"),/^[a-zA-Z]/.test(r)||n.push("Group name must start with a letter"),{isValid:n.length===0,errors:n,warnings:i}},Oe=e=>{const t=[],o=[];return!e||e.trim().length===0?(t.push(fe("groupLabelRequired")),{isValid:!1,errors:t,warnings:o}):(e.trim().length>R&&t.push(`Group label must be ${R} characters or less`),{isValid:t.length===0,errors:t,warnings:o})},ke=e=>{const t=[],o=[];if(!e||e.length===0)return t.push("At least one intensity level is required"),{isValid:!1,errors:t,warnings:o};e.length<O&&t.push(`At least ${O} intensity level is required`),e.length>k&&t.push(`Maximum ${k} intensity levels allowed`);const s=new Set,n=new Set;for(let a=0;a<e.length;a++){const u=e[a];if((!u.id||u.id.trim().length===0)&&t.push(`Intensity level ${a+1} is missing an ID`),!u.label||u.label.trim().length===0)t.push(`Intensity level ${a+1} is missing a label`);else{const m=u.label.trim();m.length>_&&t.push(`Intensity level ${a+1} label must be ${_} characters or less`),n.has(m.toLowerCase())?t.push(`Intensity label "${m}" is used multiple times`):n.add(m.toLowerCase())}typeof u.value!="number"||!Number.isInteger(u.value)?t.push(`Intensity level ${a+1} must have a valid integer value`):((u.value<P||u.value>V)&&t.push(`Intensity level ${a+1} value must be between ${P} and ${V}`),s.has(u.value)?t.push(`Intensity value ${u.value} is used multiple times`):s.add(u.value))}const i=Array.from(s).sort((a,u)=>a-u);let r=i[0];for(const a of i){if(a!==r){o.push("Intensity values are not sequential. Consider using values like 1, 2, 3, 4 for better user experience");break}r++}return{isValid:t.length===0,errors:t,warnings:o}},et=async(e,t)=>{const o=[],s=[],n=Ve(e.name,e.locale||"en",e.gameMode||"online");o.push(...n.errors),s.push(...n.warnings||[]);const i=Oe(e.label);o.push(...i.errors),s.push(...i.warnings||[]);const r=ke(e.intensities);if(o.push(...r.errors),s.push(...r.warnings||[]),n.isValid&&e.name)try{await le(e.name,e.locale||"en",e.gameMode||"online",t)||o.push(`A group with the name "${e.name}" already exists for this locale and game mode`)}catch(a){s.push("Could not verify group name uniqueness"),he.warn("Failed to check group name uniqueness:",!1,a instanceof Error?a.message:"Unknown error")}return{isValid:o.length===0,errors:o,warnings:s}},tt=async(e,t="en",o="online")=>{const s=[],n=[];if(!e.group||e.group.trim().length===0)return s.push("Tile must belong to a group"),{isValid:!1,errors:s,warnings:n};try{const i=await J(e.group,t,o);if(!i)return s.push(`Group "${e.group}" does not exist for ${t}/${o}`),{isValid:!1,errors:s,warnings:n};const r=i.intensities.map(a=>a.value);r.includes(e.intensity)||s.push(`Intensity ${e.intensity} is not valid for group "${e.group}". Valid intensities: ${r.join(", ")}`),(!e.action||e.action.trim().length===0)&&s.push("Tile action is required")}catch(i){s.push(`Error validating tile: ${i}`)}return{isValid:s.length===0,errors:s,warnings:n}},xe=()=>({MAX_GROUP_NAME_LENGTH:B,MAX_GROUP_LABEL_LENGTH:R,MAX_INTENSITY_LABEL_LENGTH:_,MIN_INTENSITY_VALUE:P,MAX_INTENSITY_VALUE:V,MIN_INTENSITIES_COUNT:O,MAX_INTENSITIES_COUNT:k,RESERVED_GROUP_NAMES:K,VALID_GROUP_TYPES:Pe});function qe(e){(!e.roomBackgroundURL||!me(e.roomBackgroundURL))&&(e.roomBackground="app")}function je(e){const t={...e},o={};e.selectedActions&&Object.entries(e.selectedActions).forEach(([n,i])=>{i&&i.level>0&&(o[n]=i)});const s=xe();return Object.keys(t).forEach(n=>{const i=t[n];i&&typeof i=="object"&&i.type&&s.VALID_GROUP_TYPES.includes(i.type)&&delete t[n]}),t.selectedActions=o,t}function nt(){const{user:e,updateUser:t}=se(),{id:o}=z(),{t:s}=x(),n=Ae(),[i,r]=H(),a=I(()=>ce(i?.gameMode)),u=I(Y),m=_e(),{messages:p}=oe(),{createLocalSession:d}=be(),l=v.useCallback(c=>{const h=(o||"")?.toUpperCase(),f=(c.room||"").toUpperCase(),g=h!==f,$=!!(c.room&&!W(c.room)),C=$&&c.roomTileCount!==i?.roomTileCount;return{roomChanged:g,isPrivateRoom:$,privateBoardSizeChanged:C}},[o,i?.roomTileCount]),b=v.useCallback(async(c,h)=>{const{displayName:f}=c,g=await Be(e,f,t);qe(c);const{settingsBoardUpdated:$,gameMode:C,newBoard:A=[]}=await n(c),{roomChanged:T,isPrivateRoom:E,privateBoardSizeChanged:Q}=l(c);if(!g)return;E&&(c.roomUpdated||!p.find(S=>S.type==="room"))&&await Re(c,g),u?.tiles!==A&&await X({title:s("settingsGenerated"),tiles:A,isActive:1,gameMode:C}),($||T||Q)&&!p.some(S=>S.type==="settings"&&S.uid===g.uid&&Date.now()-(S.timestamp?.toMillis()||0)<5e3)&&await Ne({formData:c,user:g,customTiles:a,actionsList:h,title:"Settings Generated Board",tiles:A});const L=c;if(L.hasLocalPlayers&&L.localPlayersData&&L.localPlayerSessionSettings)try{await d(c.room,L.localPlayersData,L.localPlayerSessionSettings)}catch(S){console.error("Error creating local session:",S)}const ee=je(c);r({...ee,boardUpdated:!1,roomUpdated:!1,gameMode:C}),m(c.room)},[e,t,n,l,p,u,s,a,r,m,d]);return v.useCallback((c,h)=>b(c,h),[b])}const y=new Map,j=de;window.debugActionsCache=()=>{};window.clearActionsCache=()=>{y.clear()};function st(e){const{i18n:t,t:o}=x(),{currentLanguageMigrated:s,isHealthy:n,forceRecovery:i}=ve(),[r,a]=v.useState({}),[u,m]=v.useState(!0),[p,d]=v.useState(!1);v.useEffect(()=>{const c=()=>{e&&Array.from(y.keys()).filter(f=>f.endsWith(`-${e}`)).forEach(f=>{y.delete(f)})};return t.on("languageChanged",c),()=>{t.off("languageChanged",c)}},[t,e]);const l=v.useMemo(()=>!e||!t.resolvedLanguage?"":`${t.resolvedLanguage}-${e}`,[t.resolvedLanguage,e]);v.useEffect(()=>{s&&l&&y.get(l)&&y.delete(l)},[s,l]),v.useEffect(()=>{if(l){const c=y.get(l);c&&Date.now()-c.timestamp<j&&(a(c.data),m(!1))}},[l]);const b=v.useCallback(async()=>{if(!e||!l){console.warn("⚠️ useUnifiedActionList: Missing required params",{gameMode:e,cacheKey:l});return}if(!s)return;if(s&&!n&&!p){d(!0);try{await i();return}catch{}}const c=y.get(l);if(c&&Date.now()-c.timestamp<j){a(c.data),m(!1);return}m(!0);try{const h=await ue(t.resolvedLanguage,e),f={};for(const g of h){const $={[o("none")]:[]},C={};g.intensities&&Array.isArray(g.intensities)&&g.intensities.sort((T,E)=>T.value-E.value).forEach(T=>{$[T.label]=[],C[T.value]=T.label});const A=g.type||"action";f[g.name]={label:g.label||g.name,type:A,actions:$,intensities:C}}y.set(l,{data:f,timestamp:Date.now()}),a(f)}catch(h){console.error("❌ useUnifiedActionList: Error loading unified actions",{error:h,locale:t.resolvedLanguage,gameMode:e,cacheKey:l}),a({})}finally{m(!1)}},[e,t.resolvedLanguage,l,o,s,n,p,i]);return v.useEffect(()=>{l&&s&&b()},[b,l,s,n]),{actionsList:r,isLoading:u}}export{nt as a,st as b,Qe as c,Oe as d,tt as e,Re as f,xe as g,Ne as s,Ae as u,et as v};
